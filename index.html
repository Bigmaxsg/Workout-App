<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workout Tracker Pro</title>

     <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workout Tracker Pro</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="./icon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="./icon-16x16.png">
    
    <!-- Apple Touch Icons (iOS) -->
    <link rel="apple-touch-icon" sizes="180x180" href="./apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="152x152" href="./apple-touch-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="120x120" href="./apple-touch-icon-120x120.png">
    
    <!-- Android Chrome Icons -->
    <link rel="icon" type="image/png" sizes="192x192" href="./android-chrome-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="./android-chrome-512x512.png">
    
    <!-- PWA Settings -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Workout Pro">
    <meta name="theme-color" content="#001f3f">
    <meta name="description" content="Track your workouts, set PRs, and achieve your fitness goals with Workout Tracker Pro">
    
    <!-- Web App Manifest -->
    <link rel="manifest" href="./manifest.json">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            min-height: 100vh;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            /* background: rgba(245, 245, 220, 0.85); /* 85% opaque beige */
            background: rgba(255, 255, 255, 0.85); /* 85% opaque white for better visibility */
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            overflow-y: auto; /* Allow scrolling within container */
            padding: 10px;
            overflow-x: hidden;
            border: 3px solid #8b7355;
            position: relative;
        }

        .header {
            background: linear-gradient(135deg, #001f3f 0%, #003d5c 100%);
            color: #d4af37;
            padding: 20px;
            text-align: center;
            border-bottom: 3px solid #d4af37;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 5px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .nav {
            display: flex;
            background: #d9c7a5;
            border-bottom: 2px solid #8b7355;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            flex-wrap: wrap;
        }

        .nav::-webkit-scrollbar {
            display: none;
        }

        .nav-btn {
            flex: 1 1 auto;
            min-width: 90px;
            padding: 12px 8px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 11px;
            font-weight: 600;
            transition: all 0.3s;
            white-space: nowrap;
            text-align: center;
        }

        .nav-btn.active {
            border-bottom: 3px solid;
        }

        .content {
            padding: 15px;
            min-height: 400px;
            background: transparent; /* Ensure content background is transparent */
            position: relative;
            z-index: 1;
        }
        .section {
            display: none;
        }

        .section.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        select,
        input,
        textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 16px;
            transition: border 0.3s;
            font-family: inherit;
        }

        select:focus,
        input:focus,
        textarea:focus {
            outline: none;
            border-color: #003d5c;
        }

        .btn {
            padding: 14px 28px;
            background: linear-gradient(135deg, #001f3f 0%, #003d5c 100%);
            color: #d4af37;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s;
            width: 100%;
            margin-top: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 31, 63, 0.4);
            border-color: rgba(255, 255, 255, 0.6);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: #8b7355;
            color: #f5f5dc;
        }

        .btn-success {
            background: linear-gradient(135deg, #4a6741 0%, #5d8055 100%);
            color: #f5f5dc;
        }

        .btn-danger {
            background: linear-gradient(135deg, #8b0000 0%, #a52a2a 100%);
            color: #f5f5dc;
        }
         .color-setting-card {
            background: #e8dcc4;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #003d5c;
        }
        .exercise-card {
            background: #e8dcc4;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #003d5c;
        }
        
        .exercise-equipment {
            font-size: 13px;
            margin-top: 5px;
        }
        
        .exercise-not-found {
            text-align: center;
            color: #6c757d;
        }

        .exercise-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            gap: 10px;
        }

        .exercise-name {
            font-weight: 700;
            font-size: 16px;
            flex: 1;
            max-width: 60%;
            word-wrap: break-word;
            line-height: 1.3;
        }

        .exercise-button-group {
            display: flex;
            gap: 4px;
            flex-shrink: 0;
            align-items: center;
            justify-content: flex-end;
            min-width: 140px;
        }

        .exercise-details {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .detail-input {
            display: flex;
            flex-direction: column;
            min-width: 0;
        }
        .detail-input label {
            font-size: 12px;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

         .detail-input input,
        .detail-input select {
            padding: 8px;
            font-size: 14px;
            width: 100%;
            min-height: 40px;
            box-sizing: border-box;
        }

        .exercise-image {
            width: 100%;
            max-width: 400px;
            min-height: 250px;
            background: #e9ecef;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 15px auto;
            overflow: hidden;
            position: relative;
            border: 2px solid #003d5c;
        }

        .exercise-image img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            background: white;
        }

        .exercise-image-fallback {
            color: #6c757d;
            font-size: 14px;
            text-align: center;
            padding: 20px;
        }

        .image-loading {
            color: #003d5c;
            font-size: 16px;
            font-weight: 600;
        }

        .recommendation-card {
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .recommendation-card h3 {
            margin-bottom: 10px;
            font-size: 20px;
        }

        .recommendation-card p {
            margin-bottom: 8px;
            line-height: 1.6;
        }

        .workout-history {
            margin-top: 20px;
        }

        .history-item {
            background: #e8dcc4;
            border-radius: 10px;
            padding: 15px;
            padding-bottom: 20px;
            margin-bottom: 25px;
            border-left: 4px solid #003d5c;
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .history-date {
            font-weight: 600;
        }

        .history-type {
            font-weight: 600;
        }

        .history-exercises {
            font-size: 14px;
        }

        .history-details-body {
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid #d9c7a5;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .history-exercise-detail {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            font-size: 14px;
        }

        .history-exercise-name {
            font-weight: 600;
            margin-right: 10px;
        }

        .history-exercise-stats {
            text-align: right;
            flex-shrink: 0;
        }

        .history-duration {
            font-size: 18px;
            font-weight: 600;
            text-align: right;
        }

        .history-notes {
            margin-top: 10px;
            padding: 10px;
            border-radius: 6px;
            font-size: 13px;
            font-style: italic;
        }

        .pr-badge {           
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 700;
            margin-left: 5px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-number {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 5px;
            color: #d4af37;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
            color: #f5f5dc;
        }

        .progress-chart {
            background: #e8dcc4;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            min-height: 200px;
            border: 2px solid #8b7355;
        }

        .chart-title {
            font-weight: 600;
            margin-bottom: 15px;
        }

        .chart-bar {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .chart-label {
            width: 120px;
            font-size: 14px;
        }

        .chart-fill {
            flex: 1;
            height: 30px;
            background: linear-gradient(90deg, #001f3f 0%, #003d5c 100%);
            border-radius: 5px;
            position: relative;
        }

        .chart-value {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: #d4af37;
            font-weight: 600;
            font-size: 14px;
        }

        .info-box {
            background: #d9c7a5;
            border-left: 4px solid #003d5c;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .info-box p {
            color: #3e3024;
            line-height: 1.6;
            font-size: 14px;
        }
        
        .status-success {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .status-warning {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .status-error {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .delete-btn {
            background: linear-gradient(135deg, #8b0000 0%, #a52a2a 100%);
            color: #ffffff;
            border: none;
            padding: 6px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            white-space: nowrap;
        }

        .delete-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(139, 0, 0, 0.4);
            background: linear-gradient(135deg, #a52a2a 0%, #8b0000 100%);
        }

        .delete-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .add-exercise-btn {
            background: #4a6741;
            color: #f5f5dc;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            margin-top: 10px;
        }

        .edit-btn {
            background: linear-gradient(135deg, #003d5c 0%, #005580 100%);
            color: #d4af37;
            border: none;
            padding: 6px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            white-space: nowrap;
        }

        .edit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 61, 92, 0.4);
            background: linear-gradient(135deg, #005580 0%, #003d5c 100%);
        }

        .edit-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .workout-timer {
            background: linear-gradient(135deg, #003d5c 0%, #005580 100%);
            color: #d4af37;
            border-radius: 12px;
            padding: 12px;
            text-align: center;
            margin-bottom: 15px;
            border: 2px solid #d4af37;
            display: none; 
        }

        .timer-display {
            font-size: 36px;
            font-weight: 700;
            margin: 5px 0;
        }

        .timer-controls {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-top: 8px;
        }

        .timer-btn {
            padding: 8px 16px;
            background: rgba(245, 245, 220, 0.2);
            border: 2px solid #d4af37;
            color: #d4af37;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
        }
        #modal-wrapper {
            position: relative;
            z-index: 10000;
        }
        .modal.active {
            display: flex !important;
        }
        .modal {
            position: fixed !important;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            padding: 20px;
            display: none;
            justify-content: center;
            align-items: center;
            overflow-y: auto;
            overscroll-behavior: contain;
        }
            .modal.active {
            display: flex !important;
        }
            .modal-content {
            background: white;
            border-radius: 16px;
            padding: 20px;
            max-width: 500px;
            width: 100%;
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
            z-index: 10001;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            max-height: calc(100vh - 40px);
            overflow-y: auto;
            margin: auto; /* ensure perfect viewport centering */
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
        }

        .modal-close {
            background: #dc3545;
            border: none;
            font-size: 32px;
            cursor: pointer;
            color: #ffffff;
            padding: 8px 12px;
            line-height: 1;
            transition: all 0.2s ease;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 44px;
            min-height: 44px;
            opacity: 0.9;
        }

        .modal-close:hover {
            background-color: #c82333;
            color: #ffffff;
            opacity: 1;
        }

        .modal-close:active {
            background-color: #b81c2e;
            opacity: 0.95;
        }

        #userMessage {
            flex: 1;
            border: 2px solid #8b7355;
            border-radius: 8px;
            background-color: white !important;
            color: #333 !important;
            resize: vertical;
            line-height: 1.5;
        }

        .chat-input-container {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .chat-input-container .btn {
            margin-top: 0;
            flex-shrink: 0;
             width: auto; /* <-- Add this line */
        }
        
        .chat-messages-box {
            border-radius: 10px;
            padding: 15px;
            height: 350px;
            overflow-y: auto;
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .control-group {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: 15px;
        }

        .control-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 0;
        }

        .control-label {
            font-size: 11px;
            color: #6c757d;
            margin-bottom: 5px;
            font-weight: 600;
            text-align: center;
            white-space: nowrap;
        }

        .control-buttons {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 3px;
            width: 100%;
        }

        .adjust-btn {
            background: #8b7355;
            color: #f5f5dc;
            border: none;
            width: 28px;
            height: 28px;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .adjust-btn.plus {
            background: #003d5c;
            color: #d4af37;
        }

        .control-input {
            width: 100%;
            max-width: 55px;
            text-align: center;
            font-size: 14px;
            font-weight: bold;
            padding: 6px 2px;
            border: 2px solid #003d5c;
            border-radius: 6px;
        }

        #hiitCountdownScreen {
            text-align: center;
        }

        #hiitCountdownDisplay {
            font-size: 120px;
            font-weight: bold;
        }

        #hiitActiveScreen {
            text-align: center;
        }

        #hiitTimerDisplay {
            font-size: 80px;
            font-weight: bold;
            margin: 5px 0;
            color: #d4af37;
        }

        #hiitModeDisplay {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        #hiitModeDisplay.work {
            color: #28a745;
        }

        #hiitModeDisplay.rest {
            color: #007bff;
        }

        #hiitExerciseName {
            font-size: 20px;
            color: #f5f5dc;
            font-weight: bold;
            margin-bottom: 3px;
        }

        #hiitNextExerciseName {
            font-size: 14px;
            color: #f5f5dc;
            opacity: 0.8;
        }

        #hiitRoundDisplay {
            margin-top: 8px;
            font-size: 16px;
            color: #f5f5dc;
            margin-bottom: 8px;
        }

        .calendar-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            gap: 10px;
        }

        .calendar-view-buttons {
            display: flex;
            gap: 5px;
        }

        .view-btn {
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
        }

        .view-btn.active {
            border-color: transparent;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            margin-top: 15px;
        }
        /* Styling for Today's Date */
        #calendarContent .calendar-day.today {
            border-color: var(--accent-color, #d4af37);
            box-shadow: 0 0 10px var(--accent-color, #d4af37);
        }
        .calendar-day-header {
            text-align: center;
            font-weight: 600;
            padding: 10px 5px;
            border-radius: 6px;
            font-size: 12px;
        }

        .calendar-day {
            min-height: 80px;
            padding: 8px;
            border-radius: 8px;
            border: 1px solid;
            cursor: pointer;
            transition: all 0.2s;
        }

        .calendar-day:hover {
            transform: translateY(-2px);
        }

        .calendar-day.today {
        }

        .calendar-day.other-month {
            opacity: 0.4;
        }

        .calendar-day.has-workout {
        }

        .calendar-day.rest-day {
        }

        .day-number {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 5px;
        }

        .day-workout-count {
            font-size: 11px;
            font-weight: 600;
        }

        .rest-indicator {
            font-size: 11px;
            color: #856404;
            font-weight: 600;
        }

        .weekly-view {
            display: grid;
            gap: 10px;
        }

        .week-day-card {
            background: #e8dcc4;
            border-radius: 10px;
            padding: 15px;
            border-left: 4px solid #003d5c;
        }

        .week-day-card.has-workout {
            border-left-color: #4a6741;
            background: #c8e6c9;
        }

        .week-day-card.rest-day {
            border-left-color: ${colors.accent};
        }
        .measurement-card {
            background: #e8dcc4;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #003d5c;
        }

        .measurement-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .measurement-label {
            font-weight: 600;
            color: #333;
            font-size: 16px;
        }

        .measurement-value {
            font-size: 24px;
            font-weight: 700;
        }

        .measurement-trend {
            font-size: 12px;
            margin-top: 5px;
        }

        .trend-up {
            color: #28a745;
        }

        .trend-down {
            color: #dc3545;
        }

        @media (max-width: 600px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .nav-btn {
                flex: 1 1 calc(33.333% - 2px);
                min-width: 0;
                font-size: 10px;
                padding: 10px 4px;
            }

            .exercise-card {
                padding: 12px;
            }

            .chat-input-container {
                flex-direction: column;
                align-items: stretch;
            }

            .chat-input-container .btn {
                width: 100%;
                margin-top: 10px;
            }

            .control-group {
                gap: 4px;
            }

            .control-label {
                font-size: 10px;
            }

            .control-buttons {
                gap: 2px;
            }

            .control-input {
                max-width: 45px;
                font-size: 13px;
                padding: 5px 1px;
            }

            .adjust-btn {
                width: 26px;
                height: 26px;
                font-size: 14px;
            }

            .timer-display {
                font-size: 36px;
            }

            .calendar-grid {
                gap: 3px;
            }

            .calendar-day {
                min-height: 60px;
                padding: 5px;
            }

            .day-number {
                font-size: 12px;
            }
        }

        @media (max-width: 400px) {
            .exercise-card {
                padding: 10px;
            }

            .control-group {
                gap: 3px;
            }

            .control-input {
                max-width: 40px;
                font-size: 12px;
            }

            .adjust-btn {
                width: 24px;
                height: 24px;
                font-size: 13px;
            }
        }

        #qrScannerBox.success {
            border: 5px solid #4caf50;
            box-shadow: 0 0 20px #4caf50, 0 0 0 9999px rgba(0, 0, 0, 0.5);
        }

        #qrScannerOverlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #qrScannerBox {
            width: 75%;
            padding-top: 75%;
            position: relative;
            border: 4px solid rgba(255, 255, 255, 0.5);
            border-radius: 10px;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
        }

        #qrScannerLaser {
            position: absolute;
            top: 0;
            left: 5%;
            width: 90%;
            height: 3px;
            background-color: #d4af37;
            box-shadow: 0 0 10px #d4af37;
            border-radius: 5px;
            animation: scan 2s infinite linear;
        }

        @keyframes scan {
            0% {
                top: 5%;
            }
            50% {
                top: 95%;
            }
            100% {
                top: 5%;
            }
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>üí™ Workout Tracker Pro</h1>
            <p>Your Personal Fitness Companion</p>
        </div>
        <div class="nav">
            <button class="nav-btn" onclick="showSection('ai-coach')">AI Coach</button>
            <button class="nav-btn active" onclick="showSection('workout')">Workout</button>
            <button class="nav-btn" onclick="showSection('exercises')">Exercises</button>
            <button class="nav-btn" onclick="showSection('recommend')">Recommend</button>
            <button class="nav-btn" onclick="showSection('progress')">Progress</button>
            <button class="nav-btn" onclick="showSection('history')">History</button>
            <button class="nav-btn" onclick="showSection('calendar')">Calendar</button>
            <button class="nav-btn" onclick="showSection('body-stats')">Body Stats</button>
            <button class="nav-btn" onclick="showSection('share-workout')">Share</button>
            <button class="nav-btn" onclick="showSection('settings')">Settings</button>
        </div>
        <div class="content">
            <!-- AI Coach Section -->
            <div id="ai-coach" class="section">
                <h2>ü§ñ AI Workout Coach</h2>
                <p>Get custom workouts or update exercise details. Just ask!</p>
                <div id="api-setup" class="info-box" style="margin-bottom: 20px;">
                    <h3>‚öôÔ∏è Setup Required (First Time Only)</h3>
                    <p>Get your free API key from: <a href="https://ai.google.dev"
                            target="_blank">https://ai.google.dev</a></p>
                    <div class="form-group">
                        <input type="password" id="apiKey" placeholder="Paste your Gemini API key here">
                    </div>
                    <button class="btn" onclick="saveApiKey()">üíæ Save API Key</button>
                </div>
                <div id="chat-box" style="display: none;">
                    <div style="display: flex; justify-content: flex-end; margin-bottom: 10px;">
                        <button class="btn btn-secondary" onclick="resetApiKey()"
                            style="width: auto; padding: 8px 12px; font-size: 12px; margin-top: 0;">üîÑ Change API
                            Key</button>
                    </div>
                    <div class="chat-messages-box" id="messages"></div>
                    <div class="chat-input-container">
                        <textarea id="userMessage"
                            placeholder="e.g., 'a 30 minute leg workout' or 'add instructions for farmer's walk'..."
                            rows="3"></textarea>
                        <button class="btn" onclick="sendMessage()">üì§ Send</button>
                    </div>
                    <!-- Fitness Tracker Screenshot Import -->
                    <div class="info-box" style="margin-bottom: 20px;">
                        <h3 style="margin-bottom: 10px;">üì∏ Import Fitness Tracker Workout Data</h3>
                        <p style="font-size: 14px; margin-bottom: 15px;">
                            Upload a screenshot from your Apple Fitness app or other fitness tracker and AI will automatically log the workout to your history and calendar!
                        </p>
                        <input type="file" id="appleWorkoutImage" accept="image/*" style="display: none;" onchange="processAppleWorkoutImage(event)">
                        <button class="btn" onclick="document.getElementById('appleWorkoutImage').click()">
                            üì∏ Upload Fitness Tracker Screenshot
                        </button>
                        <div id="imageProcessingStatus" style="margin-top: 10px; display: none;"></div>
                    </div>
                     <!-- Smart Import Tip -->
                    <div class="info-box" style="margin-bottom: 20px;">
                        <p><strong>üí° Smart Import Tip:</strong></p>
                        <p>If you've already logged a workout manually, importing the Fitness Tracker screenshot will ask if you want to UPDATE the existing workout with heart rate, calories, and distance data - no duplicates!</p>
                   
                    </div>
                </div>
            </div>

            <div id="workout" class="section active">   
                <!-- Workout Section -->
            <div class="workout-timer">
                <h3>‚è±Ô∏è Workout Duration Timer</h3>
                <div class="timer-display" id="timerDisplay">00:00</div>
                <div class="timer-controls">
                    <button class="timer-btn" onclick="startTimer()">‚ñ∂Ô∏è Start</button>
                    <button class="timer-btn" onclick="pauseTimer()">‚è∏Ô∏è Pause</button>
                    <button class="timer-btn" onclick="resetTimer()">üîÑ Reset</button>
                </div>
            </div>
                <div id="workoutSetup">
                    <div class="form-group">
                        <label>Select Workout Type</label>
                       <select id="workoutType" onchange="loadWorkout()">
                            <option value="">-- Choose a Workout --</option>
                            <option value="quick_cardio">üèÉ Quick Log Cardio Session</option>
                            <option value="interval_cardio">‚ö° Interval Cardio Workout</option>
                            <option value="custom">üèãÔ∏è Create Custom Strength Workout</option>
                            <option value="custom_hiit">‚ö° Create Custom HIIT Workout</option>
                            <option value="leg">ü¶µ Leg Day</option>
                            <option value="chest">üí™ Chest Day</option>
                            <option value="back">üîô Back & Biceps</option>
                            <option value="shoulders">üôå Shoulders & Triceps</option>
                            <option value="abs">üéØ Core/Abs Blast</option>
                            <option value="kettlebell">üèãÔ∏è Kettlebell Circuit</option>
                            <option value="cardio">‚ù§Ô∏è Cardio Day</option>
                            <option value="fullbody">üíØ Full Body Power</option>
                        </select>
                    </div>
                    <!-- Custom Workout Management Section -->
                    <div class="form-group" id="manageCustomWorkoutsSection" style="display:none;">
                        <label>Manage Custom Workouts</label>
                        <select id="manageCustomWorkoutSelect">
                            <option value="">-- Select a Custom Workout --</option>
                        </select>
                        <div style="display: flex; gap: 10px; margin-top: 10px;">
                            <button class="btn btn-secondary" onclick="editCustomWorkout()" style="flex: 1;">
                                ‚úèÔ∏è Edit
                            </button>
                            <button class="btn" onclick="deleteCustomWorkout()" style="flex: 1; background: #dc3545; color: white;">
                                üóëÔ∏è Delete
                            </button>
                        </div>
                    </div>
                    <div id="workoutContainer"></div>
                    <div id="workoutModeSelection" style="display:none;">
                        <div class="info-box">
                            <p><strong>Choose Your Workout Style:</strong></p>
                            <p><strong>Traditional:</strong> Complete all sets of one exercise before moving to the next.
                            </p>
                            <p><strong>Circuit:</strong> Do one set of each exercise, then repeat for all rounds.</p>
                            <p><strong>HIIT:</strong> Perform exercises for timed work/rest intervals.</p>
                        </div>
                        <div id="hiitPreWorkoutAdjustments" class="info-box" style="display:none;">
                            <div style="font-weight: 600; margin-bottom: 10px; text-align: center;">
                                Adjust HIIT Parameters:</div>
                            <div style="display: flex; justify-content: center; gap: 25px; flex-wrap: wrap;">
                                <div style="text-align: center;">
                                    <div style="font-size: 11px; margin-bottom: 6px;">Work</div>
                                    <div
                                        style="display: flex; gap: 8px; justify-content: center; align-items: center;">
                                        <button class="btn btn-secondary" onclick="adjustHiitParamPreWorkout('work', -5)"
                                            style="width: 36px; padding: 6px; margin: 0; font-size: 12px;">-</button>
                                        <span id="hiitPreWorkWorkDisplay"
                                            style="min-width: 40px; text-align: center; font-weight: bold; font-size: 14px;">30</span>
                                        <button class="btn btn-secondary" onclick="adjustHiitParamPreWorkout('work', 5)"
                                            style="width: 36px; padding: 6px; margin: 0; font-size: 12px;">+</button>
                                    </div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 11px; margin-bottom: 6px;">Rest</div>
                                    <div
                                        style="display: flex; gap: 8px; justify-content: center; align-items: center;">
                                        <button class="btn btn-secondary" onclick="adjustHiitParamPreWorkout('rest', -5)"
                                            style="width: 36px; padding: 6px; margin: 0; font-size: 12px;">-</button>
                                        <span id="hiitPreWorkRestDisplay"
                                            style="min-width: 40px; text-align: center; font-weight: bold; font-size: 14px;">15</span>
                                        <button class="btn btn-secondary" onclick="adjustHiitParamPreWorkout('rest', 5)"
                                            style="width: 36px; padding: 6px; margin: 0; font-size: 12px;">+</button>
                                    </div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 11px; margin-bottom: 6px;">Rounds</div>
                                    <div
                                        style="display: flex; gap: 8px; justify-content: center; align-items: center;">
                                        <button class="btn btn-secondary"
                                            onclick="adjustHiitParamPreWorkout('rounds', -1)"
                                            style="width: 36px; padding: 6px; margin: 0; font-size: 12px;">-</button>
                                        <span id="hiitPreWorkRoundsDisplay"
                                            style="min-width: 40px; text-align: center; font-weight: bold; font-size: 14px;">4</span>
                                        <button class="btn btn-secondary"
                                            onclick="adjustHiitParamPreWorkout('rounds', 1)"
                                            style="width: 36px; padding: 6px; margin: 0; font-size: 12px;">+</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Add workout notes field -->
                        <div class="form-group" style="margin-top: 15px;">
                            <label>üìù Workout Notes (Optional)</label>
                            <textarea id="workoutNotes" rows="2" placeholder="Add any notes about this workout..."></textarea>
                        </div>
                        <!-- Cardio Tracking Info Box -->
                        <div class="info-box" style="margin-top: 15px;">
                            <p><strong>üì± For Cardio Tracking:</strong></p>
                            <p>Use your preferred cardio app (Concept2 ErgData, Strava, Apple Fitness, etc.) during your workout, then:</p>
                            <ol style="margin-left: 20px; margin-top: 5px;">
                                <li>Take a screenshot of your workout summary</li>
                                <li>Go to <strong>AI Coach</strong> tab</li>
                                <li>Upload screenshot to auto-import data</li>
                                <li>Or manually log using "Edit Stats" button in History</li>
                            </ol>
                        </div>
                        
                        <button class="btn" onclick="startGuidedWorkout('traditional')" style="margin-bottom: 10px;">
                            üèãÔ∏è Start Traditional Style
                        </button>
                        <button class="btn btn-success" onclick="startGuidedWorkout('circuit')"
                            style="margin-bottom: 10px;">
                            üîÑ Start Circuit Style
                        </button>
                        <button class="btn btn-danger" onclick="startHiitWorkout()">
                            ‚ö° Start HIIT Style
                        </button>
                    </div>
                </div>
                
                <!-- Guided Workout Mode -->
                <div id="guidedWorkoutMode" style="display:none;">
                    <div class="recommendation-card" id="currentExerciseCard">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3 id="exerciseProgress">Exercise 1 of 5</h3>
                            <div id="setProgress" style="font-size: 18px; font-weight: bold;">Set 1/3</div>
                        </div>
                        <h2 id="currentExerciseName" style="font-size: 24px; margin-bottom: 10px;">Dumbbell Squats</h2>
                        <div
                            style="background: rgba(245,245,220,0.2); padding: 15px; border-radius: 10px; margin: 15px 0;">
                            <div style="display: flex; justify-content: space-around; text-align: center;">
                                <div>
                                    <div style="font-size: 28px; font-weight: bold;" id="currentWeight">25</div>
                                    <div style="font-size: 14px;">lbs</div>
                                </div>
                                <div>
                                    <div style="font-size: 28px; font-weight: bold;" id="currentReps">12</div>
                                    <div style="font-size: 14px;">reps</div>
                                </div>
                                <div>
                                    <div style="font-size: 28px; font-weight: bold;" id="currentSets">3</div>
                                    <div style="font-size: 14px;">sets</div>
                                </div>
                            </div>
                        </div>
                        <button class="btn btn-secondary" onclick="showCurrentExerciseInfo()"
                            style="margin-bottom: 10px;">
                            üìã View Form Instructions
                        </button>
                        <div id="restTimer" style="display:none; text-align: center; margin: 20px 0;">
                            <h3>‚è∏Ô∏è Rest Time</h3>
                            <div style="font-size: 48px; font-weight: bold; color: #d4af37;" id="restDisplay">60</div>
                            <button class="btn" onclick="skipRest()">‚è≠Ô∏è Skip Rest</button>
                        </div>
                        <button class="btn btn-success" id="completeSetBtn" onclick="completeSet()"
                            style="font-size: 18px; padding: 18px;">
                            ‚úÖ Complete Set
                        </button>
                    </div>
                    <div style="margin-top: 20px; text-align: center;">
                        <button class="btn btn-danger" onclick="endWorkout()">
                            üõë End Workout Early
                        </button>
                    </div>
                    <div class="progress-chart" style="margin-top: 20px;">
                        <h3 class="chart-title">üìä Workout Progress</h3>
                        <div id="workoutProgressList"></div>
                    </div>
                </div>

                <!-- HIIT Workout Mode -->
                <div id="hiitWorkoutMode"
                    style="display:none; padding: 12px; border-radius: 12px;">
                    <div id="hiitCountdownScreen">
                        <h2>Get Ready!</h2>
                        <div id="hiitCountdownDisplay">5</div>
                    </div>
                    <div id="hiitActiveScreen" style="display: none;">
                        <div id="hiitModeDisplay">WORK!</div>
                        <div id="hiitTimerDisplay">30</div>
                        <h3 id="hiitExerciseName">Jumping Jacks</h3>
                        <p id="hiitNextExerciseName">Next Up: Rest</p>
                        <div id="hiitRoundDisplay">Round 1 of 4</div>
                         <button class="btn btn-secondary" onclick="showCurrentHiitExerciseInfo()"
                            style="margin-bottom: 10px; margin-top: 10px;">
                            üìã View Form Instructions
                        </button>
                        <div
                            style="margin: 10px -12px 0 -12px; background: rgba(212,175,55,0.2); padding: 8px 12px; border-radius: 0;">
                            <div style="font-size: 10px; color: #f5f5dc; margin-bottom: 6px; text-align: center;">Adjust
                                Parameters:</div>
                            <div style="display: flex; justify-content: center; gap: 15px; flex-wrap: wrap;">
                                <div style="text-align: center;">
                                    <div style="font-size: 9px; color: #f5f5dc; margin-bottom: 4px;">Work</div>
                                    <div style="display: flex; gap: 6px; justify-content: center; align-items: center;">
                                        <button class="btn btn-secondary" onclick="adjustHiitParam('work', -5)"
                                            style="width: 32px; height: 32px; padding: 4px; margin: 0; font-size: 12px;">-</button>
                                        <span id="hiitWorkDisplay"
                                            style="min-width: 35px; text-align: center; color: #d4af37; font-weight: bold; font-size: 13px;">30</span>
                                        <button class="btn btn-secondary" onclick="adjustHiitParam('work', 5)"
                                            style="width: 32px; height: 32px; padding: 4px; margin: 0; font-size: 12px;">+</button>
                                    </div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 9px; color: #f5f5dc; margin-bottom: 4px;">Rest</div>
                                    <div style="display: flex; gap: 6px; justify-content: center; align-items: center;">
                                        <button class="btn btn-secondary" onclick="adjustHiitParam('rest', -5)"
                                            style="width: 32px; height: 32px; padding: 4px; margin: 0; font-size: 12px;">-</button>
                                        <span id="hiitRestDisplay"
                                            style="min-width: 35px; text-align: center; color: #d4af37; font-weight: bold; font-size: 13px;">15</span>
                                        <button class="btn btn-secondary" onclick="adjustHiitParam('rest', 5)"
                                            style="width: 32px; height: 32px; padding: 4px; margin: 0; font-size: 12px;">+</button>
                                    </div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 9px; color: #f5f5dc; margin-bottom: 4px;">Rounds</div>
                                    <div style="display: flex; gap: 6px; justify-content: center; align-items: center;">
                                        <button class="btn btn-secondary" onclick="adjustHiitParam('rounds', -1)"
                                            style="width: 32px; height: 32px; padding: 4px; margin: 0; font-size: 12px;">-</button>
                                        <span id="hiitRoundsDisplay"
                                            style="min-width: 35px; text-align: center; color: #d4af37; font-weight: bold; font-size: 13px;">4</span>
                                        <button class="btn btn-secondary" onclick="adjustHiitParam('rounds', 1)"
                                            style="width: 32px; height: 32px; padding: 4px; margin: 0; font-size: 12px;">+</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 8px; margin-top: 10px;">
                            <button id="hiitPauseResumeBtn" class="btn btn-secondary" onclick="pauseResumeHiit()"
                                style="flex: 1; padding: 10px; font-size: 13px;">‚è∏Ô∏è Pause Exercise</button>
                            <button class="btn btn-danger" onclick="endHiitWorkout()"
                                style="flex: 1; padding: 10px; font-size: 13px;">üõë End Workout</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Exercises Section -->
            <div id="exercises" class="section">
                <h2>üìö Exercise Library</h2>
                <div class="form-group">
                    <input type="search" id="exerciseSearch" placeholder="üîç Search for an exercise..."
                        onkeyup="renderExerciseList()">
                </div>
                <button class="btn" onclick="openAddExerciseModal(true)" style="margin-bottom: 20px;">‚ûï Add New
                    Exercise</button>
                <div id="exerciseListContainer"></div>
            </div>

            <!-- Recommendation Section -->
            <div id="recommend" class="section">
                <h2 style="margin-bottom: 20px;">üí° Today's Recommendation</h2>
                <div id="recommendationContainer"></div>
            </div>

            <!-- Progress Section -->
            <div id="progress" class="section">
                <h2 style="margin-bottom: 20px;">üìà Your Progress</h2>
                
                <!-- Core Stats Grid -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalWorkouts">0</div>
                        <div class="stat-label">Total Workouts</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="thisWeek">0</div>
                        <div class="stat-label">This Week</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalVolume">0</div>
                        <div class="stat-label">Total Volume (lbs)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="streak">0</div>
                        <div class="stat-label">Day Streak</div>
                    </div>
                </div>

                <!-- Enhanced Stats Grid -->
                <div class="stats-grid" style="margin-top: 20px;">
                    <div class="stat-card">
                        <div class="stat-number" id="avgDuration">0:00</div>
                        <div class="stat-label">üí™ Avg Duration</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="caloriesBurned">0</div>
                        <div class="stat-label">üî• Est. Calories</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="thisMonth">0</div>
                        <div class="stat-label">üìÖ This Month</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="workoutFrequency">0</div>
                        <div class="stat-label">‚ö° Per Week Avg</div>
                    </div>
                </div>

                <!-- Additional Enhanced Stats -->
                <div class="stats-grid" style="margin-top: 20px;">
                    <div class="stat-card">
                        <div class="stat-number" id="personalRecordsCount">0</div>
                        <div class="stat-label">üèÜ PRs Set</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="consistencyScore">0%</div>
                        <div class="stat-label">üíé Consistency</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="heaviestLift">0</div>
                        <div class="stat-label">üîù Heaviest Lift (lbs)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="completionRate">0%</div>
                        <div class="stat-label">üíØ Completion Rate</div>
                    </div>
                </div>

                <!-- Calorie Tracker Setup -->
                <div class="info-box" style="margin-top: 20px;">
                    <p><strong>üî• Calorie Tracking:</strong> For more accurate calorie data, you can input calories from your fitness tracker (Apple Watch, Garmin, etc.)</p>
                    <button class="btn btn-secondary" onclick="openCalorieModal()" style="margin-top: 10px; width: auto; padding: 10px 20px;">‚öôÔ∏è Configure Calorie Tracking</button>
                </div>

                <div class="progress-chart">
                    <h3 class="chart-title">Workout Distribution</h3>
                    <div id="workoutDistribution"></div>
                </div>
                
                <div class="progress-chart">
                    <h3 class="chart-title">üéØ Most Trained Muscle Groups</h3>
                    <div id="muscleGroupDistribution"></div>
                </div>

                <div class="progress-chart">
                    <h3 class="chart-title">Volume Progress (Last 10 Workouts)</h3>
                    <div id="volumeProgress"></div>
                </div>

                <div class="progress-chart">
                    <h3 class="chart-title">üìà Volume Trend Analysis</h3>
                    <div id="volumeTrend"></div>
                </div>

                <div class="progress-chart">
                    <h3 class="chart-title">üé™ Exercise Variety Score</h3>
                    <div id="exerciseVariety"></div>
                </div>

                <div class="progress-chart">
                    <h3 class="chart-title">üìä Average Rest Between Workouts</h3>
                    <div id="restBetweenWorkouts"></div>
                </div>
            </div>
            <!-- History Section -->
            <div id="history" class="section">
                <h2 style="margin-bottom: 20px;">üìú Workout History</h2>
                <div class="info-box">
                    <p><strong>üí™ Pro Tip:</strong> Track your progress by reviewing past workouts. Try to beat your
                        previous weights and reps!</p>
                    <p style="margin-top: 8px;"><strong>üèÜ PR Badge:</strong> Look for the gold PR badge next to exercises where you've set a new personal record!</p>
                </div>
                <div id="historyContainer"></div>
            </div>

            <!-- Calendar Section -->
            <div id="calendar" class="section">
                <h2 style="margin-bottom: 20px;">üìÖ Training Calendar</h2>
                
                <div class="calendar-controls">
                    <button class="btn btn-secondary" onclick="changeMonth(-1)" style="width: auto; padding: 10px 15px; margin: 0;">‚óÄÔ∏è</button>
                    <h3 id="calendarMonthYear" style="margin: 0;">November 2024</h3>
                    <button class="btn btn-secondary" onclick="changeMonth(1)" style="width: auto; padding: 10px 15px; margin: 0;">‚ñ∂Ô∏è</button>
                </div>
                
                <div class="calendar-view-buttons" style="margin-bottom: 15px; display: flex; gap: 10px; justify-content: center;">
                    <button class="view-btn active" onclick="switchCalendarView('month')" id="monthViewBtn">Month</button>
                    <button class="view-btn" onclick="switchCalendarView('week')" id="weekViewBtn">Week</button>
                    <button class="view-btn" onclick="switchCalendarView('day')" id="dayViewBtn">Day</button>
                </div>
                
                <div id="calendarContent"></div>
                
                <div class="info-box" style="margin-top: 20px;">
                    <p><strong>Legend:</strong></p>
                    <p>üü¢ <strong>Green:</strong> Workout completed</p>
                    <p>üü° <strong>Yellow:</strong> Recommended rest day</p>
                    <p>‚ö™ <strong>White:</strong> No workout scheduled</p>
                </div>
            </div>

            <!-- Body Stats Section -->
            <div id="body-stats" class="section">
                <h2 style="margin-bottom: 20px;">üìä Body Measurements & Stats</h2>
                
                <div class="info-box">
                    <p><strong>Track Your Progress:</strong> Monitor your body composition and measurements to see how your training is affecting your physique.</p>
                </div>
                
                <div class="measurement-card">
                    <div class="measurement-header">
                        <div class="measurement-label">‚öñÔ∏è Body Weight</div>
                        <button class="edit-btn" onclick="openMeasurementModal('weight')">Update</button>
                    </div>
                    <div class="measurement-value" id="currentBodyWeight">-- lbs</div>
                    <div class="measurement-trend" id="weightTrend"></div>
                </div>
                
                <div class="measurement-card">
                    <div class="measurement-header">
                        <div class="measurement-label">üìè Height</div>
                        <button class="edit-btn" onclick="openMeasurementModal('height')">Update</button>
                    </div>
                    <div class="measurement-value" id="currentHeight">-- in</div>
                </div>
                
                <div class="measurement-card">
                    <div class="measurement-header">
                        <div class="measurement-label">üìâ Body Fat %</div>
                        <button class="edit-btn" onclick="openMeasurementModal('bodyFat')">Update</button>
                    </div>
                    <div class="measurement-value" id="currentBodyFat">-- %</div>
                    <div class="measurement-trend" id="bodyFatTrend"></div>
                </div>
                
                <div class="measurement-card">
                    <div class="measurement-header">
                        <div class="measurement-label">üí™ Biceps (Right)</div>
                        <button class="edit-btn" onclick="openMeasurementModal('bicepsR')">Update</button>
                    </div>
                    <div class="measurement-value" id="currentBicepsR">-- in</div>
                    <div class="measurement-trend" id="bicepsRTrend"></div>
                </div>
                
                <div class="measurement-card">
                    <div class="measurement-header">
                        <div class="measurement-label">üí™ Biceps (Left)</div>
                        <button class="edit-btn" onclick="openMeasurementModal('bicepsL')">Update</button>
                    </div>
                    <div class="measurement-value" id="currentBicepsL">-- in</div>
                    <div class="measurement-trend" id="bicepsLTrend"></div>
                </div>
                
                <div class="measurement-card">
                    <div class="measurement-header">
                        <div class="measurement-label">ü´Å Chest</div>
                        <button class="edit-btn" onclick="openMeasurementModal('chest')">Update</button>
                    </div>
                    <div class="measurement-value" id="currentChest">-- in</div>
                    <div class="measurement-trend" id="chestTrend"></div>
                </div>
                
                <div class="measurement-card">
                    <div class="measurement-header">
                        <div class="measurement-label">ü¶µ Waist</div>
                        <button class="edit-btn" onclick="openMeasurementModal('waist')">Update</button>
                    </div>
                    <div class="measurement-value" id="currentWaist">-- in</div>
                    <div class="measurement-trend" id="waistTrend"></div>
                </div>
                
                <div class="measurement-card">
                    <div class="measurement-header">
                        <div class="measurement-label">üçë Hips</div>
                        <button class="edit-btn" onclick="openMeasurementModal('hips')">Update</button>
                    </div>
                    <div class="measurement-value" id="currentHips">-- in</div>
                    <div class="measurement-trend" id="hipsTrend"></div>
                </div>
                
                <div class="measurement-card">
                    <div class="measurement-header">
                        <div class="measurement-label">ü¶µ Thigh (Right)</div>
                        <button class="edit-btn" onclick="openMeasurementModal('thighR')">Update</button>
                    </div>
                    <div class="measurement-value" id="currentThighR">-- in</div>
                    <div class="measurement-trend" id="thighRTrend"></div>
                </div>
                
                <div class="measurement-card">
                    <div class="measurement-header">
                        <div class="measurement-label">ü¶µ Thigh (Left)</div>
                        <button class="edit-btn" onclick="openMeasurementModal('thighL')">Update</button>
                    </div>
                    <div class="measurement-value" id="currentThighL">-- in</div>
                    <div class="measurement-trend" id="thighLTrend"></div>
                </div>
                
                <div class="measurement-card">
                    <div class="measurement-header">
                        <div class="measurement-label">ü¶ø Calves (Right)</div>
                        <button class="edit-btn" onclick="openMeasurementModal('calfR')">Update</button>
                    </div>
                    <div class="measurement-value" id="currentCalfR">-- in</div>
                    <div class="measurement-trend" id="calfRTrend"></div>
                </div>
                
                <div class="measurement-card">
                    <div class="measurement-header">
                        <div class="measurement-label">ü¶ø Calves (Left)</div>
                        <button class="edit-btn" onclick="openMeasurementModal('calfL')">Update</button>
                    </div>
                    <div class="measurement-value" id="currentCalfL">-- in</div>
                    <div class="measurement-trend" id="calfLTrend"></div>
                </div>
                
                <div class="progress-chart">
                    <h3 class="chart-title">üìà Weight Progress (Last 10 Entries)</h3>
                    <div id="weightProgressChart"></div>
                </div>
            </div>

            <!-- Share Workout Section -->
            <div id="share-workout" class="section">
                <h2 style="margin-bottom: 20px;">üîó Share Workout via QR Code</h2>
                
                <div class="info-box">
                    <p><strong>[SHARE] Share Your Workout:</strong> Generate a QR code containing your workout data. Your friend can scan it to instantly add the workout to their app!</p>
                </div>
                
                <div class="form-group">
                    <label>Select Workout to Share</label>
                    <select id="qrShareWorkoutSelect">
                        <option value="">-- Choose a workout --</option>
                    </select>
                </div>
                
                <button class="btn btn-success" onclick="generateWorkoutQR()" style="margin-bottom: 20px;">üì± Generate QR Code</button>
                
                <div id="qrCodeContainer" style="display: none; background: white; padding: 20px; border-radius: 10px; text-align: center; margin-bottom: 30px;">
                    <h3 style="color: #001f3f; margin-bottom: 15px;">Scan to Import Workout</h3>
                    <div id="qrCodeOutput" style="margin: 0 auto; display: inline-block;"></div>
                    <p style="margin-top: 15px; color: #666; font-size: 14px;">Have your friend scan this QR code with their device camera</p>
                </div>
                
                <div class="info-box" style="margin-top: 30px;">
                    <p style="font-size: 16px; font-weight: bold; margin-bottom: 10px;">üì∑ [SCAN] How to Scan a Workout QR Code</p>
                    <p>Scanning is now easier and more reliable than ever!</p>
                    <ol style="margin-top: 10px; margin-left: 20px; line-height: 1.8;">
                        <li>Open your phone's built-in <strong>Camera app</strong>.</li>
                        <li>Point it at the workout QR code.</li>
                        <li>Tap the link that appears on your screen.</li>
                        <li>The app will open and ask you to confirm the import.</li>
                    </ol>
                </div>
            </div>

            <!-- Settings Section -->
            <div id="settings" class="section">
                <h2 style="margin-bottom: 20px;">‚öôÔ∏è Settings & Data Management</h2>
                
                <div class="info-box" style="margin-top: 20px;">
                    <p><strong>üíæ [SAVE] Backup Your Data:</strong> Save all your workout history, custom exercises, custom workouts, and preferences to a file. This is useful for transferring data to another browser or device, or as a backup in case your browser's data is cleared.</p>
                    <p style="margin-top: 10px; font-size: 13px; color: #6c757d;">Exported file includes: workout history, custom exercises, custom workouts, preferences, and API key.</p>
                </div>
                <button class="btn btn-success" onclick="exportData()" style="margin-bottom: 30px;">üíæ Export All Data to File</button>
                
                <div class="info-box" style="margin-top: 20px; border-left-color: #8b0000;">
                    <p><strong>üì• [!] Restore from Backup:</strong> Import a previously saved backup file.</p>
                    <p style="margin-top: 10px; color: #8b0000;"><strong>Warning:</strong> This will replace ALL current data in the app with the data from the backup file. Your existing workouts, exercises, and history will be overwritten. This action cannot be undone!</p>
                    <p style="margin-top: 10px; font-size: 13px; color: #6c757d;">Tip: Export your current data first if you want to keep a copy before importing.</p>
                </div>
                 <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">
                <label for="importFile" class="btn btn-danger">üì• Import Data from Backup File</label>
                
                <!-- Color Customization Section -->
                <div style="margin-top: 40px; padding-top: 30px; border-top: 2px solid #8b7355;">
                    <h3 style="margin-bottom: 20px;">üé® Color Customization</h3>
                    
                    <div class="info-box">
                        <p><strong>Customize Your App Colors:</strong> Choose custom colors for different parts of the app to make it your own! Changes apply instantly.</p>
                    </div>
                    
                    <div style="display: grid; gap: 20px; margin-top: 20px;">
                        <!-- Primary Colors -->
                        <div class="color-setting-card">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <label style="font-weight: 600; font-size: 15px;">üåä Primary Color (Header/Buttons)</label>
                                <input type="color" id="primaryColor" value="#001f3f" onchange="updateColors()" style="width: 60px; height: 40px; border: 2px solid #ccc; border-radius: 5px; cursor: pointer;">
                            </div>
                            <small style="color: #6c757d;">Used for header background and main buttons</small>
                        </div>
                        
                        <div class="color-setting-card">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <label style="font-weight: 600; font-size: 15px;">‚ú® Accent Color (Text/Borders)</label>
                                <input type="color" id="accentColor" value="#d4af37" onchange="updateColors()" style="width: 60px; height: 40px; border: 2px solid #ccc; border-radius: 5px; cursor: pointer;">
                            </div>
                            <small style="color: #6c757d;">Used for header text and accent borders</small>
                        </div>
                        
                        <div class="color-setting-card">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <label style="font-weight: 600; font-size: 15px;">üìÑ Background Color</label>
                                <input type="color" id="backgroundColor" value="#f5f5dc" onchange="updateColors()" style="width: 60px; height: 40px; border: 2px solid #ccc; border-radius: 5px; cursor: pointer;">
                            </div>
                            <small style="color: #6c757d;">Main app background color</small>
                        </div>
                        
                        <div class="color-setting-card">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <label style="font-weight: 600; font-size: 15px;">üü¢ Success Color (Save/Confirm)</label>
                                <input type="color" id="successColor" value="#4a6741" onchange="updateColors()" style="width: 60px; height: 40px; border: 2px solid #ccc; border-radius: 5px; cursor: pointer;">
                            </div>
                            <small style="color: #6c757d;">Used for success buttons and positive actions</small>
                        </div>
                        
                        <div class="color-setting-card">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <label style="font-weight: 600; font-size: 15px;">üî¥ Danger Color (Delete)</label>
                                <input type="color" id="dangerColor" value="#8b0000" onchange="updateColors()" style="width: 60px; height: 40px; border: 2px solid #ccc; border-radius: 5px; cursor: pointer;">
                            </div>
                            <small style="color: #6c757d;">Used for delete buttons and warnings</small>
                        </div>
                        
                        <div class="color-setting-card">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <label style="font-weight: 600; font-size: 15px;">üü§ Card Background</label>
                                <input type="color" id="cardColor" value="#e8dcc4" onchange="updateColors()" style="width: 60px; height: 40px; border: 2px solid #ccc; border-radius: 5px; cursor: pointer;">
                            </div>
                            <small style="color: #6c757d;">Exercise cards and content boxes</small>
                        </div>
                        
                        <div class="color-setting-card">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <label style="font-weight: 600; font-size: 15px;">üìä Nav Bar Background</label>
                                <input type="color" id="navColor" value="#d9c7a5" onchange="updateColors()" style="width: 60px; height: 40px; border: 2px solid #ccc; border-radius: 5px; cursor: pointer;">
                            </div>
                            <small style="color: #6c757d;">Navigation bar background color</small>
                        </div>
                        
                        <div class="color-setting-card">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <label style="font-weight: 600; font-size: 15px;">üî§ Nav Text Color</label>
                                <input type="color" id="navTextColor" value="#3e3024" onchange="updateColors()" style="width: 60px; height: 40px; border: 2px solid #ccc; border-radius: 5px; cursor: pointer;">
                            </div>
                            <small style="color: #6c757d;">Text color for navigation buttons</small>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-top: 25px;">
                        <button class="btn btn-secondary" onclick="resetColors()" style="flex: 1;">üîÑ Reset to Default</button>
                        <button class="btn btn-success" onclick="saveColorPreset()" style="flex: 1;">üíæ Save as Preset</button>
                    </div>
                    
                    <!-- Preset Themes -->
                    <div style="margin-top: 25px;">
                        <h4 style="margin-bottom: 15px;">üé® Quick Themes</h4>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                            <button class="btn btn-secondary" onclick="applyTheme('default')" style="margin-top: 0; padding: 10px;">üèõÔ∏è Classic (Default)</button>
                            <button class="btn btn-secondary" onclick="applyTheme('kentucky')" style="margin-top: 0; padding: 10px;">üèÄ Wildcat</button>
                            <button class="btn btn-secondary" onclick="applyTheme('ocean')" style="margin-top: 0; padding: 10px;">üåä Ocean</button>
                            <button class="btn btn-secondary" onclick="applyTheme('forest')" style="margin-top: 0; padding: 10px;">üå≤ Forest Green</button>
                            <button class="btn btn-secondary" onclick="applyTheme('sunset')" style="margin-top: 0; padding: 10px;">üåÖ Sunset Orange</button>
                            <button class="btn btn-secondary" onclick="applyTheme('purple')" style="margin-top: 0; padding: 10px;">üíú Deep Purple</button>
                            <button class="btn btn-secondary" onclick="applyTheme('gympak')" style="margin-top: 0; padding: 10px;">üåô Dark Mode</button>
                            <button class="btn btn-secondary" onclick="applyTheme('crimson')" style="margin-top: 0; padding: 10px;">üî¥ Crimson Night</button>
                        </div>
                    </div>
                </div>
            </div>
    <script>
        // ==================== GLOBAL THEME VARIABLES ====================
        let currentCardTextColor = '#333'; // Default text color for cards

        // ==================== EXERCISE DATABASE (FROM WORKING FILE) ====================
        const exerciseDatabase = {
            
            // Exercises
            'Dumbbell Goblet Squat': { equipment: 'Dumbbell', instructions: 'Hold a dumbbell vertically at chest level. Stand with feet shoulder-width apart. Lower into a squat keeping chest up and knees tracking over toes. Push through heels to return.', sets: 3, reps: 12, weight: 25, image: ' Targets: Quads, Glutes, Core' },
            'Dumbbell Romanian Deadlift': { equipment: 'Dumbbells', instructions: 'Hold dumbbells in front of thighs. Hinge at hips, keeping back straight and slight bend in knees. Lower weights along legs until you feel hamstring stretch. Return to standing.', sets: 3, reps: 10, weight: 30, image: ' Targets: Hamstrings, Glutes, Lower Back' },
            'Dumbbell Lunges': { equipment: 'Dumbbells', instructions: 'Hold dumbbells at sides. Step forward into a lunge, lowering back knee toward ground. Front knee should stay behind toes. Push back to starting position. Alternate legs.', sets: 3, reps: 10, weight: 20, image: ' Targets: Quads, Glutes, Balance' },
            'Dumbbell Calf Raises': { equipment: 'Dumbbells', instructions: 'Hold dumbbells at sides. Stand on edge of a step or platform with heels hanging off. Rise up on toes as high as possible, then lower heels below step level.', sets: 3, reps: 15, weight: 25, image: ' Targets: Calves' },
            'Bodyweight Squats': { equipment: 'Bodyweight', instructions: 'Stand with feet shoulder-width apart, toes slightly pointed out. Keep chest up and core tight. Lower down by bending knees and pushing hips back as if sitting in a chair. Go as low as comfortable, ideally until thighs are parallel to ground. Push through heels to return to standing.', sets: 3, reps: 20, weight: 0, image: ' Targets: Quads, Glutes, Core' },
            'Bulgarian Split Squats': { equipment: 'Dumbbells, Bench', instructions: 'Place rear foot elevated on bench behind you. Hold dumbbells at sides. Lower front leg until thigh is parallel to ground, back knee drops toward floor. Push through front heel to return. Complete all reps then switch legs.', sets: 3, reps: 10, weight: 20, image: ' Targets: Quads, Glutes, Balance' },
            'Walking Lunges': { equipment: 'Dumbbells', instructions: 'Hold dumbbells at sides. Step forward into lunge with both knees at 90 degrees. Push off front foot and bring back leg forward into next lunge. Continue walking forward alternating legs each step.', sets: 3, reps: 20, weight: 20, image: ' Targets: Quads, Glutes, Coordination' },
            'Step-Ups': { equipment: 'Dumbbells, Box/Bench', instructions: 'Hold dumbbells at sides, stand facing box or bench. Step up with one foot, drive through heel to lift body onto box. Step down with control. Alternate legs or complete all reps on one side first.', sets: 3, reps: 12, weight: 20, image: ' Targets: Quads, Glutes, Functional Strength' },
            'Goblet Squats': { equipment: 'Dumbbell', instructions: 'Hold one dumbbell vertically at chest with both hands (like holding a goblet). Feet shoulder-width. Squat down keeping chest up, elbows track inside knees. Excellent for learning squat form.', sets: 3, reps: 15, weight: 30, image: ' Targets: Quads, Glutes, Core' },
            'Wall Sits': { equipment: 'Bodyweight', instructions: 'Lean back against wall. Slide down until thighs are parallel to floor, knees at 90 degrees. Hold position. Great for building quad endurance.', sets: 3, reps: 45, weight: 0, image: ' Targets: Quads, Endurance (time in seconds)' },
            'Jump Squats': { equipment: 'Bodyweight', instructions: 'Start in squat position. Explode up jumping as high as possible. Land softly and immediately descend into next squat. Builds explosive power.', sets: 3, reps: 12, weight: 0, image: ' Targets: Quads, Glutes, Power, Plyometrics' },
            'Incline Dumbbell Press': { equipment: 'Dumbbells, Incline Bench', instructions: 'Set bench to 30-45 degrees. Lie back with dumbbells at shoulder level. Press weights up and together, fully extending arms. Lower with control to chest level.', sets: 4, reps: 10, weight: 35, image: ' Targets: Upper Chest, Shoulders, Triceps' },
            'Flat Dumbbell Press': { equipment: 'Dumbbells, Bench', instructions: 'Lie on flat bench with dumbbells at chest level. Press weights straight up, bringing them together at top. Lower with control until elbows are at 90 degrees.', sets: 3, reps: 10, weight: 40, image: ' Targets: Middle Chest, Triceps' },
            'Incline Dumbbell Flyes': { equipment: 'Dumbbells, Incline Bench', instructions: 'Set bench to 30 degrees. Start with arms extended above chest, slight elbow bend. Lower weights out to sides in arc motion. Squeeze chest to bring weights back together.', sets: 3, reps: 12, weight: 20, image: ' Targets: Chest, Shoulders (stretch focused)' },
            'Dumbbell Pullover': { equipment: 'Dumbbell, Bench', instructions: 'Lie perpendicular on bench (upper back only). Hold one dumbbell with both hands above chest. Lower weight behind head in arc, feel chest and lat stretch. Pull back to start.', sets: 3, reps: 12, weight: 25, image: ' Targets: Chest, Lats, Serratus' },
            'Barbell Bench Press': { equipment: 'Barbell, Bench', instructions: 'Lie on flat bench, grip barbell slightly wider than shoulders. Lower bar to chest with control. Press bar up until arms fully extended. Keep feet flat on floor.', sets: 4, reps: 8, weight: 135, image: ' Targets: Chest, Shoulders, Triceps' },
            'Incline Barbell Bench Press': { equipment: 'Barbell, Incline Bench', instructions: 'Set bench to 30-45 degrees. Lie back, grip bar slightly wider than shoulders. Lower to upper chest. Press straight up. Targets upper chest.', sets: 4, reps: 8, weight: 115, image: ' Targets: Upper Chest, Shoulders, Triceps' },
            'Decline Dumbbell Press': { equipment: 'Dumbbells, Decline Bench', instructions: 'Set bench to 15-30 degree decline. Secure feet. Lie back with dumbbells at chest. Press weights up and together. Lower with control. Targets lower chest.', sets: 3, reps: 10, weight: 35, image: ' Targets: Lower Chest, Triceps' },
            'Decline Barbell Bench Press': { equipment: 'Barbell, Decline Bench', instructions: 'Set bench to decline, secure feet. Grip bar slightly wider than shoulders. Lower to lower chest. Press up to full extension. Emphasizes lower pecs.', sets: 3, reps: 10, weight: 125, image: ' Targets: Lower Chest, Triceps' },
            'Flat Dumbbell Flyes': { equipment: 'Dumbbells, Bench', instructions: 'Lie on flat bench with dumbbells above chest, slight elbow bend. Lower weights out to sides in wide arc until stretch in chest. Squeeze pecs to bring weights back together.', sets: 3, reps: 12, weight: 20, image: ' Targets: Chest (stretch and squeeze)' },
            'Decline Dumbbell Flyes': { equipment: 'Dumbbells, Decline Bench', instructions: 'Lie on decline bench. Hold dumbbells above chest with slight elbow bend. Lower in arc motion feeling stretch in lower chest. Squeeze to return.', sets: 3, reps: 12, weight: 20, image: ' Targets: Lower Chest' },
            'Diamond Push-Ups': { equipment: 'Bodyweight', instructions: 'Get in push-up position. Place hands close together forming diamond shape with index fingers and thumbs. Lower chest to hands. Push back up. Harder on triceps.', sets: 3, reps: 12, weight: 0, image: ' Targets: Triceps, Inner Chest, Core' },
            'Wide Push-Ups': { equipment: 'Bodyweight', instructions: 'Push-up position with hands placed wider than shoulders. Lower chest toward ground. Push back up. Wider grip emphasizes chest more.', sets: 3, reps: 15, weight: 0, image: ' Targets: Chest, Shoulders' },
            'Decline Push-Ups': { equipment: 'Bench/Box', instructions: 'Place feet elevated on bench, hands on ground. Perform push-ups. Elevation increases difficulty and emphasizes upper chest.', sets: 3, reps: 12, weight: 0, image: ' Targets: Upper Chest, Shoulders' },
            'Incline Push-Ups': { equipment: 'Bench/Box', instructions: 'Place hands on elevated bench, feet on ground. Perform push-ups. Easier variation, good for beginners or burnout sets.', sets: 3, reps: 20, weight: 0, image: ' Targets: Chest, Triceps (beginner friendly)' },
            'Chest Dips': { equipment: 'Dip Bar/Parallel Bars', instructions: 'Grip bars, body suspended. Lean forward slightly. Lower body by bending elbows until shoulders are below elbows. Push back up. Lean determines chest vs tricep focus.', sets: 3, reps: 10, weight: 0, image: ' Targets: Lower Chest, Triceps, Shoulders' },
            'Cable Crossover': { equipment: 'Cable Machine', instructions: 'Stand between cable towers, handles at shoulder height. Step forward, slight bend in elbows. Bring handles together in front of chest in arc motion. Control return.', sets: 3, reps: 12, weight: 20, image: ' Targets: Inner Chest, Definition' },
            'Push-Up': { equipment: 'Bodyweight', instructions: 'Start in plank position with hands shoulder-width apart. Lower body until chest nearly touches floor. Push back up to starting position. Keep core tight throughout.', sets: 3, reps: 15, weight: 0, image: ' Targets: Chest, Triceps, Core' },
            'Dumbbell Bent-Over Row': { equipment: 'Dumbbells', instructions: 'Hinge at hips with slight knee bend, back straight. Let dumbbells hang at arms length. Pull weights to sides of torso, squeezing shoulder blades together. Lower with control.', sets: 4, reps: 10, weight: 35, image: ' Targets: Mid Back, Lats, Biceps' },
            'Single-Arm Dumbbell Row': { equipment: 'Dumbbell, Bench', instructions: 'Place one knee and hand on bench. Hold dumbbell in free hand. Pull weight to hip, keeping elbow close to body. Lower with control. Complete all reps then switch sides.', sets: 3, reps: 12, weight: 40, image: ' Targets: Lats, Mid Back, Biceps' },
            'Dumbbell Bicep Curls': { equipment: 'Dumbbells', instructions: 'Stand with dumbbells at sides, palms forward. Curl weights up keeping elbows stationary at sides. Squeeze biceps at top. Lower with control, fully extending arms.', sets: 3, reps: 12, weight: 25, image: ' Targets: Biceps' },
            'Hammer Curls': { equipment: 'Dumbbells', instructions: 'Hold dumbbells with palms facing each other. Curl weights up keeping thumbs up throughout movement. Squeeze at top. Lower with control.', sets: 3, reps: 12, weight: 25, image: ' Targets: Biceps, Forearms' },
            'Barbell Bicep Curls': { equipment: 'Barbell', instructions: 'Stand holding barbell at arms length, palms up. Curl weight up keeping elbows stationary. Squeeze biceps at top. Lower with control.', sets: 3, reps: 10, weight: 60, image: ' Targets: Biceps' },
            'EZ-Bar Curls': { equipment: 'EZ Curl Bar', instructions: 'Hold EZ bar with angled grip (less wrist strain than straight bar). Curl up keeping elbows at sides. Squeeze biceps. Lower slowly.', sets: 3, reps: 12, weight: 50, image: ' Targets: Biceps (wrist-friendly)' },
            'Preacher Curls': { equipment: 'Dumbbells or Barbell, Preacher Bench', instructions: 'Sit at preacher bench, arms resting on pad. Curl weight up with strict form (pad prevents cheating). Lower to full extension.', sets: 3, reps: 12, weight: 20, image: ' Targets: Biceps (strict form)' },
            'Concentration Curls': { equipment: 'Dumbbell', instructions: 'Sit on bench, legs spread. Rest elbow against inner thigh. Curl dumbbell up to shoulder. Lower with control. Great isolation exercise.', sets: 3, reps: 12, weight: 20, image: ' Targets: Biceps Peak' },
            'Cable Bicep Curls': { equipment: 'Cable Machine', instructions: 'Stand at cable with low pulley and straight bar. Curl bar up keeping elbows stationary. Constant tension throughout movement.', sets: 3, reps: 15, weight: 50, image: ' Targets: Biceps (constant tension)' },
            'Zottman Curls': { equipment: 'Dumbbells', instructions: 'Curl dumbbells up with palms up (supinated). At top, rotate palms down (pronated). Lower slowly. Rotate palms up at bottom. Works biceps and forearms.', sets: 3, reps: 10, weight: 20, image: ' Targets: Biceps, Forearms' },
            'Incline Dumbbell Curls': { equipment: 'Dumbbells, Incline Bench', instructions: 'Lie back on incline bench (45 degrees). Let arms hang straight down. Curl weights up. Full stretch at bottom builds long head of bicep.', sets: 3, reps: 12, weight: 20, image: ' Targets: Biceps (stretch emphasis)' },
            'Dumbbell Shrugs': { equipment: 'Dumbbells', instructions: 'Stand holding dumbbells at sides. Elevate shoulders straight up toward ears as high as possible. Hold briefly at top. Lower with control. Keep arms straight throughout.', sets: 3, reps: 15, weight: 45, image: ' Targets: Traps, Upper Back' },
            'Pull-Ups': { equipment: 'Pull-Up Bar', instructions: 'Hang from bar with overhand grip (palms away), hands shoulder-width. Pull body up until chin clears bar. Lower with control to full extension. One of the best back exercises.', sets: 3, reps: 8, weight: 0, image: ' Targets: Lats, Biceps, Upper Back' },
            'Chin-Ups': { equipment: 'Pull-Up Bar', instructions: 'Hang from bar with underhand grip (palms facing you), hands shoulder-width. Pull up until chin over bar. Lower with control. Easier than pull-ups, more bicep activation.', sets: 3, reps: 10, weight: 0, image: ' Targets: Lats, Biceps, Forearms' },
            'Assisted Pull-Ups': { equipment: 'Resistance Band or Machine', instructions: 'Use resistance band under feet or assisted pull-up machine. Perform pull-up motion with assistance. Great for building up to unassisted pull-ups.', sets: 3, reps: 10, weight: 0, image: ' Targets: Lats, Biceps (progression exercise)' },
            'Negative Pull-Ups': { equipment: 'Pull-Up Bar', instructions: 'Jump or step up to top position of pull-up (chin over bar). Lower yourself down as slowly as possible (5-10 seconds). Step down and repeat. Builds strength for full pull-ups.', sets: 3, reps: 5, weight: 0, image: ' Targets: Lats, Back (eccentric strength)' },
            'Wide-Grip Pull-Ups': { equipment: 'Pull-Up Bar', instructions: 'Hang from bar with overhand grip wider than shoulders. Pull up bringing chest toward bar. Lower with control. Wider grip emphasizes lats more.', sets: 3, reps: 6, weight: 0, image: ' Targets: Lats, Upper Back' },
            'Barbell Bent-Over Row': { equipment: 'Barbell', instructions: 'Hinge at hips holding barbell, back straight, knees slightly bent. Pull bar to lower chest/upper abs, squeezing shoulder blades. Lower with control.', sets: 4, reps: 10, weight: 95, image: ' Targets: Mid Back, Lats, Biceps' },
            'Pendlay Row': { equipment: 'Barbell', instructions: 'Bend at hips until torso parallel to floor. Pull bar from floor to chest explosively. Return bar to floor between each rep. Builds explosive pulling power.', sets: 4, reps: 8, weight: 85, image: ' Targets: Back, Power, Explosiveness' },
            'T-Bar Row': { equipment: 'Barbell, V-Handle', instructions: 'Straddle bar with weight on one end. Grip V-handle or bar. Hinge at hips. Pull bar to chest squeezing back. Lower with control.', sets: 3, reps: 10, weight: 70, image: ' Targets: Mid Back, Lats, Thickness' },
            'Inverted Row': { equipment: 'Bar/Smith Machine', instructions: 'Lie under bar set at waist height. Grip bar with straight arms. Pull chest to bar. Lower with control. Like reverse push-up. Adjust height for difficulty.', sets: 3, reps: 12, weight: 0, image: ' Targets: Back, Biceps, Core' },
            'Lat Pulldown': { equipment: 'Cable Machine', instructions: 'Sit at lat pulldown machine. Grip bar wider than shoulders. Pull bar down to upper chest. Squeeze shoulder blades. Control weight back up.', sets: 3, reps: 12, weight: 80, image: ' Targets: Lats, Back Width' },
            'Close-Grip Lat Pulldown': { equipment: 'Cable Machine, V-Handle', instructions: 'Sit at pulldown. Use close-grip V-handle. Pull to upper chest. Squeeze lats and mid-back. Emphasizes thickness.', sets: 3, reps: 12, weight: 80, image: ' Targets: Lats, Mid Back, Thickness' },
            'Straight-Arm Pulldown': { equipment: 'Cable Machine', instructions: 'Stand at cable, arms extended overhead holding bar. Keep arms straight, pull bar down to thighs using lats. Control return. Great lat isolation.', sets: 3, reps: 15, weight: 40, image: ' Targets: Lats (isolation)' },
            'Face Pulls': { equipment: 'Cable Machine, Rope', instructions: 'Set cable at head height with rope attachment. Pull rope toward face, separating ends at face. Squeeze shoulder blades. Excellent for rear delts and posture.', sets: 3, reps: 15, weight: 30, image: ' Targets: Rear Delts, Upper Back, Posture' },
            'Seated Cable Row': { equipment: 'Cable Machine', instructions: 'Sit at cable row station. Feet on platform, knees slightly bent. Pull handle to torso, squeezing shoulder blades. Control return.', sets: 3, reps: 12, weight: 90, image: ' Targets: Mid Back, Lats, Biceps' },
            'Barbell Shrugs': { equipment: 'Barbell', instructions: 'Hold barbell at arms length in front of thighs. Elevate shoulders straight up as high as possible. Hold briefly. Lower with control. Builds traps.', sets: 3, reps: 15, weight: 135, image: ' Targets: Traps, Upper Back' },
            'Meadows Row': { equipment: 'Barbell', instructions: 'Stand perpendicular to barbell loaded on one end. Hinge at hips. Grab end of bar. Pull to hip rotating slightly. Great for lats and thickness.', sets: 3, reps: 10, weight: 60, image: ' Targets: Lats, Back Thickness' },
            'Dumbbell Shoulder Press': { equipment: 'Dumbbells', instructions: 'Sit or stand with dumbbells at shoulder level, palms forward. Press weights overhead until arms are fully extended. Lower with control back to shoulders.', sets: 3, reps: 10, weight: 30, image: ' Targets: Shoulders, Triceps' },
            'Dumbbell Lateral Raises': { equipment: 'Dumbbells', instructions: 'Stand with dumbbells at sides. Raise arms out to sides until parallel with floor, slight bend in elbows. Lead with elbows, not hands. Lower with control.', sets: 3, reps: 12, weight: 15, image: ' Targets: Side Delts' },
            'Dumbbell Front Raises': { equipment: 'Dumbbells', instructions: 'Hold dumbbells in front of thighs. Raise one or both weights forward and up to shoulder level, keeping arms straight. Lower with control.', sets: 3, reps: 12, weight: 15, image: ' Targets: Front Delts' },
            'Bent-Over Rear Delt Raises': { equipment: 'Dumbbells', instructions: 'Hinge at hips until torso is nearly parallel to floor. Let dumbbells hang down. Raise arms out to sides, squeezing shoulder blades. Lower with control.', sets: 3, reps: 15, weight: 12, image: ' Targets: Rear Delts, Upper Back' },
            'Overhead Tricep Extension': { equipment: 'Dumbbell', instructions: 'Hold one dumbbell with both hands overhead. Lower weight behind head by bending elbows. Keep upper arms stationary. Extend arms back to start position.', sets: 3, reps: 12, weight: 25, image: ' Targets: Triceps' },
            'Dumbbell Tricep Kickbacks': { equipment: 'Dumbbells', instructions: 'Hinge at hips, bring elbows to sides with 90-degree bend. Extend arms backward, straightening elbows fully. Squeeze triceps at top. Return to 90 degrees.', sets: 3, reps: 12, weight: 15, image: ' Targets: Triceps' },
            'Close-Grip Bench Press': { equipment: 'Barbell, Bench', instructions: 'Lie on bench. Grip bar with hands 8-12 inches apart. Lower to chest. Press up keeping elbows close to body. Excellent for triceps mass.', sets: 4, reps: 10, weight: 95, image: ' Targets: Triceps, Chest' },
            'Skull Crushers': { equipment: 'EZ Bar or Dumbbells, Bench', instructions: 'Lie on bench holding bar above chest. Lower bar toward forehead by bending elbows. Keep upper arms stationary. Extend back up. Also called lying tricep extension.', sets: 3, reps: 12, weight: 40, image: ' Targets: Triceps (long head)' },
            'Tricep Dips': { equipment: 'Parallel Bars or Bench', instructions: 'On parallel bars: grip bars, body suspended, stay upright. Lower by bending elbows. Push back up. Or use bench with feet extended forward.', sets: 3, reps: 12, weight: 0, image: ' Targets: Triceps, Chest, Shoulders' },
            'Cable Tricep Pushdown': { equipment: 'Cable Machine, Rope or Bar', instructions: 'Stand at cable with high pulley. Grip attachment with elbows at sides. Push down straightening arms. Squeeze triceps. Control return.', sets: 3, reps: 15, weight: 50, image: ' Targets: Triceps (isolation)' },
            'Overhead Cable Extension': { equipment: 'Cable Machine, Rope', instructions: 'Face away from cable with rope overhead. Extend arms forward and up. Keep upper arms stationary. Great for tricep stretch.', sets: 3, reps: 15, weight: 30, image: ' Targets: Triceps (long head)' },
            'Bench Dips': { equipment: 'Bench', instructions: 'Sit on edge of bench, hands gripping edge. Slide forward off bench, legs extended. Lower body by bending elbows. Push back up.', sets: 3, reps: 15, weight: 0, image: ' Targets: Triceps (bodyweight)' },
            'Dumbbell Russian Twists': { equipment: 'Dumbbell', instructions: 'Sit on floor, lean back slightly, lift feet. Hold dumbbell at chest. Rotate torso side to side, touching weight to floor on each side. Keep core tight.', sets: 3, reps: 20, weight: 15, image: ' Targets: Obliques, Core' },
            'Dumbbell Side Bends': { equipment: 'Dumbbell', instructions: 'Stand holding dumbbell in one hand. Bend sideways toward weight, lowering it down your leg. Return to upright. Complete all reps then switch sides.', sets: 3, reps: 15, weight: 25, image: ' Targets: Obliques' },
            'Plank': { equipment: 'Bodyweight', instructions: 'Support body on forearms and toes, body in straight line from head to heels. Keep core tight, don\'t let hips sag or pike up. Hold for time.', sets: 3, reps: 60, weight: 0, image: ' Targets: Core, Shoulders (time in seconds)' },
            'Mountain Climbers': { equipment: 'Bodyweight', instructions: 'Start in push-up position. Drive one knee toward chest, then quickly switch legs in running motion. Keep core tight and hips level.', sets: 3, reps: 20, weight: 0, image: ' Targets: Core, Cardio' },
            'Bicycle Crunches': { equipment: 'Bodyweight', instructions: 'Lie on back, hands behind head. Bring opposite elbow to opposite knee in cycling motion. Extend other leg out. Alternate sides in controlled manner.', sets: 3, reps: 20, weight: 0, image: ' Targets: Abs, Obliques' },
            'Kettlebell Swings': { equipment: 'Kettlebell (30lb)', instructions: 'Stand with feet shoulder-width apart, kettlebell between feet. Hinge at hips, swing kettlebell back between legs. Drive hips forward powerfully, swinging weight to shoulder height.', sets: 3, reps: 15, weight: 30, image: ' Targets: Glutes, Hamstrings, Core, Cardio' },
            'Kettlebell Goblet Squat': { equipment: 'Kettlebell (30lb)', instructions: 'Hold kettlebell at chest by horns. Squat down keeping chest up, elbows inside knees. Push through heels to stand.', sets: 3, reps: 12, weight: 30, image: ' Targets: Quads, Glutes, Core' },
            'Kettlebell Turkish Get-Up': { equipment: 'Kettlebell (30lb)', instructions: 'Lie on back holding kettlebell overhead. Complex movement transitioning from lying to standing while keeping weight overhead. Reverse to return. Excellent full-body exercise.', sets: 3, reps: 5, weight: 30, image: ' Targets: Full Body, Core, Stability' },
            'Kettlebell Halos': { equipment: 'Kettlebell (30lb)', instructions: 'Hold kettlebell upside down at chest level. Circle it around your head, keeping core tight. Alternate directions.', sets: 3, reps: 10, weight: 30, image: ' Targets: Shoulders, Core' },
            'Kettlebell Single-Arm Row': { equipment: 'Kettlebell (30lb)', instructions: 'Hinge at hips, place one hand on bench for support. Row kettlebell to hip with free hand. Keep back straight. Complete reps then switch sides.', sets: 3, reps: 12, weight: 30, image: ' Targets: Back, Biceps' },
            'Kettlebell Overhead Press': { equipment: 'Kettlebell (30lb)', instructions: 'Clean kettlebell to shoulder (rack position). Press overhead until arm is fully extended. Lower with control. Complete reps then switch arms.', sets: 3, reps: 10, weight: 30, image: ' Targets: Shoulders, Core' },
            'Recumbent Bike': { equipment: 'Recumbent Bike', instructions: 'Adjust seat so legs are nearly fully extended at bottom of pedal stroke. Maintain steady cadence. Monitor heart rate. Vary resistance for intensity.', sets: 1, reps: 20, weight: 0, image: ' Targets: Cardiovascular, Quads, Glutes (time in minutes)', exerciseType: 'cardio' },
            'Rowing Machine': { equipment: 'Rowing Machine', instructions: 'Strap in feet. Drive with legs, then pull handle to chest. Reverse: extend arms, hinge at hips, bend knees. Keep back straight throughout.', sets: 1, reps: 15, weight: 0, image: ' Targets: Full Body Cardio, Back, Legs (time in minutes)', exerciseType: 'cardio' },
            'Interval Sprints - Bike': { equipment: 'Recumbent Bike', instructions: '30 seconds high intensity, 90 seconds recovery. Repeat for workout duration. Great for fat burning and conditioning.', sets: 8, reps: 1, weight: 0, image: ' Targets: HIIT Cardio, Fat Burning (intervals)', exerciseType: 'cardio' },
            'Interval Sprints - Rowing': { equipment: 'Rowing Machine', instructions: '30 seconds maximum effort, 90 seconds easy pace. Focus on powerful drives during work intervals.', sets: 8, reps: 1, weight: 0, image: ' Targets: HIIT Full Body, Conditioning (intervals)', exerciseType: 'cardio' },
            'Treadmill Walking': { equipment: 'Treadmill', instructions: 'Walk on treadmill at a comfortable pace. Adjust speed and incline as needed. Monitor heart rate and maintain steady breathing. Great for warm-up, recovery, or low-impact cardio.', sets: 1, reps: 30, weight: 0, image: ' Targets: Cardiovascular, Legs (time in minutes)', exerciseType: 'cardio' },
            'Treadmill Running': { equipment: 'Treadmill', instructions: 'Run on treadmill at your target pace. Start with warm-up walk, gradually increase to running pace. Maintain good form with arms pumping naturally. Cool down properly. Track distance and time.', sets: 1, reps: 30, weight: 0, image: ' Targets: Cardiovascular, Endurance, Fat Burning (time in minutes)', exerciseType: 'cardio' },
            'Outdoor Walking': { equipment: 'None', instructions: 'Walk outdoors at a brisk pace. Maintain good posture with shoulders back, swing arms naturally, and breathe steadily. Track your route, distance, and time. Great for mental health and low-impact cardio.', sets: 1, reps: 30, weight: 0, image: ' Targets: Cardiovascular, Legs, Mental Health (time in minutes)', exerciseType: 'cardio' },
            'Outdoor Running': { equipment: 'Running Shoes', instructions: 'Run outdoors on your preferred route. Start with dynamic warm-up, maintain steady pace and good form. Land midfoot, keep cadence around 170-180 steps per minute. Finish with cool-down walk and stretching. Track distance and pace.', sets: 1, reps: 30, weight: 0, image: ' Targets: Cardiovascular, Endurance, Mental Toughness (time in minutes)', exerciseType: 'cardio' },
            'Indoor Cycling': { equipment: 'Stationary Bike', instructions: 'Cycle on stationary bike. Adjust seat height so knee has slight bend at bottom. Maintain steady cadence (80-100 RPM). Adjust resistance for intensity. Monitor heart rate and power output.', sets: 1, reps: 30, weight: 0, image: ' Targets: Cardiovascular, Quads, Glutes (time in minutes)', exerciseType: 'cardio' },
            'Outdoor Cycling': { equipment: 'Bicycle', instructions: 'Cycle outdoors on your route. Maintain proper cycling form with back flat and core engaged. Shift gears appropriately for terrain. Stay aware of traffic and surroundings. Track distance, time, and elevation.', sets: 1, reps: 30, weight: 0, image: ' Targets: Cardiovascular, Legs, Endurance (time in minutes)', exerciseType: 'cardio' }
        };

        // ==================== GLOBAL VARIABLES & DATABASES (CORRECTED) ====================
        let audioCtx; // For HIIT sounds
        
        // This is a snapshot of original exercises, taken BEFORE custom ones are loaded. Crucial for logic.
        const builtInExerciseNames = Object.keys(exerciseDatabase);

        // YouTube Shorts/Videos mapping for exercises
        const youtubeVideoLinks = {
            'Dumbbell Goblet Squat': 'https://www.youtube.com/results?search_query=goblet+squat+tutorial',
            'Dumbbell Romanian Deadlift': 'https://www.youtube.com/results?search_query=romanian+deadlift+tutorial',
            'Dumbbell Lunges': 'https://www.youtube.com/results?search_query=dumbbell+lunges+tutorial',
            'Dumbbell Calf Raises': 'https://www.youtube.com/results?search_query=dumbbell+calf+raises+tutorial',
            'Bodyweight Squats': 'https://www.youtube.com/results?search_query=proper+squat+form+tutorial',
            'Bulgarian Split Squats': 'https://www.youtube.com/results?search_query=bulgarian+split+squat+tutorial',
            'Walking Lunges': 'https://www.youtube.com/results?search_query=walking+lunges+tutorial',
            'Step-Ups': 'https://www.youtube.com/results?search_query=step+ups+exercise+tutorial',
            'Goblet Squats': 'https://www.youtube.com/results?search_query=goblet+squat+tutorial',
            'Wall Sits': 'https://www.youtube.com/results?search_query=wall+sit+tutorial',
            'Jump Squats': 'https://www.youtube.com/results?search_query=jump+squats+tutorial',
            'Incline Dumbbell Press': 'https://www.youtube.com/results?search_query=incline+dumbbell+press+tutorial',
            'Flat Dumbbell Press': 'https://www.youtube.com/results?search_query=dumbbell+bench+press+tutorial',
            'Decline Dumbbell Press': 'https://www.youtube.com/results?search_query=decline+dumbbell+press+tutorial',
            'Barbell Bench Press': 'https://www.youtube.com/results?search_query=barbell+bench+press+tutorial',
            'Incline Barbell Bench Press': 'https://www.youtube.com/results?search_query=incline+barbell+press+tutorial',
            'Decline Barbell Bench Press': 'https://www.youtube.com/results?search_query=decline+barbell+press+tutorial',
            'Incline Dumbbell Flyes': 'https://www.youtube.com/results?search_query=incline+dumbbell+fly+tutorial',
            'Flat Dumbbell Flyes': 'https://www.youtube.com/results?search_query=dumbbell+fly+tutorial',
            'Decline Dumbbell Flyes': 'https://www.youtube.com/results?search_query=decline+dumbbell+fly+tutorial',
            'Dumbbell Pullover': 'https://www.youtube.com/results?search_query=dumbbell+pullover+tutorial',
            'Diamond Push-Ups': 'https://www.youtube.com/results?search_query=diamond+push+ups+tutorial',
            'Wide Push-Ups': 'https://www.youtube.com/results?search_query=wide+grip+push+ups+tutorial',
            'Decline Push-Ups': 'https://www.youtube.com/results?search_query=decline+push+ups+tutorial',
            'Incline Push-Ups': 'https://www.youtube.com/results?search_query=incline+push+ups+tutorial',
            'Push-Up': 'https://www.youtube.com/results?search_query=proper+push+up+form+tutorial',
            'Chest Dips': 'https://www.youtube.com/results?search_query=chest+dips+tutorial',
            'Cable Crossover': 'https://www.youtube.com/results?search_query=cable+crossover+tutorial',
            'Dumbbell Bent-Over Row': 'https://www.youtube.com/results?search_query=dumbbell+bent+over+row+tutorial',
            'Single-Arm Dumbbell Row': 'https://www.youtube.com/results?search_query=single+arm+dumbbell+row+tutorial',
            'Pull-Ups': 'https://www.youtube.com/results?search_query=proper+pull+up+form+tutorial',
            'Chin-Ups': 'https://www.youtube.com/results?search_query=chin+up+tutorial',
            'Assisted Pull-Ups': 'https://www.youtube.com/results?search_query=assisted+pull+ups+tutorial',
            'Negative Pull-Ups': 'https://www.youtube.com/results?search_query=negative+pull+ups+tutorial',
            'Wide-Grip Pull-Ups': 'https://www.youtube.com/results?search_query=wide+grip+pull+ups+tutorial',
            'Barbell Bent-Over Row': 'https://www.youtube.com/results?search_query=barbell+bent+over+row+tutorial',
            'Pendlay Row': 'https://www.youtube.com/results?search_query=pendlay+row+tutorial',
            'T-Bar Row': 'https://www.youtube.com/results?search_query=t+bar+row+tutorial',
            'Inverted Row': 'https://www.youtube.com/results?search_query=inverted+row+tutorial',
            'Lat Pulldown': 'https://www.youtube.com/results?search_query=lat+pulldown+tutorial',
            'Close-Grip Lat Pulldown': 'https://www.youtube.com/results?search_query=close+grip+lat+pulldown+tutorial',
            'Straight-Arm Pulldown': 'https://www.youtube.com/results?search_query=straight+arm+pulldown+tutorial',
            'Face Pulls': 'https://www.youtube.com/results?search_query=face+pulls+tutorial',
            'Seated Cable Row': 'https://www.youtube.com/results?search_query=seated+cable+row+tutorial',
            'Dumbbell Bicep Curls': 'https://www.youtube.com/results?search_query=dumbbell+bicep+curls+tutorial',
            'Barbell Bicep Curls': 'https://www.youtube.com/results?search_query=barbell+bicep+curls+tutorial',
            'Hammer Curls': 'https://www.youtube.com/results?search_query=hammer+curls+tutorial',
            'EZ-Bar Curls': 'https://www.youtube.com/results?search_query=ez+bar+curls+tutorial',
            'Preacher Curls': 'https://www.youtube.com/results?search_query=preacher+curls+tutorial',
            'Concentration Curls': 'https://www.youtube.com/results?search_query=concentration+curls+tutorial',
            'Cable Bicep Curls': 'https://www.youtube.com/results?search_query=cable+bicep+curls+tutorial',
            'Zottman Curls': 'https://www.youtube.com/results?search_query=zottman+curls+tutorial',
            'Incline Dumbbell Curls': 'https://www.youtube.com/results?search_query=incline+dumbbell+curls+tutorial',
            'Dumbbell Shrugs': 'https://www.youtube.com/results?search_query=dumbbell+shrugs+tutorial',
            'Barbell Shrugs': 'https://www.youtube.com/results?search_query=barbell+shrugs+tutorial',
            'Meadows Row': 'https://www.youtube.com/results?search_query=meadows+row+tutorial',
            'Dumbbell Shoulder Press': 'https://www.youtube.com/results?search_query=dumbbell+shoulder+press+tutorial',
            'Dumbbell Lateral Raises': 'https://www.youtube.com/results?search_query=dumbbell+lateral+raises+tutorial',
            'Dumbbell Front Raises': 'https://www.youtube.com/results?search_query=dumbbell+front+raises+tutorial',
            'Bent-Over Rear Delt Raises': 'https://www.youtube.com/results?search_query=rear+delt+raises+tutorial',
            'Overhead Tricep Extension': 'https://www.youtube.com/results?search_query=overhead+tricep+extension+tutorial',
            'Dumbbell Tricep Kickbacks': 'https://www.youtube.com/results?search_query=tricep+kickbacks+tutorial',
            'Close-Grip Bench Press': 'https://www.youtube.com/results?search_query=close+grip+bench+press+tutorial',
            'Skull Crushers': 'https://www.youtube.com/results?search_query=skull+crushers+tutorial',
            'Tricep Dips': 'https://www.youtube.com/results?search_query=tricep+dips+tutorial',
            'Cable Tricep Pushdown': 'https://www.youtube.com/results?search_query=tricep+pushdown+tutorial',
            'Overhead Cable Extension': 'https://www.youtube.com/results?search_query=overhead+cable+extension+tutorial',
            'Bench Dips': 'https://www.youtube.com/results?search_query=bench+dips+tutorial',
            'Dumbbell Russian Twists': 'https://www.youtube.com/results?search_query=russian+twists+tutorial',
            'Dumbbell Side Bends': 'https://www.youtube.com/results?search_query=side+bends+tutorial',
            'Plank': 'https://www.youtube.com/results?search_query=proper+plank+form+tutorial',
            'Mountain Climbers': 'https://www.youtube.com/results?search_query=mountain+climbers+tutorial',
            'Bicycle Crunches': 'https://www.youtube.com/results?search_query=bicycle+crunches+tutorial',
            'Kettlebell Swings': 'https://www.youtube.com/results?search_query=kettlebell+swings+tutorial',
            'Kettlebell Goblet Squat': 'https://www.youtube.com/results?search_query=kettlebell+goblet+squat+tutorial',
            'Kettlebell Turkish Get-Up': 'https://www.youtube.com/results?search_query=kettlebell+turkish+get+up+tutorial',
            'Kettlebell Halos': 'https://www.youtube.com/results?search_query=kettlebell+halos+tutorial',
            'Kettlebell Single-Arm Row': 'https://www.youtube.com/results?search_query=kettlebell+single+arm+row+tutorial',
            'Kettlebell Overhead Press': 'https://www.youtube.com/results?search_query=kettlebell+overhead+press+tutorial',
            'Recumbent Bike': 'https://www.youtube.com/results?search_query=recumbent+bike+cardio+tutorial',
            'Rowing Machine': 'https://www.youtube.com/results?search_query=rowing+machine+tutorial',
            'Interval Sprints - Bike': 'https://www.youtube.com/results?search_query=hiit+interval+sprints+bike',
            'Interval Sprints - Rowing': 'https://www.youtube.com/results?search_query=hiit+rowing+machine+intervals'
        };
                // ==================== TAB BACKGROUND IMAGES ====================
         // ==================== TAB BACKGROUND IMAGES ====================
        const tabBackgrounds = {
            'workout': 'https://github.com/Bigmaxsg/Enhanced-Workout-App/blob/main/Workout%20Background%20Image.png?raw=true',
            'exercises': 'https://github.com/Bigmaxsg/Enhanced-Workout-App/blob/main/Workout%20Background%20Image.png?raw=true',
            'progress': 'https://github.com/Bigmaxsg/Enhanced-Workout-App/blob/main/Body%20Stats%20Image.png?raw=true',
            'body-stats': 'https://github.com/Bigmaxsg/Enhanced-Workout-App/blob/main/Body%20Stats%20Image.png?raw=true',
            'recommend': 'https://github.com/Bigmaxsg/Enhanced-Workout-App/blob/main/Workout%20Background%20Image.png?raw=true',
            'ai-coach': 'https://github.com/Bigmaxsg/Enhanced-Workout-App/blob/main/Workout%20Background%20Image.png?raw=true',
            'history': 'https://github.com/Bigmaxsg/Enhanced-Workout-App/blob/main/Workout%20Background%20Image.png?raw=true',
            'calendar': 'https://github.com/Bigmaxsg/Enhanced-Workout-App/blob/main/Workout%20Background%20Image.png?raw=true',
            'share-workout': 'https://github.com/Bigmaxsg/Enhanced-Workout-App/blob/main/Workout%20Background%20Image.png?raw=true',
            'settings': 'https://github.com/Bigmaxsg/Enhanced-Workout-App/blob/main/Workout%20Background%20Image.png?raw=true'
        };
        // This holds AI-generated or custom instructions. It MUST be declared here at the top.
        let exerciseDescriptions = JSON.parse(localStorage.getItem('exerciseDescriptions')) || {};

        // App State
        let currentWorkout = [];
        let workoutHistory = JSON.parse(localStorage.getItem('workoutHistory')) || [];
        let timerInterval = null;
        let timerSeconds = 0;
        let timerRunning = false;

        // Guided Workout State
        let guidedMode = false;
        let workoutStyle = 'traditional';
        let currentExerciseIndex = 0;
        let currentSetNumber = 1;
        let currentRound = 1;
        let completedSets = [];
        let restInterval = null;
        let restTimeRemaining = 0;

// HIIT State
        let hiitTimerInterval = null;
        let hiitTimeRemaining = 0;
        let hiitCurrentMode = 'work';
        let hiitCurrentRound = 1;
        let hiitCurrentExerciseIndex = 0;
        let hiitIsPaused = false;
        let hiitWorkoutParams = {
            workTime: 30,
            restTime: 15,
            totalRounds: 4
        };
        
        // Calendar & Body Stats State
        let currentCalendarDate = new Date();
        let currentCalendarView = 'month';

       
        // ==================== WORKOUT PROGRAMS ====================
        // Predefined Workout Programs
        const workoutPrograms = {
            leg: {
                name: ' Leg Day',
                exercises: ['Dumbbell Goblet Squat', 'Dumbbell Romanian Deadlift', 'Dumbbell Lunges', 'Dumbbell Calf Raises']
            },
            chest: {
                name: ' Chest Day',
                exercises: ['Incline Dumbbell Press', 'Flat Dumbbell Press', 'Incline Dumbbell Flyes', 'Dumbbell Pullover', 'Push-Up']
            },
            back: {
                name: ' Back & Biceps',
                exercises: ['Dumbbell Bent-Over Row', 'Single-Arm Dumbbell Row', 'Dumbbell Shrugs', 'Dumbbell Bicep Curls', 'Hammer Curls']
            },
            shoulders: {
                name: ' Shoulders & Triceps',
                exercises: ['Dumbbell Shoulder Press', 'Dumbbell Lateral Raises', 'Dumbbell Front Raises', 'Bent-Over Rear Delt Raises', 'Overhead Tricep Extension', 'Dumbbell Tricep Kickbacks']
            },
            abs: {
                name: ' Core/Abs Blast',
                exercises: ['Dumbbell Russian Twists', 'Dumbbell Side Bends', 'Plank', 'Mountain Climbers', 'Bicycle Crunches']
            },
            kettlebell: {
                name: ' Kettlebell Circuit',
                exercises: ['Kettlebell Swings', 'Kettlebell Goblet Squat', 'Kettlebell Single-Arm Row', 'Kettlebell Overhead Press', 'Kettlebell Halos']
            },
            cardio: {
                name: ' Cardio Day',
                exercises: ['Recumbent Bike', 'Rowing Machine', 'Interval Sprints - Bike', 'Interval Sprints - Rowing']
            },
            fullbody: {
                name: ' Full Body Power',
                exercises: ['Dumbbell Goblet Squat', 'Incline Dumbbell Press', 'Dumbbell Bent-Over Row', 'Dumbbell Shoulder Press', 'Dumbbell Romanian Deadlift', 'Plank']
            }
        };

        // ==================== NAVIGATION ====================
        function showSection(sectionId) {
            // *** THE FIX STARTS HERE ***
            // Before changing tabs, check if the currently active tab is the 'share-workout' tab.
            const currentActiveSection = document.querySelector('.section.active');
            if (currentActiveSection && currentActiveSection.id === 'share-workout') {
                // If we are navigating away from the share tab, reset its view.
                resetShareTabView();
            }
            // *** THE FIX ENDS HERE ***

            // Get current colors
            const colors = {
                primary: document.getElementById('primaryColor')?.value || '#001f3f',
                accent: document.getElementById('accentColor')?.value || '#d4af37',
                background: document.getElementById('backgroundColor')?.value || '#f5f5dc',
                nav: document.getElementById('navColor')?.value || '#d9c7a5',
                navText: document.getElementById('navTextColor')?.value || '#3e3024'
            };
            
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Remove active class and style from all nav buttons
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
                btn.style.background = 'none';
                btn.style.color = colors.navText;
                btn.style.borderBottom = 'none';
            });
            
            document.getElementById(sectionId).classList.add('active');
            
            // Find and activate the correct nav button by matching the onclick attribute
            document.querySelectorAll('.nav-btn').forEach(btn => {
                const onclickAttr = btn.getAttribute('onclick');
                if (onclickAttr && onclickAttr.includes(`'${sectionId}'`)) {
                    btn.classList.add('active');
                    // Apply active styling immediately
                    btn.style.background = colors.background;
                    btn.style.color = getContrastColor(colors.background);
                    btn.style.borderBottom = `3px solid ${colors.accent}`;
                }
            });
        
            const newBgUrl = tabBackgrounds[sectionId];
            if (newBgUrl) {
                applyBackgroundImage(newBgUrl);
            } else {
                document.body.style.backgroundImage = ''; 
                document.body.style.background = ''; 
                updateColors(); 
            }

            if (sectionId === 'exercises') {
                renderExerciseList();
            } else if (sectionId === 'recommend') {
                loadRecommendation();
            } else if (sectionId === 'progress') {
                updateProgress();
            } else if (sectionId === 'history') {
                loadHistory();
            } else if (sectionId === 'share-workout') {
                populateShareWorkoutSelect();
            } else if (sectionId === 'calendar') {
                renderCalendar();
            } else if (sectionId === 'body-stats') {
                loadBodyStats();
            }
        }
        function resetShareTabView() {
                    const qrContainer = document.getElementById('qrCodeContainer');
                    if (qrContainer) {
                        qrContainer.style.display = 'none';
                    }
        
                    const qrCodeOutput = document.getElementById('qrCodeOutput');
                    if (qrCodeOutput) {
                        qrCodeOutput.innerHTML = '';
                    }
        
                    const shareSelect = document.getElementById('qrShareWorkoutSelect');
                    if (shareSelect) {
                        shareSelect.value = '';
                    }
                }
        // ==================== TIMER FUNCTIONS ====================
        function startTimer() {
            // Check if it's for starting a HIIT workout
            const hiitMode = document.getElementById('hiitWorkoutMode');
            const hiitCountdownScreen = document.getElementById('hiitCountdownScreen');
            if (hiitMode && hiitMode.style.display === 'block' && hiitCountdownScreen.style.display !== 'none') {
                // If the HIIT countdown screen is visible, initialize audio context
                if (!audioCtx) {
                    try {
                        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                        console.log("Audio Context initialized by user for HIIT workout.");
                    } catch (e) {
                        console.log("Could not initialize audio context:", e);
                    }
                }
                if (audioCtx && audioCtx.state === 'suspended') {
                    audioCtx.resume();
                }
            }

            if (!timerRunning) {
                timerRunning = true;
                timerInterval = setInterval(() => {
                    timerSeconds++;
                    updateTimerDisplay();
                }, 1000);

                // Now, if HIIT is ready, start its specific countdown process
                if (hiitMode && hiitMode.style.display === 'block' && hiitCountdownScreen.style.display !== 'none') {
                    console.log("Starting HIIT countdown");
                    startHiitCountdown();
                }
            }
        }
        
        function pauseTimer() {
            timerRunning = false;
            clearInterval(timerInterval);
        }

        function resetTimer() {
            timerRunning = false;
            clearInterval(timerInterval);
            timerSeconds = 0;
            updateTimerDisplay();
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timerSeconds / 60);
            const seconds = timerSeconds % 60;
            document.getElementById('timerDisplay').textContent = 
                `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }
        
        // ==================== IMAGE HELPER FUNCTION (FROM WORKING FILE) ====================
        function getExerciseImageUrl(exerciseName) {
            const exerciseMapping = {
                'Dumbbell Goblet Squat': 'Dumbbell_Goblet_Squat',
                'Dumbbell Romanian Deadlift': 'Romanian_Deadlift',
                'Dumbbell Lunges': 'Dumbbell_Lunge',
                'Dumbbell Calf Raises': 'Standing_Calf_Raise',
                'Bodyweight Squats': 'Bodyweight_Squat',
                'Bulgarian Split Squats': 'Bulgarian_Split_Squat',
                'Walking Lunges': 'Walking_Lunge',
                'Step-Ups': 'Step_Up',
                'Goblet Squats': 'Goblet_Squat',
                'Wall Sits': 'Wall_Sit',
                'Jump Squats': 'Jump_Squat',
                'Incline Dumbbell Press': 'Incline_Dumbbell_Press',
                'Flat Dumbbell Press': 'Dumbbell_Bench_Press',
                'Decline Dumbbell Press': 'Decline_Dumbbell_Bench_Press',
                'Barbell Bench Press': 'Barbell_Bench_Press_-_Medium_Grip',
                'Incline Barbell Bench Press': 'Barbell_Incline_Bench_Press_-_Medium_Grip',
                'Decline Barbell Bench Press': 'Decline_Barbell_Bench_Press',
                'Incline Dumbbell Flyes': 'Incline_Dumbbell_Fly',
                'Flat Dumbbell Flyes': 'Dumbbell_Flyes',
                'Decline Dumbbell Flyes': 'Decline_Dumbbell_Fly',
                'Dumbbell Pullover': 'Dumbbell_Pullover',
                'Diamond Push-Ups': 'Close-Grip_Push-Up',
                'Wide Push-Ups': 'Wide-Grip_Push-Up',
                'Decline Push-Ups': 'Decline_Push-Up',
                'Incline Push-Ups': 'Incline_Push-Up',
                'Push-Up': 'Push-Ups',
                'Chest Dips': 'Chest_Dip',
                'Cable Crossover': 'Cable_Crossover',
                'Dumbbell Bent-Over Row': 'Bent_Over_Barbell_Row',
                'Single-Arm Dumbbell Row': 'One_Arm_Dumbbell_Row',
                'Pull-Ups': 'Pullups',
                'Chin-Ups': 'Chin_Up',
                'Assisted Pull-Ups': 'Assisted_Pull-Up',
                'Negative Pull-Ups': 'Pullups',
                'Wide-Grip Pull-Ups': 'Pullups',
                'Barbell Bent-Over Row': 'Bent_Over_Barbell_Row',
                'Pendlay Row': 'Pendlay_Row',
                'T-Bar Row': 'T-Bar_Row',
                'Inverted Row': 'Inverted_Row',
                'Lat Pulldown': 'Wide_Grip_Lat_Pulldown',
                'Close-Grip Lat Pulldown': 'Close_Grip_Front_Lat_Pulldown',
                'Straight-Arm Pulldown': 'Straight-Arm_Pulldown',
                'Face Pulls': 'Face_Pull',
                'Seated Cable Row': 'Seated_Cable_Row',
                'Meadows Row': 'Meadows_Row',
                'Dumbbell Bicep Curls': 'Dumbbell_Bicep_Curl',
                'Barbell Bicep Curls': 'Barbell_Curl',
                'Hammer Curls': 'Hammer_Curls',
                'EZ-Bar Curls': 'EZ-Bar_Curl',
                'Preacher Curls': 'Preacher_Curl',
                'Concentration Curls': 'Concentration_Curls',
                'Cable Bicep Curls': 'Cable_Curl',
                'Zottman Curls': 'Zottman_Curl',
                'Incline Dumbbell Curls': 'Alternate_Incline_Dumbbell_Curl',
                'Dumbbell Shrugs': 'Dumbbell_Shrug',
                'Barbell Shrugs': 'Barbell_Shrug',
                'Dumbbell Shoulder Press': 'Dumbbell_Shoulder_Press',
                'Dumbbell Lateral Raises': 'Dumbbell_Lateral_Raise',
                'Dumbbell Front Raises': 'Dumbbell_Front_Raise',
                'Bent-Over Rear Delt Raises': 'Bent_Over_Dumbbell_Rear_Delt_Raise',
                'Overhead Tricep Extension': 'Overhead_Triceps_Extension',
                'Dumbbell Tricep Kickbacks': 'Tricep_Kickback',
                'Close-Grip Bench Press': 'Close-Grip_Bench_Press',
                'Skull Crushers': 'Lying_Triceps_Extension',
                'Tricep Dips': 'Dips_-_Triceps_Version',
                'Cable Tricep Pushdown': 'Triceps_Pushdown',
                'Overhead Cable Extension': 'Overhead_Cable_Extension',
                'Bench Dips': 'Bench_Dip',
                'Dumbbell Russian Twists': 'Russian_Twist',
                'Dumbbell Side Bends': 'Side_Bend',
                'Plank': 'Plank',
                'Mountain Climbers': 'Mountain_Climber',
                'Bicycle Crunches': 'Bicycle_Crunch',
                'Kettlebell Swings': 'Kettlebell_Swing',
                'Kettlebell Goblet Squat': 'Kettlebell_Goblet_Squat',
                'Kettlebell Turkish Get-Up': 'Turkish_Get-Up',
                'Kettlebell Halos': 'Kettlebell_Halo',
                'Kettlebell Single-Arm Row': 'Kettlebell_One_Arm_Row',
                'Kettlebell Overhead Press': 'Kettlebell_Overhead_Press',
                'Recumbent Bike': 'Air_Bike',
                'Rowing Machine': 'Seated_Cable_Row',
                'Interval Sprints - Bike': 'Air_Bike',
                'Interval Sprints - Rowing': 'Seated_Cable_Row',
                'Treadmill Walking': 'Treadmill_Walk',
                'Treadmill Running': 'Treadmill_Run',
                'Outdoor Walking': 'Walking',
                'Outdoor Running': 'Running',
                'Indoor Cycling': 'Stationary_Bike',
                'Outdoor Cycling': 'Cycling'
            };

            const mappedName = exerciseMapping[exerciseName] || exerciseName.replace(/ /g, '_');
            return `https://raw.githubusercontent.com/yuhonas/free-exercise-db/main/exercises/${mappedName}/0.jpg`;
        }


        // ==================== WORKOUT LOADING ====================
        
        function loadSavedCustomWorkoutFromMain(workoutName) {
            const savedCustomWorkouts = JSON.parse(localStorage.getItem('customWorkouts')) || {};
            const savedWorkout = savedCustomWorkouts[workoutName];

            if (!savedWorkout) {
                alert('Workout not found!');
                return;
            }

            const container = document.getElementById('workoutContainer');

            // Check if it's a HIIT workout object
            if (typeof savedWorkout === 'object' && !Array.isArray(savedWorkout) && savedWorkout.workoutType === 'hiit') {
                currentWorkout = savedWorkout.exercises.map(ex => ({
                    name: ex.name,
                    ...(exerciseDatabase[ex.name] || {})
                }));
                hiitWorkoutParams = {
                    workTime: savedWorkout.workTime,
                    restTime: savedWorkout.restTime,
                    totalRounds: savedWorkout.rounds,
                };

                // Update pre-workout display values
                document.getElementById('hiitPreWorkWorkDisplay').textContent = hiitWorkoutParams.workTime;
                document.getElementById('hiitPreWorkRestDisplay').textContent = hiitWorkoutParams.restTime;
                document.getElementById('hiitPreWorkRoundsDisplay').textContent = hiitWorkoutParams.totalRounds;

                container.innerHTML = `
                    <div class="info-box">
                        <p><strong>${workoutName} (HIIT)</strong></p>
                        <p>Work: ${hiitWorkoutParams.workTime}s | Rest: ${hiitWorkoutParams.restTime}s | Rounds: ${hiitWorkoutParams.totalRounds}</p>
                    </div>
                    <div style="margin-bottom: 20px;">
                        ${currentWorkout.map(ex => `
                          <div class="exercise-card">
                            <div class="exercise-name">${ex.name}</div>
                            <div class="exercise-equipment">${ex.equipment || 'Bodyweight'}</div>
                             <button class="btn btn-secondary" onclick="showExerciseInfo('${ex.name.replace(/'/g, "\\'")}')" style="margin-top: 12px; padding: 8px; font-size: 14px;">
                                View Instructions
                             </button>
                          </div>
                        `).join('')}
                    </div>
                `;

                document.getElementById('hiitPreWorkoutAdjustments').style.display = 'block';
                document.getElementById('workoutModeSelection').style.display = 'block';
                return;
            }
            
            // If it's not a HIIT workout, it must be a strength workout (array)
            document.getElementById('hiitPreWorkoutAdjustments').style.display = 'none';

            currentWorkout = savedWorkout.map(ex => {
                const dbExercise = exerciseDatabase[ex.name] || JSON.parse(localStorage.getItem('customExercises') || '{}')[ex.name];
                return {
                    ...(dbExercise || {}),
                    name: ex.name,
                    weight: ex.weight,
                    sets: ex.sets,
                    reps: ex.reps,
                };
            });

            container.innerHTML = `
                <div class="info-box">
                    <p><strong>${workoutName}</strong></p>
                    <p>Your saved custom workout. Adjust as needed!</p>
                </div>
                <div style="margin-bottom: 20px;">
                    ${currentWorkout.map((ex, idx) => {
    const exerciseData = exerciseDatabase[ex.name] || {};
    const isCardio = exerciseData.exerciseType === "cardio";
    
    return `
        <div class="exercise-card">
            <div class="exercise-name">${ex.name}</div>
            ${isCardio ? `
                <div class="exercise-details">
                    <div class="detail-input">
                        <label>‚è±Ô∏è Duration (minutes)</label>
                        <input type="number" value="${ex.duration || 30}" onchange="updateExerciseValue(${idx}, 'duration', this.value)">
                    </div>
                    <div class="detail-input">
                        <label>üìè Distance</label>
                        <input type="number" step="0.1" value="${ex.distance || 0}" onchange="updateExerciseValue(${idx}, 'distance', this.value)">
                    </div>
                    <div class="detail-input">
                        <label>Unit</label>
                        <select onchange="updateExerciseValue(${idx}, 'distanceUnit', this.value)">
                            <option value="miles" ${ex.distanceUnit === 'miles' ? 'selected' : ''}>Miles</option>
                            <option value="km" ${ex.distanceUnit === 'km' ? 'selected' : ''}>Kilometers</option>
                        </select>
                    </div>
                </div>
            ` : `
                <div class="exercise-details">
                    <div class="detail-input">
                        <label>Weight (lbs)</label>
                        <input type="number" value="${ex.weight}" onchange="updateExerciseValue(${idx}, 'weight', this.value)">
                    </div>
                    <div class="detail-input">
                        <label>Sets</label>
                        <input type="number" value="${ex.sets}" onchange="updateExerciseValue(${idx}, 'sets', this.value)">
                    </div>
                    <div class="detail-input">
                        <label>Reps</label>
                        <input type="number" value="${ex.reps}" onchange="updateExerciseValue(${idx}, 'reps', this.value)">
                    </div>
                </div>
            `}
        </div>
    `;
}).join('')}
                </div>
            `;

            document.getElementById('workoutModeSelection').style.display = 'block';
        }
        
        function loadWorkout() {
            const workoutType = document.getElementById('workoutType').value;
            const container = document.getElementById('workoutContainer');

            if (!workoutType) {
                container.innerHTML = '';
                document.getElementById('workoutModeSelection').style.display = 'none';
                return;
            }
            if (workoutType === 'quick_cardio') {
                showQuickCardioLogger();
                return;
            }
            
            if (workoutType === 'interval_cardio') {
                showIntervalCardioBuilder();
                return;
            }
            if (workoutType === 'custom') {
                showCustomWorkoutBuilder();
                return;
            }

            if (workoutType === 'custom_hiit') {
                showCustomHiitBuilder();
                return;
            }

            // If it's a saved workout, call the new master function and stop.
            if (workoutType.startsWith('saved_')) {
                const workoutName = workoutType.substring(6);
                loadSavedCustomWorkoutFromMain(workoutName);
                return;
            }
            
            // This part now only runs for BUILT-IN workouts
            const program = workoutPrograms[workoutType];
            currentWorkout = program.exercises.map(name => ({ name, ...exerciseDatabase[name] }));

            const preferences = JSON.parse(localStorage.getItem('workoutPreferences') || '{}');
            const workoutKey = workoutType;
            if (preferences[workoutKey]) {
                currentWorkout.forEach(exercise => {
                    const savedPrefs = preferences[workoutKey][exercise.name];
                    if (savedPrefs) {
                        exercise.weight = savedPrefs.weight ?? exercise.weight;
                        exercise.sets = savedPrefs.sets ?? exercise.sets;
                        exercise.reps = savedPrefs.reps ?? exercise.reps;
                    }
                });
            }

            displayWorkout();
        }

        function displayWorkout(isHiit = false) {
            const container = document.getElementById('workoutContainer');
            let html = '<h3>Today\'s Workout</h3>';

            // If it's a HIIT workout, display it differently
            if (isHiit) {
                html += `<div class="info-box"><p><strong>HIIT Workout:</strong> ${hiitWorkoutParams.workTime}s Work / ${hiitWorkoutParams.restTime}s Rest / ${hiitWorkoutParams.totalRounds} Rounds</p></div>`;
                currentWorkout.forEach(exercise => {
                    html += `
                        <div class="exercise-card">
                            <div class="exercise-name">${exercise.name}</div>
                        </div>
                    `;
                });
                // Show the HIIT adjustment controls
                document.getElementById('hiitPreWorkoutAdjustments').style.display = 'block';
            } else {
                // This is the original logic for STRENGTH workouts
                currentWorkout.forEach((exercise, index) => {
                    html += `
                        <div class="exercise-card">
                            <div class="exercise-header">
                                <div class="exercise-name">${exercise.name}</div>
                            </div>
                            <div class="exercise-details">
                                <div class="detail-input">
                                    <label>Weight (lbs)</label>
                                    <input type="number" value="${exercise.weight || 0}" 
                                        onchange="updateExerciseValue(${index}, 'weight', this.value)">
                                </div>
                                <div class="detail-input">
                                    <label>Sets</label>
                                    <input type="number" value="${exercise.sets || 3}" 
                                        onchange="updateExerciseValue(${index}, 'sets', this.value)">
                                </div>
                                <div class="detail-input">
                                    <label>Reps</label>
                                    <input type="number" value="${exercise.reps || 12}" 
                                        onchange="updateExerciseValue(${index}, 'reps', this.value)">
                                </div>
                            </div>
                        </div>
                    `;
                });
                // Hide the HIIT adjustment controls for strength workouts
                document.getElementById('hiitPreWorkoutAdjustments').style.display = 'none';
            }
            
            container.innerHTML = html;
            document.getElementById('workoutModeSelection').style.display = 'block';
        }

        function updateExerciseValue(index, field, value) {
            currentWorkout[index][field] = parseInt(value);
            
            const workoutType = document.getElementById('workoutType').value;
            const preferences = JSON.parse(localStorage.getItem('workoutPreferences') || '{}');
            
            if (!preferences[workoutType]) {
                preferences[workoutType] = {};
            }
            
            const exerciseName = currentWorkout[index].name;
            if (!preferences[workoutType][exerciseName]) {
                preferences[workoutType][exerciseName] = {};
            }
            
            preferences[workoutType][exerciseName][field] = parseInt(value);
            localStorage.setItem('workoutPreferences', JSON.stringify(preferences));
        }
        
        // ==================== NEW MASTER DROPDOWN FUNCTION ====================
        function loadCustomWorkoutsIntoDropdown() {
            const savedCustomWorkouts = JSON.parse(localStorage.getItem('customWorkouts')) || {};
            const customWorkoutNames = Object.keys(savedCustomWorkouts);

            const dropdown = document.getElementById('workoutType');
            
            // First, remove any old custom workouts from the list to prevent duplicates
            const existingOptions = dropdown.querySelectorAll('option[data-custom="true"]');
            existingOptions.forEach(opt => opt.remove());

            // If there are custom workouts, add a separator for better UI
            if (customWorkoutNames.length > 0) {
                const separator = document.createElement('option');
                separator.disabled = true;
                separator.textContent = '--- My Custom Workouts ---';
                separator.setAttribute('data-custom', 'true'); // Mark it as a custom entry
                dropdown.appendChild(separator);
            }

            // Loop through each saved workout and add it to the dropdown
            customWorkoutNames.sort().forEach(name => {
                const workout = savedCustomWorkouts[name];
                const option = document.createElement('option');
                
                // This logic correctly identifies if the workout is Strength (an array) or HIIT (an object)
                const isHiit = typeof workout === 'object' && !Array.isArray(workout) && workout.workoutType === 'hiit';
                
                option.value = 'saved_' + name; // The value used to load the workout
                // Display a helpful label with an icon
                option.textContent = isHiit ? `‚ö° ${name} (HIIT)` : `üèãÔ∏è ${name} (Strength)`;
                option.setAttribute('data-custom', 'true'); // Mark it as a custom entry
                dropdown.appendChild(option);
            });
            
            // Also populate the management dropdown
            populateManageCustomWorkoutsDropdown();
        }
        
        // ==================== CUSTOM WORKOUT MANAGEMENT ====================
        function populateManageCustomWorkoutsDropdown() {
            const savedCustomWorkouts = JSON.parse(localStorage.getItem('customWorkouts')) || {};
            const customWorkoutNames = Object.keys(savedCustomWorkouts);
            
            const manageDropdown = document.getElementById('manageCustomWorkoutSelect');
            const manageSection = document.getElementById('manageCustomWorkoutsSection');
            
            if (!manageDropdown) return;
            
            // Clear existing options except the first one
            manageDropdown.innerHTML = '<option value="">-- Select a Custom Workout --</option>';
            
            // Show/hide the management section based on whether custom workouts exist
            if (customWorkoutNames.length > 0) {
                manageSection.style.display = 'block';
                
                // Add all custom workouts to the management dropdown
                customWorkoutNames.sort().forEach(name => {
                    const workout = savedCustomWorkouts[name];
                    const option = document.createElement('option');
                    const isHiit = typeof workout === 'object' && !Array.isArray(workout) && workout.workoutType === 'hiit';
                    
                    option.value = name;
                    option.textContent = isHiit ? `‚ö° ${name} (HIIT)` : `üèãÔ∏è ${name} (Strength)`;
                    manageDropdown.appendChild(option);
                });
            } else {
                manageSection.style.display = 'none';
            }
        }
        
        function editCustomWorkout() {
            const manageDropdown = document.getElementById('manageCustomWorkoutSelect');
            const selectedWorkoutName = manageDropdown.value;
            
            if (!selectedWorkoutName) {
                alert('Please select a workout to edit.');
                return;
            }
            
            const savedCustomWorkouts = JSON.parse(localStorage.getItem('customWorkouts')) || {};
            const workout = savedCustomWorkouts[selectedWorkoutName];
            
            if (!workout) {
                alert('Workout not found.');
                return;
            }
            
            // Determine if it's a HIIT or Strength workout
            const isHiit = typeof workout === 'object' && !Array.isArray(workout) && workout.workoutType === 'hiit';
            
            if (isHiit) {
                // Load HIIT builder with this workout
                document.getElementById('workoutType').value = 'custom_hiit';
                showCustomHiitBuilder();
                
                // Populate with existing data
                currentWorkout = [...workout.exercises];
                hiitWorkoutParams = { ...workout.hiitParams };
                
                // Update the display
                updateHiitExerciseList();
                document.getElementById('hiitWorkTime').value = hiitWorkoutParams.workTime;
                document.getElementById('hiitRestTime').value = hiitWorkoutParams.restTime;
                document.getElementById('hiitRounds').value = hiitWorkoutParams.totalRounds;
                
                // Pre-fill the workout name
                setTimeout(() => {
                    const nameInput = document.getElementById('customHiitWorkoutName');
                    if (nameInput) nameInput.value = selectedWorkoutName;
                }, 100);
            } else {
                // Load Strength builder with this workout
                document.getElementById('workoutType').value = 'custom';
                showCustomWorkoutBuilder();
                
                // Populate with existing data
                currentWorkout = JSON.parse(JSON.stringify(workout));
                
                // Update the display
                updateCustomExerciseList();
                
                // Pre-fill the workout name
                setTimeout(() => {
                    const nameInput = document.getElementById('customWorkoutName');
                    if (nameInput) nameInput.value = selectedWorkoutName;
                }, 100);
            }
            
            // Clear the management dropdown selection
            manageDropdown.value = '';
        }
        
        function deleteCustomWorkout() {
            const manageDropdown = document.getElementById('manageCustomWorkoutSelect');
            const selectedWorkoutName = manageDropdown.value;
            
            if (!selectedWorkoutName) {
                alert('Please select a workout to delete.');
                return;
            }
            
            if (!confirm(`Are you sure you want to delete "${selectedWorkoutName}"? This cannot be undone.`)) {
                return;
            }
            
            // Remove from localStorage
            const savedCustomWorkouts = JSON.parse(localStorage.getItem('customWorkouts')) || {};
            delete savedCustomWorkouts[selectedWorkoutName];
            localStorage.setItem('customWorkouts', JSON.stringify(savedCustomWorkouts));
            
            // Refresh both dropdowns
            loadCustomWorkoutsIntoDropdown();
            
            // Clear selection
            manageDropdown.value = '';
            
            alert(`"${selectedWorkoutName}" has been deleted.`);
        }

        // ==================== CUSTOM WORKOUT BUILDER ====================
        function showCustomWorkoutBuilder() {
            const container = document.getElementById('workoutContainer');
            currentWorkout = [];
            
            let html = `
                <h3>Build Your Custom Workout</h3>
                <div id="customExerciseList"></div>
                <button class="add-exercise-btn" onclick="addExerciseToCustomWorkout()">
                    ‚ûï Add Exercise
                </button>
                <div style="margin-top: 20px;">
                    <input type="text" id="customWorkoutName" placeholder="Enter workout name (optional)" 
                        style="margin-bottom: 10px;">
                    <button class="btn btn-success" onclick="saveCustomWorkout()">
                        üíæ Save This Workout
                    </button>
                </div>
                <div style="margin-top: 10px;">
                    <select id="loadCustomWorkoutSelect" onchange="loadSavedCustomWorkout()" style="margin-bottom: 10px;">
                        <option value="">-- Load Saved Workout --</option>
                    </select>
                </div>
            `;
            
            container.innerHTML = html;
            populateLoadCustomWorkoutSelect();
            document.getElementById('workoutModeSelection').style.display = 'block';
            document.getElementById('hiitPreWorkoutAdjustments').style.display = 'none';
        }
        
        function updateCustomExerciseList() {
            const exerciseListDiv = document.getElementById('customExerciseList');
            if (!exerciseListDiv) return;
            
            let html = '';
            currentWorkout.forEach((exercise, index) => {
                html += `
                    <div class="exercise-card">
                        <div class="exercise-header">
                            <div class="exercise-name">${exercise.name}</div>
                            <button class="delete-btn" onclick="removeExerciseFromCustom(${index})">‚úñ</button>
                        </div>
                        <div class="exercise-details">
                            <div class="detail-input">
                                <label>Weight (lbs)</label>
                                <input type="number" value="${exercise.weight || 0}" 
                                    onchange="updateCustomExercise(${index}, 'weight', this.value)">
                            </div>
                            <div class="detail-input">
                                <label>Sets</label>
                                <input type="number" value="${exercise.sets || 3}" 
                                    onchange="updateCustomExercise(${index}, 'sets', this.value)">
                            </div>
                            <div class="detail-input">
                                <label>Reps</label>
                                <input type="number" value="${exercise.reps || 12}" 
                                    onchange="updateCustomExercise(${index}, 'reps', this.value)">
                            </div>
                        </div>
                    </div>
                `;
            });
            exerciseListDiv.innerHTML = html;
        }

        function removeExerciseFromCustom(index) {
            currentWorkout.splice(index, 1);
            updateCustomExerciseList();
        }

        function addExerciseToCustomWorkout() {
            const exerciseList = Object.keys(exerciseDatabase);
            const customExercises = JSON.parse(localStorage.getItem('customExercises') || '{}');
            const allExercises = [...exerciseList, ...Object.keys(customExercises)].sort();
            
            const lastUsedValues = JSON.parse(localStorage.getItem('lastUsedExerciseValues') || '{}');
            
            const exerciseSelect = document.createElement('select');
            exerciseSelect.className = 'exercise-select';
            let options = '<option value="">-- Select Exercise --</option>';
            allExercises.forEach(ex => {
                options += `<option value="${ex}">${ex}</option>`;
            });
            exerciseSelect.innerHTML = options;
            
            const index = currentWorkout.length;
            currentWorkout.push({ name: '', weight: 25, sets: 3, reps: 12 });
            
            exerciseSelect.onchange = function() {
                const selectedExercise = this.value;
                if (selectedExercise) {
                    const exerciseData = exerciseDatabase[selectedExercise] || customExercises[selectedExercise];
                    
                    let weight, sets, reps;
                    if (lastUsedValues[selectedExercise]) {
                        weight = lastUsedValues[selectedExercise].weight;
                        sets = lastUsedValues[selectedExercise].sets;
                        reps = lastUsedValues[selectedExercise].reps;
                    } else {
                        weight = exerciseData.defaultWeight || 25;
                        sets = exerciseData.defaultSets || 3;
                        reps = exerciseData.defaultReps || 12;
                    }
                    
                    currentWorkout[index] = {
                        name: selectedExercise,
                        weight: weight,
                        sets: sets,
                        reps: reps
                    };
                    updateCustomExerciseDisplay(index);
                }
            };
            
            const listContainer = document.getElementById('customExerciseList');
            const exerciseDiv = document.createElement('div');
            exerciseDiv.className = 'exercise-card';
            exerciseDiv.id = `custom-exercise-${index}`;
            exerciseDiv.appendChild(exerciseSelect);
            
            listContainer.appendChild(exerciseDiv);
        }

        function updateCustomExerciseDisplay(index) {
            const exercise = currentWorkout[index];
            const exerciseDiv = document.getElementById(`custom-exercise-${index}`);
            
            exerciseDiv.innerHTML = `
                <div class="exercise-header">
                    <div class="exercise-name">${exercise.name}</div>
                    <button class="delete-btn" onclick="removeCustomExercise(${index})">üóëÔ∏è</button>
                </div>
                <div class="exercise-details">
                    <div class="detail-input">
                        <label>Weight (lbs)</label>
                        <input type="number" value="${exercise.weight}" 
                            onchange="updateCustomExerciseValue(${index}, 'weight', this.value)">
                    </div>
                    <div class="detail-input">
                        <label>Sets</label>
                        <input type="number" value="${exercise.sets}" 
                            onchange="updateCustomExerciseValue(${index}, 'sets', this.value)">
                    </div>
                    <div class="detail-input">
                        <label>Reps</label>
                        <input type="number" value="${exercise.reps}" 
                            onchange="updateCustomExerciseValue(${index}, 'reps', this.value)">
                    </div>
                </div>
            `;
        }

        function updateCustomExerciseValue(index, field, value) {
            currentWorkout[index][field] = parseInt(value);
            
            const exerciseName = currentWorkout[index].name;
            const lastUsedValues = JSON.parse(localStorage.getItem('lastUsedExerciseValues') || '{}');
            
            if (!lastUsedValues[exerciseName]) {
                lastUsedValues[exerciseName] = {};
            }
            lastUsedValues[exerciseName][field] = parseInt(value);
            
            localStorage.setItem('lastUsedExerciseValues', JSON.stringify(lastUsedValues));
        }

        function removeCustomExercise(index) {
            currentWorkout.splice(index, 1);
            
            // Clear the list container
            const listContainer = document.getElementById('customExerciseList');
            listContainer.innerHTML = '';
            
            // Rebuild all exercises with correct indices
            currentWorkout.forEach((ex, i) => {
                if (ex.name) {
                    const exerciseDiv = document.createElement('div');
                    exerciseDiv.className = 'exercise-card';
                    exerciseDiv.id = `custom-exercise-${i}`;
                    listContainer.appendChild(exerciseDiv);
                    updateCustomExerciseDisplay(i);
                }
            });
        }

        function saveCustomWorkout() {
            if (currentWorkout.length === 0 || !currentWorkout[0].name) {
                alert('Please add at least one exercise to your workout!');
                return;
            }
            
            const workoutName = document.getElementById('customWorkoutName').value || 
                `Custom Workout ${new Date().toLocaleDateString()}`;
            
            const customWorkouts = JSON.parse(localStorage.getItem('customWorkouts') || '{}');
            customWorkouts[workoutName] = JSON.parse(JSON.stringify(currentWorkout));
            localStorage.setItem('customWorkouts', JSON.stringify(customWorkouts));
            
            alert(`Workout "${workoutName}" saved successfully!`);
            populateLoadCustomWorkoutSelect();
            populateShareWorkoutSelect();
            loadCustomWorkoutsIntoDropdown();
        }

        function populateLoadCustomWorkoutSelect() {
            const select = document.getElementById('loadCustomWorkoutSelect');
            if (!select) return;
            
            const customWorkouts = JSON.parse(localStorage.getItem('customWorkouts') || '{}');
            let html = '<option value="">-- Load Saved Workout --</option>';
            
            Object.keys(customWorkouts).forEach(name => {
                const workout = customWorkouts[name];
                if (Array.isArray(workout)) {
                    html += `<option value="${name}">${name}</option>`;
                }
            });
            
            select.innerHTML = html;
        }

        function loadSavedCustomWorkout() {
            const select = document.getElementById('loadCustomWorkoutSelect');
            const workoutName = select.value;
            
            if (!workoutName) return;
            
            const customWorkouts = JSON.parse(localStorage.getItem('customWorkouts') || '{}');
            currentWorkout = JSON.parse(JSON.stringify(customWorkouts[workoutName]));
            
            const listContainer = document.getElementById('customExerciseList');
            listContainer.innerHTML = '';
            
            currentWorkout.forEach((exercise, index) => {
                const exerciseDiv = document.createElement('div');
                exerciseDiv.className = 'exercise-card';
                exerciseDiv.id = `custom-exercise-${index}`;
                listContainer.appendChild(exerciseDiv);
                updateCustomExerciseDisplay(index);
            });
            
            document.getElementById('customWorkoutName').value = workoutName;
        }

        // ==================== CUSTOM HIIT BUILDER ====================
        function showCustomHiitBuilder() {
            const container = document.getElementById('workoutContainer');
            currentWorkout = [];
            
            let html = `
                <h3>Build Your Custom HIIT Workout</h3>
                <div class="info-box">
                    <p><strong>HIIT Style:</strong> Select bodyweight or cardio exercises. You'll perform each for timed intervals with rest periods between.</p>
                </div>
                <div id="customHiitExerciseList"></div>
                <button class="add-exercise-btn" onclick="addExerciseToCustomHiit()">
                    ‚ûï Add Exercise
                </button>
                <div style="margin-top: 20px;">
                    <input type="text" id="customHiitWorkoutName" placeholder="Enter workout name (optional)" 
                        style="margin-bottom: 10px;">
                    <button class="btn btn-success" onclick="saveCustomHiitWorkout()">
                        üíæ Save This HIIT Workout
                    </button>
                </div>
                <div style="margin-top: 10px;">
                    <select id="loadCustomHiitWorkoutSelect" onchange="loadSavedCustomHiitWorkout()" style="margin-bottom: 10px;">
                        <option value="">-- Load Saved HIIT Workout --</option>
                    </select>
                </div>
            `;
            
            container.innerHTML = html;
            populateLoadCustomHiitWorkoutSelect();
            document.getElementById('workoutModeSelection').style.display = 'block';
            document.getElementById('hiitPreWorkoutAdjustments').style.display = 'block';
        }

        function addExerciseToCustomHiit() {
            // Get ALL exercises from database AND custom exercises
            const allExercises = {
                ...exerciseDatabase,
                ...JSON.parse(localStorage.getItem('customExercises') || '{}')
            };
            
            const hiitExercises = Object.keys(allExercises).sort();
            
            const exerciseSelect = document.createElement('select');
            exerciseSelect.className = 'exercise-select';
            let options = '<option value="">-- Select Exercise --</option>';
            hiitExercises.forEach(ex => {
                options += `<option value="${ex}">${ex}</option>`;
            });
            exerciseSelect.innerHTML = options;
            
            const index = currentWorkout.length;
            currentWorkout.push({ name: '', weight: 0, sets: 1, reps: 1 });
            
            exerciseSelect.onchange = function() {
                const selectedExercise = this.value;
                if (selectedExercise) {
                    currentWorkout[index] = {
                        name: selectedExercise,
                        weight: 0,
                        sets: 1,
                        reps: 1
                    };
                    updateCustomHiitExerciseDisplay(index);
                }
            };
            
            const listContainer = document.getElementById('customHiitExerciseList');
            const exerciseDiv = document.createElement('div');
            exerciseDiv.className = 'exercise-card';
            exerciseDiv.id = `custom-hiit-exercise-${index}`;
            exerciseDiv.appendChild(exerciseSelect);
            
            listContainer.appendChild(exerciseDiv);
        }

        function updateCustomHiitExerciseDisplay(index) {
            const exercise = currentWorkout[index];
            const exerciseDiv = document.getElementById(`custom-hiit-exercise-${index}`);
            
            exerciseDiv.innerHTML = `
                <div class="exercise-header">
                    <div class="exercise-name">${exercise.name}</div>
                    <button class="delete-btn" onclick="removeCustomHiitExercise(${index})">üóëÔ∏è</button>
                </div>
                <p style="font-size: 13px; color: #6c757d; margin-top: 5px;">
                    Work/rest intervals will be set before starting the workout
                </p>
            `;
        }

        function removeCustomHiitExercise(index) {
            currentWorkout.splice(index, 1);
            showCustomHiitBuilder();
            
            currentWorkout.forEach((ex, i) => {
                if (ex.name) {
                    const exerciseDiv = document.getElementById(`custom-hiit-exercise-${i}`);
                    if (exerciseDiv) {
                        updateCustomHiitExerciseDisplay(i);
                    }
                }
            });
        }

        function saveCustomHiitWorkout() {
            if (currentWorkout.length === 0 || !currentWorkout[0].name) {
                alert('Please add at least one exercise to your HIIT workout!');
                return;
            }
            
            const workoutName = document.getElementById('customHiitWorkoutName').value || 
                `Custom HIIT ${new Date().toLocaleDateString()}`;
            
            const customWorkouts = JSON.parse(localStorage.getItem('customWorkouts') || '{}');
            customWorkouts[workoutName] = JSON.parse(JSON.stringify(currentWorkout));
            localStorage.setItem('customWorkouts', JSON.stringify(customWorkouts));
            
            alert(`HIIT Workout "${workoutName}" saved successfully!`);
            populateLoadCustomHiitWorkoutSelect();
            populateShareWorkoutSelect();
            loadCustomWorkoutsIntoDropdown();
        }

        function populateLoadCustomHiitWorkoutSelect() {
            const select = document.getElementById('loadCustomHiitWorkoutSelect');
            if (!select) return;
            
            const customWorkouts = JSON.parse(localStorage.getItem('customWorkouts') || '{}');
            let html = '<option value="">-- Load Saved HIIT Workout --</option>';
            
            Object.keys(customWorkouts).forEach(name => {
                const workout = customWorkouts[name];
                if (typeof workout === 'object' && !Array.isArray(workout) && workout.workoutType === 'hiit') {
                    html += `<option value="${name}">${name}</option>`;
                }
            });
            
            select.innerHTML = html;
        }

        function loadSavedCustomHiitWorkout() {
            const select = document.getElementById('loadCustomHiitWorkoutSelect');
            const workoutName = select.value;
            
            if (!workoutName) return;
            
            const customWorkouts = JSON.parse(localStorage.getItem('customWorkouts') || '{}');
            currentWorkout = JSON.parse(JSON.stringify(customWorkouts[workoutName]));
            
            const listContainer = document.getElementById('customHiitExerciseList');
            listContainer.innerHTML = '';
            
            currentWorkout.forEach((exercise, index) => {
                const exerciseDiv = document.createElement('div');
                exerciseDiv.className = 'exercise-card';
                exerciseDiv.id = `custom-hiit-exercise-${index}`;
                listContainer.appendChild(exerciseDiv);
                updateCustomHiitExerciseDisplay(index);
            });
            
            document.getElementById('customHiitWorkoutName').value = workoutName;
        }
                   // ==================== INTERVAL CARDIO BUILDER ====================
            function showIntervalCardioBuilder() {
                const container = document.getElementById('workoutContainer');
                
                // Get only cardio exercises
                const cardioExercises = Object.keys(exerciseDatabase).filter(ex => 
                    exerciseDatabase[ex].exerciseType === 'cardio'
                ).sort();
                
                currentWorkout = [];
                
                let html = `
                    <h3>‚ö° Build Interval Cardio Workout</h3>
                    <div class="info-box">
                        <p><strong>Perfect for:</strong> Rowing intervals, bike sprints, run/walk intervals, etc.</p>
                        <p>Set your work time (e.g., 4 minutes rowing), rest time (e.g., 2 minutes rest), and rounds.</p>
                    </div>
                    
                    <div class="form-group">
                        <label>Select Cardio Activity</label>
                        <select id="intervalCardioActivity">
                            <option value="">-- Choose Activity --</option>
                            ${cardioExercises.map(ex => `<option value="${ex}">${ex}</option>`).join('')}
                        </select>
                    </div>
                    
                    <div style="background: #fff3cd; padding: 15px; border-radius: 10px; margin: 15px 0;">
                        <h4 style="margin-bottom: 15px; color: #856404;">‚è±Ô∏è Interval Settings</h4>
                        
                        <div class="form-group">
                            <label>Work Time (seconds)</label>
                            <input type="number" id="intervalWorkTime" value="240" step="15" placeholder="e.g., 240 for 4 minutes">
                            <small style="color: #6c757d;">Tip: 60s = 1min, 120s = 2min, 240s = 4min</small>
                        </div>
                        
                        <div class="form-group">
                            <label>Rest Time (seconds)</label>
                            <input type="number" id="intervalRestTime" value="120" step="15" placeholder="e.g., 120 for 2 minutes">
                        </div>
                        
                        <div class="form-group">
                            <label>Number of Rounds</label>
                            <input type="number" id="intervalRounds" value="5" min="1" placeholder="e.g., 5">
                        </div>
                    </div>
                    
                    <div class="info-box">
                        <p><strong>Example Workout:</strong></p>
                        <p>Rowing Machine: Work 240s (4min) ‚Üí Rest 120s (2min) √ó 5 rounds = 30 minute workout</p>
                    </div>
                    
                    <button class="btn btn-success" onclick="startIntervalCardio()" style="margin-top: 15px;">
                        ‚ö° Start Interval Cardio
                    </button>
                `;
                
                container.innerHTML = html;
                document.getElementById('workoutModeSelection').style.display = 'none';
            }
            
            function startIntervalCardio() {
                const activity = document.getElementById('intervalCardioActivity').value;
                const workTime = parseInt(document.getElementById('intervalWorkTime').value);
                const restTime = parseInt(document.getElementById('intervalRestTime').value);
                const rounds = parseInt(document.getElementById('intervalRounds').value);
                
                if (!activity) {
                    alert('Please select a cardio activity!');
                    return;
                }
                
                if (workTime < 15 || restTime < 10 || rounds < 1) {
                    alert('Please set valid interval times (work ‚â•15s, rest ‚â•10s, rounds ‚â•1)');
                    return;
                }
                
                // Set up as HIIT workout with single exercise
                currentWorkout = [{
                    name: activity,
                    duration: 0,
                    distance: 0,
                    distanceUnit: 'miles'
                }];
                
                hiitWorkoutParams = {
                    workTime: workTime,
                    restTime: restTime,
                    totalRounds: rounds
                };
                
                workoutStyle = 'hiit';
                
                // Start the main workout timer
                startTimer();
                
                // Start HIIT mode
                startHiitWorkout();
} 
        // ==================== QUICK CARDIO LOGGER ====================
function showQuickCardioLogger() {
    const container = document.getElementById('workoutContainer');
    
    // Get only cardio exercises
    const cardioExercises = Object.keys(exerciseDatabase).filter(ex => 
        exerciseDatabase[ex].exerciseType === 'cardio'
    ).sort();
    
    let html = `
        <h3>üèÉ Quick Cardio Session</h3>
        <div class="info-box">
            <p><strong>How it works:</strong></p>
            <ol style="margin-left: 20px; margin-top: 5px;">
                <li>Select your cardio activity</li>
                <li>Start timer when you begin</li>
                <li>Stop timer when done</li>
                <li>Add stats (distance, calories, HR) from your fitness tracker</li>
            </ol>
        </div>
        
        <div class="form-group">
            <label>Select Activity</label>
            <select id="quickCardioActivity" onchange="updateQuickCardioDisplay()">
                <option value="">-- Choose Activity --</option>
                ${cardioExercises.map(ex => `<option value="${ex}">${ex}</option>`).join('')}
            </select>
        </div>
        
        <div id="quickCardioDetails" style="display: none;">
            <div style="background: #e3f2fd; padding: 20px; border-radius: 10px; text-align: center; margin: 20px 0;">
                <h3>‚è±Ô∏è Session Timer</h3>
                <div style="font-size: 48px; font-weight: bold; color: #1565C0; margin: 15px 0;" id="quickCardioTimer">00:00</div>
                <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                    <button class="btn btn-success" id="quickCardioStartBtn" onclick="startQuickCardioTimer()">‚ñ∂Ô∏è Start</button>
                    <button class="btn btn-secondary" id="quickCardioPauseBtn" onclick="pauseQuickCardioTimer()" style="display: none;">‚è∏Ô∏è Pause</button>
                    <button class="btn btn-danger" id="quickCardioStopBtn" onclick="stopQuickCardioTimer()" style="display: none;">‚èπÔ∏è Stop & Log</button>
                </div>
            </div>
            
            <div id="quickCardioStatsForm" style="display: none;">
                <h3 style="margin-top: 20px;">üìä Add Stats (Optional)</h3>
                <div class="info-box">
                    <p>Add data from your fitness tracker or leave blank</p>
                </div>
                
                <div class="form-group">
                    <label>üìè Distance</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="number" id="quickCardioDistance" placeholder="0.0" step="0.1" style="flex: 2;">
                        <select id="quickCardioDistanceUnit" style="flex: 1;">
                            <option value="miles">Miles</option>
                            <option value="km">Kilometers</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>üî• Calories Burned</label>
                    <input type="number" id="quickCardioCalories" placeholder="e.g., 350">
                </div>
                
                <div class="form-group">
                    <label>üíì Average Heart Rate (BPM)</label>
                    <input type="number" id="quickCardioHeartRate" placeholder="e.g., 145">
                </div>
                
                <div class="form-group">
                    <label>üìù Notes (Optional)</label>
                    <textarea id="quickCardioNotes" rows="2" placeholder="How did it feel?"></textarea>
                </div>
                
                <button class="btn btn-success" onclick="saveQuickCardioSession()">üíæ Save Session</button>
                <button class="btn btn-secondary" onclick="cancelQuickCardio()">‚ùå Cancel</button>
            </div>
        </div>
    `;
    
    container.innerHTML = html;
    document.getElementById('workoutModeSelection').style.display = 'none';
}

function updateQuickCardioDisplay() {
    const activity = document.getElementById('quickCardioActivity').value;
    if (activity) {
        document.getElementById('quickCardioDetails').style.display = 'block';
        resetQuickCardioTimer();
    } else {
        document.getElementById('quickCardioDetails').style.display = 'none';
    }
}

// Quick Cardio Timer Variables
let quickCardioTimerInterval = null;
let quickCardioSeconds = 0;
let quickCardioRunning = false;

function startQuickCardioTimer() {
    quickCardioRunning = true;
    document.getElementById('quickCardioStartBtn').style.display = 'none';
    document.getElementById('quickCardioPauseBtn').style.display = 'inline-block';
    document.getElementById('quickCardioStopBtn').style.display = 'inline-block';
    
    quickCardioTimerInterval = setInterval(() => {
        quickCardioSeconds++;
        updateQuickCardioTimerDisplay();
    }, 1000);
}

function pauseQuickCardioTimer() {
    quickCardioRunning = false;
    clearInterval(quickCardioTimerInterval);
    document.getElementById('quickCardioStartBtn').style.display = 'inline-block';
    document.getElementById('quickCardioStartBtn').textContent = '‚ñ∂Ô∏è Resume';
    document.getElementById('quickCardioPauseBtn').style.display = 'none';
}

function stopQuickCardioTimer() {
    quickCardioRunning = false;
    clearInterval(quickCardioTimerInterval);
    document.getElementById('quickCardioStartBtn').style.display = 'none';
    document.getElementById('quickCardioPauseBtn').style.display = 'none';
    document.getElementById('quickCardioStopBtn').style.display = 'none';
    
    // Show stats form
    document.getElementById('quickCardioStatsForm').style.display = 'block';
    document.getElementById('quickCardioTimer').style.opacity = '0.5';
}

function resetQuickCardioTimer() {
    quickCardioSeconds = 0;
    quickCardioRunning = false;
    clearInterval(quickCardioTimerInterval);
    updateQuickCardioTimerDisplay();
    document.getElementById('quickCardioStartBtn').style.display = 'inline-block';
    document.getElementById('quickCardioStartBtn').textContent = '‚ñ∂Ô∏è Start';
    document.getElementById('quickCardioPauseBtn').style.display = 'none';
    document.getElementById('quickCardioStopBtn').style.display = 'none';
    document.getElementById('quickCardioStatsForm').style.display = 'none';
    document.getElementById('quickCardioTimer').style.opacity = '1';
}

function updateQuickCardioTimerDisplay() {
    const minutes = Math.floor(quickCardioSeconds / 60);
    const seconds = quickCardioSeconds % 60;
    document.getElementById('quickCardioTimer').textContent = 
        `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
}

function saveQuickCardioSession() {
    const activity = document.getElementById('quickCardioActivity').value;
    const duration = Math.floor(quickCardioSeconds / 60); // Convert to minutes
    const distance = parseFloat(document.getElementById('quickCardioDistance').value) || 0;
    const distanceUnit = document.getElementById('quickCardioDistanceUnit').value;
    const calories = parseInt(document.getElementById('quickCardioCalories').value) || null;
    const heartRate = parseInt(document.getElementById('quickCardioHeartRate').value) || null;
    const notes = document.getElementById('quickCardioNotes').value.trim();
    
    if (quickCardioSeconds < 60) {
        alert('Please complete at least 1 minute of activity!');
        return;
    }
    
    // Create workout entry
    const workoutEntry = {
        id: Date.now(),
        date: new Date().toISOString(),
        duration: quickCardioSeconds,
        workoutName: activity,
        type: 'Cardio',
        heartRate: heartRate,
        calories: calories,
        distance: distance > 0 ? distance : null,
        distanceUnit: distance > 0 ? distanceUnit : null,
        notes: notes,
        exercises: [{
            name: activity,
            duration: duration,
            distance: distance,
            distanceUnit: distanceUnit
        }],
        source: 'Quick Cardio Logger'
    };
    
    // Save to history
    workoutHistory.push(workoutEntry);
    localStorage.setItem('workoutHistory', JSON.stringify(workoutHistory));
    
    // Show success
    alert(`‚úÖ ${activity} logged!\n\nDuration: ${duration} minutes\n${distance > 0 ? `Distance: ${distance} ${distanceUnit}\n` : ''}${calories ? `Calories: ${calories}\n` : ''}${heartRate ? `Avg HR: ${heartRate} BPM` : ''}`);
    
    // Refresh displays
    loadHistory();
    renderCalendar();
    
    // Reset
    document.getElementById('workoutType').value = '';
    document.getElementById('workoutContainer').innerHTML = '';
}

function cancelQuickCardio() {
    if (confirm('Cancel this cardio session? Timer will be reset.')) {
        document.getElementById('workoutType').value = '';
        document.getElementById('workoutContainer').innerHTML = '';
        resetQuickCardioTimer();
    }
}
       // ==================== GUIDED WORKOUT MODE ====================
        function startGuidedWorkout(mode) {
            document.querySelector('.workout-timer').style.display = 'block';
            if (currentWorkout.length === 0 || !currentWorkout[0].name) {
                alert('Please select or create a workout first!');
                return;
            }

            workoutMode = mode;
            currentExerciseIndex = 0;
            currentSet = 1;
            workoutStartTime = Date.now();

            // Initialize audio context for rest timer beeps
            if (!audioCtx) {
                try {
                    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                    console.log("Audio Context initialized for traditional/circuit workout rest timers.");
                } catch (e) {
                    console.log("Could not initialize audio context:", e);
                }
            }
            if (audioCtx && audioCtx.state === 'suspended') {
                audioCtx.resume();
            }

            document.getElementById('workoutSetup').style.display = 'none';
            document.getElementById('guidedWorkoutMode').style.display = 'block';

            startTimer();
            displayCurrentExercise();
        }

        function displayCurrentExercise() {
            const exercise = currentWorkout[currentExerciseIndex];
            const totalExercises = currentWorkout.length;

            document.getElementById('exerciseProgress').textContent = 
                `Exercise ${currentExerciseIndex + 1} of ${totalExercises}`;
            document.getElementById('currentExerciseName').textContent = exercise.name;
            document.getElementById('currentWeight').textContent = exercise.weight;
            document.getElementById('currentReps').textContent = exercise.reps;
            document.getElementById('currentSets').textContent = exercise.sets;

            if (workoutMode === 'traditional') {
                document.getElementById('setProgress').textContent = `Set ${currentSet}/${exercise.sets}`;
            } else if (workoutMode === 'circuit') {
                const totalSets = currentWorkout[0].sets;
                document.getElementById('setProgress').textContent = `Round ${currentSet}/${totalSets}`;
            }

            updateWorkoutProgressList();
        }

        function completeSet() {
            const exercise = currentWorkout[currentExerciseIndex];

            if (workoutMode === 'traditional') {
                if (currentSet < exercise.sets) {
                    currentSet++;
                    displayCurrentExercise();
                    startRestTimer(60);
                } else {
                    moveToNextExercise();
                }
            } else if (workoutMode === 'circuit') {
                if (currentExerciseIndex < currentWorkout.length - 1) {
                    currentExerciseIndex++;
                    displayCurrentExercise();
                    startRestTimer(30);
                } else {
                    const totalSets = currentWorkout[0].sets;
                    if (currentSet < totalSets) {
                        currentSet++;
                        currentExerciseIndex = 0;
                        displayCurrentExercise();
                        startRestTimer(60);
                    } else {
                        finishWorkout();
                    }
                }
            }
        }

        function moveToNextExercise() {
            if (currentExerciseIndex < currentWorkout.length - 1) {
                currentExerciseIndex++;
                currentSet = 1;
                displayCurrentExercise();
                startRestTimer(90);
            } else {
                finishWorkout();
            }
        }

        function startRestTimer(seconds) {
            let restTime = seconds;
            document.getElementById('restTimer').style.display = 'block';
            document.getElementById('completeSetBtn').style.display = 'none';
            document.getElementById('restDisplay').textContent = restTime;

            restInterval = setInterval(() => {
                restTime--;
                document.getElementById('restDisplay').textContent = restTime;

                // Play countdown beeps in the last 3 seconds
                if (restTime === 3) {
                    playHiitSound('countdown3');
                } else if (restTime === 2) {
                    playHiitSound('countdown2');
                } else if (restTime === 1) {
                    playHiitSound('countdown1');
                }

                if (restTime <= 0) {
                    clearInterval(restInterval);
                    document.getElementById('restTimer').style.display = 'none';
                    document.getElementById('completeSetBtn').style.display = 'block';
                    playHiitSound('rest'); // Final beep when rest is complete
                }
            }, 1000);
        }

        function skipRest() {
            clearInterval(restInterval);
            document.getElementById('restTimer').style.display = 'none';
            document.getElementById('completeSetBtn').style.display = 'block';
        }

        function updateWorkoutProgressList() {
            const container = document.getElementById('workoutProgressList');
            let html = '';

            currentWorkout.forEach((exercise, index) => {
                const isCompleted = (workoutMode === 'traditional' && index < currentExerciseIndex) ||
                                    (workoutMode === 'circuit' && currentSet > 1);
                const isCurrent = index === currentExerciseIndex;

                let status = '‚ö™';
                if (isCompleted) status = '‚úÖ';
                else if (isCurrent) status = 'üîµ';

                html += `
                    <div style="display: flex; justify-content: space-between; padding: 8px; background: ${isCurrent ? 'rgba(0, 61, 92, 0.1)' : 'transparent'}; border-radius: 6px; margin-bottom: 5px;">
                        <span>${status} ${exercise.name}</span>
                        <span style="color: #6c757d;">${exercise.sets}x${exercise.reps} @ ${exercise.weight}lbs</span>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function showCurrentExerciseInfo() {
            const exercise = currentWorkout[currentExerciseIndex];
            showExerciseInfo(exercise.name);
        }
        function showCurrentHiitExerciseInfo() {
            const exerciseName = hiitWorkoutParams.exercises[hiitCurrentExerciseIndex];
            if (exerciseName && hiitCurrentMode === 'work') {
                showExerciseInfo(exerciseName);
            }
        }
        function endWorkout() {
            if (confirm('Are you sure you want to end this workout early?')) {
                finishWorkout();
            }
        }

        function finishWorkout() {
            pauseTimer();
            const workoutDuration = timerSeconds;

            const workoutData = {
                date: new Date().toISOString(),
                exercises: currentWorkout,
                duration: workoutDuration,
                type: workoutStyle === 'hiit' && currentWorkout[0] && exerciseDatabase[currentWorkout[0].name]?.exerciseType === 'cardio' ? 'Interval Cardio' : workoutStyle,
                workoutName: document.getElementById('workoutType').value || 'Custom',
                notes: document.getElementById('workoutNotes')?.value || ''
            };

            let history = JSON.parse(localStorage.getItem('workoutHistory') || '[]');
            history.unshift(workoutData);
            localStorage.setItem('workoutHistory', JSON.stringify(history));

            updatePersonalRecords(currentWorkout);

            // Check for interval cardio stats, otherwise show the standard completion message
            if (workoutData.type === 'Interval Cardio') {
                promptForCardioStats(workoutData);
            } else {
                alert(`üéâ Workout Complete!\n\nDuration: ${Math.floor(workoutDuration / 60)} minutes ${workoutDuration % 60} seconds\n\nGreat job!`);
            }

            // *** THE FIX: Call the central reset function to properly clean up the UI ***
            resetWorkoutState();
        }
            
            function promptForCardioStats(workoutData) {
                const distance = prompt('üìè Distance (leave blank to skip):\n\nEnter distance completed:');
                if (distance && parseFloat(distance) > 0) {
                    const unit = confirm('Click OK for MILES\nClick Cancel for KILOMETERS') ? 'miles' : 'km';
                    workoutData.distance = parseFloat(distance);
                    workoutData.distanceUnit = unit;
                }
                
                const calories = prompt('üî• Calories burned (leave blank to skip):');
                if (calories && parseInt(calories) > 0) {
                    workoutData.calories = parseInt(calories);
                }
                
                const heartRate = prompt('üíì Average heart rate in BPM (leave blank to skip):');
                if (heartRate && parseInt(heartRate) > 0) {
                    workoutData.heartRate = parseInt(heartRate);
                }
                
                // Update in history
                let history = JSON.parse(localStorage.getItem('workoutHistory') || '[]');
                if (history[0].date === workoutData.date) {
                    history[0] = workoutData;
                    localStorage.setItem('workoutHistory', JSON.stringify(history));
                }
                
                alert(`üéâ Interval Cardio Complete!\n\nDuration: ${Math.floor(workoutData.duration / 60)} minutes\n${workoutData.distance ? `Distance: ${workoutData.distance} ${workoutData.distanceUnit}\n` : ''}${workoutData.calories ? `Calories: ${workoutData.calories}\n` : ''}${workoutData.heartRate ? `Avg HR: ${workoutData.heartRate} BPM` : ''}\n\nGreat job!`);
            }
            
        // ==================== PERSONAL RECORDS TRACKING ====================
        function updatePersonalRecords(workout) {
            let prs = JSON.parse(localStorage.getItem('personalRecords') || '{}');

            workout.forEach(exercise => {
                if (exercise.weight > 0) {
                    const exerciseName = exercise.name;
                    const currentMax = prs[exerciseName] || 0;

                    if (exercise.weight > currentMax) {
                        prs[exerciseName] = exercise.weight;
                    }
                }
            });

            localStorage.setItem('personalRecords', JSON.stringify(prs));
        }

        function isPersonalRecord(exerciseName, weight) {
            const prs = JSON.parse(localStorage.getItem('personalRecords') || '{}');
            return weight > 0 && weight >= (prs[exerciseName] || 0);
        }

        // ==================== HIIT WORKOUT MODE ====================
        function adjustHiitParamPreWorkout(param, delta) {
            if (param === 'work') {
                hiitWorkTime = Math.max(10, Math.min(120, hiitWorkTime + delta));
                document.getElementById('hiitPreWorkWorkDisplay').textContent = hiitWorkTime;
            } else if (param === 'rest') {
                hiitRestTime = Math.max(5, Math.min(60, hiitRestTime + delta));
                document.getElementById('hiitPreWorkRestDisplay').textContent = hiitRestTime;
            } else if (param === 'rounds') {
                hiitTotalRounds = Math.max(1, Math.min(10, hiitTotalRounds + delta));
                document.getElementById('hiitPreWorkRoundsDisplay').textContent = hiitTotalRounds;
            }
        }

        function startHiitWorkout() {
            if (!currentWorkout || currentWorkout.length === 0) {
                alert("No HIIT exercises are loaded. Please create or load a custom HIIT workout first.");
                return;
            }
        
            // This is the user interaction needed for sound.
            // We prepare everything but wait for the user to click the main timer's start button.
            if (!window.audioCtx) {
                try {
                    window.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                    console.log("Audio context initialized by HIIT start button.");
                } catch (e) {
                    console.log("Could not initialize audio context:", e);
                }
            }
        
            hiitWorkoutParams.exercises = currentWorkout.map(ex => ex.name);
        
            hiitCurrentRound = 1;
            hiitCurrentExerciseIndex = 0;
            hiitCurrentMode = 'countdown';
            hiitIsPaused = false;
        
            // Show the necessary UI components
            document.getElementById('workoutSetup').style.display = 'none';
            document.getElementById('guidedWorkoutMode').style.display = 'none';
            document.getElementById('hiitWorkoutMode').style.display = 'block';
            document.querySelector('.nav').style.display = 'none';
            document.querySelector('.workout-timer').style.display = 'block'; // <-- KEY CHANGE: Show the main timer
        
            // Prepare the HIIT screen
            document.getElementById('hiitCountdownScreen').style.display = 'block';
            document.getElementById('hiitActiveScreen').style.display = 'none';
            document.getElementById('hiitPauseResumeBtn').textContent = 'Pause Exercise';
        
            // DO NOT call startTimer() here. We wait for the user.
            }

        function startHiitCountdown() {
            let hiitCountdown = 5;
            document.getElementById('hiitCountdownDisplay').textContent = hiitCountdown;

            console.log("=== HIIT Countdown Starting ===");

            let countdownInterval = setInterval(() => {
                hiitCountdown--;
                console.log("Countdown:", hiitCountdown);
                document.getElementById('hiitCountdownDisplay').textContent = hiitCountdown;

                if (hiitCountdown <= 0) {
                    clearInterval(countdownInterval);
                    console.log("Countdown complete, showing active screen");
                    document.getElementById('hiitCountdownScreen').style.display = 'none';
                    document.getElementById('hiitActiveScreen').style.display = 'block';
                    hiitCurrentMode = 'work';
                    hiitTimeRemaining = hiitWorkoutParams.workTime;

                    window.hiitActive = true;
                    runHiitInterval();
                }
            }, 1000);
        }

        function runHiitInterval() {
            if (hiitTimerInterval) clearInterval(hiitTimerInterval);

            updateHiitDisplay();

            // Play sound when phase starts
            if (hiitCurrentMode === 'work') {
                playHiitSound('work'); // High pitch for work
            } else {
                playHiitSound('rest'); // Medium pitch for rest
            }

            hiitTimerInterval = setInterval(() => {
                if (hiitIsPaused) return;

                hiitTimeRemaining--;
                document.getElementById('hiitTimerDisplay').textContent = hiitTimeRemaining;

                // Play beeps during final 3 seconds countdown (3, 2, 1)
                if (hiitTimeRemaining === 3) {
                    playHiitSound('countdown3'); // First beep
                } else if (hiitTimeRemaining === 2) {
                    playHiitSound('countdown2'); // Second beep
                } else if (hiitTimeRemaining === 1) {
                    playHiitSound('countdown1'); // Third beep
                }

                if (hiitTimeRemaining <= 0) {
                    clearInterval(hiitTimerInterval);
                    nextHiitPhase();
                }
            }, 1000);
        }

        function nextHiitPhase() {
            if (hiitCurrentMode === 'work') {
                hiitCurrentMode = 'rest';
                hiitTimeRemaining = hiitWorkoutParams.restTime;
            } else { // It was 'rest'
                hiitCurrentExerciseIndex++;
                if (hiitCurrentExerciseIndex >= hiitWorkoutParams.exercises.length) {
                    hiitCurrentExerciseIndex = 0;
                    hiitCurrentRound++;
                }
                hiitCurrentMode = 'work';
                hiitTimeRemaining = hiitWorkoutParams.workTime;
            }

            if (hiitCurrentRound > hiitWorkoutParams.totalRounds) {
                completeHiitWorkout();
            } else {
                runHiitInterval();
            }
        }

        function updateHiitDisplay() {
            const modeDisplay = document.getElementById('hiitModeDisplay');
            const exerciseNameEl = document.getElementById('hiitExerciseName');
            const nextExerciseNameEl = document.getElementById('hiitNextExerciseName');
            const roundDisplay = document.getElementById('hiitRoundDisplay');

            roundDisplay.textContent = `Round ${hiitCurrentRound} of ${hiitWorkoutParams.totalRounds}`;

            // Update the display values
            document.getElementById('hiitWorkDisplay').textContent = hiitWorkoutParams.workTime;
            document.getElementById('hiitRestDisplay').textContent = hiitWorkoutParams.restTime;
            document.getElementById('hiitRoundsDisplay').textContent = hiitWorkoutParams.totalRounds;

            if (hiitCurrentMode === 'work') {
                modeDisplay.textContent = 'WORK!';
                modeDisplay.classList.remove('rest');
                modeDisplay.classList.add('work');
                const exerciseName = hiitWorkoutParams.exercises[hiitCurrentExerciseIndex] || 'Exercise';
                exerciseNameEl.textContent = exerciseName;
                nextExerciseNameEl.textContent = 'Next Up: Rest';
            } else {
                modeDisplay.textContent = 'REST';
                modeDisplay.classList.remove('work');
                modeDisplay.classList.add('rest');
                exerciseNameEl.textContent = 'Rest';

                let nextIndex = hiitCurrentExerciseIndex + 1;
                let nextUpText = 'Next Up: ';
                if (nextIndex >= hiitWorkoutParams.exercises.length) {
                    nextUpText += `Round ${hiitCurrentRound + 1} - ${hiitWorkoutParams.exercises[0]}`;
                } else {
                    nextUpText += hiitWorkoutParams.exercises[nextIndex];
                }
                nextExerciseNameEl.textContent = nextUpText;
            }

            document.getElementById('hiitTimerDisplay').textContent = hiitTimeRemaining;
        }

        function adjustHiitParamPreWorkout(param, change) {
            if (param === 'work') {
                hiitWorkoutParams.workTime = Math.max(5, hiitWorkoutParams.workTime + change);
                document.getElementById('hiitPreWorkWorkDisplay').textContent = hiitWorkoutParams.workTime;
                console.log("Pre-workout: Work time adjusted to:", hiitWorkoutParams.workTime);
            } else if (param === 'rest') {
                hiitWorkoutParams.restTime = Math.max(5, hiitWorkoutParams.restTime + change);
                document.getElementById('hiitPreWorkRestDisplay').textContent = hiitWorkoutParams.restTime;
                console.log("Pre-workout: Rest time adjusted to:", hiitWorkoutParams.restTime);
            } else if (param === 'rounds') {
                hiitWorkoutParams.totalRounds = Math.max(1, hiitWorkoutParams.totalRounds + change);
                document.getElementById('hiitPreWorkRoundsDisplay').textContent = hiitWorkoutParams.totalRounds;
                console.log("Pre-workout: Rounds adjusted to:", hiitWorkoutParams.totalRounds);
            }
        }

        function adjustHiitParam(param, change) {
            if (param === 'work') {
                hiitWorkoutParams.workTime = Math.max(5, hiitWorkoutParams.workTime + change);
                document.getElementById('hiitWorkDisplay').textContent = hiitWorkoutParams.workTime;
                console.log("Work time adjusted to:", hiitWorkoutParams.workTime);
            } else if (param === 'rest') {
                hiitWorkoutParams.restTime = Math.max(5, hiitWorkoutParams.restTime + change);
                document.getElementById('hiitRestDisplay').textContent = hiitWorkoutParams.restTime;
                console.log("Rest time adjusted to:", hiitWorkoutParams.restTime);
            } else if (param === 'rounds') {
                hiitWorkoutParams.totalRounds = Math.max(1, hiitWorkoutParams.totalRounds + change);
                document.getElementById('hiitRoundsDisplay').textContent = hiitWorkoutParams.totalRounds;
                // Update the round display to reflect new total
                document.getElementById('hiitRoundDisplay').textContent = `Round ${hiitCurrentRound} of ${hiitWorkoutParams.totalRounds}`;
                console.log("Rounds adjusted to:", hiitWorkoutParams.totalRounds);
            }
        }

        function pauseResumeHiit() {
            const btn = document.getElementById('hiitPauseResumeBtn');
            hiitIsPaused = !hiitIsPaused; // This flag is all we need to pause the interval

            if (hiitIsPaused) {
                // We are now paused. Update the button text.
                btn.textContent = 'Resume Exercise';
                // DO NOT call pauseTimer(). The main timer will continue running.
            } else {
                // We are resuming. Update the button text.
                btn.textContent = 'Pause Exercise';
                
                // It's still good practice to resume the audio context here.
                if (window.audioCtx && window.audioCtx.state === 'suspended') {
                    window.audioCtx.resume();
                }
            }
        }

        function endHiitWorkout() {
            if (!confirm('Are you sure you want to end this workout?')) {
                return;
            }
            pauseTimer();
            clearInterval(hiitTimerInterval);

            // Check if manual calorie tracking is enabled
            const calorieSettings = JSON.parse(localStorage.getItem('calorieSettings') || '{"method": "automatic", "multiplier": 1.0}');
            let caloriesBurned = null;

            if (calorieSettings.method === 'manual') {
                const userCalories = prompt('Enter calories burned from your fitness tracker (or leave blank to skip):');
                if (userCalories && !isNaN(userCalories) && userCalories > 0) {
                    caloriesBurned = parseInt(userCalories);
                }
            }

            const workout = {
                date: new Date().toISOString(),
                type: 'HIIT Workout',
                exercises: hiitWorkoutParams.exercises,
                rounds: hiitCurrentRound - 1,
                volume: 0,
                duration: timerSeconds,
                caloriesBurned: caloriesBurned
            };

            workoutHistory.unshift(workout);
            localStorage.setItem('workoutHistory', JSON.stringify(workoutHistory));

            alert('Workout saved! Great work!');
            resetWorkoutState();
        }
        function completeHiitWorkout() {
            pauseTimer();
            clearInterval(hiitTimerInterval);
            playHiitSound('work');

            document.getElementById('hiitModeDisplay').textContent = 'COMPLETE!';
            document.getElementById('hiitTimerDisplay').textContent = '‚úì';
            document.getElementById('hiitExerciseName').textContent = 'Workout Finished';
            document.getElementById('hiitNextExerciseName').textContent = '';
            document.getElementById('hiitPauseResumeBtn').style.display = 'none';

            setTimeout(() => {
                // Check if manual calorie tracking is enabled
                const calorieSettings = JSON.parse(localStorage.getItem('calorieSettings') || '{"method": "automatic", "multiplier": 1.0}');
                let caloriesBurned = null;

                if (calorieSettings.method === 'manual') {
                    const userCalories = prompt('Enter calories burned from your fitness tracker (or leave blank to skip):');
                    if (userCalories && !isNaN(userCalories) && userCalories > 0) {
                        caloriesBurned = parseInt(userCalories);
                    }
                }

                const workout = {
                    date: new Date().toISOString(),
                    type: 'HIIT Workout',
                    exercises: hiitWorkoutParams.exercises,
                    rounds: hiitWorkoutParams.totalRounds,
                    volume: 0,
                    duration: timerSeconds,
                    caloriesBurned: caloriesBurned
                };

                workoutHistory.unshift(workout);
                localStorage.setItem('workoutHistory', JSON.stringify(workoutHistory));

                alert('Workout Complete! Excellent work! üí™');
                resetWorkoutState();
            }, 1500);
        }
        function resetWorkoutState() {
                // Reset flags and UI
                document.querySelector('.workout-timer').style.display = 'none'; // <-- THIS IS THE CRITICAL FIX
            
                guidedMode = false;
                window.hiitActive = false;
                document.getElementById('workoutSetup').style.display = 'block';
                document.getElementById('guidedWorkoutMode').style.display = 'none';
                document.getElementById('hiitWorkoutMode').style.display = 'none';
                document.getElementById('workoutType').value = '';
                document.getElementById('workoutContainer').innerHTML = '';
                document.getElementById('workoutModeSelection').style.display = 'none';
                if (document.querySelector('.nav')) {
                    document.querySelector('.nav').style.display = 'flex';
                }
            
                // Reset all state variables to their defaults
                currentWorkout = [];
                completedSets = [];
                currentExerciseIndex = 0;
                currentSetNumber = 1;
                currentRound = 1;
                workoutStyle = 'traditional';
                restTimeRemaining = 0;
                
                // Reset timers and update other sections
                resetTimer();
                loadRecommendation();
                updateProgress();
                loadHistory();
                
                // Go to a neutral tab after workout completion
                showSection('history');
            }
        function playHiitSound(type) {
            // If audioCtx was never created (because it's not a HIIT workout), it will just exit silently.
            if (!audioCtx) return;

            try {
                const ctx = audioCtx;
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();

                let freq = 440;
                let duration = 0.1;

                if (type === 'work') {
                    freq = 1000;
                    duration = 0.3;
                } else if (type === 'rest') {
                    freq = 600;
                    duration = 0.3;
                } else if (type === 'countdown3' || type === 'countdown2' || type === 'countdown1') {
                    freq = 800;
                    duration = 0.15;
                }

                osc.frequency.value = freq;
                osc.type = 'sine';
                gain.gain.setValueAtTime(0.7, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + duration);
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.start(ctx.currentTime);
                osc.stop(ctx.currentTime + duration);

            } catch (e) {
                console.log("Sound not available or could not play:", e.message);
            }
        }

        // ==================== EXERCISE LIBRARY ====================
        function renderExerciseList() {
            const container = document.getElementById('exerciseListContainer');
            const searchTerm = document.getElementById('exerciseSearch').value.toLowerCase();

            const customExercises = JSON.parse(localStorage.getItem('customExercises') || '{}');
            const allExercises = { ...exerciseDatabase, ...customExercises };
            const exerciseNames = Object.keys(allExercises).sort();

            const filteredExercises = exerciseNames.filter(name => 
                name.toLowerCase().includes(searchTerm)
            );

            let html = '';
            filteredExercises.forEach(name => {
                const exercise = allExercises[name];
                const isCustom = customExercises.hasOwnProperty(name);

                html += `
                    <div class="exercise-card">
                        <div class="exercise-header">
                            <div class="exercise-name">${name} ${isCustom ? '(Custom)' : ''}</div>
                            <div class="exercise-button-group">
                                <button class="edit-btn" onclick="showExerciseInfo('${name.replace(/'/g, "\\'")}')">‚ÑπÔ∏è</button>
                                ${isCustom ? `<button class="edit-btn" onclick="editCustomExercise('${name.replace(/'/g, "\\'")}')">‚úèÔ∏è</button>` : ''}
                                ${isCustom ? `<button class="delete-btn" onclick="deleteCustomExercise('${name.replace(/'/g, "\\'")}')">üóëÔ∏è</button>` : ''}
                            </div>
                        </div>
                        <p class="exercise-equipment">
                            Equipment: ${exercise.equipment}
                        </p>
                    </div>
                `;
            });

            container.innerHTML = html || '<p class="exercise-not-found">No exercises found</p>';
        }

        function showExerciseInfo(exerciseName) {
            const customExercises = JSON.parse(localStorage.getItem('customExercises') || '{}');
            const exercise = exerciseDatabase[exerciseName] || customExercises[exerciseName];

            if (!exercise) {
                alert('Exercise not found!');
                return;
            }
            
            const modalName = document.getElementById('modalExerciseName');
            const modalContent = document.getElementById('modalExerciseContent');

            modalName.textContent = exerciseName;

            const imageUrl = getExerciseImageUrl(exerciseName);
            
            const customYouTubeLinks = JSON.parse(localStorage.getItem('customYouTubeLinks') || '{}');
            let youtubeLink = customYouTubeLinks[exerciseName] || youtubeVideoLinks[exerciseName];
            if (!youtubeLink) {
                youtubeLink = 'https://www.youtube.com/results?search_query=' + encodeURIComponent(exerciseName + " tutorial");
            }
            
            const displayInstructions = exerciseDescriptions[exerciseName] || exercise.instructions;

           modalContent.innerHTML = `
                <p><strong>Equipment:</strong> ${exercise.equipment}</p>
                <div class="exercise-image">
                    <img src="${imageUrl}" 
                         alt="${exerciseName}" 
                         onerror="this.parentElement.innerHTML='<div class=\\'exercise-image-fallback\\'>${exercise.image || 'Image not found'}<br><small>Image preview not available</small></div>'">
                </div>
                <div style="margin-top: 15px;">
                    <strong>[TIP] Detailed Instructions</strong>
                    <p style="line-height: 1.6; margin-top: 10px;">${displayInstructions}</p>
                </div>
                <div class="exercise-card" style="margin-top: 15px; margin-bottom: 15px;">
                    <strong>Suggested:</strong> ${exercise.sets} sets, ${exercise.reps} reps @ ${exercise.weight} lbs
                </div>
                <div style="margin-top: 15px;">
                    <a href="${youtubeLink}" target="_blank" class="btn" style="display: block; text-align: center; text-decoration: none; margin-top: 0;">
                        [VIDEO] Watch Video
                    </a>
                </div>
            `;

            // It now correctly uses our new master function
            showModalById('exerciseModal');
        }

        function showModalById(modalId) {
            const modal = document.getElementById(modalId);
            if (!modal) {
                console.error(`Modal with ID "${modalId}" not found.`);
                return;
            }

            modal.classList.add('active');
            document.body.classList.add('modal-open');

            // FIX: Use setTimeout to delay the scroll reset. This gives the
            // browser a moment to render the modal before we try to scroll it,
            // fixing the "invisible modal" bug.
            setTimeout(() => {
                modal.scrollTop = 0;
            }, 0);
        }

        function closeModal(modalElement) {
            if (modalElement) {
                modalElement.classList.remove('active');
                document.body.classList.remove('modal-open');
            }
        }


        // ==================== CUSTOM EXERCISES ====================
        function openAddExerciseModal(isNew = true) {
            document.getElementById('addExerciseModalTitle').textContent = 
                isNew ? '‚ûï Add Custom Exercise' : '‚úèÔ∏è Edit Exercise';
            document.getElementById('saveExerciseBtn').textContent = 
                isNew ? 'üíæ Add Exercise to Database' : 'üíæ Save Changes';

            if (isNew) {
                document.getElementById('originalExerciseName').value = '';
                document.getElementById('newExerciseName').value = '';
                document.getElementById('newExerciseEquipment').value = '';
                document.getElementById('newExerciseInstructions').value = '';
                document.getElementById('newExerciseImage').value = '';
                document.getElementById('newExerciseYouTubeLink').value = '';
                document.getElementById('newExerciseWeight').value = 25;
                document.getElementById('newExerciseSets').value = 3;
                document.getElementById('newExerciseReps').value = 12;
            }

            // Simply call the new helper function
            showModalById('addExerciseModal');
        }
        
        function editCustomExercise(exerciseName) {
            const customExercises = JSON.parse(localStorage.getItem('customExercises') || '{}');
            const exercise = customExercises[exerciseName];

            if (!exercise) {
                alert('Exercise not found!');
                return;
            }

            document.getElementById('originalExerciseName').value = exerciseName;
            document.getElementById('newExerciseName').value = exerciseName;
            document.getElementById('newExerciseEquipment').value = exercise.equipment || '';
            document.getElementById('newExerciseInstructions').value = exercise.instructions || '';
            document.getElementById('newExerciseImage').value = exercise.image || '';
            
            const customYouTubeLinks = JSON.parse(localStorage.getItem('customYouTubeLinks') || '{}');
            document.getElementById('newExerciseYouTubeLink').value = customYouTubeLinks[exerciseName] || '';
            
            document.getElementById('newExerciseWeight').value = exercise.defaultWeight || 25;
            document.getElementById('newExerciseSets').value = exercise.defaultSets || 3;
            document.getElementById('newExerciseReps').value = exercise.defaultReps || 12;

            openAddExerciseModal(false);
        }

        function deleteCustomExercise(exerciseName) {
            if (!confirm(`Are you sure you want to delete "${exerciseName}"? This cannot be undone.`)) {
                return;
            }

            const customExercises = JSON.parse(localStorage.getItem('customExercises') || '{}');
            delete customExercises[exerciseName];
            localStorage.setItem('customExercises', JSON.stringify(customExercises));

            const customYouTubeLinks = JSON.parse(localStorage.getItem('customYouTubeLinks') || '{}');
            delete customYouTubeLinks[exerciseName];
            localStorage.setItem('customYouTubeLinks', JSON.stringify(customYouTubeLinks));

            alert('Exercise deleted successfully!');
            renderExerciseList();
        }

        function saveNewExercise() {
            const originalName = document.getElementById('originalExerciseName').value;
            const name = document.getElementById('newExerciseName').value.trim();
            const equipment = document.getElementById('newExerciseEquipment').value.trim();
            const instructions = document.getElementById('newExerciseInstructions').value.trim();
            const image = document.getElementById('newExerciseImage').value.trim();
            const youtubeLink = document.getElementById('newExerciseYouTubeLink').value.trim();
            const weight = parseInt(document.getElementById('newExerciseWeight').value);
            const sets = parseInt(document.getElementById('newExerciseSets').value);
            const reps = parseInt(document.getElementById('newExerciseReps').value);

            if (!name || !equipment || !instructions) {
                alert('Please fill in all required fields (Name, Equipment, Instructions)');
                return;
            }

            const customExercises = JSON.parse(localStorage.getItem('customExercises') || '{}');

            if (originalName && originalName !== name) {
                delete customExercises[originalName];
            }

            if (exerciseDatabase[name] && !originalName) {
                alert('An exercise with this name already exists in the default database!');
                return;
            }

            customExercises[name] = {
                equipment: equipment,
                instructions: instructions,
                image: image || 'Custom exercise',
                defaultWeight: weight,
                defaultSets: sets,
                defaultReps: reps
            };

            localStorage.setItem('customExercises', JSON.stringify(customExercises));

            if (youtubeLink) {
                const customYouTubeLinks = JSON.parse(localStorage.getItem('customYouTubeLinks') || '{}');
                if (originalName && originalName !== name) {
                    delete customYouTubeLinks[originalName];
                }
                customYouTubeLinks[name] = youtubeLink;
                localStorage.setItem('customYouTubeLinks', JSON.stringify(customYouTubeLinks));
            }

            alert(originalName ? 'Exercise updated successfully!' : 'Exercise added successfully!');
            closeModal(document.getElementById('addExerciseModal'));
            renderExerciseList();
        }

        // ==================== AI FEATURES ====================
        function checkApiKey() {
            const apiKey = localStorage.getItem('geminiKey');
            if (apiKey) {
                document.getElementById('api-setup').style.display = 'none';
                document.getElementById('chat-box').style.display = 'block';
            }
        }

        // ===================================================================
        // START: AI COACH FUNCTIONS (RESTORED FROM WORKING FILE)
        // ===================================================================

         function saveCustomExerciseToDB(name, data) {
            const customExercises = JSON.parse(localStorage.getItem('customExercises') || '{}');
            customExercises[name] = data;
            localStorage.setItem('customExercises', JSON.stringify(customExercises));
            
            // Also update the runtime database so it's immediately available
            exerciseDatabase[name] = data;
        }
        
        function saveApiKey() {
            const key = document.getElementById('apiKey').value.trim();
            if (!key) {
                alert('Please paste your API key');
                return;
            }
            localStorage.setItem('geminiKey', key);
            initAI();
        }

        function initAI() {
            const key = localStorage.getItem('geminiKey');
            if (key) {
                document.getElementById('api-setup').style.display = 'none';
                document.getElementById('chat-box').style.display = 'block';
                if (document.getElementById('messages').children.length === 0) {
                    addMsg('Hi! I am your AI Workout Coach. How can I help you train today?', 'bot');
                }
            }
        }

        function resetApiKey() {
            if (confirm('Are you sure you want to change your API key?')) {
                localStorage.removeItem('geminiKey');
                document.getElementById('api-setup').style.display = 'block';
                document.getElementById('chat-box').style.display = 'none';
                document.getElementById('messages').innerHTML = ''; // Clear chat history on key change
            }
        }

        function addMsg(text, role) {
            const msg = document.createElement('div');
            msg.style.padding = '10px';
            msg.style.borderRadius = '8px';
            msg.style.maxWidth = '80%';
            if (role === 'user') {
                msg.style.background = '#003d5c';
                msg.style.color = '#f5f5dc';
                msg.style.alignSelf = 'flex-end';
            } else {
                msg.style.background = '#d4af37';
                msg.style.color = '#001f3f';
                msg.style.alignSelf = 'flex-start';
            }
            msg.textContent = text;
            document.getElementById('messages').appendChild(msg);
            document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
        }
        // ==================== APPLE FITNESS IMPORT ====================
       async function processAppleWorkoutImage(event) {
            const file = event.target.files[0];
            if (!file) return;

            const key = localStorage.getItem('geminiKey');
            if (!key) {
                alert('Please set up your Gemini API key first in the AI Coach tab.');
                return;
            }

            const statusDiv = document.getElementById('imageProcessingStatus');
            statusDiv.style.display = 'block';
            statusDiv.innerHTML = '<p style="color: #2196F3;">üîÑ Analyzing workout image...</p>';

            try {
                // Convert image to base64
                const reader = new FileReader();
                reader.readAsDataURL(file);
                
                reader.onload = async () => {
                    try {
                        const base64Data = reader.result.split(',')[1]; // Remove data:image/png;base64, prefix

                        const prompt = `You are analyzing an Apple Fitness or workout screenshot. Extract ALL workout data visible in the image.

Respond with a JSON object in this EXACT format:
{
  "workoutName": "Exercise type (e.g., Outdoor Run, Strength Training, HIIT, etc.)",
  "duration": "Duration in minutes as a number",
  "calories": "Calories burned as a number",
  "date": "Workout date in YYYY-MM-DD format (use today's date if not visible)",
  "heartRate": "Average heart rate if visible, otherwise null",
  "distance": "Distance if visible (for running/cycling), otherwise null",
  "exercises": [
    {
      "name": "Exercise name if detailed workout shown",
      "sets": 3,
      "reps": 12,
      "weight": 0
    }
  ]
}

If this is just a summary screen (showing duration/calories only), leave exercises array empty. If detailed exercises are shown, populate the exercises array.`;

                        // Use retry logic
                        const data = await apiCallWithRetry(
                            `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${key}`,
                            {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    contents: [{
                                        parts: [
                                            { text: prompt },
                                            {
                                                inline_data: {
                                                    mime_type: file.type,
                                                    data: base64Data
                                                }
                                            }
                                        ]
                                    }]
                                })
                            }
                        );

                        const resultText = data.candidates[0].content.parts[0].text;
                        const workoutData = JSON.parse(resultText.match(/\{[\s\S]*\}/)[0]);

                        // Show extracted data
                        statusDiv.innerHTML = `
                            <div class="status-success">
                                ‚úÖ Workout Detected: ${workoutData.workoutName}<br>
                                Duration: ${workoutData.duration} min | Calories: ${workoutData.calories}
                            </div>
                            <button class="btn btn-success" onclick='confirmAppleWorkoutImport(${JSON.stringify(workoutData).replace(/'/g, "&apos;")})'>
                                ‚úÖ Confirm & Add to History
                            </button>
                            <button class="btn btn-secondary" onclick="document.getElementById('imageProcessingStatus').style.display='none'" style="margin-left: 10px;">
                                ‚ùå Cancel
                            </button>
                        `;
                        
                    } catch (error) {
                        console.error('Error processing image:', error);
                        
                        // Check if it's a rate limit error
                        if (error.message && (error.message.includes('429') || error.message.includes('Resource exhausted') || error.message.includes('quota'))) {
                            statusDiv.innerHTML = `
                                <div class="status-warning">
                                    <p style="font-weight: bold; margin-bottom: 10px;">‚ö†Ô∏è API Rate Limit Reached</p>
                                    <p style="margin-bottom: 10px;">The free Gemini API has usage limits. Please try one of these options:</p>
                                    <ol style="margin-left: 20px; line-height: 1.6;">
                                        <li><strong>Wait 1-2 minutes</strong> and try again</li>
                                        <li><strong>Manually log the workout:</strong>
                                            <ul style="margin-top: 5px; margin-left: 15px;">
                                                <li>Go to Workout tab ‚Üí Quick Log Cardio</li>
                                                <li>Or add workout to History ‚Üí Edit Stats</li>
                                            </ul>
                                        </li>
                                        <li><strong>Upgrade API plan</strong> at <a href="https://ai.google.dev/" target="_blank">ai.google.dev</a> for higher limits</li>
                                    </ol>
                                </div>
                            `;
                        } else {
                            // Other errors
                            statusDiv.innerHTML = `
                                <div class="status-error">
                                    <p style="font-weight: bold; margin-bottom: 10px;">‚ùå Error Analyzing Image</p>
                                    <p>Could not process the screenshot. Please check:</p>
                                    <ul style="margin-left: 20px; margin-top: 10px; line-height: 1.6;">
                                        <li>Screenshot is clear and readable</li>
                                        <li>It's from Apple Fitness app</li>
                                        <li>API key is valid</li>
                                    </ul>
                                    <p style="margin-top: 10px;"><strong>Error details:</strong> ${error.message}</p>
                                    <p style="margin-top: 10px;"><strong>Alternative:</strong> Manually log the workout using Quick Log Cardio or Edit Stats.</p>
                                </div>
                            `;
                        }
                    }
                };
                
                reader.onerror = () => {
                    statusDiv.innerHTML = '<p style="color: #f44336;">‚ùå Error reading image file. Please try again.</p>';
                };

            } catch (error) {
                console.error('Error processing image:', error);
                statusDiv.innerHTML = '<p style="color: #f44336;">‚ùå Error processing image. Please try again.</p>';
            }
        }
            // Helper function to get YYYY-MM-DD from a Date object without timezone shifting.
            function getLocalDateString(date) {
                const year = date.getFullYear();
                // Month is 0-indexed, so add 1
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }
        
        function confirmAppleWorkoutImport(workoutData) {
    
    // --- NEW: USER PROMPT FOR DATE AND TIME (FRIENDLIER FORMAT) ---

    const now = new Date();
    // 1. Get Date from user (pre-fill with MM-DD-YYYY)
    const defaultDate = now.toLocaleDateString('en-US').replace(/(\d{1,2})\/(\d{1,2})\/(\d{4})/, '$1-$2-$3'); // MM-DD-YYYY or M-D-YYYY
    const userDate = prompt('Please confirm the workout date (MM-DD-YYYY):', defaultDate);

    if (!userDate) {
        alert('Workout logging canceled.');
        document.getElementById('imageProcessingStatus').style.display = 'none';
        return;
    }

    // 2. Get Time from user (pre-fill with a common time, ask for HH:MM AM/PM)
    const defaultTime = now.toLocaleTimeString('en-US', {hour: '2-digit', minute:'2-digit', hour12: true});
    const userTime = prompt('Please confirm the workout time (HH:MM AM/PM, e.g., 5:22 PM):', defaultTime);

    if (!userTime) {
        alert('Workout logging canceled.');
        document.getElementById('imageProcessingStatus').style.display = 'none';
        return;
    }

    // Combine user date and time into a correct local date string
    // Example: "11/14/2023 5:22 PM"
    const localDateTimeString = `${userDate.replace(/-/g, '/')} ${userTime}`;
    
    // The Date constructor correctly handles local time when given a full date string like "11/14/2023 5:22 PM"
    const workoutDate = new Date(localDateTimeString);
    
    // Check for "Invalid Date"
    if (isNaN(workoutDate)) {
        alert('Invalid Date or Time entered. Workout logging canceled. Please use MM-DD-YYYY and HH:MM AM/PM format.');
        document.getElementById('imageProcessingStatus').style.display = 'none';
        return;
    }
            
            // ==================== DUPLICATE DETECTION ====================
    // Check if a workout already exists within 5 minutes of this time
    const existingWorkoutIndex = workoutHistory.findIndex(w => {
        const existingDate = new Date(w.date);
        const timeDiff = Math.abs(existingDate - workoutDate);
        const fiveMinutes = 5 * 60 * 1000; // 5 minutes in milliseconds
        
        // Consider it a match if within 5 minutes and same workout name
        return timeDiff < fiveMinutes && 
               (w.workoutName === workoutData.workoutName || 
                w.type === workoutData.workoutName);
    });

    if (existingWorkoutIndex !== -1) {
        // Workout already exists - ASK USER what to do
        const existingWorkout = workoutHistory[existingWorkoutIndex];
        const existingTime = new Date(existingWorkout.date).toLocaleTimeString();
        
        if (confirm(`‚ö†Ô∏è Found existing workout:\n\n"${existingWorkout.workoutName || existingWorkout.type}" at ${existingTime}\n\nDo you want to UPDATE this workout with Fitness Tracker data?\n\n‚úÖ Click OK to update existing workout\n‚ùå Click Cancel to create a new separate entry`)) {
            // UPDATE existing workout with Fitness Tracker data
            workoutHistory[existingWorkoutIndex].date = workoutDate.toISOString(); // FIX: Update date on the existing entry too!
            workoutHistory[existingWorkoutIndex].heartRate = workoutData.heartRate || existingWorkout.heartRate;
            workoutHistory[existingWorkoutIndex].calories = workoutData.calories || existingWorkout.calories;
            workoutHistory[existingWorkoutIndex].distance = workoutData.distance || existingWorkout.distance;
            workoutHistory[existingWorkoutIndex].distanceUnit = workoutData.distanceUnit || existingWorkout.distanceUnit;
            
            // If Fitness Tracker has exercise details, add/update them
            if (workoutData.exercises && workoutData.exercises.length > 0) {
                 // ... (existing logic to update exercises remains unchanged)
            }

            localStorage.setItem('workoutHistory', JSON.stringify(workoutHistory));
            
            // ... (rest of update logic remains unchanged)
            return;
        }
    }

    // ==================== CREATE NEW WORKOUT ====================
    // Either no duplicate found, or user chose to create new entry
    
    const workoutEntry = {
        id: Date.now(),
        date: workoutDate.toISOString(), // FIX: Use the new correct local time ISO string
        duration: (workoutData.duration || 0) * 60,
        totalVolume: 0,
        exercises: [],
        workoutName: workoutData.workoutName,
        type: workoutData.workoutName,
        heartRate: workoutData.heartRate || null,
        calories: workoutData.calories || null,
        distance: workoutData.distance || null,
        distanceUnit: workoutData.distanceUnit || null,
        source: 'Fitness Tracker Import'
    };
            // Add exercises if available
            if (workoutData.exercises && workoutData.exercises.length > 0) {
                workoutData.exercises.forEach(ex => {
                    const exerciseData = exerciseDatabase[ex.name] || {};
                    const isCardio = exerciseData.exerciseType === "cardio";
                    
                    if (isCardio) {
                        // Cardio exercise
                        workoutEntry.exercises.push({
                            name: ex.name,
                            duration: ex.duration || workoutData.duration || 0,
                            distance: ex.distance || workoutData.distance || 0,
                            distanceUnit: ex.distanceUnit || workoutData.distanceUnit || 'miles'
                        });
                    } else {
                        // Strength exercise
                        workoutEntry.exercises.push({
                            name: ex.name,
                            sets: ex.sets || 3,
                            reps: ex.reps || 12,
                            weight: ex.weight || 0
                        });
                    }
                });
            } else {
                // If no detailed exercises, create a generic cardio entry
                workoutEntry.exercises.push({
                    name: workoutData.workoutName,
                    duration: workoutData.duration || 0,
                    distance: workoutData.distance || 0,
                    distanceUnit: workoutData.distanceUnit || 'miles'
                });
            }

            // Add to workout history
            workoutHistory.push(workoutEntry);
            localStorage.setItem('workoutHistory', JSON.stringify(workoutHistory));
            
            // Show success message
            document.getElementById('imageProcessingStatus').innerHTML = `
                <div class="status-success">
                    ‚úÖ Workout successfully added to your history and calendar!<br>
                    <small>View it in the History or Calendar tab</small>
                </div>
            `;

            // Clear after 3 seconds
            setTimeout(() => {
                document.getElementById('imageProcessingStatus').style.display = 'none';
                document.getElementById('appleWorkoutImage').value = '';
            }, 3000);

            loadHistory();
            renderCalendar();

            alert(`‚úÖ ${workoutData.workoutName} imported successfully!\n\nDuration: ${workoutData.duration} min\nCalories: ${workoutData.calories || 'N/A'}\nDistance: ${workoutData.distance ? workoutData.distance + ' ' + workoutData.distanceUnit : 'N/A'}\n\nCheck your History and Calendar tabs!`);
        } 
        
        // ==================== RETRY LOGIC FOR API RATE LIMITS ====================
        async function apiCallWithRetry(url, options, retryCount = 0) {
            const MAX_RETRIES = 3;
            const BASE_DELAY_MS = 2000; // Start with 2 seconds
            
            try {
                const response = await fetch(url, options);
                
                // If rate limited and we have retries left
                if (response.status === 429 && retryCount < MAX_RETRIES) {
                    const delay = Math.pow(2, retryCount) * BASE_DELAY_MS + Math.random() * 1000;
                    console.warn(`Rate limit hit. Retrying in ${(delay / 1000).toFixed(1)} seconds... (Attempt ${retryCount + 1}/${MAX_RETRIES})`);
                    
                    // Show user feedback in chat if available
                    const messagesDiv = document.getElementById('messages');
                    if (messagesDiv) {
                        const retryMsg = document.createElement('div');
                        retryMsg.style.padding = '10px';
                        retryMsg.style.borderRadius = '8px';
                        retryMsg.style.background = '#fff3cd';
                        retryMsg.style.color = '#856404';
                        retryMsg.style.alignSelf = 'center';
                        retryMsg.style.fontSize = '13px';
                        retryMsg.textContent = `‚è≥ Rate limit reached. Retrying in ${(delay / 1000).toFixed(0)} seconds... (${retryCount + 1}/${MAX_RETRIES})`;
                        messagesDiv.appendChild(retryMsg);
                        messagesDiv.scrollTop = messagesDiv.scrollHeight;
                    }
                    
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return apiCallWithRetry(url, options, retryCount + 1); // Recursive retry
                }
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(`API error: ${response.status} - ${errorData.error?.message || response.statusText}`);
                }
                
                return await response.json();
                
            } catch (error) {
                if (retryCount >= MAX_RETRIES) {
                    console.error("Failed after maximum retries:", error);
                }
                throw error;
            }
        }
        
        async function sendMessage() {
            const msg = document.getElementById('userMessage').value.trim();
            if (!msg) return;

            addMsg(msg, 'user');
            document.getElementById('userMessage').value = '';

            const key = localStorage.getItem('geminiKey');
            if (!key) {
                alert('API key not set');
                return;
            }

            // THIS IS THE WORKING, DETAILED PROMPT
            const instruction_prompt = `You are a helpful AI fitness coach integrated into a workout app. Your primary goal is to assist the user. Analyze the user's request and respond in one of four ways:

1. If the user wants to create a standard strength workout (e.g., "give me a leg workout", "create a 30 minute dumbbell routine"):
Respond with a JSON object for the workout plan. The JSON must have this EXACT structure:
{"title": "Workout Name", "exercises": [{"name": "Exercise Name", "sets": number, "reps": number, "weight": number, "equipment": "e.g., Dumbbells", "description": "Detailed 2-3 sentence description of proper form"}]}

2. If the user wants to create a High-Intensity Interval Training (HIIT) workout (e.g., "give me a 20 minute HIIT workout", "bodyweight HIIT routine"):
Respond with a JSON object specifically for a HIIT workout. The JSON must have this EXACT structure:
{"title": "Workout Name", "workoutType": "hiit", "workTime": number, "restTime": number, "rounds": number, "exercises": [{"name": "Exercise Name", "description": "How to do the exercise. Assume bodyweight unless specified."}]}

3. If the user wants to add, fix, or update the details for a SINGLE exercise (e.g., "add instructions for farmers walk", "what's the equipment for a dumbbell squat?"):
Respond with a JSON object to update the app's database. The JSON must have this EXACT structure:
{"action": "update_exercise", "exerciseName": "Name Of The Exercise", "details": {"description": "Detailed instructions on how to perform the exercise.", "equipment": "The equipment needed."}}

4. If the user asks a general fitness question or wants advice (e.g., "what's the best way to warm up?", "should I do cardio before or after weights?", "how many rest days should I take?", "what's better for fat loss?"):
Respond conversationally with helpful, accurate fitness advice. Do NOT use JSON format for these responses - just respond naturally as a knowledgeable fitness coach.

For workout/HIIT creation or exercise updates (options 1-3), respond ONLY with the appropriate JSON format. For general questions and advice (option 4), respond conversationally without JSON.

User's request: ${msg}`;

            try {
                // Add timeout wrapper for iOS standalone mode
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout
                
                // Use retry logic for API calls
                const data = await apiCallWithRetry(
                    'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=' + key,
                    {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            contents: [{
                                parts: [{
                                    text: instruction_prompt
                                }]
                            }]
                        }),
                        signal: controller.signal,
                        mode: 'cors',
                        cache: 'no-cache'
                    }
                );

                clearTimeout(timeoutId);

                let resultText = 'Error getting response';
                if (data.candidates && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts[0]) {
                    resultText = data.candidates[0].content.parts[0].text;
                } else if (data.error) {
                    console.error('API Error Response:', data);
                    resultText = `API Error: ${data.error.message}. Please check your key.`;
                    addMsg(resultText, 'bot');
                    return;
                }

                // THIS IS THE WORKING PARSING LOGIC
                try {
                    const aiResponse = JSON.parse(resultText.match(/\{[\s\S]*\}/)[0]);

                    if (aiResponse.action === 'update_exercise') {
                        updateExerciseFromAI(aiResponse);
                    } else if (aiResponse.title && aiResponse.exercises) {
                        handleWorkoutCreation(aiResponse);
                    } else {
                        addMsg(resultText, 'bot');
                    }
                } catch (e) {
                    console.error('Failed to parse AI response as JSON:', e);
                    addMsg(resultText, 'bot');
                }

            } catch (e) {
                console.error('Network or other error:', e);
                if (e.name === 'AbortError') {
                    addMsg(`Request timeout. This may happen in standalone mode - try opening in Safari browser instead, or check your internet connection.`, 'bot');
                } else {
                    addMsg(`Error: ${e.message}. Make sure you are connected to the internet. If using home screen app, try opening in Safari.`, 'bot');
                }
            }
        }
        
        function handleWorkoutCreation(aiWorkout) {
            let workoutDetails;
            if (aiWorkout.workoutType === 'hiit') {
                workoutDetails = `Work: ${aiWorkout.workTime}s, Rest: ${aiWorkout.restTime}s, Rounds: ${aiWorkout.rounds}\n` +
                    aiWorkout.exercises.map(ex => `- ${ex.name}`).join('\n');
            } else {
                workoutDetails = aiWorkout.exercises.map(ex => `- ${ex.name}: ${ex.sets}x${ex.reps} @ ${ex.weight} lbs`).join('\n');
            }

            addMsg('Here is the workout I generated for you:', 'bot');
            addMsg(workoutDetails, 'bot');
            addMsg('Would you like me to save this workout in your app?', 'bot');

            const msgContainer = document.getElementById('messages');
            const buttonContainer = document.createElement('div');
            buttonContainer.style.display = 'flex';
            buttonContainer.style.gap = '10px';
            buttonContainer.style.marginTop = '10px';
            buttonContainer.style.justifyContent = 'center';

            const createBtn = document.createElement('button');
            createBtn.textContent = 'üíæ Save Workout';
            createBtn.className = 'btn btn-success';
            createBtn.style.width = 'auto';
            createBtn.style.padding = '10px 20px';
            createBtn.style.marginTop = '0';
            createBtn.onclick = () => {
                createWorkoutFromAI(aiWorkout);
                buttonContainer.remove();
            };

            const cancelBtn = document.createElement('button');
            cancelBtn.textContent = '‚ùå No Thanks';
            cancelBtn.className = 'btn btn-secondary';
            cancelBtn.style.width = 'auto';
            cancelBtn.style.padding = '10px 20px';
            cancelBtn.style.marginTop = '0';
            cancelBtn.onclick = () => buttonContainer.remove();

            buttonContainer.appendChild(createBtn);
            buttonContainer.appendChild(cancelBtn);
            msgContainer.appendChild(buttonContainer);
            msgContainer.scrollTop = msgContainer.scrollHeight;
        }

        function updateExerciseFromAI(data) {
            const { exerciseName, details } = data;
            if (!exerciseName || !details) {
                addMsg("I couldn't understand which exercise to update. Please try again.", 'bot');
                return;
            }

            const { description, equipment } = details;
            const customExercises = JSON.parse(localStorage.getItem('customExercises') || '{}');
            const existingExercise = customExercises[exerciseName] || exerciseDatabase[exerciseName] || {};
            const updatedExerciseData = {
                ...existingExercise,
                equipment: equipment || existingExercise.equipment || 'Various',
                instructions: description || existingExercise.instructions || 'No instructions provided.',
                image: existingExercise.image || 'AI Generated Exercise'
            };

            saveCustomExerciseToDB(exerciseName, updatedExerciseData);

            if (description) {
                exerciseDescriptions[exerciseName] = description;
                localStorage.setItem('exerciseDescriptions', JSON.stringify(exerciseDescriptions));
            }

            addMsg(`‚úÖ I've updated the details for "${exerciseName}" in the app's database.`, 'bot');
            renderExerciseList();
        }

        function createWorkoutFromAI(aiWorkout) {
            const savedCustomWorkouts = JSON.parse(localStorage.getItem('customWorkouts')) || {};
            let workoutName = aiWorkout.title || (aiWorkout.workoutType === 'hiit' ? 'AI HIIT Workout' : 'AI Strength Workout');
            let counter = 1;
            const originalName = workoutName;
            while (savedCustomWorkouts[workoutName]) {
                workoutName = `${originalName} (${counter})`;
                counter++;
            }

            if (aiWorkout.workoutType === 'hiit') {
                savedCustomWorkouts[workoutName] = {
                    workoutType: 'hiit',
                    workTime: aiWorkout.workTime || 30,
                    restTime: aiWorkout.restTime || 15,
                    rounds: aiWorkout.rounds || 4,
                    exercises: aiWorkout.exercises.map(ex => ({ name: ex.name }))
                };
            } else {
                savedCustomWorkouts[workoutName] = aiWorkout.exercises.map(ex => ({
                    name: ex.name,
                    sets: parseInt(ex.sets) || 3,
                    reps: parseInt(ex.reps) || 10,
                    weight: parseInt(ex.weight) || 0
                }));
            }

            const customExercises = JSON.parse(localStorage.getItem('customExercises') || '{}');
            aiWorkout.exercises.forEach(ex => {
                if (!exerciseDatabase[ex.name] && !customExercises[ex.name]) {
                    const newExerciseData = {
                        equipment: ex.equipment || 'Bodyweight',
                        instructions: ex.description || 'No specific instructions provided by AI.',
                        sets: parseInt(ex.sets) || 3,
                        reps: parseInt(ex.reps) || 10,
                        weight: parseInt(ex.weight) || 0,
                        image: 'AI Generated Exercise'
                    };
                    saveCustomExerciseToDB(ex.name, newExerciseData);
                }
                if (ex.description) {
                    exerciseDescriptions[ex.name] = ex.description;
                }
            });
            localStorage.setItem('exerciseDescriptions', JSON.stringify(exerciseDescriptions));

            localStorage.setItem('customWorkouts', JSON.stringify(savedCustomWorkouts));
            addMsg(`‚úÖ Workout saved! You can now find "${workoutName}" in the "Workout" tab.`, 'bot');

            loadCustomWorkoutsIntoDropdown();
            renderExerciseList();
        }

        async function generateExerciseDetailsWithAI() {
            const exerciseName = document.getElementById('newExerciseName').value.trim();
            if (!exerciseName) {
                alert('Please enter an exercise name first.');
                return;
            }

            const key = localStorage.getItem('geminiKey');
            if (!key) {
                alert('Please set up your API key in the AI Coach tab first.');
                return;
            }

            const btn = document.getElementById('aiGenerateBtn');
            btn.textContent = 'ü§ñ Generating...';
            btn.disabled = true;

            const prompt = `Provide a detailed description and the typical equipment for the exercise: "${exerciseName}". Respond ONLY with a JSON object in this exact format: {"description": "...", "equipment": "..."}`;

            try {
                // Add timeout wrapper for iOS standalone mode
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout
                
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${key}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }]
                    }),
                    signal: controller.signal,
                    mode: 'cors',
                    cache: 'no-cache'
                });

                clearTimeout(timeoutId);

                if (!response.ok) throw new Error('API request failed');
                
                const data = await response.json();
                const resultText = data.candidates[0].content.parts[0].text;
                const jsonResponse = JSON.parse(resultText.match(/\{[\s\S]*\}/)[0]);

                if (jsonResponse.description && jsonResponse.equipment) {
                    document.getElementById('newExerciseInstructions').value = jsonResponse.description;
                    document.getElementById('newExerciseEquipment').value = jsonResponse.equipment;
                } else {
                    alert('AI could not generate details in the correct format. Please try again.');
                }

            } catch (error) {
                console.error("AI Generation Error:", error);
                if (error.name === 'AbortError') {
                    alert('Request timeout. If using home screen app, try opening in Safari browser instead.');
                } else {
                    alert('An error occurred while generating details with AI. If using home screen app, try Safari instead.');
                }
            } finally {
                btn.textContent = 'ü§ñ Generate with AI';
                btn.disabled = false;
            }
            
        }
        
        // ===================================================================
        // END: AI COACH FUNCTIONS (RESTORED FROM WORKING FILE)
        // ===================================================================
       // ==================== RECOMMENDATION ENGINE ====================
        function loadRecommendation() {
            const container = document.getElementById('recommendationContainer');
            const history = JSON.parse(localStorage.getItem('workoutHistory') || '[]');
            let recommendationHtml = '';

            // Simple logic: if no workouts, recommend a full body workout.
            if (history.length === 0) {
                recommendationHtml = `
                    <div class="recommendation-card">
                        <h3>Welcome! Let's Get Started.</h3>
                        <p>Since you're new here, a great place to start is with a full body workout to engage all your major muscle groups.</p>
                        <button class="btn" onclick="document.querySelector('.nav-btn[onclick*=\'workout\']').click(); document.getElementById('workoutType').value='fullbody'; loadWorkout();">
                            Load Full Body Workout
                        </button>
                    </div>
                `;
            } else {
                // SMART RECOMMENDATION LOGIC
                const recommendation = generateSmartRecommendation(history);
                recommendationHtml = `
                    <div class="recommendation-card">
                        <h3>${recommendation.title}</h3>
                        <p>${recommendation.message}</p>
                        ${recommendation.reasoning ? `<p class="info-box" style="margin-top: 10px; font-size: 14px;"><strong>üí° Why?</strong> ${recommendation.reasoning}</p>` : ''}
                        ${recommendation.workoutType ? `
                            <button class="btn" onclick="document.querySelector('.nav-btn[onclick*=\'workout\']').click(); document.getElementById('workoutType').value='${recommendation.workoutType}'; loadWorkout();">
                                Load ${recommendation.workoutName} Workout
                            </button>
                        ` : `
                            <button class="btn" onclick="showSection('workout');">
                                Go to Workout Section
                            </button>
                        `}
                    </div>
                `;
            }

            container.innerHTML = recommendationHtml;
        }

        function generateSmartRecommendation(history) {
            const now = new Date();
            const today = now.toDateString();
            
            // Check if user worked out today
            const workedOutToday = history.some(w => new Date(w.date).toDateString() === today);
            
            if (workedOutToday) {
                return {
                    title: "üéâ Great Job Today!",
                    message: "You've already crushed a workout today! Your body needs time to recover and grow stronger.",
                    reasoning: "Rest and recovery are just as important as training. Consider light stretching, walking, or taking the day off completely."
                };
            }

            // Get last 7 days of workouts
            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
            const recentWorkouts = history.filter(w => new Date(w.date) >= sevenDaysAgo);

            // Check for consecutive workout days (potential overtraining)
            const last3Days = history.slice(0, 3);
            const consecutiveDays = checkConsecutiveDays(last3Days);
            
            if (consecutiveDays >= 3) {
                return {
                    title: "‚è∏Ô∏è Consider a Rest Day",
                    message: "You've worked out 3+ days in a row! Your muscles grow during rest, not during workouts.",
                    reasoning: "Overtraining can lead to injury and burnout. Take a rest day or do light cardio/stretching."
                };
            }

            // Analyze muscle groups trained recently
            const muscleGroupMap = {
                'chest': ['chest', 'press', 'fly', 'flyes', 'pushup', 'push-up', 'dips'],
                'back': ['back', 'row', 'pull', 'deadlift', 'lat'],
                'legs': ['leg', 'squat', 'lunge', 'calf', 'glute', 'thigh'],
                'shoulders': ['shoulder', 'lateral', 'overhead', 'military', 'shrug', 'delt'],
                'arms': ['curl', 'tricep', 'bicep', 'hammer', 'preacher'],
                'core': ['ab', 'core', 'crunch', 'plank', 'russian', 'mountain'],
                'cardio': ['hiit', 'bike', 'row', 'sprint', 'run', 'jump', 'cardio']
            };

            const recentMuscleGroups = {};
            const last5Workouts = history.slice(0, 5);

            last5Workouts.forEach(workout => {
                const workoutName = (workout.workoutName || '').toLowerCase();
                const exercises = workout.exercises || [];
                
                // Check workout name first
                for (const [group, keywords] of Object.entries(muscleGroupMap)) {
                    if (keywords.some(keyword => workoutName.includes(keyword))) {
                        recentMuscleGroups[group] = (recentMuscleGroups[group] || 0) + 2; // Weight workout names more
                    }
                }

                // Check individual exercises
                exercises.forEach(exercise => {
                    const exerciseName = (typeof exercise === 'object' ? exercise.name : exercise || '').toLowerCase();
                    for (const [group, keywords] of Object.entries(muscleGroupMap)) {
                        if (keywords.some(keyword => exerciseName.includes(keyword))) {
                            recentMuscleGroups[group] = (recentMuscleGroups[group] || 0) + 1;
                            break;
                        }
                    }
                });
            });

            // Find least trained muscle groups
            const allGroups = ['chest', 'back', 'legs', 'shoulders', 'arms', 'core', 'cardio'];
            const leastTrained = allGroups
                .map(group => ({ group, count: recentMuscleGroups[group] || 0 }))
                .sort((a, b) => a.count - b.count);

            // Check last workout to avoid same muscle group
            const lastWorkout = history[0];
            const lastWorkoutName = (lastWorkout.workoutName || '').toLowerCase();
            const lastMuscleGroup = findPrimaryMuscleGroup(lastWorkoutName, lastWorkout.exercises, muscleGroupMap);

            // Determine recommendation based on training history
            let recommendation = {};

            // If too much strength training, suggest cardio
            const strengthWorkouts = last5Workouts.filter(w => 
                (w.type !== 'HIIT' && w.type !== 'HIIT Workout') &&
                !w.workoutName?.toLowerCase().includes('cardio')
            ).length;

            if (strengthWorkouts >= 4 && (recentMuscleGroups['cardio'] || 0) === 0) {
                recommendation = {
                    title: "üèÉ Time for Cardio!",
                    message: "You've been crushing strength training! Let's add some cardio for heart health and fat burning.",
                    reasoning: "Balanced training includes cardiovascular exercise. HIIT is great for conditioning while maintaining muscle.",
                    workoutType: null,
                    workoutName: "HIIT"
                };
            }
            // If lots of cardio, suggest strength
            else if ((recentMuscleGroups['cardio'] || 0) >= 3) {
                const strengthGroup = leastTrained.find(g => g.group !== 'cardio');
                const workoutMapping = {
                    'chest': { type: 'chest', name: 'Chest' },
                    'back': { type: 'back', name: 'Back' },
                    'legs': { type: 'legs', name: 'Leg' },
                    'shoulders': { type: 'shoulders', name: 'Shoulder' },
                    'arms': { type: 'arms', name: 'Arm' },
                    'core': { type: 'abs', name: 'Core/Abs' }
                };
                
                const suggested = workoutMapping[strengthGroup.group];
                recommendation = {
                    title: "üí™ Build Some Muscle!",
                    message: `You've been doing lots of cardio! Let's build strength with a ${suggested.name} workout.`,
                    reasoning: `Your ${suggested.name.toLowerCase()} muscles haven't been trained recently. Time to focus on strength!`,
                    workoutType: suggested.type,
                    workoutName: suggested.name
                };
            }
            // Suggest least trained muscle group
            else {
                const targetGroup = leastTrained[0];
                
                // Avoid suggesting same as last workout
                let suggestedGroup = targetGroup;
                if (targetGroup.group === lastMuscleGroup && leastTrained.length > 1) {
                    suggestedGroup = leastTrained[1];
                }

                const workoutMapping = {
                    'chest': { type: 'chest', name: 'Chest', emoji: 'üí™' },
                    'back': { type: 'back', name: 'Back', emoji: 'üîô' },
                    'legs': { type: 'legs', name: 'Leg', emoji: 'ü¶µ' },
                    'shoulders': { type: 'shoulders', name: 'Shoulder', emoji: 'üí™' },
                    'arms': { type: 'arms', name: 'Arm', emoji: 'üí™' },
                    'core': { type: 'abs', name: 'Core/Abs', emoji: 'üéØ' },
                    'cardio': { type: null, name: 'HIIT/Cardio', emoji: 'üèÉ' }
                };

                const suggested = workoutMapping[suggestedGroup.group] || workoutMapping['chest'];
                
                recommendation = {
                    title: `${suggested.emoji} ${suggested.name} Day!`,
                    message: `Your last workout was ${lastWorkout.workoutName}. Today's perfect for training ${suggested.name.toLowerCase()}!`,
                    reasoning: `You haven't trained ${suggested.name.toLowerCase()} recently. Balanced training targets all muscle groups throughout the week.`,
                    workoutType: suggested.type,
                    workoutName: suggested.name
                };
            }

            return recommendation;
        }

        function checkConsecutiveDays(workouts) {
            if (workouts.length === 0) return 0;
            
            let consecutive = 1;
            for (let i = 0; i < workouts.length - 1; i++) {
                const current = new Date(workouts[i].date);
                const next = new Date(workouts[i + 1].date);
                const daysDiff = Math.floor((current - next) / (1000 * 60 * 60 * 24));
                
                if (daysDiff === 1) {
                    consecutive++;
                } else {
                    break;
                }
            }
            return consecutive;
        }

        function findPrimaryMuscleGroup(workoutName, exercises, muscleGroupMap) {
            // Check workout name first
            for (const [group, keywords] of Object.entries(muscleGroupMap)) {
                if (keywords.some(keyword => workoutName.includes(keyword))) {
                    return group;
                }
            }

            // Check exercises
            const groupCounts = {};
            (exercises || []).forEach(exercise => {
                const exerciseName = (typeof exercise === 'object' ? exercise.name : exercise || '').toLowerCase();
                for (const [group, keywords] of Object.entries(muscleGroupMap)) {
                    if (keywords.some(keyword => exerciseName.includes(keyword))) {
                        groupCounts[group] = (groupCounts[group] || 0) + 1;
                        break;
                    }
                }
            });

            // Return most common group
            const sorted = Object.entries(groupCounts).sort((a, b) => b[1] - a[1]);
            return sorted.length > 0 ? sorted[0][0] : 'chest';
        }
        // ==================== PROGRESS TRACKING ====================
        function updateProgress() {
            const history = JSON.parse(localStorage.getItem('workoutHistory') || '[]');
            
            // Total workouts
            document.getElementById('totalWorkouts').textContent = history.length;

            // This week
            const oneWeekAgo = new Date();
            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
            const thisWeek = history.filter(w => new Date(w.date) >= oneWeekAgo).length;
            document.getElementById('thisWeek').textContent = thisWeek;

            // This month
            const oneMonthAgo = new Date();
            oneMonthAgo.setMonth(oneMonthAgo.getMonth() - 1);
            const thisMonth = history.filter(w => new Date(w.date) >= oneMonthAgo).length;
            document.getElementById('thisMonth').textContent = thisMonth;

            // Total volume
            let totalVolume = 0;
            history.forEach(workout => {
                workout.exercises.forEach(exercise => {
                    totalVolume += (exercise.weight || 0) * (exercise.sets || 0) * (exercise.reps || 0);
                });
            });
            document.getElementById('totalVolume').textContent = totalVolume.toLocaleString();

            // Streak
            const streak = calculateStreak(history);
            document.getElementById('streak').textContent = streak;

            // NEW METRICS
            updateAverageDuration(history);
            updateCaloriesBurned(history);
            updateWorkoutFrequency(history);
            updatePersonalRecordsCount();
            updateConsistencyScore(history);
            updateHeaviestLift(history);
            updateCompletionRate(history);

            // Workout distribution
            updateWorkoutDistribution(history);

            // Muscle group distribution
            updateMuscleGroupDistribution(history);

            // Volume progress
            updateVolumeProgress(history);

            // Volume trend
            updateVolumeTrend(history);

            // Exercise variety
            updateExerciseVariety(history);

            // Rest between workouts
            updateRestBetweenWorkouts(history);
        }

        function calculateStreak(history) {
            if (history.length === 0) return 0;

            const sortedDates = history
                .map(w => new Date(w.date).toDateString())
                .filter((date, index, self) => self.indexOf(date) === index)
                .sort((a, b) => new Date(b) - new Date(a));

            let streak = 0;
            let currentDate = new Date();

            for (let i = 0; i < sortedDates.length; i++) {
                const workoutDate = new Date(sortedDates[i]);
                const diffDays = Math.floor((currentDate - workoutDate) / (1000 * 60 * 60 * 24));

                if (diffDays === streak || (streak === 0 && diffDays === 0)) {
                    streak++;
                    currentDate = workoutDate;
                } else {
                    break;
                }
            }

            return streak;
        }

        function updateWorkoutDistribution(history) {
            const container = document.getElementById('workoutDistribution');
            const distribution = {};

            history.forEach(workout => {
                const type = workout.workoutName || 'Custom';
                distribution[type] = (distribution[type] || 0) + 1;
            });

            const sortedTypes = Object.entries(distribution)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);

            if (sortedTypes.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6c757d;">No workout data yet</p>';
                return;
            }

            const maxCount = Math.max(...sortedTypes.map(([_, count]) => count));

            let html = '';
            sortedTypes.forEach(([type, count]) => {
                const percentage = (count / maxCount) * 100;
                html += `
                    <div class="chart-bar">
                        <div class="chart-label">${type}</div>
                        <div class="chart-fill" style="width: ${percentage}%;">
                            <div class="chart-value">${count}</div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function updateVolumeProgress(history) {
            const container = document.getElementById('volumeProgress');
            const last10 = history.slice(0, 10).reverse();

            if (last10.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6c757d;">No workout data yet</p>';
                return;
            }

            const volumes = last10.map(workout => {
                let volume = 0;
                workout.exercises.forEach(exercise => {
                    volume += (exercise.weight || 0) * (exercise.sets || 0) * (exercise.reps || 0);
                });
                return volume;
            });

            const maxVolume = Math.max(...volumes);

            let html = '';
            last10.forEach((workout, index) => {
                const volume = volumes[index];
                const percentage = (volume / maxVolume) * 100;
                const date = new Date(workout.date).toLocaleDateString();

                html += `
                    <div class="chart-bar">
                        <div class="chart-label">${date}</div>
                        <div class="chart-fill" style="width: ${percentage}%;">
                            <div class="chart-value">${volume.toLocaleString()}</div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }
// ==================== NEW ENHANCED METRICS ====================
        
        function updateAverageDuration(history) {
            if (history.length === 0) {
                document.getElementById('avgDuration').textContent = '0:00';
                return;
            }

            const totalDuration = history.reduce((sum, w) => sum + (w.duration || 0), 0);
            const avgSeconds = Math.floor(totalDuration / history.length);
            const minutes = Math.floor(avgSeconds / 60);
            const seconds = avgSeconds % 60;
            
            document.getElementById('avgDuration').textContent = `${minutes}:${String(seconds).padStart(2, '0')}`;
        }

         function updateCaloriesBurned(history) {
            const calorieSettings = JSON.parse(localStorage.getItem('calorieSettings') || '{"method": "automatic", "multiplier": 1.0}');
            let totalCalories = 0;

            history.forEach(workout => {
                // Check both workout.calories (from AI/edit) and workout.caloriesBurned (legacy)
                const workoutCalories = workout.calories || workout.caloriesBurned;
                
                if (workoutCalories && workoutCalories > 0) {
                    // Use actual calories if available
                    totalCalories += workoutCalories;
                } else if (calorieSettings.method === 'manual') {
                    // Manual mode with no calories recorded = skip estimation
                    // Do nothing (don't estimate)
                } else {
                    // Automatic estimation when no calories are recorded
                    const duration = (workout.duration || 0) / 60; // Convert to minutes
                    const multiplier = parseFloat(calorieSettings.multiplier) || 1.0;
                    
                    if (workout.type === 'HIIT' || workout.type === 'HIIT Workout') {
                        totalCalories += duration * 10 * multiplier; // 10 cal/min for HIIT
                    } else {
                        totalCalories += duration * 5 * multiplier; // 5 cal/min for strength
                    }
                }
            });

            document.getElementById('caloriesBurned').textContent = Math.round(totalCalories).toLocaleString();
        }
        function updateWorkoutFrequency(history) {
            if (history.length === 0) {
                document.getElementById('workoutFrequency').textContent = '0';
                return;
            }

            const oldestWorkout = new Date(history[history.length - 1].date);
            const newestWorkout = new Date(history[0].date);
            const weeksDiff = Math.max(1, (newestWorkout - oldestWorkout) / (1000 * 60 * 60 * 24 * 7));
            const frequency = (history.length / weeksDiff).toFixed(1);

            document.getElementById('workoutFrequency').textContent = frequency;
        }

        function updatePersonalRecordsCount() {
            const prs = JSON.parse(localStorage.getItem('personalRecords') || '{}');
            const prCount = Object.keys(prs).length;
            document.getElementById('personalRecordsCount').textContent = prCount;
        }

        function updateConsistencyScore(history) {
            if (history.length === 0) {
                document.getElementById('consistencyScore').textContent = '0%';
                return;
            }

            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            
            const recentWorkouts = history.filter(w => new Date(w.date) >= thirtyDaysAgo);
            const targetWorkouts = 12; // 3 per week for 4 weeks
            const consistency = Math.min(100, Math.round((recentWorkouts.length / targetWorkouts) * 100));

            document.getElementById('consistencyScore').textContent = `${consistency}%`;
        }

        function updateHeaviestLift(history) {
            let heaviest = 0;

            history.forEach(workout => {
                if (workout.exercises && Array.isArray(workout.exercises)) {
                    workout.exercises.forEach(exercise => {
                        if (typeof exercise === 'object' && exercise.weight) {
                            heaviest = Math.max(heaviest, exercise.weight);
                        }
                    });
                }
            });

            document.getElementById('heaviestLift').textContent = heaviest;
        }

        function updateCompletionRate(history) {
            // This tracks workouts that were completed vs ended early
            // We'll consider any workout saved as "completed" for now
            // You could enhance this by tracking which workouts were ended early
            const completed = history.length;
            const total = history.length; // In future, track attempted workouts
            
            const rate = total > 0 ? Math.round((completed / total) * 100) : 0;
            document.getElementById('completionRate').textContent = `${rate}%`;
        }

        function updateMuscleGroupDistribution(history) {
            const container = document.getElementById('muscleGroupDistribution');
            const muscleGroups = {};

            // Map exercises to muscle groups
            const muscleGroupMap = {
                'Chest': ['Press', 'Fly', 'Flyes', 'Push-Up', 'Dips', 'Chest', 'Pushup'],
                'Back': ['Row', 'Pull', 'Deadlift', 'Lat', 'Back'],
                'Legs': ['Squat', 'Lunge', 'Leg', 'Calf', 'Bulgarian', 'Step-Up', 'Glute'],
                'Shoulders': ['Shoulder', 'Lateral', 'Front Raise', 'Overhead', 'Military', 'Shrug'],
                'Arms': ['Curl', 'Tricep', 'Bicep', 'Hammer', 'Preacher'],
                'Core': ['Crunch', 'Plank', 'Ab', 'Russian', 'Mountain', 'Bicycle', 'Side Bend'],
                'Cardio': ['HIIT', 'Bike', 'Row', 'Sprint', 'Run', 'Jump']
            };

            history.forEach(workout => {
                if (workout.exercises && Array.isArray(workout.exercises)) {
                    workout.exercises.forEach(exercise => {
                        const exerciseName = typeof exercise === 'object' ? exercise.name : exercise;
                        
                        // Determine muscle group
                        for (const [group, keywords] of Object.entries(muscleGroupMap)) {
                            if (keywords.some(keyword => exerciseName.includes(keyword))) {
                                muscleGroups[group] = (muscleGroups[group] || 0) + 1;
                                break;
                            }
                        }
                    });
                }
            });

            const sortedGroups = Object.entries(muscleGroups)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 7);

            if (sortedGroups.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6c757d;">No workout data yet</p>';
                return;
            }

            const maxCount = Math.max(...sortedGroups.map(([_, count]) => count));

            let html = '';
            sortedGroups.forEach(([group, count]) => {
                const percentage = (count / maxCount) * 100;
                html += `
                    <div class="chart-bar">
                        <div class="chart-label">${group}</div>
                        <div class="chart-fill" style="width: ${percentage}%;">
                            <div class="chart-value">${count}</div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function updateVolumeTrend(history) {
            const container = document.getElementById('volumeTrend');
            
            if (history.length < 2) {
                container.innerHTML = '<p style="text-align: center; color: #6c757d;">Need at least 2 workouts to show trend</p>';
                return;
            }

            const last10 = history.slice(0, 10).reverse();
            const volumes = last10.map(workout => {
                let volume = 0;
                workout.exercises.forEach(exercise => {
                    volume += (exercise.weight || 0) * (exercise.sets || 0) * (exercise.reps || 0);
                });
                return volume;
            });

            // Calculate trend
            const firstHalf = volumes.slice(0, Math.floor(volumes.length / 2));
            const secondHalf = volumes.slice(Math.floor(volumes.length / 2));
            
            const firstAvg = firstHalf.reduce((a, b) => a + b, 0) / firstHalf.length;
            const secondAvg = secondHalf.reduce((a, b) => a + b, 0) / secondHalf.length;
            
            const percentChange = ((secondAvg - firstAvg) / firstAvg * 100).toFixed(1);
            const trend = percentChange > 0 ? 'üìà Increasing' : percentChange < 0 ? 'üìâ Decreasing' : '‚û°Ô∏è Stable';
            const trendColor = percentChange > 0 ? '#28a745' : percentChange < 0 ? '#dc3545' : '#6c757d';

            container.innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <div style="font-size: 32px; font-weight: bold; color: ${trendColor};">${trend}</div>
                    <div style="font-size: 24px; margin-top: 10px; color: ${trendColor};">${percentChange}%</div>
                    <p style="margin-top: 10px; color: #6c757d;">Comparing first half vs second half of last ${volumes.length} workouts</p>
                </div>
            `;
        }

        function updateExerciseVariety(history) {
            const container = document.getElementById('exerciseVariety');
            
            if (history.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6c757d;">No workout data yet</p>';
                return;
            }

            const uniqueExercises = new Set();
            history.forEach(workout => {
                if (workout.exercises && Array.isArray(workout.exercises)) {
                    workout.exercises.forEach(exercise => {
                        const exerciseName = typeof exercise === 'object' ? exercise.name : exercise;
                        uniqueExercises.add(exerciseName);
                    });
                }
            });

            const varietyCount = uniqueExercises.size;
            const totalExercisesInDatabase = Object.keys(exerciseDatabase).length + Object.keys(JSON.parse(localStorage.getItem('customExercises') || '{}')).length;
            const varietyPercentage = Math.round((varietyCount / totalExercisesInDatabase) * 100);

            let varietyRating = 'Beginner';
            let varietyColor = '#dc3545';
            if (varietyCount > 50) {
                varietyRating = 'Master';
                varietyColor = '#d4af37';
            } else if (varietyCount > 30) {
                varietyRating = 'Advanced';
                varietyColor = '#28a745';
            } else if (varietyCount > 15) {
                varietyRating = 'Intermediate';
                varietyColor = '#ffc107';
            }

            container.innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <div style="font-size: 32px; font-weight: bold; color: ${varietyColor};">${varietyRating}</div>
                    <div style="font-size: 48px; margin-top: 10px; font-weight: bold; color: ${currentCardTextColor};">${varietyCount}</div>
                    <p style="margin-top: 10px; color: #6c757d;">Unique exercises performed (${varietyPercentage}% of available)</p>
                </div>
            `;
        }

        function updateRestBetweenWorkouts(history) {
            const container = document.getElementById('restBetweenWorkouts');
            
            if (history.length < 2) {
                container.innerHTML = '<p style="text-align: center; color: #6c757d;">Need at least 2 workouts to calculate</p>';
                return;
            }

            const sortedHistory = [...history].sort((a, b) => new Date(b.date) - new Date(a.date));
            let totalRestDays = 0;
            let restPeriods = 0;

            for (let i = 0; i < sortedHistory.length - 1; i++) {
                const current = new Date(sortedHistory[i].date);
                const next = new Date(sortedHistory[i + 1].date);
                const daysDiff = Math.floor((current - next) / (1000 * 60 * 60 * 24));
                
                if (daysDiff > 0) {
                    totalRestDays += daysDiff;
                    restPeriods++;
                }
            }

            const avgRest = restPeriods > 0 ? (totalRestDays / restPeriods).toFixed(1) : 0;
            
            let restRating = '';
            let restColor = '#6c757d';
            if (avgRest < 1) {
                restRating = '‚ö†Ô∏è Very Frequent';
                restColor = '#ffc107';
            } else if (avgRest <= 2) {
                restRating = '‚úÖ Optimal';
                restColor = '#28a745';
            } else if (avgRest <= 4) {
                restRating = 'üëç Good';
                restColor = '#003d5c';
            } else {
                restRating = '‚è∏Ô∏è Infrequent';
                restColor = '#dc3545';
            }

            container.innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <div style="font-size: 48px; font-weight: bold; color: ${currentCardTextColor};">${avgRest}</div>
                    <p style="margin-top: 10px; color: #6c757d;">Average days between workouts</p>
                    <div style="font-size: 20px; margin-top: 10px; font-weight: bold; color: ${restColor};">${restRating}</div>
                </div>
            `;
        }

        // ==================== CALORIE MODAL FUNCTIONS ====================
        
        function openCalorieModal() {
            const settings = JSON.parse(localStorage.getItem('calorieSettings') || '{"method": "automatic", "multiplier": 1.0}');
            
            document.getElementById('calorieTrackingMethod').value = settings.method || 'automatic';
            document.getElementById('calorieMultiplier').value = settings.multiplier || 1.0;
            
            toggleCalorieInputMethod();
            showModalById('calorieModal');
        }

        function toggleCalorieInputMethod() {
            const method = document.getElementById('calorieTrackingMethod').value;
            const automaticDiv = document.getElementById('automaticCalorieInfo');
            const manualDiv = document.getElementById('manualCalorieInfo');
            
            if (method === 'automatic') {
                automaticDiv.style.display = 'block';
                manualDiv.style.display = 'none';
            } else {
                automaticDiv.style.display = 'none';
                manualDiv.style.display = 'block';
            }
        }
        
        function saveCalorieSettings() {
            const method = document.getElementById('calorieTrackingMethod').value;
            const multiplier = document.getElementById('calorieMultiplier').value;
            
            const settings = {
                method: method,
                multiplier: parseFloat(multiplier) || 1.0
            };
            
            localStorage.setItem('calorieSettings', JSON.stringify(settings));
            alert('Calorie tracking settings saved!');
            closeModal(document.getElementById('calorieModal'));
            updateProgress(); // Refresh the progress display
        }

        // ==================== WORKOUT HISTORY ====================
        function loadHistory() {
            const container = document.getElementById('historyContainer');
            const history = JSON.parse(localStorage.getItem('workoutHistory') || '[]');

            if (history.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6c757d;">No workout history yet. Complete your first workout!</p>';
                return;
            }

            const prs = JSON.parse(localStorage.getItem('personalRecords') || '{}');

            let html = '';
            history.forEach((workout, index) => {
                const date = new Date(workout.date);
                const duration = workout.duration;
                const minutes = Math.floor(duration / 60);
                const seconds = duration % 60;

                let exercisesSummary = '';
                if (workout.type === 'HIIT') {
                    exercisesSummary = `${workout.exercises.length} exercises √ó ${workout.hiitParams?.rounds || 'N/A'} rounds`;
                } else {
                    exercisesSummary = workout.exercises.map(e => e.name).join(', ');
                }

                html += `
                    <div class="history-item">
                        <div class="history-header">
                            <div>
                                <div class="history-date">${date.toLocaleDateString()} - ${date.toLocaleTimeString()}</div>
                                <div class="history-type">${workout.workoutName || 'Custom'} (${workout.type})</div>
                            </div>
                            <div class="history-duration">${minutes}:${String(seconds).padStart(2, '0')}</div>
                        </div>
                        ${workout.heartRate || workout.calories || workout.distance ? `
                            <div class="history-stats-box">
                                ${workout.heartRate ? `üíì Avg HR: <strong>${workout.heartRate} BPM</strong> &nbsp;|&nbsp; ` : ''}
                                ${workout.calories ? `üî• Calories: <strong>${workout.calories}</strong> &nbsp;|&nbsp; ` : ''}
                                ${workout.distance ? `üìè Distance: <strong>${workout.distance} ${workout.distanceUnit}</strong>` : ''}
                            </div>
                        ` : ''}
                        <div class="history-exercises">
                            ${exercisesSummary}
                        </div>
                        ${workout.notes ? `<div class="history-notes">üìù ${workout.notes}</div>` : ''}
                        <div class="history-details-body">
                `;

                // Check if exercises exist and determine type
               if (Array.isArray(workout.exercises) && workout.exercises.length > 0) {
                    // Check if the first exercise item is an object (strength or single cardio log)
                    if (typeof workout.exercises[0] === 'object' && workout.exercises[0] !== null && workout.exercises[0].name) {
                        workout.exercises.forEach(exercise => {
                            const isPR = isPersonalRecord(exercise.name, exercise.weight) && exercise.weight > 0;
                            
                            // NEW CHECK: Use property existence to determine cardio vs. strength
                            const isCardioLog = exercise.duration !== undefined; // If it has a duration property, treat it as a logged cardio exercise.

                            html += `
                                <div class="history-exercise-detail">
                                    <span class="history-exercise-name">
                                        ${exercise.name}
                                        ${isPR ? '<span class="pr-badge">PR!</span>' : ''}
                                    </span>
                                    <span class="history-exercise-stats">
                                        ${isCardioLog ? 
                                            // FIX: Prioritize exercise.distanceUnit, then the workout's top-level unit, then 'mi'
                                            `${exercise.duration || 0} min${exercise.distance ? ` | ${exercise.distance} ${exercise.distanceUnit || workout.distanceUnit || 'mi'}` : ''}` :
                                            // Displays strength stats
                                            `${exercise.sets || 0}x${exercise.reps || 0} @ ${exercise.weight || 0}lbs`
                                        }
                                    </span>
                                </div>
                            `;
                        });
                    }  
                    // Case 2: HIIT workout - exercises are just strings (exercise names)
                    else {
                        html += `
                            <div class="history-exercise-detail">
                                <strong>Exercises:</strong> ${workout.exercises.join(', ')}
                            </div>
                        `;
                        if (workout.rounds) {
                            html += `
                                <div class="history-exercise-detail">
                                    <strong>Rounds Completed:</strong> ${workout.rounds}
                                </div>
                            `;
                        }
                    }
                } else {
                    html += `<div class="history-exercise-detail">No exercise data available.</div>`;
                }

                html += `
                        </div>
                        <div style="display: flex; gap: 10px; margin-top: 15px;">
                            <button class="btn btn-secondary" onclick="editWorkoutStats(${index})" style="flex: 1; padding: 12px 20px; margin-top: 0;">
                                ‚úèÔ∏è Edit Stats
                            </button>
                            <button class="btn btn-danger" onclick="deleteWorkout(${index})" style="flex: 1; padding: 12px 20px; margin-top: 0;">
                                üóëÔ∏è Delete
                            </button>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }
        // ==================== EDIT WORKOUT STATS ====================
        let currentEditingWorkoutIndex = null;

        function editWorkoutStats(index) {
            currentEditingWorkoutIndex = index;
            const history = JSON.parse(localStorage.getItem('workoutHistory') || '[]');
            const workout = history[index];

            const isoString = workout.date;
            const datePart = isoString.substring(0, 10); // YYYY-MM-DD
            const timePart = isoString.substring(11, 16); // HH:MM from "YYYY-MM-DDTHH:MM:SS.sssZ"

            document.getElementById('editWorkoutDate').value = datePart;
            document.getElementById('editWorkoutTime').value = timePart; 
            document.getElementById('editWorkoutName').value = workout.workoutName || '';
            
            const durationInMinutes = Math.round((workout.duration || 0) / 60);
            
            document.getElementById('editDurationMinutes').value = durationInMinutes || '';
            
            document.getElementById('editHeartRate').value = workout.heartRate || '';
            document.getElementById('editCalories').value = workout.calories || '';
            document.getElementById('editDistance').value = workout.distance || '';
            document.getElementById('editDistanceUnit').value = workout.distanceUnit || '';
            document.getElementById('editWorkoutNotes').value = workout.notes || '';

            showModalById('editStatsModal');
        }

        function saveWorkoutStats() {
            if (currentEditingWorkoutIndex === null) return;

            const history = JSON.parse(localStorage.getItem('workoutHistory') || '[]');
            const workout = history[currentEditingWorkoutIndex];

            const newDate = document.getElementById('editWorkoutDate').value;
            const newTime = document.getElementById('editWorkoutTime').value;

            if (newDate && newTime) {
                 const oldIsoString = workout.date;
                 const oldSeconds = oldIsoString.substring(17, 23);
                 workout.date = `${newDate}T${newTime}${oldSeconds}`;
            }
            workout.workoutName = document.getElementById('editWorkoutName').value.trim() || workout.workoutName;
            
            const durationMinutes = parseInt(document.getElementById('editDurationMinutes').value);
            if (!isNaN(durationMinutes) && durationMinutes > 0) {
                workout.duration = durationMinutes * 60;
            } else {
                workout.duration = 0;
            }
            workout.heartRate = parseInt(document.getElementById('editHeartRate').value) || null;
            workout.calories = parseInt(document.getElementById('editCalories').value) || null;
            
            const distance = parseFloat(document.getElementById('editDistance').value);
            const distanceUnit = document.getElementById('editDistanceUnit').value;
            
            if (distance && distanceUnit) {
                workout.distance = distance;
                workout.distanceUnit = distanceUnit;
                
                if (Array.isArray(workout.exercises) && workout.exercises.length > 0) {
                    workout.exercises.forEach(exercise => {
                        if (exercise.distance !== undefined) {
                            exercise.distance = distance;
                            exercise.distanceUnit = distanceUnit;
                        }
                    });
                }
            } else {
                workout.distance = null;
                workout.distanceUnit = null;
                
                if (Array.isArray(workout.exercises) && workout.exercises.length > 0) {
                    workout.exercises.forEach(exercise => {
                        if (exercise.distance !== undefined) {
                            exercise.distance = null;
                            exercise.distanceUnit = null;
                        }
                    });
                }
            }
            
            workout.notes = document.getElementById('editWorkoutNotes').value.trim() || '';

            localStorage.setItem('workoutHistory', JSON.stringify(history));
            workoutHistory = history;

            loadHistory();
            renderCalendar();

            closeModal(document.getElementById('editStatsModal'));
            currentEditingWorkoutIndex = null;
            alert('‚úÖ Workout stats updated successfully!');
        }

        function deleteWorkout(index) {
            if (!confirm('Are you sure you want to delete this workout? This cannot be undone.')) {
                return;
            }

            const history = JSON.parse(localStorage.getItem('workoutHistory') || '[]');
            history.splice(index, 1);
            localStorage.setItem('workoutHistory', JSON.stringify(history));

            loadHistory();
            updateProgress();
            renderCalendar();
        }

        // ==================== CALENDAR FUNCTIONS ====================
        function renderCalendar() {
            const view = currentCalendarView;
            
            if (view === 'month') {
                renderMonthView();
            } else if (view === 'week') {
                renderWeekView();
            } else if (view === 'day') {
                renderDayView();
            }
        }

        function renderMonthView() {
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            
            document.getElementById('calendarMonthYear').textContent = 
                `${currentCalendarDate.toLocaleString('default', { month: 'long' })} ${year}`;

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startingDayOfWeek = firstDay.getDay();
            const daysInMonth = lastDay.getDate();

            const history = JSON.parse(localStorage.getItem('workoutHistory') || '[]');
            const workoutDates = getWorkoutDateCounts(history);
            const restDays = getRecommendedRestDays(history);

            let html = '<div class="calendar-grid">';
            
            const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            dayNames.forEach(day => {
                html += `<div class="calendar-day-header">${day}</div>`;
            });

            const prevMonthLastDay = new Date(year, month, 0).getDate();
            for (let i = startingDayOfWeek - 1; i >= 0; i--) {
                const day = prevMonthLastDay - i;
                html += `<div class="calendar-day other-month"><div class="day-number">${day}</div></div>`;
            }

            const today = new Date();
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dateString = date.toISOString().split('T')[0];
                const isToday = date.toDateString() === today.toDateString();
                const workoutCount = workoutDates[dateString] || 0;
                const isRestDay = restDays.includes(dateString);

                let classes = 'calendar-day';
                if (isToday) classes += ' today';
                if (workoutCount > 0) classes += ' has-workout';
                if (isRestDay && workoutCount === 0) classes += ' rest-day';

                html += `
                    <div class="${classes}" onclick="showDayDetail('${dateString}')">
                        <div class="day-number">${day}</div>
                        ${workoutCount > 0 ? `<div class="day-workout-count">${workoutCount} workout${workoutCount > 1 ? 's' : ''}</div>` : ''}
                        ${isRestDay && workoutCount === 0 ? '<div class="rest-indicator">Rest Day</div>' : ''}
                    </div>
                `;
            }

            const remainingCells = 42 - (startingDayOfWeek + daysInMonth);
            for (let day = 1; day <= remainingCells; day++) {
                html += `<div class="calendar-day other-month"><div class="day-number">${day}</div></div>`;
            }

            html += '</div>';
            document.getElementById('calendarContent').innerHTML = html;
        }

        function renderWeekView() {
            const startOfWeek = new Date(currentCalendarDate);
            startOfWeek.setDate(currentCalendarDate.getDate() - currentCalendarDate.getDay());

            document.getElementById('calendarMonthYear').textContent = 
                `Week of ${startOfWeek.toLocaleDateString()}`;

            const history = JSON.parse(localStorage.getItem('workoutHistory') || '[]');
            const workoutDates = getWorkoutDateCounts(history);
            const restDays = getRecommendedRestDays(history);

            let html = '<div class="weekly-view">';

            for (let i = 0; i < 7; i++) {
                const date = new Date(startOfWeek);
                date.setDate(startOfWeek.getDate() + i);
                const dateString = date.toISOString().split('T')[0];
                const workoutCount = workoutDates[dateString] || 0;
                const isRestDay = restDays.includes(dateString);
                const isToday = date.toDateString() === new Date().toDateString();

                let classes = 'week-day-card';
                if (workoutCount > 0) classes += ' has-workout';
                if (isRestDay && workoutCount === 0) classes += ' rest-day';

                html += `
                     <div class="${classes}" onclick="showDayDetail('${dateString}')">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-weight: 700; font-size: 16px;">
                                    ${date.toLocaleDateString('default', { weekday: 'long' })}
                                    ${isToday ? ' (Today)' : ''}
                                </div>
                                <div style="font-size: 14px;">${date.toLocaleDateString()}</div>
                            </div>
                            <div style="text-align: right;">
                                ${workoutCount > 0 ? `<div style="font-size: 20px; font-weight: 700;">${workoutCount} workout${workoutCount > 1 ? 's' : ''}</div>` : ''}
                                ${isRestDay && workoutCount === 0 ? '<div style="font-size: 14px;">Rest Day</div>' : ''}
                                ${workoutCount === 0 && !isRestDay ? '<div style="font-size: 14px;">No workout</div>' : ''}
                            </div>
                        </div>
                    </div>
                `;
            }

            html += '</div>';
            document.getElementById('calendarContent').innerHTML = html;
        }

        function renderDayView() {
    const dateString = getLocalDateString(currentCalendarDate);
    
    document.getElementById('calendarMonthYear').textContent = 
        currentCalendarDate.toLocaleDateString('default', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

    const history = JSON.parse(localStorage.getItem('workoutHistory') || '[]');
    const dayWorkouts = history.filter(w => {
        // FIX 2: Compare against the correct local date string of the workout
        const workoutDate = getLocalDateString(new Date(w.date));
        return workoutDate === dateString;
    });

    let html = '<div style="margin-top: 20px;">';

    if (dayWorkouts.length === 0) {
        const restDays = getRecommendedRestDays(history);
        const isRestDay = restDays.includes(dateString);

        html += `
            <div class="info-box">
                <p>${isRestDay ? 'üü° Recommended rest day - your body needs recovery!' : 'No workouts completed on this day.'}</p>
            </div>
        `;
    } else {
        dayWorkouts.forEach(workout => {
            const time = new Date(workout.date).toLocaleTimeString();
            const duration = workout.duration;
            const minutes = Math.floor(duration / 60);
            const seconds = duration % 60;

            html += `
                <div class="history-item">
                    <div class="history-header">
                        <div>
                            <div class="history-date">${time}</div>
                            <div class="history-type">${workout.workoutName || 'Custom'} (${workout.type})</div>
                        </div>
                        <div class="history-duration">${minutes}:${String(seconds).padStart(2, '0')}</div>
                    </div>
                    ${workout.heartRate || workout.calories || workout.distance ? `
                    <div style="background: #e3f2fd; padding: 8px; border-radius: 5px; margin: 8px 0; font-size: 13px;">
                    ${workout.heartRate ? `üíì ${workout.heartRate} BPM &nbsp;` : ''}
                    ${workout.calories ? `üî• ${workout.calories} cal &nbsp;` : ''}
                    ${workout.distance ? `üìè ${workout.distance} ${workout.distanceUnit}` : ''}
                </div>
            ` : ''}
                     ${workout.notes ? `<div class="history-notes">üìù ${workout.notes}</div>` : ''}
                    <div class="history-details-body">
            `;

            // Check if exercises exist and determine type
            if (Array.isArray(workout.exercises) && workout.exercises.length > 0) {
                // Case 1: Strength workout - exercises are objects with properties
                if (typeof workout.exercises[0] === 'object' && workout.exercises[0] !== null && workout.exercises[0].name) {
                    workout.exercises.forEach(exercise => {
                        const isPR = isPersonalRecord(exercise.name, exercise.weight) && exercise.weight > 0;
                        html += `
                            <div class="history-exercise-detail">
                                <span class="history-exercise-name">
                                    ${exercise.name}
                                    ${isPR ? '<span class="pr-badge">PR!</span>' : ''}
                                </span>
                                <span class="history-exercise-stats">
                                    ${exercise.sets}x${exercise.reps} @ ${exercise.weight}lbs
                                </span>
                            </div>
                        `;
                    });
                } 
                // Case 2: HIIT workout - exercises are just strings (exercise names)
                else {
                    html += `
                        <div class="history-exercise-detail">
                            <strong>Exercises:</strong> ${workout.exercises.join(', ')}
                        </div>
                    `;
                    if (workout.rounds) {
                        html += `
                            <div class="history-exercise-detail">
                                <strong>Rounds Completed:</strong> ${workout.rounds}
                            </div>
                        `;
                    }
                }
            } else {
                html += `<div class="history-exercise-detail">No exercise data available.</div>`;
            }

             html += `
                        </div>
                        <button class="btn btn-secondary" onclick="editWorkoutStats(${history.indexOf(workout)})" style="margin-top: 10px; width: 100%;">
                            ‚úèÔ∏è Edit Workout Stats
                        </button>
                    </div>
                `;
            });
    }

    html += '</div>';
    document.getElementById('calendarContent').innerHTML = html;
}
        function getWorkoutDateCounts(history) {
            const dateCounts = {};
            history.forEach(workout => {
                // FIX: Use getLocalDateString to ensure correct local date is counted
                const date = getLocalDateString(new Date(workout.date));
                dateCounts[date] = (dateCounts[date] || 0) + 1;
            });
            return dateCounts;
        }

        function getRecommendedRestDays(history) {
            const restDays = [];
            const sortedHistory = history
                .map(w => new Date(w.date))
                .sort((a, b) => b - a);

            if (sortedHistory.length === 0) return restDays;

            // Recommend rest day after workout
            sortedHistory.forEach(workoutDate => {
                const nextDay = new Date(workoutDate);
                nextDay.setDate(nextDay.getDate() + 1);
                const nextDayString = nextDay.toISOString().split('T')[0];
                
                // Only suggest if it's not too far in the past and no workout on that day
                const hasWorkoutNextDay = history.some(w => {
                    return new Date(w.date).toISOString().split('T')[0] === nextDayString;
                });

                if (!hasWorkoutNextDay && nextDay <= new Date()) {
                    restDays.push(nextDayString);
                }
            });

            // Suggest rest day after 3 consecutive workout days
            const today = new Date();
            for (let i = 0; i < 30; i++) {
                const date = new Date(today);
                date.setDate(today.getDate() - i);
                const dateString = date.toISOString().split('T')[0];

                let consecutiveDays = 0;
                for (let j = 0; j < 3; j++) {
                    const checkDate = new Date(date);
                    checkDate.setDate(date.getDate() - j);
                    const checkDateString = checkDate.toISOString().split('T')[0];
                    
                    if (history.some(w => new Date(w.date).toISOString().split('T')[0] === checkDateString)) {
                        consecutiveDays++;
                    }
                }

                if (consecutiveDays >= 3) {
                    const restDate = new Date(date);
                    restDate.setDate(date.getDate() + 1);
                    const restDateString = restDate.toISOString().split('T')[0];
                    if (!restDays.includes(restDateString)) {
                        restDays.push(restDateString);
                    }
                }
            }

            return [...new Set(restDays)];
        }

        function changeMonth(delta) {
            if (currentCalendarView === 'month') {
                currentCalendarDate.setMonth(currentCalendarDate.getMonth() + delta);
            } else if (currentCalendarView === 'week') {
                currentCalendarDate.setDate(currentCalendarDate.getDate() + (delta * 7));
            } else if (currentCalendarView === 'day') {
                currentCalendarDate.setDate(currentCalendarDate.getDate() + delta);
            }
            renderCalendar();
        }

        function switchCalendarView(view) {
            currentCalendarView = view;
            
            document.getElementById('monthViewBtn').classList.remove('active');
            document.getElementById('weekViewBtn').classList.remove('active');
            document.getElementById('dayViewBtn').classList.remove('active');
            
            if (view === 'month') {
                document.getElementById('monthViewBtn').classList.add('active');
            } else if (view === 'week') {
                document.getElementById('weekViewBtn').classList.add('active');
            } else if (view === 'day') {
                document.getElementById('dayViewBtn').classList.add('active');
            }
            
            renderCalendar();
        }

        function showDayDetail(dateString) {
            // FIX: Force the date object to be created at local midnight to prevent timezone shifting the date.
            currentCalendarDate = new Date(dateString + 'T00:00:00'); 
            switchCalendarView('day');
        }

        // ==================== BODY STATS & MEASUREMENTS ====================
        function loadBodyStats() {
            const measurements = JSON.parse(localStorage.getItem('bodyMeasurements') || '{}');
            
            const stats = [
                { id: 'weight', label: 'Body Weight', unit: 'lbs', trend: true },
                { id: 'height', label: 'Height', unit: 'in', trend: false },
                { id: 'bodyFat', label: 'Body Fat %', unit: '%', trend: true },
                { id: 'bicepsR', label: 'Biceps (Right)', unit: 'in', trend: true },
                { id: 'bicepsL', label: 'Biceps (Left)', unit: 'in', trend: true },
                { id: 'chest', label: 'Chest', unit: 'in', trend: true },
                { id: 'waist', label: 'Waist', unit: 'in', trend: true },
                { id: 'hips', label: 'Hips', unit: 'in', trend: true },
                { id: 'thighR', label: 'Thigh (Right)', unit: 'in', trend: true },
                { id: 'thighL', label: 'Thigh (Left)', unit: 'in', trend: true },
                { id: 'calfR', label: 'Calves (Right)', unit: 'in', trend: true },
                { id: 'calfL', label: 'Calves (Left)', unit: 'in', trend: true }
            ];

             stats.forEach(stat => {
                const data = measurements[stat.id] || [];
                const current = data.length > 0 ? data[data.length - 1].value : null;
                
                // Special handling for body weight to avoid conflict with exercise weight
                const elementId = stat.id === 'weight' ? 'currentBodyWeight' : `current${stat.id.charAt(0).toUpperCase() + stat.id.slice(1)}`;
                const element = document.getElementById(elementId);
                if (element) {
                    element.textContent = current !== null ? `${current} ${stat.unit}` : `-- ${stat.unit}`;
                }

                if (stat.trend && data.length >= 2) {
                    const previous = data[data.length - 2].value;
                    const diff = current - previous;
                    const trendElement = document.getElementById(`${stat.id}Trend`);
                    
                    if (trendElement) {
                        if (diff > 0) {
                            // For weight, waist, body fat - up is usually not good
                            if (stat.id === 'weight' || stat.id === 'waist' || stat.id === 'bodyFat') {
                                trendElement.innerHTML = `<span class="trend-down">‚ñ≤ +${diff.toFixed(1)} ${stat.unit} from last</span>`;
                            } else {
                                trendElement.innerHTML = `<span class="trend-up">‚ñ≤ +${diff.toFixed(1)} ${stat.unit} from last</span>`;
                            }
                        } else if (diff < 0) {
                            if (stat.id === 'weight' || stat.id === 'waist' || stat.id === 'bodyFat') {
                                trendElement.innerHTML = `<span class="trend-up">‚ñº ${diff.toFixed(1)} ${stat.unit} from last</span>`;
                            } else {
                                trendElement.innerHTML = `<span class="trend-down">‚ñº ${diff.toFixed(1)} ${stat.unit} from last</span>`;
                            }
                        } else {
                            trendElement.innerHTML = `<span style="color: #6c757d;">No change</span>`;
                        }
                    }
                }
            });

            renderWeightProgressChart();
        }

        function renderWeightProgressChart() {
            const measurements = JSON.parse(localStorage.getItem('bodyMeasurements') || '{}');
            const weightData = measurements.weight || [];
            const container = document.getElementById('weightProgressChart');

            if (weightData.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6c757d;">No weight data yet</p>';
                return;
            }

            const last10 = weightData.slice(-10);
            const maxWeight = Math.max(...last10.map(d => d.value));
            const minWeight = Math.min(...last10.map(d => d.value));
            const range = maxWeight - minWeight;

            let html = '';
            last10.forEach(entry => {
                const percentage = range > 0 ? ((entry.value - minWeight) / range) * 100 : 100;
                const date = new Date(entry.date).toLocaleDateString();

                html += `
                    <div class="chart-bar">
                        <div class="chart-label">${date}</div>
                        <div class="chart-fill" style="width: ${percentage}%;">
                            <div class="chart-value">${entry.value} lbs</div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function openMeasurementModal(type) {
            document.getElementById('measurementType').value = type;
            
            const labels = {
                weight: 'Body Weight (lbs)',
                height: 'Height (inches)',
                bodyFat: 'Body Fat Percentage (%)',
                bicepsR: 'Right Bicep (inches)',
                bicepsL: 'Left Bicep (inches)',
                chest: 'Chest (inches)',
                waist: 'Waist (inches)',
                hips: 'Hips (inches)',
                thighR: 'Right Thigh (inches)',
                thighL: 'Left Thigh (inches)',
                calfR: 'Right Calf (inches)',
                calfL: 'Left Calf (inches)'
            };

            document.getElementById('measurementModalTitle').textContent = `Update ${labels[type] || 'Measurement'}`;
            document.getElementById('measurementLabel').textContent = labels[type] || 'Value';
            document.getElementById('measurementValue').value = '';
            document.getElementById('measurementDate').value = new Date().toISOString().split('T')[0];

            showModalById('measurementModal');
        }
        
        function saveMeasurement() {
            const type = document.getElementById('measurementType').value;
            const value = parseFloat(document.getElementById('measurementValue').value);
            const date = document.getElementById('measurementDate').value;

            if (!value || isNaN(value)) {
                alert('Please enter a valid measurement value');
                return;
            }

            const measurements = JSON.parse(localStorage.getItem('bodyMeasurements') || '{}');
            
            if (!measurements[type]) {
                measurements[type] = [];
            }

            measurements[type].push({
                value: value,
                date: date || new Date().toISOString()
            });

            // Sort by date
            measurements[type].sort((a, b) => new Date(a.date) - new Date(b.date));

            localStorage.setItem('bodyMeasurements', JSON.stringify(measurements));

            alert('Measurement saved successfully!');
            closeModal(document.getElementById('measurementModal'));
            loadBodyStats();
        }

        // ==================== WORKOUT SHARING ====================
        function populateShareWorkoutSelect() {
            const select = document.getElementById('qrShareWorkoutSelect');
            if (!select) return;
            select.innerHTML = '<option value="">-- Choose a workout --</option>';
            const savedCustomWorkouts = JSON.parse(localStorage.getItem('customWorkouts')) || {};
            Object.keys(savedCustomWorkouts).forEach(workoutName => {
                const option = document.createElement('option');
                option.value = workoutName;
                option.textContent = workoutName;
                select.appendChild(option);
            });
        }

       function generateWorkoutQR() {
            try {
                const workoutSelect = document.getElementById('qrShareWorkoutSelect');
                const workoutName = workoutSelect.value;
                
                if (!workoutName) {
                    alert('Please select a workout to share.');
                    return;
                }
                
                const savedCustomWorkouts = JSON.parse(localStorage.getItem('customWorkouts')) || {};
                const workoutData = savedCustomWorkouts[workoutName];
                
                if (!workoutData) {
                    alert('Workout not found.');
                    return;
                }

                // Collect custom exercises used in this workout
                const customExercisesData = [];
                const allCustomExercises = JSON.parse(localStorage.getItem('customExercises')) || '{}';
                
                // Determine workout type and extract exercises
                let exercisesInWorkout = [];
                let isHiitWorkout = false;
                
                if (workoutData.workoutType === 'hiit') {
                    // HIIT workout created by AI
                    isHiitWorkout = true;
                    exercisesInWorkout = workoutData.exercises || [];
                } else if (Array.isArray(workoutData)) {
                    // Strength workout (array format)
                    exercisesInWorkout = workoutData;
                } else {
                    console.error('Unknown workout format:', workoutData);
                    alert('Error: Unable to determine workout format.');
                    return;
                }

                 // Collect any custom exercises from localStorage
                if (Array.isArray(exercisesInWorkout)) {
                    exercisesInWorkout.forEach(ex => {
                        const exerciseName = ex.name;
                        if (exerciseName && allCustomExercises[exerciseName]) {
                            // Check if not already added
                            if (!customExercisesData.some(customEx => customEx.name === exerciseName)) {
                                customExercisesData.push({ 
                                    name: exerciseName, 
                                    ...allCustomExercises[exerciseName] 
                                });
                            }
                        }
                    });
                }
                
                // Also check exerciseDatabase for any custom exercises that might only be there
                if (Array.isArray(exercisesInWorkout)) {
                    exercisesInWorkout.forEach(ex => {
                        const exerciseName = ex.name;
                        // If exercise is in exerciseDatabase but NOT in allCustomExercises yet
                        if (exerciseName && exerciseDatabase[exerciseName]) {
                            // Check if we haven't already added it
                            if (!customExercisesData.some(customEx => customEx.name === exerciseName)) {
                                // Check if it's truly custom by seeing if it was added after initial load
                                // If it has a custom image or equipment field that differs from defaults
                                const exerciseData = exerciseDatabase[exerciseName];
                                if (exerciseData.image === 'Custom exercise' || exerciseData.image === 'AI Generated Exercise') {
                                    customExercisesData.push({ 
                                        name: exerciseName, 
                                        ...exerciseData 
                                    });
                                }
                            }
                        }
                    });
                }
                // Create shareable workout object
                const shareableWorkout = {
                    v: '2.2-b64zip', 
                    t: workoutName,
                    d: workoutData,
                    c: customExercisesData,
                    s: new Date().toISOString()
                };

                console.log('Generating QR for workout:', workoutName);
                console.log('Workout data:', workoutData);
                console.log('Custom exercises:', customExercisesData);

                // Compress and encode
                const jsonString = JSON.stringify(shareableWorkout);
                const compressedBinary = pako.deflate(jsonString);
                
                // Convert to binary string in chunks to avoid call stack issues
                let binaryString = '';
                const chunkSize = 8192;
                for (let i = 0; i < compressedBinary.length; i += chunkSize) {
                    const chunk = compressedBinary.subarray(i, i + chunkSize);
                    binaryString += String.fromCharCode.apply(null, chunk);
                }
                
                const base64String = btoa(binaryString);

                // Create URL
                const baseUrl = window.location.origin + window.location.pathname;
                const shareUrl = `${baseUrl}?workout=${encodeURIComponent(base64String)}`;
                
                console.log('Share URL length:', shareUrl.length);
                
                // Make the container visible
                const qrContainer = document.getElementById('qrCodeContainer');
                qrContainer.style.display = 'block';
                
                // Get the output div and clear it
                const qrCodeOutput = document.getElementById('qrCodeOutput');
                qrCodeOutput.innerHTML = '';

                // Generate QR code
                if (typeof QRCode === 'undefined') {
                    alert('Error: QR Code library not loaded. Please refresh the page.');
                    return;
                }

                new QRCode(qrCodeOutput, {
                    text: shareUrl,
                    width: 280,
                    height: 280,
                    colorDark: "#001f3f",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.M
                });
                
                console.log('QR Code generated successfully!');
                
            } catch (error) {
                console.error('Error generating QR code:', error);
                alert(`Error generating QR code: ${error.message}\n\nPlease check the console for more details.`);
            }
        }

        function handleIncomingWorkout() {
            const params = new URLSearchParams(window.location.search);
            const workoutParam = params.get('workout');

            if (!workoutParam) return; // No workout data in URL, do nothing

            try {
                let jsonString;
                let sharedWorkout;
                const qrData = decodeURIComponent(workoutParam);

                try {
                   const binaryString = atob(qrData);
                   const compressedBinary = new Uint8Array(binaryString.length).map((_, i) => binaryString.charCodeAt(i));
                   jsonString = pako.inflate(compressedBinary, { to: 'string' });
                   sharedWorkout = JSON.parse(jsonString);
                } catch (e) {
                   console.log("Could not decompress, attempting to parse as plain JSON.");
                   sharedWorkout = JSON.parse(qrData);
                }
                
                const title = sharedWorkout.t || sharedWorkout.title;
                const workoutData = sharedWorkout.d || sharedWorkout.workoutData;
                const customExercisesData = sharedWorkout.c || sharedWorkout.customExercisesData;

                if (!title || !workoutData) {
                    alert('Invalid workout data in the URL.');
                    return;
                }
                
                const workoutType = workoutData.workoutType === 'hiit' ? 'HIIT' : 'Strength';
                const exercises = workoutData.workoutType === 'hiit' ? workoutData.exercises : workoutData;
                const exerciseCount = Array.isArray(exercises) ? exercises.length : 0;
                
                let confirmMsg = `Import this shared workout?\n\n`;
                confirmMsg += `Name: ${title}\n`;
                confirmMsg += `Type: ${workoutType}\n`;
                confirmMsg += `Exercises: ${exerciseCount}\n`;
                if (customExercisesData && customExercisesData.length > 0) {
                    confirmMsg += `Custom Exercises: ${customExercisesData.length}\n`;
                }
                confirmMsg += `\nAdd this workout to your app?`;
                
                if (!confirm(confirmMsg)) {
                     // Clean the URL even if user cancels
                    window.history.replaceState({}, document.title, window.location.pathname);
                    return;
                }
                
                let importedExerciseCount = 0;
                if (customExercisesData && customExercisesData.length > 0) {
                    customExercisesData.forEach(ex => {
                        const { name, ...exerciseData } = ex;
                        if (!exerciseDatabase[name]) {
                            saveCustomExerciseToDB(name, exerciseData);
                            importedExerciseCount++;
                        }
                    });
                }
                
                const savedCustomWorkouts = JSON.parse(localStorage.getItem('customWorkouts')) || {};
                let newName = title;
                let counter = 1;
                while (savedCustomWorkouts[newName]) {
                    newName = `${title} (Imported ${counter++})`;
                }
                
                savedCustomWorkouts[newName] = workoutData;
                localStorage.setItem('customWorkouts', JSON.stringify(savedCustomWorkouts));
                
                loadCustomWorkoutsIntoDropdown();
                populateShareWorkoutSelect();
                
                let successMsg = `Workout imported!\n\n"${newName}" is now available in your custom workouts.`;
                if (importedExerciseCount > 0) {
                    successMsg += `\n${importedExerciseCount} new custom exercise(s) were also added.`;
                }
                alert(successMsg);
                
                // Clean the URL after successful import
                window.history.replaceState({}, document.title, window.location.pathname);
                
            } catch (error) {
                console.error('Error importing workout:', error);
                alert('Error importing workout. The QR code data may be invalid or corrupted.');
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }

        // ==================== DATA MANAGEMENT ====================
        function exportData() {
            const data = {
                version: '3.0',
                exportDate: new Date().toISOString(),
                workoutHistory: JSON.parse(localStorage.getItem('workoutHistory') || '[]'),
                customExercises: JSON.parse(localStorage.getItem('customExercises') || '{}'),
                customWorkouts: JSON.parse(localStorage.getItem('customWorkouts') || '{}'),
                customYouTubeLinks: JSON.parse(localStorage.getItem('customYouTubeLinks') || '{}'),
                workoutPreferences: JSON.parse(localStorage.getItem('workoutPreferences') || '{}'),
                lastUsedExerciseValues: JSON.parse(localStorage.getItem('lastUsedExerciseValues') || '{}'),
                geminiKey: localStorage.getItem('geminiKey') || '',
                bodyMeasurements: JSON.parse(localStorage.getItem('bodyMeasurements') || '{}'),
                personalRecords: JSON.parse(localStorage.getItem('personalRecords') || '{}')
            };

            const dataStr = JSON.stringify(data, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `workout-tracker-backup-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            alert('Data exported successfully! Keep this file safe as a backup.');
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!confirm('WARNING: This will replace ALL current data! Are you sure you want to continue?')) {
                event.target.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);

                    if (data.workoutHistory) localStorage.setItem('workoutHistory', JSON.stringify(data.workoutHistory));
                    if (data.customExercises) localStorage.setItem('customExercises', JSON.stringify(data.customExercises));
                    if (data.customWorkouts) localStorage.setItem('customWorkouts', JSON.stringify(data.customWorkouts));
                    if (data.customYouTubeLinks) localStorage.setItem('customYouTubeLinks', JSON.stringify(data.customYouTubeLinks));
                    if (data.workoutPreferences) localStorage.setItem('workoutPreferences', JSON.stringify(data.workoutPreferences));
                    if (data.lastUsedExerciseValues) localStorage.setItem('lastUsedExerciseValues', JSON.stringify(data.lastUsedExerciseValues));
                    if (data.geminiKey) localStorage.setItem('geminiKey', data.geminiKey);
                    if (data.bodyMeasurements) localStorage.setItem('bodyMeasurements', JSON.stringify(data.bodyMeasurements));
                    if (data.personalRecords) localStorage.setItem('personalRecords', JSON.stringify(data.personalRecords));

                    alert('Data imported successfully! The page will now reload.');
                    location.reload();
                } catch (error) {
                    alert('Error importing data. Please make sure you selected a valid backup file.');
                    console.error('Import error:', error);
                }
            };

            reader.readAsText(file);
            event.target.value = '';
        }
        // ==================== COLOR CUSTOMIZATION ====================
       function updateColors() {
            const colors = {
                primary: document.getElementById('primaryColor').value,
                accent: document.getElementById('accentColor').value,
                background: document.getElementById('backgroundColor').value,
                success: document.getElementById('successColor').value,
                danger: document.getElementById('dangerColor').value,
                card: document.getElementById('cardColor').value,
                nav: document.getElementById('navColor').value,
                navText: document.getElementById('navTextColor').value
            };
            
            // Apply colors using CSS variables
            document.documentElement.style.setProperty('--primary-color', colors.primary);
            document.documentElement.style.setProperty('--accent-color', colors.accent);
            document.documentElement.style.setProperty('--bg-color', colors.background);
            document.documentElement.style.setProperty('--success-color', colors.success);
            document.documentElement.style.setProperty('--danger-color', colors.danger);
            document.documentElement.style.setProperty('--card-color', colors.card);
            document.documentElement.style.setProperty('--nav-color', colors.nav);
            document.documentElement.style.setProperty('--nav-text-color', colors.navText);
            
            // Update specific elements
            updateColorStyles(colors);
            
            // Save to localStorage
            localStorage.setItem('customColors', JSON.stringify(colors));
        }
        function updateColorStyles(colors) {
            // Get or create the style tag
            let themeStyle = document.getElementById('theme-styles');
            if (!themeStyle) {
                themeStyle = document.createElement('style');
                themeStyle.id = 'theme-styles';
                document.head.appendChild(themeStyle);
            }

            const textColor = getContrastColor(colors.background);
            const cardTextColor = getContrastColor(colors.card);
            currentCardTextColor = cardTextColor;
            const fadedCardTextColor = adjustBrightness(cardTextColor, -30);
            const primaryContrast = getContrastColor(colors.primary);

            const backgroundRgb = hexToRgb(colors.background);
            const cardRgb = hexToRgb(colors.card);
            const primaryRgb = hexToRgb(colors.primary);
            const navRgb = hexToRgb(colors.nav);
            const css = `
                body {
                    background: linear-gradient(135deg, ${colors.primary} 0%, ${adjustBrightness(colors.primary, 20)} 100%);
                }
                .container {
                    background: transparent;
                    border-color: ${adjustBrightness(colors.nav, -20)};
                    -webkit-backdrop-filter: none;
                    backdrop-filter: none;
                }
                .header {
                    background: rgba(${primaryRgb.r}, ${primaryRgb.g}, ${primaryRgb.b}, 0.75);
                    color: ${colors.accent};
                    border-bottom-color: ${colors.accent};
                    backdrop-filter: blur(10px);
                    -webkit-backdrop-filter: blur(10px);
                }
                .header h1, .header p { color: ${colors.accent}; }
                .nav {
                    background: rgba(${navRgb.r}, ${navRgb.g}, ${navRgb.b}, 0.80);
                    border-bottom-color: ${adjustBrightness(colors.nav, -20)};
                    backdrop-filter: blur(8px);
                    -webkit-backdrop-filter: blur(8px);
                }
                .nav-btn { color: ${colors.navText}; }
                .nav-btn.active {
                    background: rgba(${backgroundRgb.r}, ${backgroundRgb.g}, ${backgroundRgb.b}, 0.85);
                    color: ${textColor};
                    border-bottom-color: ${colors.accent};
                }
                .content, h2, h3, h4, label {
                     color: ${textColor} !important;
                     opacity: 1 !important;
                     font-weight: 600 !important;
                }
                h2 {
                     font-size: 26px !important;
                     font-weight: 800 !important;
                     text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
                     padding: 10px;
                     background: rgba(${backgroundRgb.r}, ${backgroundRgb.g}, ${backgroundRgb.b}, 0.9);
                     border-radius: 8px;
                     margin-bottom: 15px;
                }
                label {
                     font-weight: 800 !important;
                     font-size: 16px !important;
                     text-shadow: 2px 2px 3px rgba(0, 0, 0, 0.4);
                     padding: 5px 8px;
                     background: rgba(${backgroundRgb.r}, ${backgroundRgb.g}, ${backgroundRgb.b}, 0.85);
                     border-radius: 5px;
                     display: inline-block;
                }

                /* ==================== FIX STARTS HERE ==================== */
                /* This single rule now applies a uniform accent border to ALL card types */
                .exercise-card, .history-item, .measurement-card, .progress-chart, .color-setting-card, .chat-messages-box, .info-box, .recommendation-card, .week-day-card {
                    background: rgba(${cardRgb.r}, ${cardRgb.g}, ${cardRgb.b}, 0.75);
                    border: 3px solid ${colors.accent}; /* UNIFORM BORDER */
                    color: ${cardTextColor};
                    backdrop-filter: blur(8px);
                    -webkit-backdrop-filter: blur(8px);
                    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
                }
                /* ===================== FIX ENDS HERE ===================== */

                .stat-card {
                    background: linear-gradient(135deg, ${colors.primary} 0%, ${adjustBrightness(colors.primary, 20)} 100%);
                    border: 2px solid ${colors.accent};
                    color: ${primaryContrast};
                    border-radius: 12px;
                    padding: 20px;
                    text-align: center;
                }
                .week-day-card.has-workout {
                    border-color: ${colors.success}; /* Changed from border-left-color to affect the whole border */
                }

                .calendar-day, .calendar-day-header {
                    background: rgba(${cardRgb.r}, ${cardRgb.g}, ${cardRgb.b}, 0.85);
                    color: ${cardTextColor};
                    border-radius: 6px;
                    border: 1px solid ${colors.accent};
                    backdrop-filter: blur(8px);
                    -webkit-backdrop-filter: blur(8px);
                }
                .calendar-day.today {
                    border: 2px solid ${colors.accent};
                    box-shadow: 0 0 5px ${colors.accent};
                }
                
                .info-box p, .info-box strong { color: ${cardTextColor} !important; }
                .exercise-name, .history-date, .history-exercise-name, .measurement-label, .chart-title { color: ${cardTextColor}; }
                .exercise-equipment, .history-exercises, .history-exercise-stats, .day-workout-count, .rest-indicator { color: ${fadedCardTextColor}; }
                .exercise-not-found { color: ${textColor}; }
                
                .btn {
                    background: linear-gradient(135deg, ${colors.primary} 0%, ${adjustBrightness(colors.primary, 20)} 100%);
                    color: ${colors.accent};
                }
                .btn-secondary {
                    background: ${adjustBrightness(colors.nav, -10)};
                    color: ${getContrastColor(adjustBrightness(colors.nav, -10))};
                }
                .btn-success {
                    background: linear-gradient(135deg, ${colors.success} 0%, ${adjustBrightness(colors.success, 15)} 100%);
                    color: #ffffff;
                }
                .btn-danger, .delete-btn {
                    background: linear-gradient(135deg, ${colors.danger} 0%, ${adjustBrightness(colors.danger, 20)} 100%);
                    color: #ffffff;
                    border: 1px solid rgba(255, 255, 255, 0.6);
                }
                .edit-btn {
                    background: linear-gradient(135deg, ${colors.primary} 0%, ${adjustBrightness(colors.primary, 25)} 100%);
                    color: ${colors.accent};
                    border: 1px solid ${colors.accent};
                }
                .timer-btn {
                    color: ${colors.accent};
                    border-color: ${colors.accent};
                }
                .workout-timer {
                    background: linear-gradient(135deg, ${colors.primary} 0%, ${adjustBrightness(colors.primary, 25)} 100%);
                    color: ${primaryContrast};
                    border-color: ${colors.accent};
                }
                .workout-timer h3 { color: ${primaryContrast}; }
                .timer-display { color: ${colors.accent}; }

                /* START: HIIT Theme Rules */
                #hiitWorkoutMode {
                    background: linear-gradient(135deg, ${colors.primary} 0%, ${adjustBrightness(colors.primary, 25)} 100%);
                    color: ${primaryContrast};
                }
                #hiitWorkoutMode h2, #hiitWorkoutMode p, #hiitWorkoutMode #hiitRoundDisplay, #hiitModeDisplay, #hiitExerciseName, #hiitNextExerciseName {
                    color: ${primaryContrast} !important;
                }
                #hiitTimerDisplay, #hiitCountdownDisplay { 
                    color: ${colors.accent} !important; 
                }
                /* END: HIIT Theme Rules */

                .stat-number { color: ${colors.accent}; }
                .stat-label { color: ${primaryContrast}; }
                .history-stats-box {
                    background: rgba(${cardRgb.r}, ${cardRgb.g}, ${cardRgb.b}, 0.4);
                    color: ${getContrastColor(adjustBrightness(colors.card, -10))};
                    padding: 10px; border-radius: 5px; margin: 10px 0; font-size: 14px;
                }
                .history-stats-box strong { color: ${getContrastColor(adjustBrightness(colors.card, -10))}; }
                .chart-fill { background: linear-gradient(90deg, ${colors.primary}, ${colors.accent}); }
                .chart-value { color: ${getContrastColor(colors.primary)}; }
                .pr-badge { background: ${colors.accent}; color: ${colors.primary}; }
                .modal { z-index: 10000 !important; }
                .modal-content {
                    background: rgba(${backgroundRgb.r}, ${backgroundRgb.g}, ${backgroundRgb.b}, 0.98) !important;
                    border: 2px solid ${colors.primary};
                    opacity: 1 !important;
                    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.7);
                    backdrop-filter: blur(10px);
                    -webkit-backdrop-filter: blur(10px);
                }
                .modal-content, .modal-content label, .modal-content h3, .modal-content p, .modal-content strong, .modal-content div, .modal-content input, .modal-content textarea, .modal-content select, .modal-content a {
                    color: ${textColor} !important;
                    opacity: 1 !important;
                }
                .modal-content a {
                    color: ${colors.primary} !important;
                    text-decoration: underline;
                }
                .modal-content .btn {
                    color: ${colors.accent} !important;
                    text-decoration: none !important;
                    background: linear-gradient(135deg, ${colors.primary} 0%, ${adjustBrightness(colors.primary, 20)} 100%) !important;
                }
            `;
             themeStyle.innerHTML = css;
             
                if (colors.background === '#000000' && colors.accent === '#dfff00') {
                    const glassCSS = `
                        .exercise-card, .history-item, .measurement-card, .progress-chart, .color-setting-card, .chat-messages-box, .info-box, .week-day-card, .stat-card, #currentExerciseCard {
                            background: rgba(42, 42, 42, 0.75);
                            border: 2px solid ${colors.accent}; /* Ensure uniform border for glass theme too */
                        }
                        .btn-success { color: #000000; }
                        .nav-btn.active { background: #2a2a2a; }
                    `;
                    themeStyle.innerHTML += glassCSS;
                }
            }
        function getContrastColor(hexColor) {
            // Convert hex to RGB
            const r = parseInt(hexColor.substr(1, 2), 16);
            const g = parseInt(hexColor.substr(3, 2), 16);
            const b = parseInt(hexColor.substr(5, 2), 16);
            
            // Calculate luminance
            const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
            
            // Return black or white based on luminance - pure white for dark themes
            return luminance > 0.5 ? '#333333' : '#ffffff';
        }
            // Convert hex to RGB
        function adjustBrightness(hex, percent) {            
            const num = parseInt(hex.replace('#', ''), 16);
            const r = (num >> 16) + percent;
            const g = ((num >> 8) & 0x00FF) + percent;
            const b = (num & 0x0000FF) + percent;
            
            // Clamp values
            const newR = Math.min(255, Math.max(0, r));
            const newG = Math.min(255, Math.max(0, g));
            const newB = Math.min(255, Math.max(0, b));
            
            return `#${((newR << 16) | (newG << 8) | newB).toString(16).padStart(6, '0')}`;
        }
        
        function resetColors() {
            if (!confirm('Reset all colors to default theme?')) return;
            
            document.getElementById('primaryColor').value = '#001f3f';
            document.getElementById('accentColor').value = '#d4af37';
            document.getElementById('backgroundColor').value = '#f5f5dc';
            document.getElementById('successColor').value = '#4a6741';
            document.getElementById('dangerColor').value = '#8b0000';
            document.getElementById('cardColor').value = '#e8dcc4';
            document.getElementById('navColor').value = '#d9c7a5';
            document.getElementById('navTextColor').value = '#3e3024';
            
            updateColors();
            alert('‚úÖ Colors reset to default!');
        }
        
        function saveColorPreset() {
            const presetName = prompt('Enter a name for this color preset:');
            if (!presetName) return;
            
            const colors = {
                primary: document.getElementById('primaryColor').value,
                accent: document.getElementById('accentColor').value,
                background: document.getElementById('backgroundColor').value,
                success: document.getElementById('successColor').value,
                danger: document.getElementById('dangerColor').value,
                card: document.getElementById('cardColor').value,
                nav: document.getElementById('navColor').value,
                navText: document.getElementById('navTextColor').value
            };
            
            const presets = JSON.parse(localStorage.getItem('colorPresets') || '{}');
            presets[presetName] = colors;
            localStorage.setItem('colorPresets', JSON.stringify(presets));
            
            alert(`‚úÖ Preset "${presetName}" saved!`);
        }
        
        function applyTheme(themeName) {
            const themes = {
                default: {
                    primary: '#001f3f',
                    accent: '#d4af37',
                    background: '#f5f5dc',
                    success: '#4a6741',
                    danger: '#8b0000',
                    card: '#e8dcc4',
                    nav: '#d9c7a5',
                    navText: '#3e3024'
                },
                ocean: {
                    primary: '#006064',
                    accent: '#00e5ff',
                    background: '#e0f7fa',
                    success: '#00796b',
                    danger: '#d32f2f',
                    card: '#b2ebf2',
                    nav: '#00838f',
                    navText: '#ffffff'
                },
                forest: {
                    primary: '#1b5e20',
                    accent: '#76ff03',
                    background: '#f1f8e9',
                    success: '#388e3c',
                    danger: '#c62828',
                    card: '#dcedc8',
                    nav: '#33691e',
                    navText: '#ffffff'
                },
                sunset: {
                    primary: '#e65100',
                    accent: '#ffd54f',
                    background: '#fff3e0',
                    success: '#ef6c00',
                    danger: '#b71c1c',
                    card: '#ffe0b2',
                    nav: '#f57c00',
                    navText: '#ffffff'
                },
                purple: {
                    primary: '#4a148c',
                    accent: '#e1bee7',
                    background: '#f3e5f5',
                    success: '#7b1fa2',
                    danger: '#c2185b',
                    card: '#e1bee7',
                    nav: '#6a1b9a',
                    navText: '#ffffff'
                }, 
                kentucky: {
                    primary: '#0033A0',
                    accent: '#ffffff',
                    background: '#f8f8f8',
                    success: '#0033A0',
                    danger: '#c5050c',
                    card: '#e6f0ff',
                    nav: '#0033A0',
                    navText: '#ffffff'
                },
                gympak: { // <-- PASTE THE NEW THEME OBJECT HERE
                    primary: '#1c1c1c',
                    accent: '#dfff00',
                    background: '#000000',
                    success: '#dfff00',
                    danger: '#e53935',
                    card: '#2a2a2a',
                    nav: '#111111',
                    navText: '#ffffff'
                },
                crimson: {
                    primary: '#1a1a1a', // Near Black
                    accent: '#ff4d4d', // Bright Crimson Red
                    background: '#212121', // Dark Gray
                    success: '#ff4d4d',
                    danger: '#ff1744',
                    card: '#2c2c2c', // Slightly Lighter Gray
                    nav: '#111111', // Pure Black
                    navText: '#FFFFFF'
                }
            };
            
            const theme = themes[themeName];
            if (!theme) return;
            
            document.getElementById('primaryColor').value = theme.primary;
            document.getElementById('accentColor').value = theme.accent;
            document.getElementById('backgroundColor').value = theme.background;
            document.getElementById('successColor').value = theme.success;
            document.getElementById('dangerColor').value = theme.danger;
            document.getElementById('cardColor').value = theme.card;
            document.getElementById('navColor').value = theme.nav;
            document.getElementById('navTextColor').value = theme.navText;
            
            updateColors();
        }
        
        function loadSavedColors() {
            const savedColors = localStorage.getItem('customColors');
            if (savedColors) {
                const colors = JSON.parse(savedColors);
                document.getElementById('primaryColor').value = colors.primary || '#001f3f';
                document.getElementById('accentColor').value = colors.accent || '#d4af37';
                document.getElementById('backgroundColor').value = colors.background || '#f5f5dc';
                document.getElementById('successColor').value = colors.success || '#4a6741';
                document.getElementById('dangerColor').value = colors.danger || '#8b0000';
                document.getElementById('cardColor').value = colors.card || '#e8dcc4';
                document.getElementById('navColor').value = colors.nav || '#d9c7a5';
                document.getElementById('navTextColor').value = colors.navText || '#3e3024';
                updateColors();
            }
        }
        function hexToRgb(hex) {
            let result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? {
                r: parseInt(result[1], 16),
                g: parseInt(result[2], 16),
                b: parseInt(result[3], 16)
            } : null;
        }
        
        function applyBackgroundImage(imageData) {
            // Detect if user is on mobile/iOS
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            
            if (isMobile) {
                // Mobile approach: Apply background to a fixed pseudo-element
                // Create or update a style element for the fixed background
                let bgStyle = document.getElementById('mobile-bg-style');
                if (!bgStyle) {
                    bgStyle = document.createElement('style');
                    bgStyle.id = 'mobile-bg-style';
                    document.head.appendChild(bgStyle);
                }
                
                bgStyle.textContent = `
                    body::before {
                        content: '';
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background-image: url('${imageData}');
                        background-size: cover;
                        background-position: center;
                        background-repeat: no-repeat;
                        z-index: -1;
                    }
                `;
                
                // Clear body background since we're using ::before
                document.body.style.backgroundImage = 'none';
            } else {
                // Desktop approach: Use background-attachment: fixed with !important
                document.body.style.setProperty('background-image', `url('${imageData}')`, 'important');
                document.body.style.setProperty('background-size', 'cover', 'important');
                document.body.style.setProperty('background-attachment', 'fixed', 'important');
                document.body.style.setProperty('background-position', 'center', 'important');
                document.body.style.setProperty('background-repeat', 'no-repeat', 'important');
            }
            
            // Make container more transparent to show the background image (both mobile and desktop)
            const container = document.querySelector('.container');
            if (container) {
                container.style.background = 'rgba(255, 255, 255, 0.1)';
                container.style.backdropFilter = 'blur(.05px)';
                container.style.webkitBackdropFilter = 'blur(.05px)';
            }
        }

function removeBackgroundImage() {
    if (!confirm('Are you sure you want to remove the custom background image?')) return;
    localStorage.removeItem('backgroundImage');
    
    // Remove mobile background style if it exists
    const bgStyle = document.getElementById('mobile-bg-style');
    if (bgStyle) {
        bgStyle.remove();
    }
    
    const activeSectionId = document.querySelector('.section.active')?.id;
    if (activeSectionId) {
        showSection(activeSectionId);
    } else {
        document.body.style.backgroundImage = '';
        updateColors();
    }
    alert('Background image removed.');
}

function loadBackgroundImage() {
    const savedImage = localStorage.getItem('backgroundImage');
    if (savedImage) {
        applyBackgroundImage(savedImage);
    }
}
        // ==================== INITIALIZATION (MOVED TO THE END) ====================
        document.addEventListener('DOMContentLoaded', function() {
            checkApiKey();
            loadRecommendation();
            renderExerciseList();
            updateProgress();
            loadHistory();
            populateShareWorkoutSelect();
            handleIncomingWorkout();
            renderCalendar();
            loadBodyStats();
            loadCustomWorkoutsIntoDropdown();
            loadSavedColors();
            loadBackgroundImage();
            
            // Load the initial tab's background image (workout tab is active by default)
            showSection('workout');
        });
       
    </script>
             <!-- Exercise Info Modal -->
    <div id="exerciseModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalExerciseName"></h3>
                <button class="modal-close" onclick="closeModal(this.closest('.modal'))">&times;</button>
            </div>
            <div id="modalExerciseContent"></div>
        </div>
    </div>

    <!-- Add/Edit Custom Exercise Modal -->
    <div id="addExerciseModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="addExerciseModalTitle">‚ûï Add Custom Exercise</h3>
                <button class="modal-close" onclick="closeModal(this.closest('.modal'))">&times;</button>
            </div>
            <input type="hidden" id="originalExerciseName">
            <div class="form-group">
                <label>Exercise Name *</label>
                <input type="text" id="newExerciseName" placeholder="e.g., Dumbbell Chest Fly">
            </div>
            <button class="btn btn-secondary" onclick="generateExerciseDetailsWithAI()" id="aiGenerateBtn"
                style="width: auto; padding: 10px 15px; font-size: 14px; margin-bottom: 20px;">
                ü§ñ Generate with AI
            </button>
            <div class="form-group">
                <label>Equipment *</label>
                <input type="text" id="newExerciseEquipment" placeholder="e.g., Dumbbells">
            </div>
            <div class="form-group">
                <label>Instructions *</label>
                <textarea id="newExerciseInstructions" rows="4"
                    placeholder="Describe how to perform this exercise..."></textarea>
            </div>
            <div class="form-group">
                <label>Target Muscles/Description</label>
                <input type="text" id="newExerciseImage" placeholder="e.g., Targets: Chest, Shoulders">
            </div>
            <div class="form-group">
                <label>YouTube Video Link (optional)</label>
                <input type="url" id="newExerciseYouTubeLink" placeholder="e.g., https://www.youtube.com/watch?v=...">
            </div>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px;">
                <div class="form-group">
                    <label>Default Weight (lbs)</label>
                    <input type="number" id="newExerciseWeight" value="25">
                </div>
                <div class="form-group">
                    <label>Default Sets</label>
                    <input type="number" id="newExerciseSets" value="3">
                </div>
                <div class="form-group">
                    <label>Default Reps</label>
                    <input type="number" id="newExerciseReps" value="12">
                </div>
            </div>
            <button class="btn" id="saveExerciseBtn" onclick="saveNewExercise()">üíæ Add Exercise to Database</button>
        </div>
    </div>

    <!-- Measurement Update Modal -->
    <div id="measurementModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="measurementModalTitle">Update Measurement</h3>
                <button class="modal-close" onclick="closeModal(this.closest('.modal'))">&times;</button>
            </div>
            <input type="hidden" id="measurementType">
            <div class="form-group">
                <label id="measurementLabel">Value</label>
                <input type="number" step="0.1" id="measurementValue" placeholder="Enter value">
            </div>
            <div class="form-group">
                <label>Date (optional)</label>
                <input type="date" id="measurementDate">
            </div>
            <button class="btn" onclick="saveMeasurement()">üíæ Save Measurement</button>
        </div>
    </div>
<!-- Calorie Tracking Modal -->
    <div id="calorieModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">üî• Configure Calorie Tracking</h3>
                <button class="modal-close" onclick="closeModal(this.closest('.modal'))">&times;</button>
            </div>
            <div>
                <div class="info-box" style="margin-bottom: 20px;">
                    <p><strong>How it works:</strong> Choose between automatic estimation based on workout data or manual input from your fitness tracker.</p>
                </div>
                
                <div class="form-group">
                    <label>Tracking Method</label>
                    <select id="calorieTrackingMethod" onchange="toggleCalorieInputMethod()">
                        <option value="automatic">Automatic Estimation</option>
                        <option value="manual">Manual Input from Tracker</option>
                    </select>
                </div>

                <div id="automaticCalorieInfo" style="display: block;">
                    <div class="info-box">
                        <p><strong>Automatic Estimation Formula:</strong></p>
                        <p>‚Ä¢ Strength Training: ~5 calories per minute</p>
                        <p>‚Ä¢ HIIT Training: ~10 calories per minute</p>
                        <p>Adjust the multiplier based on your intensity level:</p>
                    </div>
                    
                    <div class="form-group">
                        <label>Intensity Multiplier (0.5 - 2.0)</label>
                        <input type="number" id="calorieMultiplier" step="0.1" min="0.5" max="2.0" value="1.0" placeholder="1.0 = Average">
                        <small style="color: #6c757d;">Lower intensity: 0.5-0.8 | Average: 1.0 | High intensity: 1.2-2.0</small>
                    </div>
                </div>

                <div id="manualCalorieInfo" style="display: none;">
                    <div class="info-box">
                        <p><strong>Manual Entry:</strong> After each workout, you'll be prompted to enter calories burned from your fitness tracker.</p>
                    </div>
                </div>

                <button class="btn" onclick="saveCalorieSettings()">üíæ Save Settings</button>
            </div>
        </div>
    </div>
  <!-- Edit Workout Stats Modal -->
    <div id="editStatsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
            <h3 class="modal-title">‚úèÔ∏è Edit Workout Stats</h3>
            <button class="modal-close" onclick="closeModal(this.closest('.modal'))">&times;</button>
            </div>
                <!-- NEW DATE/TIME FIELDS ADDED HERE -->
                <div class="form-group">
                    <label>üìÖ Workout Date</label>
                    <input type="date" id="editWorkoutDate">
                </div>
                <div class="form-group">
                    <label>‚è±Ô∏è Workout Time (HH:MM)</label>
                    <input type="time" id="editWorkoutTime">
                </div>
                <div class="form-group">
                    <label>Workout Name</label>
                    <input type="text" id="editWorkoutName" placeholder="e.g., Morning Run">
                </div>
                <div class="form-group">
                    <label>üíì Average Heart Rate (BPM)</label>
                    <input type="number" id="editHeartRate" placeholder="e.g., 145">
                </div>
                <div class="form-group">
                    <label>üî• Total Calories Burned</label>
                    <input type="number" id="editCalories" placeholder="e.g., 350">
                </div>
                <div class="form-group">
                    <label>‚è±Ô∏è Duration (Minutes)</label>
                    <input type="number" id="editDurationMinutes" placeholder="e.g., 60">
                    <small style="color: #6c757d;">Primary workout length in minutes.</small>
                </div>
                <div class="form-group">
                    <label>üìè Distance</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="number" id="editDistance" placeholder="0.0" step="0.1" style="flex: 2;">
                        <select id="editDistanceUnit" style="flex: 1;">
                            <option value="">-- Select Unit --</option>
                            <option value="miles">Miles</option>
                            <option value="km">Kilometers</option>
                            <option value="meters">Meters</option>
                        </select>
                    </div>
                    <small style="color: #6c757d;">Use miles for walks/runs, km for rows/bikes</small>
                </div>
                <div class="form-group">
                    <label>üìù Notes (Optional)</label>
                    <textarea id="editWorkoutNotes" rows="3" placeholder="How did you feel? Any achievements?"></textarea>
                </div>
                <button class="btn btn-success" onclick="saveWorkoutStats()">üíæ Save Changes</button>
            </div>
        </div>
    </div>
        <script>
        // Move modals out of scrolling container so they center on screen correctly
        document.addEventListener('DOMContentLoaded', () => {
          document.querySelectorAll('.modal').forEach(modal => {
            if (modal.parentElement !== document.body) {
              document.body.appendChild(modal);
            }
          });
        });
        </script>
    </body>
</html>
    
