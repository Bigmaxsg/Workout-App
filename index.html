<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workout Tracker Pro</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #001f3f 0%, #003d5c 100%);
            min-height: 100vh;
            padding: 10px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: #f5f5dc;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            overflow: hidden;
            border: 3px solid #8b7355;
        }

        .header {
            background: linear-gradient(135deg, #001f3f 0%, #003d5c 100%);
            color: #d4af37;
            padding: 20px;
            text-align: center;
            border-bottom: 3px solid #d4af37;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 5px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .nav {
            display: flex;
            background: #d9c7a5;
            border-bottom: 2px solid #8b7355;
        }

        .nav-btn {
            flex: 1;
            padding: 15px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: #3e3024;
            transition: all 0.3s;
        }

        .nav-btn.active {
            background: #f5f5dc;
            color: #001f3f;
            border-bottom: 3px solid #d4af37;
        }

        .content {
            padding: 20px;
            min-height: 400px;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        select, input, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 16px;
            transition: border 0.3s;
        }

        select:focus, input:focus, textarea:focus {
            outline: none;
            border-color: #003d5c;
        }

        .btn {
            padding: 14px 28px;
            background: linear-gradient(135deg, #001f3f 0%, #003d5c 100%);
            color: #d4af37;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
            margin-top: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 31, 63, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: #8b7355;
            color: #f5f5dc;
        }

        .btn-success {
            background: linear-gradient(135deg, #4a6741 0%, #5d8055 100%);
            color: #f5f5dc;
        }

        .btn-danger {
            background: linear-gradient(135deg, #8b0000 0%, #a52a2a 100%);
            color: #f5f5dc;
        }

        .exercise-card {
            background: #e8dcc4;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #003d5c;
        }

        .exercise-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .exercise-name {
            font-weight: 700;
            font-size: 16px;
            color: #333;
        }

        .exercise-details {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .detail-input {
            display: flex;
            flex-direction: column;
        }

        .detail-input label {
            font-size: 12px;
            margin-bottom: 5px;
            color: #6c757d;
        }

        .detail-input input {
            padding: 8px;
            font-size: 14px;
        }

        .exercise-image {
            width: 100%;
            max-width: 400px;
            min-height: 250px;
            background: #e9ecef;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 15px auto;
            overflow: hidden;
            position: relative;
            border: 2px solid #003d5c;
        }
        
        .exercise-image img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            background: white;
        }
        
        .exercise-image-fallback {
            color: #6c757d;
            font-size: 14px;
            text-align: center;
            padding: 20px;
        }
        
        .image-loading {
            color: #003d5c;
            font-size: 16px;
            font-weight: 600;
        }

        .recommendation-card {
            background: linear-gradient(135deg, #003d5c 0%, #005580 100%);
            color: #f5f5dc;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 2px solid #d4af37;
        }

        .recommendation-card h3 {
            margin-bottom: 10px;
            font-size: 20px;
        }

        .recommendation-card p {
            margin-bottom: 8px;
            line-height: 1.6;
        }

        .workout-history {
            margin-top: 20px;
        }

        .history-item {
            background: #e8dcc4;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #003d5c;
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .history-date {
            font-weight: 600;
            color: #333;
        }

        .history-type {
            color: #003d5c;
            font-weight: 600;
        }

        .history-exercises {
            font-size: 14px;
            color: #6c757d;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #001f3f 0%, #003d5c 100%);
            color: #d4af37;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            border: 2px solid #8b7355;
        }

        .stat-number {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 5px;
            color: #d4af37;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
            color: #f5f5dc;
        }

        .progress-chart {
            background: #e8dcc4;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            min-height: 200px;
            border: 2px solid #8b7355;
        }

        .chart-title {
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
        }

        .chart-bar {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .chart-label {
            width: 120px;
            font-size: 14px;
            color: #6c757d;
        }

        .chart-fill {
            flex: 1;
            height: 30px;
            background: linear-gradient(90deg, #001f3f 0%, #003d5c 100%);
            border-radius: 5px;
            position: relative;
        }

        .chart-value {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: #d4af37;
            font-weight: 600;
            font-size: 14px;
        }

        .info-box {
            background: #d9c7a5;
            border-left: 4px solid #003d5c;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .info-box p {
            color: #3e3024;
            line-height: 1.6;
            font-size: 14px;
        }

        .delete-btn {
            background: #8b0000;
            color: #f5f5dc;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
        }

        .add-exercise-btn {
            background: #4a6741;
            color: #f5f5dc;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            margin-top: 10px;
        }

        .workout-timer {
            background: linear-gradient(135deg, #003d5c 0%, #005580 100%);
            color: #d4af37;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
            border: 2px solid #d4af37;
        }

        .timer-display {
            font-size: 48px;
            font-weight: 700;
            margin: 10px 0;
        }

        .timer-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
        }

        .timer-btn {
            padding: 10px 20px;
            background: rgba(245, 245, 220, 0.2);
            border: 2px solid #d4af37;
            color: #d4af37;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 20px;
            max-width: 500px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #6c757d;
        }

        /* IMPROVED MOBILE LAYOUT FOR CONTROLS */
        .control-group {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: 15px;
        }

        .control-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 0;
        }

        .control-label {
            font-size: 11px;
            color: #6c757d;
            margin-bottom: 5px;
            font-weight: 600;
            text-align: center;
            white-space: nowrap;
        }

        .control-buttons {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 3px;
            width: 100%;
        }

        .adjust-btn {
            background: #8b7355;
            color: #f5f5dc;
            border: none;
            width: 28px;
            height: 28px;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .adjust-btn.plus {
            background: #003d5c;
            color: #d4af37;
        }

        .control-input {
            width: 100%;
            max-width: 55px;
            text-align: center;
            font-size: 14px;
            font-weight: bold;
            padding: 6px 2px;
            border: 2px solid #003d5c;
            border-radius: 6px;
        }

        @media (max-width: 600px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .nav-btn {
                font-size: 12px;
                padding: 12px 8px;
            }

            .exercise-card {
                padding: 12px;
            }

            .control-group {
                gap: 4px;
            }

            .control-label {
                font-size: 10px;
            }

            .control-buttons {
                gap: 2px;
            }

            .control-input {
                max-width: 45px;
                font-size: 13px;
                padding: 5px 1px;
            }

            .adjust-btn {
                width: 26px;
                height: 26px;
                font-size: 14px;
            }

            .timer-display {
                font-size: 36px;
            }
        }

        @media (max-width: 400px) {
            .exercise-card {
                padding: 10px;
            }

            .control-group {
                gap: 3px;
            }

            .control-input {
                max-width: 40px;
                font-size: 12px;
            }

            .adjust-btn {
                width: 24px;
                height: 24px;
                font-size: 13px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>&#128170; Workout Tracker Pro</h1>
            <p>Your Personal Fitness Companion</p>
        </div>

        <div class="nav">
            <button class="nav-btn active" onclick="showSection('workout')">Workout</button>
            <button class="nav-btn" onclick="showSection('recommend')">Recommend</button>
            <button class="nav-btn" onclick="showSection('progress')">Progress</button>
            <button class="nav-btn" onclick="showSection('history')">History</button>
        </div>

        <div class="content">
            <!-- Workout Section -->
            <div id="workout" class="section active">
                <div class="workout-timer">
                    <h3>Workout Timer</h3>
                    <div class="timer-display" id="timerDisplay">00:00</div>
                    <div class="timer-controls">
                        <button class="timer-btn" onclick="startTimer()">Start</button>
                        <button class="timer-btn" onclick="pauseTimer()">Pause</button>
                        <button class="timer-btn" onclick="resetTimer()">Reset</button>
                    </div>
                </div>

                <div id="workoutSetup">
                    <div class="form-group">
                        <label>Select Workout Type</label>
                        <select id="workoutType" onchange="loadWorkout()">
                            <option value="">-- Choose a Workout --</option>
                            <option value="custom">&#10133; Create Custom Workout</option>
                            <option value="warmup">&#128295; Dynamic Warm-up</option>
                            <option value="leg">&#129461; Leg Day</option>
                            <option value="chest">&#128170; Chest Day</option>
                            <option value="back">&#127947;&#65039; Back & Biceps</option>
                            <option value="shoulders">&#128170; Shoulders & Triceps</option>
                            <option value="abs">&#128293; Core/Abs Blast</option>
                            <option value="kettlebell">&#127947;&#65039; Kettlebell Circuit</option>
                            <option value="cardio">&#128692; Cardio Day</option>
                            <option value="fullbody">&#127919; Full Body Power</option>
                        </select>
                    </div>

                    <div id="workoutContainer"></div>

                    <div id="workoutModeSelection" style="display:none;">
                        <div class="info-box">
                            <p><strong>Choose Your Workout Style:</strong></p>
                            <p><strong>Traditional:</strong> Complete all sets of one exercise before moving to the next.</p>
                            <p><strong>Circuit:</strong> Do one set of each exercise, then repeat for all rounds.</p>
                            <p style="margin-top: 10px; font-size: 13px;"><strong>&#8986; Apple Watch Tip:</strong> Manually start a "Traditional Strength Training" workout on your Watch when you begin!</p>
                        </div>
                        <button class="btn" onclick="startGuidedWorkout('traditional')" style="margin-bottom: 10px;">
                            &#127947;&#65039; Start Traditional Style
                        </button>
                        <button class="btn btn-success" onclick="startGuidedWorkout('circuit')">
                            &#128293; Start Circuit Style
                        </button>
                    </div>
                </div>

                <!-- Guided Workout Mode -->
                <div id="guidedWorkoutMode" style="display:none;">
                    <div class="recommendation-card" id="currentExerciseCard">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3 id="exerciseProgress">Exercise 1 of 5</h3>
                            <div id="setProgress" style="font-size: 18px; font-weight: bold;">Set 1/3</div>
                        </div>
                        
                        <h2 id="currentExerciseName" style="font-size: 24px; margin-bottom: 10px;">Dumbbell Squats</h2>
                        
                        <div style="background: rgba(245,245,220,0.2); padding: 15px; border-radius: 10px; margin: 15px 0;">
                            <div style="display: flex; justify-content: space-around; text-align: center;">
                                <div>
                                    <div style="font-size: 28px; font-weight: bold;" id="currentWeight">25</div>
                                    <div style="font-size: 14px;">lbs</div>
                                </div>
                                <div>
                                    <div style="font-size: 28px; font-weight: bold;" id="currentReps">12</div>
                                    <div style="font-size: 14px;">reps</div>
                                </div>
                                <div>
                                    <div style="font-size: 28px; font-weight: bold;" id="currentSets">3</div>
                                    <div style="font-size: 14px;">sets</div>
                                </div>
                            </div>
                        </div>

                        <button class="btn btn-secondary" onclick="showCurrentExerciseInfo()" style="margin-bottom: 10px;">
                            &#128214; View Form Instructions
                        </button>

                        <div id="restTimer" style="display:none; text-align: center; margin: 20px 0;">
                            <h3>Rest Time</h3>
                            <div style="font-size: 48px; font-weight: bold; color: #d4af37;" id="restDisplay">60</div>
                            <button class="btn" onclick="skipRest()">Skip Rest</button>
                        </div>

                        <button class="btn btn-success" id="completeSetBtn" onclick="completeSet()" style="font-size: 18px; padding: 18px;">
                            &#10004; Complete Set
                        </button>
                    </div>

                    <div style="margin-top: 20px; text-align: center;">
                        <button class="btn btn-danger" onclick="endWorkout()">
                            End Workout Early
                        </button>
                    </div>

                    <!-- Progress Overview -->
                    <div class="progress-chart" style="margin-top: 20px;">
                        <h3 class="chart-title">Workout Progress</h3>
                        <div id="workoutProgressList"></div>
                    </div>
                </div>
            </div>

            <!-- Recommendation Section -->
            <div id="recommend" class="section">
                <h2 style="margin-bottom: 20px;">Today's Recommendation</h2>
                <div id="recommendationContainer"></div>
            </div>

            <!-- Progress Section -->
            <div id="progress" class="section">
                <h2 style="margin-bottom: 20px;">Your Progress</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalWorkouts">0</div>
                        <div class="stat-label">Total Workouts</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="thisWeek">0</div>
                        <div class="stat-label">This Week</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalVolume">0</div>
                        <div class="stat-label">Total Volume (lbs)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="streak">0</div>
                        <div class="stat-label">Day Streak</div>
                    </div>
                </div>

                <div class="progress-chart">
                    <h3 class="chart-title">Workout Distribution</h3>
                    <div id="workoutDistribution"></div>
                </div>

                <div class="progress-chart">
                    <h3 class="chart-title">Volume Progress (Last 10 Workouts)</h3>
                    <div id="volumeProgress"></div>
                </div>
            </div>

            <!-- History Section -->
            <div id="history" class="section">
                <h2 style="margin-bottom: 20px;">Workout History</h2>
                <div class="info-box">
                    <p><strong>Pro Tip:</strong> Track your progress by reviewing past workouts. Try to beat your previous weights and reps!</p>
                </div>
                <div id="historyContainer"></div>
            </div>
        </div>
    </div>

    <!-- Exercise Info Modal -->
    <div id="exerciseModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalExerciseName"></h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div id="modalExerciseContent"></div>
        </div>
    </div>

    <!-- Add Custom Exercise Modal -->
    <div id="addExerciseModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">&#10133; Add Custom Exercise</h3>
                <button class="modal-close" onclick="closeAddExerciseModal()">&times;</button>
            </div>
            <div>
                <div class="form-group">
                    <label>Exercise Name *</label>
                    <input type="text" id="newExerciseName" placeholder="e.g., Dumbbell Chest Fly">
                </div>
                <div class="form-group">
                    <label>Equipment *</label>
                    <input type="text" id="newExerciseEquipment" placeholder="e.g., Dumbbells">
                </div>
                <div class="form-group">
                    <label>Instructions *</label>
                    <textarea id="newExerciseInstructions" rows="4" placeholder="Describe how to perform this exercise..."></textarea>
                </div>
                <div class="form-group">
                    <label>Target Muscles/Description</label>
                    <input type="text" id="newExerciseImage" placeholder="e.g., &#128170; Targets: Chest, Shoulders">
                </div>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px;">
                    <div class="form-group">
                        <label>Default Weight (lbs)</label>
                        <input type="number" id="newExerciseWeight" value="25">
                    </div>
                    <div class="form-group">
                        <label>Default Sets</label>
                        <input type="number" id="newExerciseSets" value="3">
                    </div>
                    <div class="form-group">
                        <label>Default Reps</label>
                        <input type="number" id="newExerciseReps" value="12">
                    </div>
                </div>
                <button class="btn" onclick="saveNewExercise()">&#128190; Add Exercise to Database</button>
            </div>
        </div>
    </div>

    <script>
        // Using FREE public domain exercise images from yuhonas/free-exercise-db
        // All images are CC-BY-SA-4.0 or public domain - free for commercial use!
        
        function getExerciseImageUrl(exerciseName) {
            // **FINAL & FULLY VERIFIED**: This mapping now correctly points to all exercises.
            const exerciseMapping = {
                'Air Bike': 'Air_Bike',
                'Arm Circles': 'Arm_Circles',
                'Assisted Pull-Up': 'Assisted_Pull-Up',
                'Barbell Bench Press - Medium Grip': 'Barbell_Bench_Press_-_Medium_Grip',
                'Barbell Curl': 'Barbell_Curl',
                'Barbell Full Squat': 'Barbell_Full_Squat',
                'Barbell Glute Bridge': 'Barbell_Glute_Bridge',
                'Barbell Incline Bench Press - Medium Grip': 'Barbell_Incline_Bench_Press_-_Medium_Grip',
                'Barbell Lunge': 'Barbell_Lunge',
                'Barbell Shrug': 'Barbell_Shrug',
                'Bench Dip': 'Bench_Dip',
                'Bent Over Dumbbell Rear Delt Raise': 'Bent_Over_Dumbbell_Rear_Delt_Raise',
                'Bent Over Barbell Row': 'Bent_Over_Barbell_Row',
                'Bicycle Crunch': 'Bicycle_Crunch',
                'Bodyweight Squat': 'Bodyweight_Squat',
                'Bulgarian Split Squat': 'Bulgarian_Split_Squat',
                'Chest Dip': 'Chest_Dip',
                'Chin Up': 'Chin_Up',
                'Close-Grip Bench Press': 'Close-Grip_Bench_Press',
                'Close-Grip Push-Up': 'Close-Grip_Push-Up',
                'Concentration Curls': 'Concentration_Curls',
                'Decline Barbell Bench Press': 'Decline_Barbell_Bench_Press',
                'Decline Dumbbell Bench Press': 'Decline_Dumbbell_Bench_Press',
                'Decline Dumbbell Fly': 'Decline_Dumbbell_Fly',
                'Decline Push-Up': 'Decline_Push-Up',
                'Dips - Triceps Version': 'Dips_-_Triceps_Version',
                'Dumbbell Bench Press': 'Dumbbell_Bench_Press',
                'Dumbbell Bicep Curl': 'Dumbbell_Bicep_Curl',
                'Dumbbell Flyes': 'Dumbbell_Flyes',
                'Dumbbell Goblet Squat': 'Dumbbell_Goblet_Squat',
                'Dumbbell Lunge': 'Dumbbell_Lunge',
                'Dumbbell Pullover': 'Dumbbell_Pullover',
                'Dumbbell Shrug': 'Dumbbell_Shrug',
                'Dumbbell Shoulder Press': 'Dumbbell_Shoulder_Press',
                'EZ-Bar Curl': 'EZ-Bar_Curl',
                'Front Dumbbell Raise': 'Front_Dumbbell_Raise',
                'Hammer Curls': 'Hammer_Curls',
                'Incline Dumbbell Curl': 'Incline_Dumbbell_Curl',
                'Incline Dumbbell Fly': 'Incline_Dumbbell_Fly',
                'Incline Dumbbell Press': 'Incline_Dumbbell_Press',
                'Incline Push-Up': 'Incline_Push-Up',
                'Jump Squat': 'Jump_Squat',
                'Kettlebell Goblet Squat': 'Kettlebell_Goblet_Squat',
                'Kettlebell Halo': 'Kettlebell_Halo',
                'Kettlebell One-Arm Row': 'Kettlebell_One-Arm_Row',
                'Kettlebell Overhead Press': 'Kettlebell_Overhead_Press',
                'Kettlebell Swing': 'Kettlebell_Swing',
                'Kettlebell Turkish Get-Up': 'Turkish_Get_Up',
                'Leg Swings': 'Leg_Swings',
                'Lying Triceps Extension': 'Lying_Triceps_Extension',
                'Mountain Climber': 'Mountain_Climber',
                'One Arm Dumbbell Row': 'One_Arm_Dumbbell_Row',
                'Overhead Triceps Extension': 'Overhead_Triceps_Extension',
                'Pendlay Row': 'Pendlay_Row',
                'Plank': 'Plank',
                'Preacher Curl': 'Preacher_Curl',
                'Pullups': 'Pullups',
                'Pushups': 'Pushups',
                'Romanian Deadlift': 'Romanian_Deadlift',
                'Rowing Machine': 'Rowing_Machine',
                'Russian Twist': 'Russian_Twist',
                'Seated Calf Raise': 'Seated_Calf_Raise',
                'Seated Dumbbell Press': 'Seated_Dumbbell_Press',
                'Side Bend': 'Side_Bend',
                'Side Lateral Raise': 'Side_Lateral_Raise',
                'Standing Calf Raise': 'Standing_Calf_Raise',
                'Step Up': 'Step_Up',
                'Stiff Leg Dumbbell Deadlift': 'Stiff_Leg_Dumbbell_Deadlift',
                'T-Bar Row': 'T-Bar_Row',
                'Tricep Kickback': 'Tricep_Kickback',
                'Walking Lunge': 'Walking_Lunge',
                'Wall Sit': 'Wall_Sit',
                'Wide-Grip Push-Up': 'Wide-Grip_Push-Up',
                'Zottman Curl': 'Zottman_Curl',
            };
            
            const mappedName = exerciseMapping[exerciseName];
            return `https://raw.githubusercontent.com/yuhonas/free-exercise-db/main/exercises/${mappedName}/0.jpg`;
        }

        // **NEW & OVERHAULED**: Exercise Database tailored to your equipment and verified against yuhonas DB
        const exerciseDatabase = {
            // Bodyweight & Warmup
            'Bodyweight Squat': { equipment: 'Bodyweight', instructions: 'Stand with feet shoulder-width apart. Lower your hips back and down as if sitting in a chair, keeping your chest up and back straight. Go as low as you can comfortably, then push through your heels to return to the starting position.', sets: 2, reps: 15, weight: 0, image: '&#129336; Targets: Full Body Mobility' },
            'Pushups': { equipment: 'Bodyweight', instructions: 'Start in a plank position with hands under your shoulders. Lower your body until your chest nearly touches the floor. Keep your body in a straight line. Push back up to the starting position.', sets: 2, reps: 10, weight: 0, image: '&#129336; Targets: Chest, Shoulders, Core' },
            'Jump Squat': { equipment: 'Bodyweight', instructions: 'Perform a bodyweight squat, but explode up into a jump at the top of the movement. Land softly and immediately go into the next squat.', sets: 3, reps: 12, weight: 0, image: '&#129336; Targets: Legs, Power' },
            'Arm Circles': { equipment: 'Bodyweight', instructions: 'Stand with your arms extended out to your sides. Make small circles with your hands, gradually increasing the size. Reverse direction after 30 seconds.', sets: 1, reps: 30, weight: 0, image: '&#129336; Targets: Shoulder Mobility (time in seconds)' },
            'Leg Swings': { equipment: 'Bodyweight', instructions: 'Hold onto a stable surface for balance. Swing one leg forward and backward in a controlled motion. Then swing it side-to-side across your body. Repeat on the other leg.', sets: 1, reps: 15, weight: 0, image: '&#129336; Targets: Hip Mobility' },
            'Plank': { equipment: 'Bodyweight', instructions: 'Hold a push-up position, but on your forearms. Keep your body in a perfectly straight line from your head to your heels. Brace your core.', sets: 3, reps: 45, weight: 0, image: '&#128293; Targets: Core Stability (time in seconds)' },
            'Mountain Climber': { equipment: 'Bodyweight', instructions: 'From a push-up position, bring one knee towards your chest, then quickly switch and bring the other knee in. Continue in a running motion.', sets: 3, reps: 30, weight: 0, image: '&#128293; Targets: Core, Cardio (time in seconds)' },
            'Bicycle Crunch': { equipment: 'Bodyweight', instructions: 'Lie on your back and bring your opposite elbow to your opposite knee in a twisting, cycling motion. Keep your core engaged and movements controlled.', sets: 3, reps: 20, weight: 0, image: '&#128293; Targets: Abs, Obliques' },
            'Close-Grip Push-Up': { equipment: 'Bodyweight', instructions: 'Perform a push-up with your hands closer than shoulder-width apart to place more emphasis on the triceps.', sets: 3, reps: 12, weight: 0, image: '&#128170; Targets: Triceps, Chest' },
            'Decline Push-Up': { equipment: 'Bodyweight, Bench', instructions: 'Place your feet on a bench and your hands on the floor. Perform a push-up. This variation targets the upper chest.', sets: 3, reps: 12, weight: 0, image: '&#128170; Targets: Upper Chest, Shoulders' },
            'Incline Push-Up': { equipment: 'Bodyweight, Bench', instructions: 'Place your hands on a bench and your feet on the floor. Perform a push-up. This is a less difficult variation that targets the lower chest.', sets: 3, reps: 15, weight: 0, image: '&#128170; Targets: Lower Chest, Triceps' },
            'Wide-Grip Push-Up': { equipment: 'Bodyweight', instructions: 'Perform a push-up with your hands placed wider than your shoulders to increase the focus on your chest.', sets: 3, reps: 12, weight: 0, image: '&#128170; Targets: Chest, Shoulders' },

            // Barbell (from Squat Rack)
            'Barbell Full Squat': { equipment: 'Barbell', instructions: 'With the barbell on your upper back, stand with feet shoulder-width apart. Squat down until your hips are below your knees, keeping your chest up. Drive through your heels to stand back up.', sets: 4, reps: 8, weight: 135, image: '&#129461; Targets: Quads, Glutes, Hamstrings' },
            'Barbell Bench Press - Medium Grip': { equipment: 'Barbell, Bench', instructions: 'Lie on a flat bench, gripping the barbell slightly wider than shoulder-width. Lower the bar to your mid-chest, then press it back up until your arms are fully extended.', sets: 4, reps: 8, weight: 135, image: '&#128170; Targets: Chest, Shoulders, Triceps' },
            'Barbell Incline Bench Press - Medium Grip': { equipment: 'Barbell, Incline Bench', instructions: 'On an incline bench, perform a bench press. This variation emphasizes the upper part of your chest.', sets: 3, reps: 10, weight: 95, image: '&#128170; Targets: Upper Chest, Shoulders' },
            'Decline Barbell Bench Press': { equipment: 'Barbell, Decline Bench', instructions: 'On a decline bench, perform a bench press. This variation emphasizes the lower part of your chest.', sets: 3, reps: 10, weight: 145, image: '&#128170; Targets: Lower Chest, Triceps' },
            'Bent Over Barbell Row': { equipment: 'Barbell', instructions: 'Hinge at your hips, keeping your back straight. Grab the barbell with an overhand grip and pull it towards your lower chest, squeezing your back muscles.', sets: 4, reps: 8, weight: 95, image: '&#127947;&#65039; Targets: Back, Biceps' },
            'Pendlay Row': { equipment: 'Barbell', instructions: 'From a bent-over position with the barbell on the floor, explosively pull the bar to your chest. Let it rest on the floor between each rep to reset.', sets: 3, reps: 8, weight: 95, image: '&#127947;&#65039; Targets: Back Power, Lats' },
            'Barbell Shrug': { equipment: 'Barbell', instructions: 'Hold the barbell in front of you. Without bending your arms, shrug your shoulders straight up towards your ears. Squeeze at the top, then lower with control.', sets: 3, reps: 12, weight: 135, image: '&#127947;&#65039; Targets: Traps' },
            'Romanian Deadlift': { equipment: 'Barbell', instructions: 'Hold the barbell and hinge at your hips, keeping your back straight and legs mostly straight (slight knee bend is okay). Lower the bar until you feel a deep stretch in your hamstrings, then return to standing.', sets: 3, reps: 10, weight: 135, image: '&#129461; Targets: Hamstrings, Glutes' },
            'Barbell Lunge': { equipment: 'Barbell', instructions: 'With the barbell on your back, step forward into a lunge, lowering until both knees are at 90-degree angles. Push off the front foot to return to the start. Alternate legs.', sets: 3, reps: 10, weight: 65, image: '&#129461; Targets: Quads, Glutes' },
            'Barbell Glute Bridge': { equipment: 'Barbell', instructions: 'Lie on your back with knees bent. Place a barbell across your hips. Drive your hips up towards the ceiling, squeezing your glutes. Lower with control.', sets: 3, reps: 12, weight: 95, image: '&#129461; Targets: Glutes, Hamstrings' },
            'Close-Grip Bench Press': { equipment: 'Barbell, Bench', instructions: 'Perform a bench press, but with your hands closer together (shoulder-width or slightly less). This shifts the focus to your triceps.', sets: 3, reps: 10, weight: 95, image: '&#128170; Targets: Triceps, Chest' },
            'T-Bar Row': { equipment: 'Barbell', instructions: 'Place one end of a barbell in a corner. Grip the bar with both hands and pull it towards your chest, keeping your back straight.', sets: 3, reps: 10, weight: 70, image: '&#127947;&#65039; Targets: Mid-Back, Lats' },

            // Dumbbell
            'Dumbbell Bench Press': { equipment: 'Dumbbells, Bench', instructions: 'Lie on a flat bench holding dumbbells at your chest. Press them straight up until your arms are extended, then lower them back down with control.', sets: 3, reps: 10, weight: 50, image: '&#128170; Targets: Chest, Shoulders, Triceps' },
            'Incline Dumbbell Press': { equipment: 'Dumbbells, Incline Bench', instructions: 'On an incline bench, perform a dumbbell press. This focuses on the upper chest.', sets: 3, reps: 10, weight: 40, image: '&#128170; Targets: Upper Chest, Shoulders' },
            'Decline Dumbbell Bench Press': { equipment: 'Dumbbells, Decline Bench', instructions: 'On a decline bench, perform a dumbbell press. This focuses on the lower chest.', sets: 3, reps: 10, weight: 55, image: '&#128170; Targets: Lower Chest, Triceps' },
            'Dumbbell Flyes': { equipment: 'Dumbbells, Bench', instructions: 'Lie on a flat bench with dumbbells pressed over your chest. With a slight bend in your elbows, lower the weights out to your sides in a wide arc. Squeeze your chest to bring them back up.', sets: 3, reps: 12, weight: 25, image: '&#128170; Targets: Chest (Isolation)' },
            'Incline Dumbbell Fly': { equipment: 'Dumbbells, Incline Bench', instructions: 'Perform a dumbbell fly on an incline bench to target the upper chest fibers.', sets: 3, reps: 12, weight: 20, image: '&#128170; Targets: Upper Chest (Isolation)' },
            'Decline Dumbbell Fly': { equipment: 'Dumbbells, Decline Bench', instructions: 'Perform a dumbbell fly on a decline bench to target the lower chest fibers.', sets: 3, reps: 12, weight: 30, image: '&#128170; Targets: Lower Chest (Isolation)' },
            'Dumbbell Pullover': { equipment: 'Dumbbell, Bench', instructions: 'Lie with your upper back across a flat bench. Hold one dumbbell with both hands over your chest. Lower it back behind your head, feeling a stretch in your chest and lats. Pull it back over your chest.', sets: 3, reps: 12, weight: 40, image: '&#128170; Targets: Chest, Lats' },
            'One Arm Dumbbell Row': { equipment: 'Dumbbell, Bench', instructions: 'Place one knee and one hand on a flat bench for support. Hold a dumbbell in the other hand and pull it up towards your hip, keeping your back straight and core tight. Lower with control.', sets: 3, reps: 10, weight: 40, image: '&#127947;&#65039; Targets: Back, Biceps' },
            'Dumbbell Shrug': { equipment: 'Dumbbells', instructions: 'Stand holding heavy dumbbells at your sides. Without bending your arms, shrug your shoulders straight up towards your ears. Squeeze at the top, then lower with control.', sets: 3, reps: 12, weight: 60, image: '&#127947;&#65039; Targets: Traps' },
            'Dumbbell Shoulder Press': { equipment: 'Dumbbells', instructions: 'Sit or stand holding dumbbells at shoulder height, palms forward. Press the weights directly overhead until your arms are fully extended. Lower with control.', sets: 4, reps: 10, weight: 35, image: '&#128170; Targets: Shoulders, Triceps' },
            'Seated Dumbbell Press': { equipment: 'Dumbbells, Bench', instructions: 'Sitting on a bench with back support, perform a dumbbell shoulder press. This provides more stability and allows you to focus on the shoulders.', sets: 4, reps: 10, weight: 40, image: '&#128170; Targets: Shoulders, Triceps' },
            'Side Lateral Raise': { equipment: 'Dumbbells', instructions: 'Stand with dumbbells at your sides. With a slight bend in your elbows, raise the weights out to your sides until they are at shoulder level. Lower with control.', sets: 3, reps: 15, weight: 15, image: '&#128170; Targets: Side Delts' },
            'Front Dumbbell Raise': { equipment: 'Dumbbells', instructions: 'Stand with dumbbells in front of your thighs. Raise one or both weights straight out in front of you up to shoulder level. Lower with control.', sets: 3, reps: 12, weight: 15, image: '&#128170; Targets: Front Delts' },
            'Bent Over Dumbbell Rear Delt Raise': { equipment: 'Dumbbells', instructions: 'Hinge at the hips with a flat back. Let the dumbbells hang down. Raise the weights out to your sides in a wide arc, squeezing your shoulder blades together.', sets: 3, reps: 15, weight: 15, image: '&#128170; Targets: Rear Delts, Upper Back' },
            'Dumbbell Bicep Curl': { equipment: 'Dumbbells', instructions: 'Stand or sit, holding dumbbells with palms facing forward. Curl the weights up towards your shoulders, keeping your elbows locked at your sides. Squeeze your biceps at the top and lower with control.', sets: 3, reps: 12, weight: 25, image: '&#127947;&#65039; Targets: Biceps' },
            'Hammer Curls': { equipment: 'Dumbbells', instructions: 'Perform a bicep curl, but with your palms facing each other (neutral grip). This targets the brachialis muscle and forearms more.', sets: 3, reps: 12, weight: 30, image: '&#127947;&#65039; Targets: Biceps, Forearms' },
            'Incline Dumbbell Curl': { equipment: 'Dumbbells, Incline Bench', instructions: 'Sit back on an incline bench, letting the dumbbells hang down with straight arms. Curl the weights up. The incline position provides a great stretch on the bicep.', sets: 3, reps: 12, weight: 20, image: '&#127947;&#65039; Targets: Biceps (Long Head)' },
            'Concentration Curls': { equipment: 'Dumbbell, Bench', instructions: 'Sit on a bench and brace your elbow against your inner thigh. Curl the dumbbell up towards your chest. This strict form provides excellent bicep isolation.', sets: 3, reps: 12, weight: 20, image: '&#127947;&#65039; Targets: Biceps (Peak)' },
            'Zottman Curl': { equipment: 'Dumbbells', instructions: 'Curl the dumbbells up with palms facing up. At the top, rotate your wrists so palms face down, and lower the weights slowly. Rotate back at the bottom.', sets: 3, reps: 12, weight: 20, image: '&#127947;&#65039; Targets: Biceps, Forearms' },
            'Overhead Triceps Extension': { equipment: 'Dumbbell', instructions: 'Sit or stand, holding one dumbbell with both hands over your head. Lower the dumbbell behind your head by bending your elbows. Extend your arms to lift it back up.', sets: 3, reps: 12, weight: 30, image: '&#128170; Targets: Triceps' },
            'Tricep Kickback': { equipment: 'Dumbbell', instructions: 'Hinge forward with a flat back, supporting yourself with one hand if needed. Hold a dumbbell with your elbow bent at 90 degrees. Extend your arm straight back, squeezing your tricep. Return to the start.', sets: 3, reps: 12, weight: 15, image: '&#128170; Targets: Triceps' },
            'Dumbbell Lunge': { equipment: 'Dumbbells', instructions: 'Hold dumbbells at your sides. Step forward into a lunge, keeping your front knee aligned with your ankle. Push off your front foot to return to the start.', sets: 3, reps: 10, weight: 20, image: '&#129461; Targets: Quads, Glutes' },
            'Walking Lunge': { equipment: 'Dumbbells', instructions: 'Perform a lunge, but instead of returning to the start, bring your back foot forward to step into the next lunge.', sets: 3, reps: 12, weight: 20, image: '&#129461; Targets: Quads, Glutes' },
            'Dumbbell Goblet Squat': { equipment: 'Dumbbell', instructions: 'Hold one dumbbell vertically against your chest. Perform a squat, keeping your chest up and elbows between your knees.', sets: 3, reps: 12, weight: 30, image: '&#129461; Targets: Quads, Glutes, Core' },
            'Bulgarian Split Squat': { equipment: 'Dumbbell, Bench', instructions: 'Place the top of one foot on a bench behind you. Hold dumbbells and squat down with your front leg.', sets: 3, reps: 10, weight: 20, image: '&#129461; Targets: Quads, Glutes' },
            'Stiff Leg Dumbbell Deadlift': { equipment: 'Dumbbells', instructions: 'Hold dumbbells in front of you. Hinge at your hips with a flat back and mostly straight legs. Lower the weights until you feel a deep hamstring stretch.', sets: 3, reps: 12, weight: 40, image: '&#129461; Targets: Hamstrings, Glutes' },
            'Standing Calf Raise': { equipment: 'Dumbbells', instructions: 'Stand holding dumbbells and press up onto the balls of your feet, raising your heels as high as possible. Lower with control.', sets: 4, reps: 15, weight: 40, image: '&#129461; Targets: Calves' },
            'Seated Calf Raise': { equipment: 'Dumbbells, Bench', instructions: 'Sit on a bench and place dumbbells on your knees. Press up onto the balls of your feet.', sets: 4, reps: 15, weight: 25, image: '&#129461; Targets: Calves (Soleus)' },
            'Step Up': { equipment: 'Dumbbells, Bench', instructions: 'Hold dumbbells and step up onto a bench or box with one foot. Drive through the heel to lift your body up. Step down with control.', sets: 3, reps: 12, weight: 20, image: '&#129461; Targets: Quads, Glutes' },
            'Side Bend': { equipment: 'Dumbbell', instructions: 'Hold a dumbbell in one hand. Bend your torso sideways towards the dumbbell, then use your obliques to pull yourself back to the upright position.', sets: 3, reps: 15, weight: 30, image: '&#128293; Targets: Obliques' },
            'Russian Twist': { equipment: 'Dumbbell', instructions: 'Sit on the floor, lean back, and lift your feet. Hold a dumbbell and twist your torso from side to side.', sets: 3, reps: 20, weight: 15, image: '&#128293; Targets: Obliques, Core' },

            // EZ Curl Bar
            'EZ-Bar Curl': { equipment: 'EZ Curl Bar', instructions: 'Hold the EZ-bar with an underhand grip. Curl the bar up towards your shoulders, keeping your elbows at your sides. Squeeze your biceps at the top.', sets: 3, reps: 12, weight: 50, image: '&#127947;&#65039; Targets: Biceps' },
            'Preacher Curl': { equipment: 'EZ Curl Bar, Bench', instructions: 'Using the backrest of your incline bench as a preacher bench, brace your arm and curl the EZ-bar with strict form.', sets: 3, reps: 12, weight: 40, image: '&#127947;&#65039; Targets: Biceps (Isolation)' },
            'Lying Triceps Extension': { equipment: 'EZ Curl Bar, Bench', instructions: 'Lie on a flat bench holding the EZ-bar above your chest. Lower the bar towards your forehead by bending your elbows. Extend your arms to press it back up. (Also known as Skull Crushers)', sets: 3, reps: 12, weight: 50, image: '&#128170; Targets: Triceps' },

            // Kettlebell
            'Kettlebell Swing': { equipment: 'Kettlebell', instructions: 'Hinge at your hips, swinging the kettlebell back between your legs. Explosively drive your hips forward to swing the kettlebell up to chest height.', sets: 4, reps: 15, weight: 30, image: '&#127947;&#65039; Targets: Glutes, Hamstrings, Power' },
            'Kettlebell Goblet Squat': { equipment: 'Kettlebell', instructions: 'Hold the kettlebell by its horns against your chest. Perform a deep squat, keeping your chest up.', sets: 3, reps: 12, weight: 30, image: '&#129461; Targets: Quads, Glutes' },
            'Kettlebell One-Arm Row': { equipment: 'Kettlebell', instructions: 'Hinge at the hips with a flat back. Pull the kettlebell up towards your hip, leading with your elbow.', sets: 3, reps: 12, weight: 30, image: '&#127947;&#65039; Targets: Back, Biceps' },
            'Kettlebell Overhead Press': { equipment: 'Kettlebell', instructions: 'From the rack position, press the kettlebell straight overhead until your arm is fully locked out. Keep your core tight.', sets: 3, reps: 10, weight: 30, image: '&#128170; Targets: Shoulders, Core' },
            'Kettlebell Halo': { equipment: 'Kettlebell', instructions: 'Hold the kettlebell upside down by the horns. Move it in a circle (halo) around your head. Keep your core tight and torso still.', sets: 3, reps: 10, weight: 30, image: '&#128170; Targets: Shoulder Mobility, Core' },
            'Kettlebell Turkish Get-Up': { equipment: 'Kettlebell', instructions: 'A complex, full-body movement that involves transitioning from lying on the floor to a standing position, all while keeping the kettlebell locked out overhead.', sets: 3, reps: 3, weight: 30, image: '&#127947;&#65039; Targets: Full Body, Stability' },

            // Bodyweight on Equipment
            'Pullups': { equipment: 'Pull-up Bar (Squat Rack)', instructions: 'Hang from the bar with an overhand grip. Pull your chest up to the bar. Lower yourself back down with control.', sets: 3, reps: 8, weight: 0, image: '&#127947;&#65039; Targets: Lats, Back, Biceps' },
            'Chin Up': { equipment: 'Pull-up Bar (Squat Rack)', instructions: 'Hang from the bar with an underhand grip. Pull your chin over the bar. This variation puts more emphasis on the biceps.', sets: 3, reps: 8, weight: 0, image: '&#127947;&#65039; Targets: Biceps, Lats' },
            'Bench Dip': { equipment: 'Bench', instructions: 'Place your hands on a bench behind you and your feet out in front. Lower your body by bending your elbows, then press back up. Great for triceps.', sets: 3, reps: 12, weight: 0, image: '&#128170; Targets: Triceps' },
            'Chest Dip': { equipment: 'Parallel Bars (if available)', instructions: 'On parallel bars, lean your torso forward as you lower your body to emphasize the chest.', sets: 3, reps: 10, weight: 0, image: '&#128170; Targets: Lower Chest, Triceps' },
            'Dips - Triceps Version': { equipment: 'Parallel Bars (if available)', instructions: 'On parallel bars, keep your torso upright as you lower your body to emphasize the triceps.', sets: 3, reps: 10, weight: 0, image: '&#128170; Targets: Triceps, Chest' },
            'Wall Sit': { equipment: 'Bodyweight', instructions: 'Slide your back down a wall until your thighs are parallel to the floor. Hold this position.', sets: 3, reps: 45, weight: 0, image: '&#129461; Targets: Quads, Endurance (time in seconds)' },

            // Cardio
            'Rowing Machine': { equipment: 'Concept 2 Rower', instructions: 'Drive powerfully with your legs first, then swing your back, and finally pull with your arms. Reverse the motion smoothly: arms, back, then legs.', sets: 1, reps: 15, weight: 0, image: '&#128695; Targets: Full Body Cardio (time in minutes)' },
            'Air Bike': { equipment: 'Recumbent Bike', instructions: 'Maintain a steady pace on the bike. Adjust resistance as needed to keep your heart rate in the desired zone.', sets: 1, reps: 20, weight: 0, image: '&#128692; Targets: Cardio (time in minutes)' },
        };

        // **NEW & REBUILT**: Predefined Workout Programs using new database
        const workoutPrograms = {
            warmup: {
                name: '&#128295; Dynamic Warm-up',
                exercises: ['Arm Circles', 'Leg Swings', 'Bodyweight Squat', 'Pushups']
            },
            leg: {
                name: '&#129461; Leg Day',
                exercises: ['Barbell Full Squat', 'Romanian Deadlift', 'Dumbbell Lunge', 'Bulgarian Split Squat', 'Standing Calf Raise']
            },
            chest: {
                name: '&#128170; Chest Day',
                exercises: ['Barbell Bench Press - Medium Grip', 'Incline Dumbbell Press', 'Decline Dumbbell Fly', 'Dumbbell Pullover', 'Pushups']
            },
            back: {
                name: '&#127947;&#65039; Back & Biceps',
                exercises: ['Pullups', 'Bent Over Barbell Row', 'One Arm Dumbbell Row', 'Barbell Curl', 'Hammer Curls']
            },
            shoulders: {
                name: '&#128170; Shoulders & Triceps',
                exercises: ['Dumbbell Shoulder Press', 'Side Lateral Raise', 'Bent Over Dumbbell Rear Delt Raise', 'Close-Grip Bench Press', 'Lying Triceps Extension']
            },
            abs: {
                name: '&#128293; Core/Abs Blast',
                exercises: ['Plank', 'Bicycle Crunch', 'Russian Twist', 'Mountain Climber']
            },
            kettlebell: {
                name: '&#127947;&#65039; Kettlebell Circuit',
                exercises: ['Kettlebell Swing', 'Kettlebell Goblet Squat', 'Kettlebell One-Arm Row', 'Kettlebell Overhead Press', 'Kettlebell Halo']
            },
            cardio: {
                name: '&#128692; Cardio Day',
                exercises: ['Rowing Machine', 'Air Bike']
            },
            fullbody: {
                name: '&#127919; Full Body Power',
                exercises: ['Barbell Full Squat', 'Barbell Bench Press - Medium Grip', 'Bent Over Barbell Row', 'Dumbbell Shoulder Press', 'Plank']
            }
        };

        // App State
        let currentWorkout = [];
        let workoutHistory = JSON.parse(localStorage.getItem('workoutHistory')) || [];
        let timerInterval = null;
        let timerSeconds = 0;
        let timerRunning = false;
        
        // Guided Workout State
        let guidedMode = false;
        let workoutStyle = 'traditional';
        let currentExerciseIndex = 0;
        let currentSetNumber = 1;
        let currentRound = 1;
        let completedSets = [];
        let restInterval = null;
        let restTimeRemaining = 0;

        // Initialize
        updateRecommendation();
        updateProgress();
        updateHistory();
        loadCustomWorkoutsIntoDropdown();
        loadCustomExercises();
        
        // Load custom exercises from localStorage
        function loadCustomExercises() {
            const customExercises = JSON.parse(localStorage.getItem('customExercises')) || {};
            Object.keys(customExercises).forEach(name => {
                if(!exerciseDatabase[name]) { // Avoid overwriting curated exercises
                    exerciseDatabase[name] = customExercises[name];
                }
            });
        }
        
        // Save custom exercise to localStorage
        function saveCustomExerciseToDB(name, data) {
            const customExercises = JSON.parse(localStorage.getItem('customExercises')) || {};
            customExercises[name] = data;
            localStorage.setItem('customExercises', JSON.stringify(customExercises));
            exerciseDatabase[name] = data;
        }
        
        // Open add exercise modal
        function openAddExerciseModal() {
            document.getElementById('addExerciseModal').classList.add('active');
        }
        
        // Close add exercise modal
        function closeAddExerciseModal() {
            document.getElementById('addExerciseModal').classList.remove('active');
            document.getElementById('newExerciseName').value = '';
            document.getElementById('newExerciseEquipment').value = '';
            document.getElementById('newExerciseInstructions').value = '';
            document.getElementById('newExerciseImage').value = '';
            document.getElementById('newExerciseWeight').value = '25';
            document.getElementById('newExerciseSets').value = '3';
            document.getElementById('newExerciseReps').value = '12';
        }
        
        // Save new custom exercise
        function saveNewExercise() {
            const name = document.getElementById('newExerciseName').value.trim();
            const equipment = document.getElementById('newExerciseEquipment').value.trim();
            const instructions = document.getElementById('newExerciseInstructions').value.trim();
            const image = document.getElementById('newExerciseImage').value.trim() || '&#128170; Custom Exercise';
            const weight = parseInt(document.getElementById('newExerciseWeight').value) || 25;
            const sets = parseInt(document.getElementById('newExerciseSets').value) || 3;
            const reps = parseInt(document.getElementById('newExerciseReps').value) || 12;
            
            if (!name || !equipment || !instructions) {
                alert('Please fill in all required fields (Name, Equipment, Instructions)');
                return;
            }
            
            if (exerciseDatabase[name]) {
                if (!confirm(`An exercise named "${name}" already exists. Do you want to overwrite it?`)) {
                    return;
                }
            }
            
            const exerciseData = {
                equipment,
                instructions,
                sets,
                reps,
                weight,
                image
            };
            
            saveCustomExerciseToDB(name, exerciseData);
            closeAddExerciseModal();
            alert(`&#9989; Exercise "${name}" added successfully!\n\nYou can now use it in your workouts!`);
            
            if (document.getElementById('customExerciseSelect')) {
                loadCustomWorkout();
            }
        }
        
        // Load saved custom workouts into main dropdown
        function loadCustomWorkoutsIntoDropdown() {
            const savedCustomWorkouts = JSON.parse(localStorage.getItem('customWorkouts')) || {};
            const customWorkoutNames = Object.keys(savedCustomWorkouts);
            
            const dropdown = document.getElementById('workoutType');
            const existingOptions = dropdown.querySelectorAll('option[data-custom="true"]');
            existingOptions.forEach(opt => opt.remove());
            
            if (customWorkoutNames.length === 0) return;

            const separator = document.createElement('option');
            separator.disabled = true;
            separator.textContent = '--- My Custom Workouts ---';
            separator.setAttribute('data-custom', 'true');
            dropdown.appendChild(separator);
            
            customWorkoutNames.forEach(name => {
                const option = document.createElement('option');
                option.value = 'saved_' + name;
                option.textContent = '&#11088; ' + name;
                option.setAttribute('data-custom', 'true');
                dropdown.appendChild(option);
            });
        }

        // Navigation
        function showSection(section) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            
            document.getElementById(section).classList.add('active');
            event.target.classList.add('active');

            if (section === 'recommend') updateRecommendation();
            if (section === 'progress') updateProgress();
            if (section === 'history') updateHistory();
        }

        function generateExerciseCardHTML(ex, idx, isCustom = false) {
            const idPrefix = isCustom ? 'custom-' : '';
            const onchangeFunc = isCustom ? 'updateCustomExerciseValue' : 'updateWorkoutValue';
            const adjustFunc = isCustom ? 'adjustCustomValue' : 'adjustValue';
            const imageUrl = getExerciseImageUrl(ex.name);

            return `
                <div class="exercise-card">
                    <div style="font-weight: bold; font-size: 16px; margin-bottom: 10px; color: #001f3f;">
                        ${ex.name}
                    </div>
                    <div style="font-size: 12px; color: #6c757d; margin-bottom: 10px;">${ex.equipment}</div>
                    
                    <div class="exercise-image" style="max-height: 150px; min-height: 150px; margin: 10px auto;">
                        <img src="${imageUrl}" alt="${ex.name}" loading="lazy" onerror="this.parentElement.innerHTML='<div class=exercise-image-fallback>Image not available</div>'">
                    </div>
                    
                    <div class="control-group">
                        <div class="control-item">
                            <div class="control-label">Weight (lbs)</div>
                            <div class="control-buttons">
                                <button onclick="${adjustFunc}(${idx}, 'weight', -5)" class="adjust-btn">&minus;</button>
                                <input type="number" id="${idPrefix}weight-${idx}" value="${ex.weight}" onchange="${onchangeFunc}(${idx}, 'weight', this.value)" class="control-input">
                                <button onclick="${adjustFunc}(${idx}, 'weight', 5)" class="adjust-btn plus">+</button>
                            </div>
                        </div>
                        
                        <div class="control-item">
                            <div class="control-label">Sets</div>
                            <div class="control-buttons">
                                <button onclick="${adjustFunc}(${idx}, 'sets', -1)" class="adjust-btn">&minus;</button>
                                <input type="number" id="${idPrefix}sets-${idx}" value="${ex.sets}" onchange="${onchangeFunc}(${idx}, 'sets', this.value)" class="control-input">
                                <button onclick="${adjustFunc}(${idx}, 'sets', 1)" class="adjust-btn plus">+</button>
                            </div>
                        </div>
                        
                        <div class="control-item">
                            <div class="control-label">Reps</div>
                            <div class="control-buttons">
                                <button onclick="${adjustFunc}(${idx}, 'reps', -1)" class="adjust-btn">&minus;</button>
                                <input type="number" id="${idPrefix}reps-${idx}" value="${ex.reps}" onchange="${onchangeFunc}(${idx}, 'reps', this.value)" class="control-input">
                                <button onclick="${adjustFunc}(${idx}, 'reps', 1)" class="adjust-btn plus">+</button>
                            </div>
                        </div>
                    </div>
                    
                    <button class="btn btn-secondary" onclick="showExerciseInfo('${ex.name}')" style="margin-top: 12px; padding: 8px; font-size: 14px;">
                        &#128214; View Instructions
                    </button>
                </div>
            `;
        }

        // Load Workout
        function loadWorkout() {
            const type = document.getElementById('workoutType').value;
            const container = document.getElementById('workoutContainer');
            
            if (!type) {
                container.innerHTML = '';
                document.getElementById('workoutModeSelection').style.display = 'none';
                return;
            }

            if (type === 'custom') {
                loadCustomWorkout();
                return;
            }
            
            if (type.startsWith('saved_')) {
                const workoutName = type.substring(6);
                loadSavedCustomWorkoutFromMain(workoutName);
                return;
            }

            const program = workoutPrograms[type];
            const savedPrefs = JSON.parse(localStorage.getItem('workoutPreferences')) || {};
            const workoutPrefs = savedPrefs[type] || {};
            
            currentWorkout = program.exercises.map(name => {
                const defaults = exerciseDatabase[name];
                const saved = workoutPrefs[name] || {};
                return {
                    name,
                    ...defaults,
                    weight: saved.weight !== undefined ? saved.weight : defaults.weight,
                    sets: saved.sets !== undefined ? saved.sets : defaults.sets,
                    reps: saved.reps !== undefined ? saved.reps : defaults.reps,
                    completed: false,
                    setsCompleted: 0
                };
            });

            container.innerHTML = `
                <div class="info-box">
                    <p><strong>${program.name}</strong></p>
                    <p>Customize your weights, sets, and reps below. Your changes will be saved!</p>
                </div>
                <div style="margin-bottom: 20px;">
                    ${currentWorkout.map((ex, idx) => generateExerciseCardHTML(ex, idx)).join('')}
                </div>
            `;

            document.getElementById('workoutModeSelection').style.display = 'block';
        }
        
        function loadSavedCustomWorkoutFromMain(workoutName) {
            const savedCustomWorkouts = JSON.parse(localStorage.getItem('customWorkouts')) || {};
            const savedWorkout = savedCustomWorkouts[workoutName];
            
            if (!savedWorkout) {
                alert('Workout not found!');
                return;
            }
            
            currentWorkout = savedWorkout.map(ex => ({
                ...exerciseDatabase[ex.name],
                name: ex.name,
                weight: ex.weight,
                sets: ex.sets,
                reps: ex.reps,
                completed: false,
                setsCompleted: 0
            }));
            
            const container = document.getElementById('workoutContainer');
            
            container.innerHTML = `
                <div class="info-box">
                    <p><strong>&#11088; ${workoutName}</strong></p>
                    <p>Your saved custom workout. Adjust as needed!</p>
                </div>
                <div style="margin-bottom: 20px;">
                    ${currentWorkout.map((ex, idx) => generateExerciseCardHTML(ex, idx)).join('')}
                </div>
            `;

            document.getElementById('workoutModeSelection').style.display = 'block';
        }
        
        function adjustValue(idx, field, change) {
            const input = document.getElementById(`${field}-${idx}`);
            let newValue = parseInt(input.value) + change;
            
            if (field === 'sets' || field === 'reps') {
                newValue = Math.max(1, newValue);
            } else if (field === 'weight') {
                newValue = Math.max(0, newValue);
            }
            
            input.value = newValue;
            updateWorkoutValue(idx, field, newValue);
        }
        
        function updateWorkoutValue(idx, field, value) {
            const numValue = parseFloat(value) || 0;
            currentWorkout[idx][field] = numValue;
            saveWorkoutPreferences();
        }
        
        function saveWorkoutPreferences() {
            const type = document.getElementById('workoutType').value;
            if (!type || type === 'custom' || type.startsWith('saved_')) return;
            
            const savedPrefs = JSON.parse(localStorage.getItem('workoutPreferences')) || {};
            const workoutPrefs = {};
            currentWorkout.forEach(ex => {
                workoutPrefs[ex.name] = {
                    weight: ex.weight,
                    sets: ex.sets,
                    reps: ex.reps
                };
            });
            
            savedPrefs[type] = workoutPrefs;
            localStorage.setItem('workoutPreferences', JSON.stringify(savedPrefs));
        }

        function loadCustomWorkout() {
            const container = document.getElementById('workoutContainer');
            const exercises = Object.keys(exerciseDatabase).sort();
            const savedCustomWorkouts = JSON.parse(localStorage.getItem('customWorkouts')) || {};
            const customWorkoutNames = Object.keys(savedCustomWorkouts);
            
            container.innerHTML = `
                <div class="info-box">
                    <p><strong>Custom Workout Builder:</strong> Build your own workout from over 80 curated exercises, or load a saved routine.</p>
                </div>
                
                ${customWorkoutNames.length > 0 ? `
                    <div style="margin-bottom: 20px;">
                        <label style="font-weight: 600; margin-bottom: 8px; display: block;">Load Saved Custom Workout</label>
                        <select id="savedCustomSelect" onchange="loadSavedCustomWorkout()" style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 10px; font-size: 16px; margin-bottom: 10px;">
                            <option value="">-- Select a saved workout --</option>
                            ${customWorkoutNames.map(name => `<option value="${name}">${name}</option>`).join('')}
                        </select>
                        <button class="delete-btn" onclick="deleteSavedCustomWorkout()" style="width: 100%; padding: 10px;">
                            &#128465;&#65039; Delete Selected Workout
                        </button>
                    </div>
                ` : ''}
                
                <div style="${customWorkoutNames.length > 0 ? 'border-top: 2px solid #8b7355; padding-top: 20px; margin-top: 20px;' : ''}">
                    <label style="font-weight: 600; margin-bottom: 8px; display: block;">Build New Custom Workout</label>
                    <div class="form-group">
                        <label>Choose Exercise</label>
                        <select id="customExerciseSelect">
                            <option value="">-- Select Exercise --</option>
                            ${exercises.map(ex => `<option value="${ex}">${ex}</option>`).join('')}
                        </select>
                        <button class="add-exercise-btn" onclick="addCustomExercise()">+ Add Exercise</button>
                        <button class="btn btn-secondary" onclick="openAddExerciseModal()" style="margin-top: 10px; width: 100%;">
                            &#10133; Create New Exercise (Not in list)
                        </button>
                    </div>
                </div>
                
                <div id="customExercisesList"></div>
                
                <div id="saveCustomWorkoutSection" style="display: none; margin-top: 20px; padding: 15px; background: #d9c7a5; border-radius: 10px;">
                    <label style="font-weight: 600; margin-bottom: 8px; display: block;">Save This Custom Workout</label>
                    <input type="text" id="customWorkoutName" placeholder="Enter workout name (e.g., 'My Upper Body Day')" style="width: 100%; padding: 12px; border: 2px solid #003d5c; border-radius: 8px; font-size: 16px; margin-bottom: 10px;">
                    <button class="btn" onclick="saveCustomWorkout()" style="width: 100%;">
                        &#128190; Save Custom Workout
                    </button>
                </div>
            `;

            currentWorkout = [];
            document.getElementById('workoutModeSelection').style.display = 'none';
        }
        
        function loadSavedCustomWorkout() {
            const select = document.getElementById('savedCustomSelect');
            const workoutName = select.value;
            
            if (!workoutName) return;
            
            const savedCustomWorkouts = JSON.parse(localStorage.getItem('customWorkouts')) || {};
            const savedWorkout = savedCustomWorkouts[workoutName];
            
            if (!savedWorkout) return;
            
            currentWorkout = savedWorkout.map(ex => {
                const exerciseData = exerciseDatabase[ex.name] || {};
                return {
                ...exerciseData,
                name: ex.name,
                weight: ex.weight,
                sets: ex.sets,
                reps: ex.reps,
                completed: false,
                setsCompleted: 0
            }});
            
            renderCustomWorkout();
        }
        
        function deleteSavedCustomWorkout() {
            const select = document.getElementById('savedCustomSelect');
            const workoutName = select.value;
            
            if (!workoutName) {
                alert('Please select a workout to delete');
                return;
            }
            
            if (!confirm(`Are you sure you want to delete "${workoutName}"?`)) {
                return;
            }
            
            const savedCustomWorkouts = JSON.parse(localStorage.getItem('customWorkouts')) || {};
            delete savedCustomWorkouts[workoutName];
            localStorage.setItem('customWorkouts', JSON.stringify(savedCustomWorkouts));
            
            loadCustomWorkoutsIntoDropdown();
            loadCustomWorkout();
        }
        
        function saveCustomWorkout() {
            const nameInput = document.getElementById('customWorkoutName');
            const workoutName = nameInput.value.trim();
            
            if (!workoutName) {
                alert('Please enter a name for your workout');
                return;
            }
            
            if (currentWorkout.length === 0) {
                alert('Add some exercises first!');
                return;
            }
            
            const savedCustomWorkouts = JSON.parse(localStorage.getItem('customWorkouts')) || {};
            savedCustomWorkouts[workoutName] = currentWorkout.map(ex => ({
                name: ex.name,
                weight: ex.weight,
                sets: ex.sets,
                reps: ex.reps
            }));
            
            localStorage.setItem('customWorkouts', JSON.stringify(savedCustomWorkouts));
            loadCustomWorkoutsIntoDropdown();
            
            alert(`&#9989; Custom workout "${workoutName}" saved successfully!\n\nYou can now find it in the main workout dropdown!`);
            nameInput.value = '';
        }

        function addCustomExercise() {
            const select = document.getElementById('customExerciseSelect');
            const exerciseName = select.value;
            
            if (!exerciseName) {
                alert('Please select an exercise first!');
                return;
            }

            currentWorkout.push({
                name: exerciseName,
                ...exerciseDatabase[exerciseName],
                completed: false,
                setsCompleted: 0
            });

            select.value = '';
            renderCustomWorkout();
        }

        function renderCustomWorkout() {
            const list = document.getElementById('customExercisesList');
            
            if (currentWorkout.length === 0) {
                list.innerHTML = '<p style="color: #6c757d; text-align: center; padding: 20px;">No exercises added yet</p>';
                document.getElementById('workoutModeSelection').style.display = 'none';
                document.getElementById('saveCustomWorkoutSection').style.display = 'none';
                return;
            }

            list.innerHTML = currentWorkout.map((ex, idx) => `
                <div class="exercise-card">
                    <div class="exercise-header">
                        <div class="exercise-name">${ex.name}</div>
                        <button class="delete-btn" onclick="removeCustomExercise(${idx})">Remove</button>
                    </div>
                    ${generateExerciseCardHTML(ex, idx, true)}
                </div>
            `).join('');
            
            document.getElementById('workoutModeSelection').style.display = 'block';
            document.getElementById('saveCustomWorkoutSection').style.display = 'block';
        }
        
        function adjustCustomValue(idx, field, change) {
            const input = document.getElementById(`custom-${field}-${idx}`);
            let newValue = parseInt(input.value) + change;
            
            if (field === 'sets' || field === 'reps') {
                newValue = Math.max(1, newValue);
            } else if (field === 'weight') {
                newValue = Math.max(0, newValue);
            }
            
            input.value = newValue;
            updateCustomExerciseValue(idx, field, newValue);
        }
        
        function updateCustomExerciseValue(idx, field, value) {
            const numValue = parseFloat(value) || 0;
            currentWorkout[idx][field] = numValue;
        }

        function removeCustomExercise(idx) {
            currentWorkout.splice(idx, 1);
            renderCustomWorkout();
        }

        // Guided Workout Functions
        function startGuidedWorkout(style) {
            if (currentWorkout.length === 0) {
                alert("Please select or build a workout first!");
                return;
            }
            workoutStyle = style;
            guidedMode = true;
            currentExerciseIndex = 0;
            currentSetNumber = 1;
            currentRound = 1;
            completedSets = currentWorkout.map(ex => ({ name: ex.name, completed: Array(ex.sets).fill(false) }));
            
            document.getElementById('workoutSetup').style.display = 'none';
            document.getElementById('guidedWorkoutMode').style.display = 'block';
            
            startTimer();
            showAppleWatchReminder();
            updateGuidedDisplay();
        }
        
        function showAppleWatchReminder() {
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
            
            if (!isIOS) return;
            
            const reminder = document.createElement('div');
            reminder.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: linear-gradient(135deg, #003d5c 0%, #005580 100%);
                color: #d4af37;
                padding: 15px 25px;
                border-radius: 12px;
                border: 2px solid #d4af37;
                font-weight: 600;
                z-index: 10000;
                box-shadow: 0 10px 30px rgba(0,0,0,0.5);
                text-align: center;
                max-width: 90%;
            `;
            reminder.innerHTML = '&#8986; Start your Apple Watch workout now!';
            document.body.appendChild(reminder);
            
            setTimeout(() => {
                reminder.style.transition = 'opacity 0.5s';
                reminder.style.opacity = '0';
                setTimeout(() => document.body.removeChild(reminder), 500);
            }, 4000);
        }

        function updateGuidedDisplay() {
            const exercise = currentWorkout[currentExerciseIndex];
            
            document.getElementById('currentExerciseName').textContent = exercise.name;
            document.getElementById('currentWeight').textContent = exercise.weight;
            document.getElementById('currentReps').textContent = exercise.reps;
            document.getElementById('currentSets').textContent = exercise.sets;
            
            if (workoutStyle === 'traditional') {
                document.getElementById('exerciseProgress').textContent = 
                    `Exercise ${currentExerciseIndex + 1} of ${currentWorkout.length}`;
                document.getElementById('setProgress').textContent = 
                    `Set ${currentSetNumber}/${exercise.sets}`;
            } else {
                document.getElementById('exerciseProgress').textContent = 
                    `Round ${currentRound} &bull; Exercise ${currentExerciseIndex + 1}/${currentWorkout.length}`;
                document.getElementById('setProgress').textContent = 
                    `Set ${currentRound}/${exercise.sets}`;
            }
            
            updateProgressList();
        }

        function updateProgressList() {
            const list = document.getElementById('workoutProgressList');
            list.innerHTML = completedSets.map((ex, idx) => {
                const completedCount = ex.completed.filter(s => s).length;
                const totalSets = ex.completed.length;
                const percentage = totalSets > 0 ? (completedCount / totalSets) * 100 : 0;
                
                return `
                    <div class="chart-bar" style="margin-bottom: 10px;">
                        <div class="chart-label" style="width: 150px; font-size: 13px;">${ex.name}</div>
                        <div style="flex: 1; height: 25px; background: #d9c7a5; border-radius: 5px; position: relative; overflow: hidden;">
                            <div style="width: ${percentage}%; height: 100%; background: linear-gradient(90deg, #001f3f 0%, #003d5c 100%); transition: width 0.3s;"></div>
                            <div style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); color: ${percentage > 50 ? '#d4af37' : '#333'}; font-weight: 600; font-size: 12px;">
                                ${completedCount}/${totalSets}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function completeSet() {
            completedSets[currentExerciseIndex].completed[currentSetNumber - 1] = true;
            
            if (workoutStyle === 'traditional') {
                if (currentSetNumber < currentWorkout[currentExerciseIndex].sets) {
                    currentSetNumber++;
                    startRest(60);
                } else {
                    currentExerciseIndex++;
                    currentSetNumber = 1;
                    
                    if (currentExerciseIndex < currentWorkout.length) {
                        startRest(90);
                    } else {
                        finishWorkout();
                    }
                }
            } else {
                currentExerciseIndex++;
                
                if (currentExerciseIndex < currentWorkout.length) {
                    startRest(30);
                } else {
                    currentRound++;
                    currentExerciseIndex = 0;
                    
                    const allRoundsComplete = currentRound > currentWorkout[0].sets;

                    if (allRoundsComplete) {
                        finishWorkout();
                    } else {
                        currentSetNumber++;
                        startRest(90);
                    }
                }
            }
        }

        function startRest(seconds) {
            restTimeRemaining = seconds;
            document.getElementById('restTimer').style.display = 'block';
            document.getElementById('completeSetBtn').style.display = 'none';
            document.getElementById('restDisplay').textContent = restTimeRemaining;
            
            restInterval = setInterval(() => {
                restTimeRemaining--;
                document.getElementById('restDisplay').textContent = restTimeRemaining;
                
                if (restTimeRemaining <= 0) {
                    skipRest();
                }
            }, 1000);
        }

        function skipRest() {
            clearInterval(restInterval);
            document.getElementById('restTimer').style.display = 'none';
            document.getElementById('completeSetBtn').style.display = 'block';
            updateGuidedDisplay();
        }

        function showCurrentExerciseInfo() {
            const exercise = currentWorkout[currentExerciseIndex];
            showExerciseInfo(exercise.name);
        }

        function endWorkout() {
            if (confirm('Are you sure you want to end this workout early? Your progress will still be saved.')) {
                finishWorkout();
            }
        }

        function finishWorkout() {
            pauseTimer();
            
            const workoutTypeSelect = document.getElementById('workoutType');
            const selectedOption = workoutTypeSelect.options[workoutTypeSelect.selectedIndex];
            const programName = selectedOption.text || 'Custom Workout';

            const totalVolume = completedSets.reduce((sum, ex, idx) => {
                const completedCount = ex.completed.filter(s => s).length;
                const exercise = currentWorkout[idx];
                return sum + (exercise.weight * completedCount * exercise.reps);
            }, 0);

            const workout = {
                date: new Date().toISOString(),
                type: programName + (workoutStyle === 'circuit' ? ' (Circuit)' : ''),
                exercises: currentWorkout.map((ex, idx) => ({
                    name: ex.name,
                    weight: ex.weight,
                    sets: completedSets[idx].completed.filter(s => s).length,
                    reps: ex.reps,
                    plannedSets: ex.sets
                })),
                duration: timerSeconds,
                volume: totalVolume
            };

            workoutHistory.unshift(workout);
            localStorage.setItem('workoutHistory', JSON.stringify(workoutHistory));

            const totalSets = completedSets.reduce((sum, ex) => sum + ex.completed.length, 0);
            const completedCount = completedSets.reduce((sum, ex) => sum + ex.completed.filter(s => s).length, 0);
            const percentage = totalSets > 0 ? Math.round((completedCount / totalSets) * 100) : 0;

            alert(`&#127881; Workout ${percentage === 100 ? 'Completed' : 'Saved'}!\n\nCompleted: ${completedCount}/${totalSets} sets (${percentage}%)\nTotal Volume: ${totalVolume.toLocaleString()} lbs\nDuration: ${formatTime(timerSeconds)}\n\nGreat work! Keep crushing it! &#128170;`);

            resetWorkoutState();
        }

        function resetWorkoutState() {
            guidedMode = false;
            document.getElementById('workoutSetup').style.display = 'block';
            document.getElementById('guidedWorkoutMode').style.display = 'none';
            document.getElementById('workoutType').value = '';
            document.getElementById('workoutContainer').innerHTML = '';
            document.getElementById('workoutModeSelection').style.display = 'none';
            currentWorkout = [];
            resetTimer();
            updateRecommendation();
            updateProgress();
            updateHistory();
        }

        function updateExercise(idx, field, value) {
            currentWorkout[idx][field] = parseFloat(value) || 0;
        }

        function showExerciseInfo(name) {
            const exercise = exerciseDatabase[name];
            if (!exercise) return;
            const modal = document.getElementById('exerciseModal');
            const modalName = document.getElementById('modalExerciseName');
            const modalContent = document.getElementById('modalExerciseContent');

            modalName.textContent = name;
            
            const imageUrl = getExerciseImageUrl(name);
            const imageHtml = `
                <div class="exercise-image" style="margin: 15px auto;" id="modal-img">
                    <img src="${imageUrl}" 
                         alt="${name}" 
                         onerror="this.parentElement.innerHTML='<div class=exercise-image-fallback>${exercise.image}<br><small>Image not available</small></div>'">
                </div>
            `;
            modalContent.innerHTML = `
                <div style="margin-bottom: 15px;">
                    <strong>Equipment:</strong> ${exercise.equipment}
                </div>
                ${imageHtml}
                <div style="margin-top: 15px;">
                    <strong>How to Perform:</strong>
                    <p style="line-height: 1.6; margin-top: 10px;">${exercise.instructions}</p>
                </div>
                <div style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <strong>Suggested:</strong> ${exercise.sets} sets &times; ${exercise.reps} reps @ ${exercise.weight} lbs
                </div>
            `;

            modal.classList.add('active');
        }

        function closeModal() {
            document.getElementById('exerciseModal').classList.remove('active');
        }

        // Recommendations
        function updateRecommendation() {
            const container = document.getElementById('recommendationContainer');
            
            if (workoutHistory.length === 0) {
                container.innerHTML = `
                    <div class="recommendation-card">
                        <h3>&#127919; Welcome to Your Fitness Journey!</h3>
                        <p><strong>Today's Recommendation: Full Body Power</strong></p>
                        <p>Start with a well-rounded full body workout to establish your baseline strength. This workout includes compound movements that hit all major muscle groups.</p>
                        <p style="margin-top: 15px;"><strong>Why this workout?</strong> It's perfect for beginners and helps you learn proper form on key exercises while building foundational strength.</p>
                        <button class="btn" onclick="selectRecommendedWorkout('fullbody')" style="margin-top: 15px;">Start This Workout</button>
                    </div>
                    <div class="info-box">
                        <p><strong>Workout Tips:</strong></p>
                        <p>&bull; Start with suggested weights and adjust as needed</p>
                        <p>&bull; Focus on proper form over heavy weight</p>
                        <p>&bull; Rest 60-90 seconds between sets</p>
                        <p>&bull; Stay hydrated throughout your workout</p>
                    </div>
                `;
                return;
            }

            const lastWorkout = workoutHistory[0];
            const lastWorkoutDate = new Date(lastWorkout.date);
            const daysSince = Math.floor((Date.now() - lastWorkoutDate) / (1000 * 60 * 60 * 24));
            
            const recentTypes = workoutHistory.slice(0, 5).map(w => w.type);
            const recommendation = getSmartRecommendation(recentTypes, daysSince);

            container.innerHTML = `
                <div class="recommendation-card">
                    <h3>${recommendation.title}</h3>
                    <p><strong>Recommended: ${recommendation.workout}</strong></p>
                    <p>${recommendation.reason}</p>
                    <p style="margin-top: 10px;"><strong>Focus:</strong> ${recommendation.focus}</p>
                    ${daysSince > 3 ? `<p style="margin-top: 10px; color: #fff3cd; background: rgba(255,255,255,0.2); padding: 10px; border-radius: 8px;">&#9888;&#65039; It's been ${daysSince} days since your last workout. Let's get back on track!</p>` : ''}
                    <button class="btn" onclick="selectRecommendedWorkout('${recommendation.type}')" style="margin-top: 15px;">Start This Workout</button>
                </div>
                <div class="info-box">
                    <p><strong>Last Workout:</strong> ${lastWorkout.type} - ${formatDate(lastWorkout.date)}</p>
                    <p><strong>Total Volume:</strong> ${lastWorkout.volume.toLocaleString()} lbs</p>
                    <p><strong>Duration:</strong> ${formatTime(lastWorkout.duration)}</p>
                </div>
            `;
        }

        function getSmartRecommendation(recentTypes, daysSince) {
            if (daysSince > 5) {
                return {
                    title: '&#128293; Welcome Back!',
                    workout: 'Full Body Power or Cardio Day',
                    type: 'fullbody',
                    reason: 'After a break, ease back in with a full body workout or cardio to rebuild conditioning.',
                    focus: 'Overall fitness and getting back into rhythm'
                };
            }

            const hasLeg = recentTypes.some(t => t.includes('Leg'));
            const hasChest = recentTypes.some(t => t.includes('Chest'));
            const hasBack = recentTypes.some(t => t.includes('Back'));
            const hasShoulder = recentTypes.some(t => t.includes('Shoulder'));
            const hasAbs = recentTypes.some(t => t.includes('Core') || t.includes('Abs'));
            const hasCardio = recentTypes.some(t => t.includes('Cardio'));
            const hasKettlebell = recentTypes.some(t => t.includes('Kettlebell'));

            if (!hasLeg) {
                return {
                    title: '&#129461; Time to Train Legs!',
                    workout: 'Leg Day',
                    type: 'leg',
                    reason: 'You haven\'t trained legs recently. Lower body strength is crucial for overall fitness and metabolism.',
                    focus: 'Quads, hamstrings, glutes, and calves'
                };
            }

            if (!hasBack && !hasChest) {
                return {
                    title: '&#128170; Upper Body Push Day',
                    workout: 'Chest Day',
                    type: 'chest',
                    reason: 'Build upper body pushing strength with chest and tricep focused exercises.',
                    focus: 'Chest, shoulders, and triceps'
                };
            }

            if (!hasBack) {
                return {
                    title: '&#127947;&#65039; Pull Day - Back Focus',
                    workout: 'Back & Biceps',
                    type: 'back',
                    reason: 'Balance your training with a pulling day. Strong back muscles improve posture and overall strength.',
                    focus: 'Lats, traps, rhomboids, and biceps'
                };
            }

            if (!hasShoulder) {
                return {
                    title: '&#128170; Shoulder Development',
                    workout: 'Shoulders & Triceps',
                    type: 'shoulders',
                    reason: 'Well-developed shoulders create a strong upper body foundation and improve functional strength.',
                    focus: 'All three deltoid heads and triceps'
                };
            }

            if (!hasCardio && (hasLeg || hasChest || hasBack)) {
                return {
                    title: '&#128692; Cardio & Recovery',
                    workout: 'Cardio Day',
                    type: 'cardio',
                    reason: 'You\'ve been lifting hard! Time for cardio to boost heart health, burn fat, and aid recovery.',
                    focus: 'Cardiovascular endurance and active recovery'
                };
            }

            if (!hasKettlebell) {
                return {
                    title: '&#127947;&#65039; Kettlebell Circuit',
                    workout: 'Kettlebell Circuit',
                    type: 'kettlebell',
                    reason: 'Mix things up with kettlebell training! Great for explosive power, core strength, and conditioning.',
                    focus: 'Full body power and conditioning'
                };
            }

            if (!hasAbs) {
                return {
                    title: '&#128293; Core Strength',
                    workout: 'Core/Abs Blast',
                    type: 'abs',
                    reason: 'A strong core is the foundation for all other lifts and protects your back.',
                    focus: 'Abs, obliques, and core stability'
                };
            }

            return {
                title: '&#127919; Balanced Training',
                workout: 'Full Body Power',
                type: 'fullbody',
                reason: 'Hit all major muscle groups with compound movements for balanced development.',
                focus: 'Total body strength and coordination'
            };
        }

        function selectRecommendedWorkout(type) {
            document.getElementById('workoutType').value = type;
            loadWorkout();
            showSection('workout');
            document.querySelector('.nav-btn').classList.remove('active');
            document.querySelectorAll('.nav-btn')[0].classList.add('active');
        }

        // Progress Tracking
        function updateProgress() {
            const total = workoutHistory.length;
            document.getElementById('totalWorkouts').textContent = total;

            const weekAgo = Date.now() - (7 * 24 * 60 * 60 * 1000);
            const thisWeek = workoutHistory.filter(w => new Date(w.date) > weekAgo).length;
            document.getElementById('thisWeek').textContent = thisWeek;

            const totalVolume = workoutHistory.reduce((sum, w) => sum + (w.volume || 0), 0);
            document.getElementById('totalVolume').textContent = totalVolume.toLocaleString();

            const streak = calculateStreak();
            document.getElementById('streak').textContent = streak;

            updateWorkoutDistribution();
            updateVolumeProgress();
        }

        function calculateStreak() {
            if (workoutHistory.length === 0) return 0;

            let streak = 0;
            const workoutDates = [...new Set(workoutHistory.map(w => new Date(w.date).toDateString()))];
            let checkDate = new Date();

            if (!workoutDates.includes(checkDate.toDateString())) {
                checkDate.setDate(checkDate.getDate() - 1);
            }

            while (workoutDates.includes(checkDate.toDateString())) {
                streak++;
                checkDate.setDate(checkDate.getDate() - 1);
            }

            return streak;
        }

        function updateWorkoutDistribution() {
            const container = document.getElementById('workoutDistribution');
            const distribution = {};

            workoutHistory.forEach(w => {
                const type = w.type.split(' (')[0]; // Ignore circuit/traditional
                distribution[type] = (distribution[type] || 0) + 1;
            });

            const sorted = Object.entries(distribution).sort((a, b) => b[1] - a[1]);
            const max = sorted[0]?.[1] || 1;

            if (sorted.length === 0) {
                container.innerHTML = '<p style="color: #6c757d; text-align: center;">No workout data yet. Start training to see your progress!</p>';
                return;
            }

            container.innerHTML = sorted.map(([type, count]) => {
                const width = (count / max) * 100;
                return `
                    <div class="chart-bar">
                        <div class="chart-label">${type}</div>
                        <div class="chart-fill" style="width: ${width}%">
                            <div class="chart-value">${count}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateVolumeProgress() {
            const container = document.getElementById('volumeProgress');
            const recent = workoutHistory.slice(0, 10).reverse();

            if (recent.length === 0) {
                container.innerHTML = '<p style="color: #6c757d; text-align: center;">Complete workouts to track volume progress!</p>';
                return;
            }

            const max = Math.max(...recent.map(w => w.volume || 0));

            container.innerHTML = recent.map((w, idx) => {
                const width = max > 0 ? ((w.volume || 0) / max) * 100 : 0;
                const shortType = w.type.split(' ')[0];
                return `
                    <div class="chart-bar">
                        <div class="chart-label">${shortType} #${recent.length - idx}</div>
                        <div class="chart-fill" style="width: ${width}%">
                            <div class="chart-value">${(w.volume || 0).toLocaleString()}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // History
        function updateHistory() {
            const container = document.getElementById('historyContainer');

            if (workoutHistory.length === 0) {
                container.innerHTML = '<p style="color: #6c757d; text-align: center; padding: 40px;">No workout history yet. Complete your first workout to start tracking progress!</p>';
                return;
            }

            container.innerHTML = workoutHistory.map((w, idx) => `
                <div class="history-item">
                    <div class="history-header">
                        <div class="history-date">${formatDate(w.date)}</div>
                        <div class="history-type">${w.type}</div>
                    </div>
                    <div class="history-exercises">
                        <strong>Exercises:</strong> ${w.exercises.map(e => e.name).join(', ')}
                    </div>
                    <div style="margin-top: 10px; font-size: 14px; color: #6c757d;">
                        <strong>Volume:</strong> ${(w.volume || 0).toLocaleString()} lbs | <strong>Duration:</strong> ${formatTime(w.duration)}
                    </div>
                    <button class="delete-btn" onclick="deleteWorkout(${idx})" style="margin-top: 10px;">Delete</button>
                </div>
            `).join('');
        }

        function deleteWorkout(idx) {
            if (confirm('Are you sure you want to delete this workout?')) {
                workoutHistory.splice(idx, 1);
                localStorage.setItem('workoutHistory', JSON.stringify(workoutHistory));
                updateHistory();
                updateProgress();
                updateRecommendation();
            }
        }

        // Timer Functions
        function startTimer() {
            if (!timerRunning) {
                timerRunning = true;
                timerInterval = setInterval(() => {
                    timerSeconds++;
                    document.getElementById('timerDisplay').textContent = formatTime(timerSeconds);
                }, 1000);
            }
        }

        function pauseTimer() {
            timerRunning = false;
            clearInterval(timerInterval);
        }

        function resetTimer() {
            timerRunning = false;
            clearInterval(timerInterval);
            timerSeconds = 0;
            document.getElementById('timerDisplay').textContent = '00:00';
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffTime = now - date;
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

            if (diffDays === 0) return 'Today';
            if (diffDays === 1) return 'Yesterday';
            if (diffDays < 7) return `${diffDays} days ago`;

            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        // Close modal on outside click
        document.getElementById('exerciseModal').addEventListener('click', (e) => {
            if (e.target.id === 'exerciseModal') {
                closeModal();
            }
        });
        
        document.getElementById('addExerciseModal').addEventListener('click', (e) => {
            if (e.target.id === 'addExerciseModal') {
                closeAddExerciseModal();
            }
        });
    </script>
</body>
</html>
```
