<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workout Tracker Pro</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #001f3f 0%, #003d5c 100%);
            min-height: 100vh;
            padding: 10px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: #f5f5dc;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            overflow: hidden;
            border: 3px solid #8b7355;
        }

        .header {
            background: linear-gradient(135deg, #001f3f 0%, #003d5c 100%);
            color: #d4af37;
            padding: 20px;
            text-align: center;
            border-bottom: 3px solid #d4af37;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 5px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .nav {
            display: flex;
            background: #d9c7a5;
            border-bottom: 2px solid #8b7355;
            overflow-x: auto;
            /* Allows horizontal scrolling on small screens */
            -webkit-overflow-scrolling: touch;
            /* Smooth scrolling on iOS */
            flex-wrap: wrap;
            /* Allow wrapping to multiple rows */
        }

        .nav::-webkit-scrollbar {
            display: none;
            /* Hide scrollbar for a cleaner look */
        }

        .nav-btn {
            flex: 1 1 auto;
            /* Allow flexible sizing and wrapping */
            min-width: 100px;
            /* Minimum width for readability */
            padding: 12px 8px;
            /* Reduced padding for smaller screens */
            background: none;
            border: none;
            cursor: pointer;
            font-size: 12px;
            /* Reduced font size for better fit */
            font-weight: 600;
            color: #3e3024;
            transition: all 0.3s;
            white-space: nowrap;
            /* Prevents text from wrapping */
            text-align: center;
            /* Center tab text */
        }

        .nav-btn.active {
            background: #f5f5dc;
            color: #001f3f;
            border-bottom: 3px solid #d4af37;
        }

        .content {
            padding: 15px;
            /* Reduced from 20px */
            min-height: 400px;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        select,
        input,
        textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 16px;
            transition: border 0.3s;
            font-family: inherit;
        }

        select:focus,
        input:focus,
        textarea:focus {
            outline: none;
            border-color: #003d5c;
        }

        .btn {
            padding: 14px 28px;
            background: linear-gradient(135deg, #001f3f 0%, #003d5c 100%);
            color: #d4af37;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
            margin-top: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 31, 63, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: #8b7355;
            color: #f5f5dc;
        }

        .btn-success {
            background: linear-gradient(135deg, #4a6741 0%, #5d8055 100%);
            color: #f5f5dc;
        }

        .btn-danger {
            background: linear-gradient(135deg, #8b0000 0%, #a52a2a 100%);
            color: #f5f5dc;
        }

        .exercise-card {
            background: #e8dcc4;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #003d5c;
        }

        .exercise-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .exercise-name {
            font-weight: 700;
            font-size: 16px;
            color: #333;
        }

        .exercise-details {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .detail-input {
            display: flex;
            flex-direction: column;
        }

        .detail-input label {
            font-size: 12px;
            margin-bottom: 5px;
            color: #6c757d;
        }

        .detail-input input {
            padding: 8px;
            font-size: 14px;
        }

        .exercise-image {
            width: 100%;
            max-width: 400px;
            min-height: 250px;
            background: #e9ecef;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 15px auto;
            overflow: hidden;
            position: relative;
            border: 2px solid #003d5c;
        }

        .exercise-image img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            background: white;
        }

        .exercise-image-fallback {
            color: #6c757d;
            font-size: 14px;
            text-align: center;
            padding: 20px;
        }

        .image-loading {
            color: #003d5c;
            font-size: 16px;
            font-weight: 600;
        }

        .recommendation-card {
            background: linear-gradient(135deg, #003d5c 0%, #005580 100%);
            color: #f5f5dc;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 2px solid #d4af37;
        }

        .recommendation-card h3 {
            margin-bottom: 10px;
            font-size: 20px;
        }

        .recommendation-card p {
            margin-bottom: 8px;
            line-height: 1.6;
        }

        .workout-history {
            margin-top: 20px;
        }

        .history-item {
            background: #e8dcc4;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #003d5c;
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .history-date {
            font-weight: 600;
            color: #333;
        }

        .history-type {
            color: #003d5c;
            font-weight: 600;
        }

        .history-exercises {
            font-size: 14px;
            color: #6c757d;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #001f3f 0%, #003d5c 100%);
            color: #d4af37;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            border: 2px solid #8b7355;
        }

        .stat-number {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 5px;
            color: #d4af37;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
            color: #f5f5dc;
        }

        .progress-chart {
            background: #e8dcc4;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            min-height: 200px;
            border: 2px solid #8b7355;
        }

        .chart-title {
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
        }

        .chart-bar {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .chart-label {
            width: 120px;
            font-size: 14px;
            color: #6c757d;
        }

        .chart-fill {
            flex: 1;
            height: 30px;
            background: linear-gradient(90deg, #001f3f 0%, #003d5c 100%);
            border-radius: 5px;
            position: relative;
        }

        .chart-value {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: #d4af37;
            font-weight: 600;
            font-size: 14px;
        }

        .info-box {
            background: #d9c7a5;
            border-left: 4px solid #003d5c;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .info-box p {
            color: #3e3024;
            line-height: 1.6;
            font-size: 14px;
        }

        .delete-btn {
            background: #8b0000;
            color: #f5f5dc;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
        }

        .add-exercise-btn {
            background: #4a6741;
            color: #f5f5dc;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            margin-top: 10px;
        }

        .edit-btn {
            background: #003d5c;
            color: #d4af37;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
        }

        .workout-timer {
            background: linear-gradient(135deg, #003d5c 0%, #005580 100%);
            color: #d4af37;
            border-radius: 12px;
            padding: 12px;
            /* Reduced from 20px */
            text-align: center;
            margin-bottom: 15px;
            /* Reduced from 20px */
            border: 2px solid #d4af37;
        }

        .timer-display {
            font-size: 36px;
            /* Reduced from 48px */
            font-weight: 700;
            margin: 5px 0;
            /* Reduced from 10px */
        }

        .timer-controls {
            display: flex;
            gap: 8px;
            /* Reduced from 10px */
            justify-content: center;
            margin-top: 8px;
            /* Reduced from 15px */
        }

        .timer-btn {
            padding: 8px 16px;
            /* Reduced from 10px 20px */
            background: rgba(245, 245, 220, 0.2);
            border: 2px solid #d4af37;
            color: #d4af37;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 20px;
            max-width: 500px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #6c757d;
        }

        /* AI Chat Input Box Styling */
        #userMessage {
            flex: 1;
            border: 2px solid #8b7355;
            border-radius: 8px;
            background-color: white !important;
            /* Force white background */
            color: #333 !important;
            /* Force dark text color */
            resize: vertical;
            /* Allow user to resize it */
            line-height: 1.5;
        }

        .chat-input-container {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .chat-input-container .btn {
            margin-top: 0;
            flex-shrink: 0;
        }

        /* IMPROVED MOBILE LAYOUT FOR CONTROLS */
        .control-group {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: 15px;
        }

        .control-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 0;
        }

        .control-label {
            font-size: 11px;
            color: #6c757d;
            margin-bottom: 5px;
            font-weight: 600;
            text-align: center;
            white-space: nowrap;
        }

        .control-buttons {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 3px;
            width: 100%;
        }

        .adjust-btn {
            background: #8b7355;
            color: #f5f5dc;
            border: none;
            width: 28px;
            height: 28px;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .adjust-btn.plus {
            background: #003d5c;
            color: #d4af37;
        }

        .control-input {
            width: 100%;
            max-width: 55px;
            text-align: center;
            font-size: 14px;
            font-weight: bold;
            padding: 6px 2px;
            border: 2px solid #003d5c;
            border-radius: 6px;
        }

        /* HIIT specific styling */
        #hiitCountdownScreen {
            text-align: center;
            color: #d4af37;
        }

        #hiitCountdownDisplay {
            font-size: 120px;
            font-weight: bold;
        }

        #hiitActiveScreen {
            text-align: center;
        }

        #hiitTimerDisplay {
            font-size: 80px;
            /* Reduced from 100px */
            font-weight: bold;
            margin: 5px 0;
            /* Reduced from 10px */
            color: #d4af37;
        }

        #hiitModeDisplay {
            font-size: 28px;
            /* Reduced from 32px */
            font-weight: 600;
            margin-bottom: 5px;
            /* Reduced from 10px */
        }

        #hiitModeDisplay.work {
            color: #28a745;
        }

        #hiitModeDisplay.rest {
            color: #007bff;
        }

        #hiitExerciseName {
            font-size: 20px;
            /* Reduced from 24px */
            color: #f5f5dc;
            font-weight: bold;
            margin-bottom: 3px;
        }

        #hiitNextExerciseName {
            font-size: 14px;
            /* Reduced from 16px */
            color: #f5f5dc;
            opacity: 0.8;
        }

        #hiitRoundDisplay {
            margin-top: 8px;
            /* Reduced from 15px */
            font-size: 16px;
            /* Reduced from 18px */
            color: #f5f5dc;
            margin-bottom: 8px;
        }

        @media (max-width: 600px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .nav-btn {
                flex: 1 1 calc(33.333% - 2px);
                /* 3 tabs per row on mobile */
                min-width: 0;
                font-size: 11px;
                padding: 10px 4px;
            }

            .exercise-card {
                padding: 12px;
            }

            /* Mobile layout for AI chat input */
            .chat-input-container {
                flex-direction: column;
                align-items: stretch;
            }

            .chat-input-container .btn {
                width: 100%;
                margin-top: 10px;
            }

            .control-group {
                gap: 4px;
            }

            .control-label {
                font-size: 10px;
            }

            .control-buttons {
                gap: 2px;
            }

            .control-input {
                max-width: 45px;
                font-size: 13px;
                padding: 5px 1px;
            }

            .adjust-btn {
                width: 26px;
                height: 26px;
                font-size: 14px;
            }

            .timer-display {
                font-size: 36px;
            }
        }

        @media (max-width: 400px) {
            .exercise-card {
                padding: 10px;
            }

            .control-group {
                gap: 3px;
            }

            .control-input {
                max-width: 40px;
                font-size: 12px;
            }

            .adjust-btn {
                width: 24px;
                height: 24px;
                font-size: 13px;
            }
        }
       /* --- START: QR SCANNER OVERLAY CSS --- */
       #qrScannerBox.success {
            border: 5px solid #4caf50; /* Bright green for success */
            box-shadow: 0 0 20px #4caf50, 0 0 0 9999px rgba(0, 0, 0, 0.5); /* Add a glow */
       }
       #qrScannerOverlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #qrScannerBox {
            width: 75%;
            padding-top: 75%; /* This creates a square aspect ratio */
            position: relative;
            border: 4px solid rgba(255, 255, 255, 0.5);
            border-radius: 10px;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5); /* This creates the dark overlay around the box */
        }

        #qrScannerLaser {
            position: absolute;
            top: 0;
            left: 5%;
            width: 90%;
            height: 3px;
            background-color: #d4af37;
            box-shadow: 0 0 10px #d4af37;
            border-radius: 5px;
            animation: scan 2s infinite linear;
        }

        @keyframes scan {
            0% {
                top: 5%;
            }
            50% {
                top: 95%;
            }
            100% {
                top: 5%;
            }
        } 
    </style>
      <!-- QR LIBRARIES -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<!-- ADD THIS LINE FOR COMPRESSION -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1> Workout Tracker Pro</h1>
            <p>Your Personal Fitness Companion</p>
        </div>
        <div class="nav">
            <button class="nav-btn" onclick="showSection('ai-coach')">AI Coach</button>
            <button class="nav-btn active" onclick="showSection('workout')">Workout</button>
            <button class="nav-btn" onclick="showSection('exercises')">Exercises</button>
            <button class="nav-btn" onclick="showSection('recommend')">Recommend</button>
            <button class="nav-btn" onclick="showSection('progress')">Progress</button>
            <button class="nav-btn" onclick="showSection('history')">History</button>
            <button class="nav-btn" onclick="showSection('share-workout')">Share Workout</button>
            <button class="nav-btn" onclick="showSection('settings')">Settings</button>
        </div>
        <div class="content">
            <!-- AI Coach Section -->
            <div id="ai-coach" class="section">
                <h2>AI Workout Coach</h2>
                <p>Get custom workouts or update exercise details. Just ask!</p>
                <div id="api-setup"
                    style="background: #fff3cd; border: 2px solid #ffc107; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 style="color: #856404;">Setup Required (First Time Only)</h3>
                    <p style="color: #856404;">Get your free API key from: <a href="https://ai.google.dev"
                            target="_blank">https://ai.google.dev</a></p>
                    <div class="form-group">
                        <input type="password" id="apiKey" placeholder="Paste your Gemini API key here">
                    </div>
                    <button class="btn" onclick="saveApiKey()">Save API Key</button>
                </div>
                <div id="chat-box" style="display: none;">
                    <div style="display: flex; justify-content: flex-end; margin-bottom: 10px;">
                        <button class="btn btn-secondary" onclick="resetApiKey()"
                            style="width: auto; padding: 8px 12px; font-size: 12px; margin-top: 0;">Change API
                            Key</button>
                    </div>
                    <div style="background: #e8dcc4; border: 2px solid #8b7355; border-radius: 10px; padding: 15px; height: 350px; overflow-y: auto; margin-bottom: 15px; display: flex; flex-direction: column; gap: 10px;"
                        id="messages"></div>
                    <div class="chat-input-container">
                        <textarea id="userMessage"
                            placeholder="e.g., 'a 30 minute leg workout' or 'add instructions for farmer's walk'..."
                            rows="3"></textarea>
                        <button class="btn" onclick="sendMessage()">Send</button>
                    </div>
                </div>
            </div>
            <!-- Workout Section -->
            <div id="workout" class="section active">
                <div class="workout-timer">
                    <h3>Workout Duration Timer</h3>
                    <div class="timer-display" id="timerDisplay">00:00</div>
                    <div class="timer-controls">
                        <button class="timer-btn" onclick="startTimer()">Start</button>
                        <button class="timer-btn" onclick="pauseTimer()">Pause</button>
                        <button class="timer-btn" onclick="resetTimer()">Reset</button>
                    </div>
                </div>
                <div id="workoutSetup">
                    <div class="form-group">
                        <label>Select Workout Type</label>
                        <select id="workoutType" onchange="loadWorkout()">
                            <option value="">-- Choose a Workout --</option>
                            <option value="custom"> Create Custom Strength Workout</option>
                            <option value="custom_hiit"> Create Custom HIIT Workout</option>
                            <option value="leg"> Leg Day</option>
                            <option value="chest"> Chest Day</option>
                            <option value="back"> Back & Biceps</option>
                            <option value="shoulders"> Shoulders & Triceps</option>
                            <option value="abs"> Core/Abs Blast</option>
                            <option value="kettlebell"> Kettlebell Circuit</option>
                            <option value="cardio"> Cardio Day</option>
                            <option value="fullbody"> Full Body Power</option>
                        </select>
                    </div>
                    <div id="workoutContainer"></div>
                    <div id="workoutModeSelection" style="display:none;">
                        <div class="info-box">
                            <p><strong>Choose Your Workout Style:</strong></p>
                            <p><strong>Traditional:</strong> Complete all sets of one exercise before moving to the next.
                            </p>
                            <p><strong>Circuit:</strong> Do one set of each exercise, then repeat for all rounds.</p>
                            <p><strong>HIIT:</strong> Perform exercises for timed work/rest intervals.</p>
                        </div>
                        <!-- HIIT Adjustments (Pre-Workout) -->
                        <div id="hiitPreWorkoutAdjustments"
                            style="display:none; margin: 15px -20px; background: rgba(212,175,55,0.2); padding: 12px 20px; border-radius: 0;">
                            <div
                                style="font-size: 12px; font-weight: 600; color: #333; margin-bottom: 10px; text-align: center;">
                                Adjust HIIT Parameters:</div>
                            <div style="display: flex; justify-content: center; gap: 25px; flex-wrap: wrap;">
                                <div style="text-align: center;">
                                    <div style="font-size: 11px; color: #6c757d; margin-bottom: 6px;">Work</div>
                                    <div
                                        style="display: flex; gap: 8px; justify-content: center; align-items: center;">
                                        <button class="btn btn-secondary" onclick="adjustHiitParamPreWorkout('work', -5)"
                                            style="width: 36px; padding: 6px; margin: 0; font-size: 12px;">-</button>
                                        <span id="hiitPreWorkWorkDisplay"
                                            style="min-width: 40px; text-align: center; color: #001f3f; font-weight: bold; font-size: 14px;">30</span>
                                        <button class="btn btn-secondary" onclick="adjustHiitParamPreWorkout('work', 5)"
                                            style="width: 36px; padding: 6px; margin: 0; font-size: 12px;">+</button>
                                    </div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 11px; color: #6c757d; margin-bottom: 6px;">Rest</div>
                                    <div
                                        style="display: flex; gap: 8px; justify-content: center; align-items: center;">
                                        <button class="btn btn-secondary" onclick="adjustHiitParamPreWorkout('rest', -5)"
                                            style="width: 36px; padding: 6px; margin: 0; font-size: 12px;">-</button>
                                        <span id="hiitPreWorkRestDisplay"
                                            style="min-width: 40px; text-align: center; color: #001f3f; font-weight: bold; font-size: 14px;">15</span>
                                        <button class="btn btn-secondary" onclick="adjustHiitParamPreWorkout('rest', 5)"
                                            style="width: 36px; padding: 6px; margin: 0; font-size: 12px;">+</button>
                                    </div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 11px; color: #6c757d; margin-bottom: 6px;">Rounds</div>
                                    <div
                                        style="display: flex; gap: 8px; justify-content: center; align-items: center;">
                                        <button class="btn btn-secondary"
                                            onclick="adjustHiitParamPreWorkout('rounds', -1)"
                                            style="width: 36px; padding: 6px; margin: 0; font-size: 12px;">-</button>
                                        <span id="hiitPreWorkRoundsDisplay"
                                            style="min-width: 40px; text-align: center; color: #001f3f; font-weight: bold; font-size: 14px;">4</span>
                                        <button class="btn btn-secondary"
                                            onclick="adjustHiitParamPreWorkout('rounds', 1)"
                                            style="width: 36px; padding: 6px; margin: 0; font-size: 12px;">+</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button class="btn" onclick="startGuidedWorkout('traditional')" style="margin-bottom: 10px;">
                            Start Traditional Style
                        </button>
                        <button class="btn btn-success" onclick="startGuidedWorkout('circuit')"
                            style="margin-bottom: 10px;">
                            Start Circuit Style
                        </button>
                        <button class="btn btn-danger" onclick="startHiitWorkout()">
                            Start HIIT Style
                        </button>
                    </div>
                </div>
                <!-- Guided Workout Mode -->
                <div id="guidedWorkoutMode" style="display:none;">
                    <div class="recommendation-card" id="currentExerciseCard">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3 id="exerciseProgress">Exercise 1 of 5</h3>
                            <div id="setProgress" style="font-size: 18px; font-weight: bold;">Set 1/3</div>
                        </div>
                        <h2 id="currentExerciseName" style="font-size: 24px; margin-bottom: 10px;">Dumbbell Squats</h2>
                        <div
                            style="background: rgba(245,245,220,0.2); padding: 15px; border-radius: 10px; margin: 15px 0;">
                            <div style="display: flex; justify-content: space-around; text-align: center;">
                                <div>
                                    <div style="font-size: 28px; font-weight: bold;" id="currentWeight">25</div>
                                    <div style="font-size: 14px;">lbs</div>
                                </div>
                                <div>
                                    <div style="font-size: 28px; font-weight: bold;" id="currentReps">12</div>
                                    <div style="font-size: 14px;">reps</div>
                                </div>
                                <div>
                                    <div style="font-size: 28px; font-weight: bold;" id="currentSets">3</div>
                                    <div style="font-size: 14px;">sets</div>
                                </div>
                            </div>
                        </div>
                        <button class="btn btn-secondary" onclick="showCurrentExerciseInfo()"
                            style="margin-bottom: 10px;">
                            View Form Instructions
                        </button>
                        <div id="restTimer" style="display:none; text-align: center; margin: 20px 0;">
                            <h3>Rest Time</h3>
                            <div style="font-size: 48px; font-weight: bold; color: #d4af37;" id="restDisplay">60</div>
                            <button class="btn" onclick="skipRest()">Skip Rest</button>
                        </div>
                        <button class="btn btn-success" id="completeSetBtn" onclick="completeSet()"
                            style="font-size: 18px; padding: 18px;">
                            Complete Set
                        </button>
                    </div>
                    <div style="margin-top: 20px; text-align: center;">
                        <button class="btn btn-danger" onclick="endWorkout()">
                            End Workout Early
                        </button>
                    </div>
                    <!-- Progress Overview -->
                    <div class="progress-chart" style="margin-top: 20px;">
                        <h3 class="chart-title">Workout Progress</h3>
                        <div id="workoutProgressList"></div>
                    </div>
                </div>
                <!-- HIIT Workout Mode -->
                <div id="hiitWorkoutMode"
                    style="display:none; background: linear-gradient(135deg, #001f3f 0%, #003d5c 100%); padding: 12px; border-radius: 12px;">
                    <div id="hiitCountdownScreen">
                        <h2 style="color: #f5f5dc;">Get Ready!</h2>
                        <div id="hiitCountdownDisplay">5</div>
                    </div>
                    <div id="hiitActiveScreen" style="display: none;">
                        <div id="hiitModeDisplay">WORK!</div>
                        <div id="hiitTimerDisplay">30</div>
                        <h3 id="hiitExerciseName">Jumping Jacks</h3>
                        <p id="hiitNextExerciseName">Next Up: Rest</p>
                        <div id="hiitRoundDisplay">Round 1 of 4</div>
                        <!-- Adjustment Controls - Full Width Mobile Optimized -->
                        <div
                            style="margin: 10px -12px 0 -12px; background: rgba(212,175,55,0.2); padding: 8px 12px; border-radius: 0;">
                            <div style="font-size: 10px; color: #f5f5dc; margin-bottom: 6px; text-align: center;">Adjust
                                Parameters:</div>
                            <div style="display: flex; justify-content: center; gap: 15px; flex-wrap: wrap;">
                                <div style="text-align: center;">
                                    <div style="font-size: 9px; color: #f5f5dc; margin-bottom: 4px;">Work</div>
                                    <div style="display: flex; gap: 6px; justify-content: center; align-items: center;">
                                        <button class="btn btn-secondary" onclick="adjustHiitParam('work', -5)"
                                            style="width: 32px; height: 32px; padding: 4px; margin: 0; font-size: 12px;">-</button>
                                        <span id="hiitWorkDisplay"
                                            style="min-width: 35px; text-align: center; color: #d4af37; font-weight: bold; font-size: 13px;">30</span>
                                        <button class="btn btn-secondary" onclick="adjustHiitParam('work', 5)"
                                            style="width: 32px; height: 32px; padding: 4px; margin: 0; font-size: 12px;">+</button>
                                    </div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 9px; color: #f5f5dc; margin-bottom: 4px;">Rest</div>
                                    <div style="display: flex; gap: 6px; justify-content: center; align-items: center;">
                                        <button class="btn btn-secondary" onclick="adjustHiitParam('rest', -5)"
                                            style="width: 32px; height: 32px; padding: 4px; margin: 0; font-size: 12px;">-</button>
                                        <span id="hiitRestDisplay"
                                            style="min-width: 35px; text-align: center; color: #d4af37; font-weight: bold; font-size: 13px;">15</span>
                                        <button class="btn btn-secondary" onclick="adjustHiitParam('rest', 5)"
                                            style="width: 32px; height: 32px; padding: 4px; margin: 0; font-size: 12px;">+</button>
                                    </div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 9px; color: #f5f5dc; margin-bottom: 4px;">Rounds</div>
                                    <div style="display: flex; gap: 6px; justify-content: center; align-items: center;">
                                        <button class="btn btn-secondary" onclick="adjustHiitParam('rounds', -1)"
                                            style="width: 32px; height: 32px; padding: 4px; margin: 0; font-size: 12px;">-</button>
                                        <span id="hiitRoundsDisplay"
                                            style="min-width: 35px; text-align: center; color: #d4af37; font-weight: bold; font-size: 13px;">4</span>
                                        <button class="btn btn-secondary" onclick="adjustHiitParam('rounds', 1)"
                                            style="width: 32px; height: 32px; padding: 4px; margin: 0; font-size: 12px;">+</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 8px; margin-top: 10px;">
                            <button id="hiitPauseResumeBtn" class="btn btn-secondary" onclick="pauseResumeHiit()"
                                style="flex: 1; padding: 10px; font-size: 13px;">Pause Exercise</button>
                            <button class="btn btn-danger" onclick="endHiitWorkout()"
                                style="flex: 1; padding: 10px; font-size: 13px;">End Workout</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Exercises Section -->
            <div id="exercises" class="section">
                <h2>Exercise Library</h2>
                <div class="form-group">
                    <input type="search" id="exerciseSearch" placeholder="Search for an exercise..."
                        onkeyup="renderExerciseList()">
                </div>
                <button class="btn" onclick="openAddExerciseModal(true)" style="margin-bottom: 20px;">+ Add New
                    Exercise</button>
                <div id="exerciseListContainer"></div>
            </div>
            <!-- Recommendation Section -->
            <div id="recommend" class="section">
                <h2 style="margin-bottom: 20px;">Today's Recommendation</h2>
                <div id="recommendationContainer"></div>
            </div>
            <!-- Progress Section -->
            <div id="progress" class="section">
                <h2 style="margin-bottom: 20px;">Your Progress</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalWorkouts">0</div>
                        <div class="stat-label">Total Workouts</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="thisWeek">0</div>
                        <div class="stat-label">This Week</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalVolume">0</div>
                        <div class="stat-label">Total Volume (lbs)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="streak">0</div>
                        <div class="stat-label">Day Streak</div>
                    </div>
                </div>
                <div class="progress-chart">
                    <h3 class="chart-title">Workout Distribution</h3>
                    <div id="workoutDistribution"></div>
                </div>
                <div class="progress-chart">
                    <h3 class="chart-title">Volume Progress (Last 10 Workouts)</h3>
                    <div id="volumeProgress"></div>
                </div>
            </div>
            <!-- History Section -->
            <div id="history" class="section">
                <h2 style="margin-bottom: 20px;">Workout History</h2>
                <div class="info-box">
                    <p><strong>Pro Tip:</strong> Track your progress by reviewing past workouts. Try to beat your
                        previous weights and reps!</p>
                </div>
                <div id="historyContainer"></div>
            </div>
            <!-- Share Workout Section -->
            <div id="share-workout" class="section">
                <h2 style="margin-bottom: 20px;">Share Workout via QR Code</h2>
                
                <!-- Share Your Workout -->
                <div class="info-box">
                    <p><strong>[SHARE] Share Your Workout:</strong> Generate a QR code containing your workout data. Your friend can scan it to instantly add the workout to their app!</p>
                </div>
                
                <div class="form-group">
                    <label>Select Workout to Share</label>
                    <select id="qrShareWorkoutSelect">
                        <option value="">-- Choose a workout --</option>
                    </select>
                </div>
                
                <button class="btn btn-success" onclick="generateWorkoutQR()" style="margin-bottom: 20px;">[QR] Generate QR Code</button>
                
                <div id="qrCodeContainer" style="display: none; background: white; padding: 20px; border-radius: 10px; text-align: center; margin-bottom: 30px;">
                    <h3 style="color: #001f3f; margin-bottom: 15px;">Scan to Import Workout</h3>
                    <canvas id="qrCanvas" style="margin: 0 auto; display: block;"></canvas>
                    <p style="margin-top: 15px; color: #666; font-size: 14px;">Have your friend scan this QR code with their device camera or the scanner below</p>
                </div>
                
                <!-- Scan QR Code -->
                <div class="info-box" style="background: #e8f5e9; border-left-color: #4caf50; border: 2px solid #4caf50; margin-top: 30px;">
                    <p style="font-size: 16px; font-weight: bold; color: #2e7d32; margin-bottom: 10px;">[SCAN] Received a Workout QR Code?</p>
                    <p><strong>Scan it here!</strong> If someone shared a workout QR code with you:</p>
                    <ol style="margin-top: 10px; margin-left: 20px; line-height: 1.8;">
                        <li>Click the "Start Camera Scanner" button below</li>
                        <li>Point your camera at the QR code</li>
                        <li>Wait for it to scan automatically</li>
                        <li>Review the workout and confirm import</li>
                    </ol>
                </div>
                
                <!-- NEW, SIMPLER INSTRUCTIONS -->
                <div class="info-box" style="background: #e8f5e9; border-left-color: #4caf50; border: 2px solid #4caf50; margin-top: 30px;">
                    <p style="font-size: 16px; font-weight: bold; color: #2e7d32; margin-bottom: 10px;">[SCAN] How to Scan a Workout QR Code</p>
                    <p>Scanning is now easier and more reliable than ever!</p>
                    <ol style="margin-top: 10px; margin-left: 20px; line-height: 1.8;">
                        <li>Open your phone's built-in <strong>Camera app</strong>.</li>
                        <li>Point it at the workout QR code.</li>
                        <li>Tap the link that appears on your screen.</li>
                        <li>The app will open and ask you to confirm the import.</li>
                    </ol>
                </div>

            </div>
            <!-- Settings Section -->
            <div id="settings" class="section">
                 <h2 style="margin-bottom: 20px;">Settings & Data Management</h2>
                
                <!-- Export Data Section -->
                <div class="info-box" style="margin-top: 20px;">
                    <p><strong>[SAVE] Backup Your Data:</strong> Save all your workout history, custom exercises, custom workouts, and preferences to a file. This is useful for transferring data to another browser or device, or as a backup in case your browser's data is cleared.</p>
                    <p style="margin-top: 10px; font-size: 13px; color: #6c757d;">Exported file includes: workout history, custom exercises, custom workouts, preferences, and API key.</p>
                </div>
                <button class="btn btn-success" onclick="exportData()" style="margin-bottom: 30px;">[SAVE] Export All Data to File</button>
                
                <!-- [IMPORT] Import Data Section -->
                <div class="info-box" style="margin-top: 20px; border-left-color: #8b0000;">
                    <p><strong>[!] Restore from Backup:</strong> Import a previously saved backup file.</p>
                    <p style="margin-top: 10px; color: #8b0000;"><strong>Warning:</strong> This will replace ALL current data in the app with the data from the backup file. Your existing workouts, exercises, and history will be overwritten. This action cannot be undone!</p>
                    <p style="margin-top: 10px; font-size: 13px; color: #6c757d;">Tip: Export your current data first if you want to keep a copy before importing.</p>
                </div>
                <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">
                <label for="importFile" class="btn btn-danger">[IMPORT] Import Data from Backup File</label>
                
                <!-- Clear Data Section -->
                <div class="info-box" style="margin-top: 30px; border-left-color: #8b0000;">
                    <p><strong>[DELETE] Clear All Data:</strong> Permanently delete all data from the app and start fresh.</p>
                    <p style="margin-top: 10px; color: #8b0000;"><strong>Warning:</strong> This will delete your entire workout history, all custom exercises, all custom workouts, and all preferences. This action cannot be undone!</p>
                </div>
                <button class="btn btn-danger" onclick="clearAllData()" style="margin-top: 10px;">[DELETE] Clear All App Data</button>
            </div>
        </div>
    </div>
    <!-- Exercise Info Modal -->
    <div id="exerciseModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalExerciseName"></h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div id="modalExerciseContent"></div>
        </div>
    </div>
    <!-- Add/Edit Custom Exercise Modal -->
    <div id="addExerciseModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="addExerciseModalTitle"> Add Custom Exercise</h3>
                <button class="modal-close" onclick="closeAddExerciseModal()">&times;</button>
            </div>
            <div>
                <input type="hidden" id="originalExerciseName">
                <div class="form-group">
                    <label>Exercise Name *</label>
                    <input type="text" id="newExerciseName" placeholder="e.g., Dumbbell Chest Fly">
                </div>
                <button class="btn btn-secondary" onclick="generateExerciseDetailsWithAI()" id="aiGenerateBtn"
                    style="width: auto; padding: 10px 15px; font-size: 14px; margin-bottom: 20px;">
                    [AI] Generate with AI
                </button>
                <div class="form-group">
                    <label>Equipment *</label>
                    <input type="text" id="newExerciseEquipment" placeholder="e.g., Dumbbells">
                </div>
                <div class="form-group">
                    <label>Instructions *</label>
                    <textarea id="newExerciseInstructions" rows="4"
                        placeholder="Describe how to perform this exercise..."></textarea>
                </div>
                <div class="form-group">
                    <label>Target Muscles/Description</label>
                    <input type="text" id="newExerciseImage" placeholder="e.g., Targets: Chest, Shoulders">
                </div>
                <div class="form-group">
                    <label>YouTube Video Link (optional)</label>
                    <input type="url" id="newExerciseYouTubeLink" placeholder="e.g., https://www.youtube.com/watch?v=...">
                </div>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px;">
                    <div class="form-group">
                        <label>Default Weight (lbs)</label>
                        <input type="number" id="newExerciseWeight" value="25">
                    </div>
                    <div class="form-group">
                        <label>Default Sets</label>
                        <input type="number" id="newExerciseSets" value="3">
                    </div>
                    <div class="form-group">
                        <label>Default Reps</label>
                        <input type="number" id="newExerciseReps" value="12">
                    </div>
                </div>
                <button class="btn" id="saveExerciseBtn" onclick="saveNewExercise()"> Add Exercise to Database</button>
            </div>
        </div>
    </div>
     <script>
        // Using FREE public domain exercise images from yuhonas/free-exercise-db
        // All images are CC-BY-SA-4.0 or public domain - free for commercial use!

        // YouTube Shorts/Videos mapping for exercises
        const youtubeVideoLinks = {
            'Dumbbell Goblet Squat': 'https://www.youtube.com/results?search_query=goblet+squat+tutorial',
            'Dumbbell Romanian Deadlift': 'https://www.youtube.com/results?search_query=romanian+deadlift+tutorial',
            'Dumbbell Lunges': 'https://www.youtube.com/results?search_query=dumbbell+lunges+tutorial',
            'Dumbbell Calf Raises': 'https://www.youtube.com/results?search_query=dumbbell+calf+raises+tutorial',
            'Bodyweight Squats': 'https://www.youtube.com/results?search_query=proper+squat+form+tutorial',
            'Bulgarian Split Squats': 'https://www.youtube.com/results?search_query=bulgarian+split+squat+tutorial',
            'Walking Lunges': 'https://www.youtube.com/results?search_query=walking+lunges+tutorial',
            'Step-Ups': 'https://www.youtube.com/results?search_query=step+ups+exercise+tutorial',
            'Goblet Squats': 'https://www.youtube.com/results?search_query=goblet+squat+tutorial',
            'Wall Sits': 'https://www.youtube.com/results?search_query=wall+sit+tutorial',
            'Jump Squats': 'https://www.youtube.com/results?search_query=jump+squats+tutorial',
            'Incline Dumbbell Press': 'https://www.youtube.com/results?search_query=incline+dumbbell+press+tutorial',
            'Flat Dumbbell Press': 'https://www.youtube.com/results?search_query=dumbbell+bench+press+tutorial',
            'Decline Dumbbell Press': 'https://www.youtube.com/results?search_query=decline+dumbbell+press+tutorial',
            'Barbell Bench Press': 'https://www.youtube.com/results?search_query=barbell+bench+press+tutorial',
            'Incline Barbell Bench Press': 'https://www.youtube.com/results?search_query=incline+barbell+press+tutorial',
            'Decline Barbell Bench Press': 'https://www.youtube.com/results?search_query=decline+barbell+press+tutorial',
            'Incline Dumbbell Flyes': 'https://www.youtube.com/results?search_query=incline+dumbbell+fly+tutorial',
            'Flat Dumbbell Flyes': 'https://www.youtube.com/results?search_query=dumbbell+fly+tutorial',
            'Decline Dumbbell Flyes': 'https://www.youtube.com/results?search_query=decline+dumbbell+fly+tutorial',
            'Dumbbell Pullover': 'https://www.youtube.com/results?search_query=dumbbell+pullover+tutorial',
            'Diamond Push-Ups': 'https://www.youtube.com/results?search_query=diamond+push+ups+tutorial',
            'Wide Push-Ups': 'https://www.youtube.com/results?search_query=wide+grip+push+ups+tutorial',
            'Decline Push-Ups': 'https://www.youtube.com/results?search_query=decline+push+ups+tutorial',
            'Incline Push-Ups': 'https://www.youtube.com/results?search_query=incline+push+ups+tutorial',
            'Push-Up': 'https://www.youtube.com/results?search_query=proper+push+up+form+tutorial',
            'Chest Dips': 'https://www.youtube.com/results?search_query=chest+dips+tutorial',
            'Cable Crossover': 'https://www.youtube.com/results?search_query=cable+crossover+tutorial',
            'Dumbbell Bent-Over Row': 'https://www.youtube.com/results?search_query=dumbbell+bent+over+row+tutorial',
            'Single-Arm Dumbbell Row': 'https://www.youtube.com/results?search_query=single+arm+dumbbell+row+tutorial',
            'Pull-Ups': 'https://www.youtube.com/results?search_query=proper+pull+up+form+tutorial',
            'Chin-Ups': 'https://www.youtube.com/results?search_query=chin+up+tutorial',
            'Assisted Pull-Ups': 'https://www.youtube.com/results?search_query=assisted+pull+ups+tutorial',
            'Negative Pull-Ups': 'https://www.youtube.com/results?search_query=negative+pull+ups+tutorial',
            'Wide-Grip Pull-Ups': 'https://www.youtube.com/results?search_query=wide+grip+pull+ups+tutorial',
            'Barbell Bent-Over Row': 'https://www.youtube.com/results?search_query=barbell+bent+over+row+tutorial',
            'Pendlay Row': 'https://www.youtube.com/results?search_query=pendlay+row+tutorial',
            'T-Bar Row': 'https://www.youtube.com/results?search_query=t+bar+row+tutorial',
            'Inverted Row': 'https://www.youtube.com/results?search_query=inverted+row+tutorial',
            'Lat Pulldown': 'https://www.youtube.com/results?search_query=lat+pulldown+tutorial',
            'Close-Grip Lat Pulldown': 'https://www.youtube.com/results?search_query=close+grip+lat+pulldown+tutorial',
            'Straight-Arm Pulldown': 'https://www.youtube.com/results?search_query=straight+arm+pulldown+tutorial',
            'Face Pulls': 'https://www.youtube.com/results?search_query=face+pulls+tutorial',
            'Seated Cable Row': 'https://www.youtube.com/results?search_query=seated+cable+row+tutorial',
            'Dumbbell Bicep Curls': 'https://www.youtube.com/results?search_query=dumbbell+bicep+curls+tutorial',
            'Barbell Bicep Curls': 'https://www.youtube.com/results?search_query=barbell+bicep+curls+tutorial',
            'Hammer Curls': 'https://www.youtube.com/results?search_query=hammer+curls+tutorial',
            'EZ-Bar Curls': 'https://www.youtube.com/results?search_query=ez+bar+curls+tutorial',
            'Preacher Curls': 'https://www.youtube.com/results?search_query=preacher+curls+tutorial',
            'Concentration Curls': 'https://www.youtube.com/results?search_query=concentration+curls+tutorial',
            'Cable Bicep Curls': 'https://www.youtube.com/results?search_query=cable+bicep+curls+tutorial',
            'Zottman Curls': 'https://www.youtube.com/results?search_query=zottman+curls+tutorial',
            'Incline Dumbbell Curls': 'https://www.youtube.com/results?search_query=incline+dumbbell+curls+tutorial',
            'Dumbbell Shrugs': 'https://www.youtube.com/results?search_query=dumbbell+shrugs+tutorial',
            'Barbell Shrugs': 'https://www.youtube.com/results?search_query=barbell+shrugs+tutorial',
            'Meadows Row': 'https://www.youtube.com/results?search_query=meadows+row+tutorial',
            'Dumbbell Shoulder Press': 'https://www.youtube.com/results?search_query=dumbbell+shoulder+press+tutorial',
            'Dumbbell Lateral Raises': 'https://www.youtube.com/results?search_query=dumbbell+lateral+raises+tutorial',
            'Dumbbell Front Raises': 'https://www.youtube.com/results?search_query=dumbbell+front+raises+tutorial',
            'Bent-Over Rear Delt Raises': 'https://www.youtube.com/results?search_query=rear+delt+raises+tutorial',
            'Overhead Tricep Extension': 'https://www.youtube.com/results?search_query=overhead+tricep+extension+tutorial',
            'Dumbbell Tricep Kickbacks': 'https://www.youtube.com/results?search_query=tricep+kickbacks+tutorial',
            'Close-Grip Bench Press': 'https://www.youtube.com/results?search_query=close+grip+bench+press+tutorial',
            'Skull Crushers': 'https://www.youtube.com/results?search_query=skull+crushers+tutorial',
            'Tricep Dips': 'https://www.youtube.com/results?search_query=tricep+dips+tutorial',
            'Cable Tricep Pushdown': 'https://www.youtube.com/results?search_query=tricep+pushdown+tutorial',
            'Overhead Cable Extension': 'https://www.youtube.com/results?search_query=overhead+cable+extension+tutorial',
            'Bench Dips': 'https://www.youtube.com/results?search_query=bench+dips+tutorial',
            'Dumbbell Russian Twists': 'https://www.youtube.com/results?search_query=russian+twists+tutorial',
            'Dumbbell Side Bends': 'https://www.youtube.com/results?search_query=side+bends+tutorial',
            'Plank': 'https://www.youtube.com/results?search_query=proper+plank+form+tutorial',
            'Mountain Climbers': 'https://www.youtube.com/results?search_query=mountain+climbers+tutorial',
            'Bicycle Crunches': 'https://www.youtube.com/results?search_query=bicycle+crunches+tutorial',
            'Kettlebell Swings': 'https://www.youtube.com/results?search_query=kettlebell+swings+tutorial',
            'Kettlebell Goblet Squat': 'https://www.youtube.com/results?search_query=kettlebell+goblet+squat+tutorial',
            'Kettlebell Turkish Get-Up': 'https://www.youtube.com/results?search_query=kettlebell+turkish+get+up+tutorial',
            'Kettlebell Halos': 'https://www.youtube.com/results?search_query=kettlebell+halos+tutorial',
            'Kettlebell Single-Arm Row': 'https://www.youtube.com/results?search_query=kettlebell+single+arm+row+tutorial',
            'Kettlebell Overhead Press': 'https://www.youtube.com/results?search_query=kettlebell+overhead+press+tutorial',
            'Recumbent Bike': 'https://www.youtube.com/results?search_query=recumbent+bike+cardio+tutorial',
            'Rowing Machine': 'https://www.youtube.com/results?search_query=rowing+machine+tutorial',
            'Interval Sprints - Bike': 'https://www.youtube.com/results?search_query=hiit+interval+sprints+bike',
            'Interval Sprints - Rowing': 'https://www.youtube.com/results?search_query=hiit+rowing+machine+intervals'
        };

        // Helper function to get free exercise image URL
        function getExerciseImageUrl(exerciseName) {
            // Map specific exercise names to their correct repository paths
            const exerciseMapping = {
                'Dumbbell Goblet Squat': 'Dumbbell_Goblet_Squat',
                'Dumbbell Romanian Deadlift': 'Romanian_Deadlift',
                'Dumbbell Lunges': 'Dumbbell_Lunge',
                'Dumbbell Calf Raises': 'Standing_Calf_Raise',
                'Bodyweight Squats': 'Bodyweight_Squat',
                'Bulgarian Split Squats': 'Bulgarian_Split_Squat',
                'Walking Lunges': 'Walking_Lunge',
                'Step-Ups': 'Step_Up',
                'Goblet Squats': 'Goblet_Squat',
                'Wall Sits': 'Wall_Sit',
                'Jump Squats': 'Jump_Squat',
                'Incline Dumbbell Press': 'Incline_Dumbbell_Press',
                'Flat Dumbbell Press': 'Dumbbell_Bench_Press',
                'Decline Dumbbell Press': 'Decline_Dumbbell_Bench_Press',
                'Barbell Bench Press': 'Barbell_Bench_Press_-_Medium_Grip',
                'Incline Barbell Bench Press': 'Barbell_Incline_Bench_Press_-_Medium_Grip',
                'Decline Barbell Bench Press': 'Decline_Barbell_Bench_Press',
                'Incline Dumbbell Flyes': 'Incline_Dumbbell_Fly',
                'Flat Dumbbell Flyes': 'Dumbbell_Flyes',
                'Decline Dumbbell Flyes': 'Decline_Dumbbell_Fly',
                'Dumbbell Pullover': 'Dumbbell_Pullover',
                'Diamond Push-Ups': 'Close-Grip_Push-Up',
                'Wide Push-Ups': 'Wide-Grip_Push-Up',
                'Decline Push-Ups': 'Decline_Push-Up',
                'Incline Push-Ups': 'Incline_Push-Up',
                'Push-Up': 'Push-Ups',
                'Chest Dips': 'Chest_Dip',
                'Cable Crossover': 'Cable_Crossover',
                'Dumbbell Bent-Over Row': 'Bent_Over_Barbell_Row',
                'Single-Arm Dumbbell Row': 'One_Arm_Dumbbell_Row',
                'Pull-Ups': 'Pullups',
                'Chin-Ups': 'Chin_Up',
                'Assisted Pull-Ups': 'Assisted_Pull-Up',
                'Negative Pull-Ups': 'Pullups',
                'Wide-Grip Pull-Ups': 'Pullups',
                'Barbell Bent-Over Row': 'Bent_Over_Barbell_Row',
                'Pendlay Row': 'Pendlay_Row',
                'T-Bar Row': 'T-Bar_Row',
                'Inverted Row': 'Inverted_Row',
                'Lat Pulldown': 'Wide_Grip_Lat_Pulldown',
                'Close-Grip Lat Pulldown': 'Close_Grip_Front_Lat_Pulldown',
                'Straight-Arm Pulldown': 'Straight-Arm_Pulldown',
                'Face Pulls': 'Face_Pull',
                'Seated Cable Row': 'Seated_Cable_Row',
                'Meadows Row': 'Meadows_Row',
                'Dumbbell Bicep Curls': 'Dumbbell_Bicep_Curl',
                'Barbell Bicep Curls': 'Barbell_Curl',
                'Hammer Curls': 'Hammer_Curls',
                'EZ-Bar Curls': 'EZ-Bar_Curl',
                'Preacher Curls': 'Preacher_Curl',
                'Concentration Curls': 'Concentration_Curls',
                'Cable Bicep Curls': 'Cable_Curl',
                'Zottman Curls': 'Zottman_Curl',
                'Incline Dumbbell Curls': 'Alternate_Incline_Dumbbell_Curl',
                'Dumbbell Shrugs': 'Dumbbell_Shrug',
                'Barbell Shrugs': 'Barbell_Shrug',
                'Dumbbell Shoulder Press': 'Dumbbell_Shoulder_Press',
                'Dumbbell Lateral Raises': 'Dumbbell_Lateral_Raise',
                'Dumbbell Front Raises': 'Dumbbell_Front_Raise',
                'Bent-Over Rear Delt Raises': 'Bent_Over_Dumbbell_Rear_Delt_Raise',
                'Overhead Tricep Extension': 'Overhead_Triceps_Extension',
                'Dumbbell Tricep Kickbacks': 'Tricep_Kickback',
                'Close-Grip Bench Press': 'Close-Grip_Bench_Press',
                'Skull Crushers': 'Lying_Triceps_Extension',
                'Tricep Dips': 'Dips_-_Triceps_Version',
                'Cable Tricep Pushdown': 'Triceps_Pushdown',
                'Overhead Cable Extension': 'Overhead_Cable_Extension',
                'Bench Dips': 'Bench_Dip',
                'Dumbbell Russian Twists': 'Russian_Twist',
                'Dumbbell Side Bends': 'Side_Bend',
                'Plank': 'Plank',
                'Mountain Climbers': 'Mountain_Climber',
                'Bicycle Crunches': 'Bicycle_Crunch',
                'Kettlebell Swings': 'Kettlebell_Swing',
                'Kettlebell Goblet Squat': 'Kettlebell_Goblet_Squat',
                'Kettlebell Turkish Get-Up': 'Turkish_Get-Up',
                'Kettlebell Halos': 'Kettlebell_Halo',
                'Kettlebell Single-Arm Row': 'Kettlebell_One_Arm_Row',
                'Kettlebell Overhead Press': 'Kettlebell_Overhead_Press',
                'Recumbent Bike': 'Air_Bike',
                'Rowing Machine': 'Seated_Cable_Row',
                'Interval Sprints - Bike': 'Air_Bike',
                'Interval Sprints - Rowing': 'Seated_Cable_Row'
            };

            const mappedName = exerciseMapping[exerciseName] || exerciseName.replace(/ /g, '_');
            return `https://raw.githubusercontent.com/yuhonas/free-exercise-db/main/exercises/${mappedName}/0.jpg`;
        }

        function escapeHTML(str) {
            const p = document.createElement("p");
            p.textContent = str;
            return p.innerHTML.replace(/"/g, "&quot;").replace(/'/g, "&#39;");
        }

        // Storage for AI-generated exercise descriptions
        let exerciseDescriptions = JSON.parse(localStorage.getItem('exerciseDescriptions')) || {};

        // Exercise Database with FREE images
        const exerciseDatabase = {
            // Leg Exercises
            'Dumbbell Goblet Squat': {
                equipment: 'Dumbbell',
                instructions: 'Hold a dumbbell vertically at chest level. Stand with feet shoulder-width apart. Lower into a squat keeping chest up and knees tracking over toes. Push through heels to return.',
                sets: 3,
                reps: 12,
                weight: 25,
                image: ' Targets: Quads, Glutes, Core'
            },
            'Dumbbell Romanian Deadlift': {
                equipment: 'Dumbbells',
                instructions: 'Hold dumbbells in front of thighs. Hinge at hips, keeping back straight and slight bend in knees. Lower weights along legs until you feel hamstring stretch. Return to standing.',
                sets: 3,
                reps: 10,
                weight: 30,
                image: ' Targets: Hamstrings, Glutes, Lower Back'
            },
            'Dumbbell Lunges': {
                equipment: 'Dumbbells',
                instructions: 'Hold dumbbells at sides. Step forward into a lunge, lowering back knee toward ground. Front knee should stay behind toes. Push back to starting position. Alternate legs.',
                sets: 3,
                reps: 10,
                weight: 20,
                image: ' Targets: Quads, Glutes, Balance'
            },
            'Dumbbell Calf Raises': {
                equipment: 'Dumbbells',
                instructions: 'Hold dumbbells at sides. Stand on edge of a step or platform with heels hanging off. Rise up on toes as high as possible, then lower heels below step level.',
                sets: 3,
                reps: 15,
                weight: 25,
                image: ' Targets: Calves'
            },
            'Bodyweight Squats': {
                equipment: 'Bodyweight',
                instructions: 'Stand with feet shoulder-width apart, toes slightly pointed out. Keep chest up and core tight. Lower down by bending knees and pushing hips back as if sitting in a chair. Go as low as comfortable, ideally until thighs are parallel to ground. Push through heels to return to standing.',
                sets: 3,
                reps: 20,
                weight: 0,
                image: ' Targets: Quads, Glutes, Core'
            },
            'Bulgarian Split Squats': {
                equipment: 'Dumbbells, Bench',
                instructions: 'Place rear foot elevated on bench behind you. Hold dumbbells at sides. Lower front leg until thigh is parallel to ground, back knee drops toward floor. Push through front heel to return. Complete all reps then switch legs.',
                sets: 3,
                reps: 10,
                weight: 20,
                image: ' Targets: Quads, Glutes, Balance'
            },
            'Walking Lunges': {
                equipment: 'Dumbbells',
                instructions: 'Hold dumbbells at sides. Step forward into lunge with both knees at 90 degrees. Push off front foot and bring back leg forward into next lunge. Continue walking forward alternating legs each step.',
                sets: 3,
                reps: 20,
                weight: 20,
                image: ' Targets: Quads, Glutes, Coordination'
            },
            'Step-Ups': {
                equipment: 'Dumbbells, Box/Bench',
                instructions: 'Hold dumbbells at sides, stand facing box or bench. Step up with one foot, drive through heel to lift body onto box. Step down with control. Alternate legs or complete all reps on one side first.',
                sets: 3,
                reps: 12,
                weight: 20,
                image: ' Targets: Quads, Glutes, Functional Strength'
            },
            'Goblet Squats': {
                equipment: 'Dumbbell',
                instructions: 'Hold one dumbbell vertically at chest with both hands (like holding a goblet). Feet shoulder-width. Squat down keeping chest up, elbows track inside knees. Excellent for learning squat form.',
                sets: 3,
                reps: 15,
                weight: 30,
                image: ' Targets: Quads, Glutes, Core'
            },
            'Wall Sits': {
                equipment: 'Bodyweight',
                instructions: 'Lean back against wall. Slide down until thighs are parallel to floor, knees at 90 degrees. Hold position. Great for building quad endurance.',
                sets: 3,
                reps: 45,
                weight: 0,
                image: ' Targets: Quads, Endurance (time in seconds)'
            },
            'Jump Squats': {
                equipment: 'Bodyweight',
                instructions: 'Start in squat position. Explode up jumping as high as possible. Land softly and immediately descend into next squat. Builds explosive power.',
                sets: 3,
                reps: 12,
                weight: 0,
                image: ' Targets: Quads, Glutes, Power, Plyometrics'
            },

            // Chest Exercises
            'Incline Dumbbell Press': {
                equipment: 'Dumbbells, Incline Bench',
                instructions: 'Set bench to 30-45 degrees. Lie back with dumbbells at shoulder level. Press weights up and together, fully extending arms. Lower with control to chest level.',
                sets: 4,
                reps: 10,
                weight: 35,
                image: ' Targets: Upper Chest, Shoulders, Triceps'
            },
            'Flat Dumbbell Press': {
                equipment: 'Dumbbells, Bench',
                instructions: 'Lie on flat bench with dumbbells at chest level. Press weights straight up, bringing them together at top. Lower with control until elbows are at 90 degrees.',
                sets: 3,
                reps: 10,
                weight: 40,
                image: ' Targets: Middle Chest, Triceps'
            },
            'Incline Dumbbell Flyes': {
                equipment: 'Dumbbells, Incline Bench',
                instructions: 'Set bench to 30 degrees. Start with arms extended above chest, slight elbow bend. Lower weights out to sides in arc motion. Squeeze chest to bring weights back together.',
                sets: 3,
                reps: 12,
                weight: 20,
                image: ' Targets: Chest, Shoulders (stretch focused)'
            },
            'Dumbbell Pullover': {
                equipment: 'Dumbbell, Bench',
                instructions: 'Lie perpendicular on bench (upper back only). Hold one dumbbell with both hands above chest. Lower weight behind head in arc, feel chest and lat stretch. Pull back to start.',
                sets: 3,
                reps: 12,
                weight: 25,
                image: ' Targets: Chest, Lats, Serratus'
            },
            'Barbell Bench Press': {
                equipment: 'Barbell, Bench',
                instructions: 'Lie on flat bench, grip barbell slightly wider than shoulders. Lower bar to chest with control. Press bar up until arms fully extended. Keep feet flat on floor.',
                sets: 4,
                reps: 8,
                weight: 135,
                image: ' Targets: Chest, Shoulders, Triceps'
            },
            'Incline Barbell Bench Press': {
                equipment: 'Barbell, Incline Bench',
                instructions: 'Set bench to 30-45 degrees. Lie back, grip bar slightly wider than shoulders. Lower to upper chest. Press straight up. Targets upper chest.',
                sets: 4,
                reps: 8,
                weight: 115,
                image: ' Targets: Upper Chest, Shoulders, Triceps'
            },
            'Decline Dumbbell Press': {
                equipment: 'Dumbbells, Decline Bench',
                instructions: 'Set bench to 15-30 degree decline. Secure feet. Lie back with dumbbells at chest. Press weights up and together. Lower with control. Targets lower chest.',
                sets: 3,
                reps: 10,
                weight: 35,
                image: ' Targets: Lower Chest, Triceps'
            },
            'Decline Barbell Bench Press': {
                equipment: 'Barbell, Decline Bench',
                instructions: 'Set bench to decline, secure feet. Grip bar slightly wider than shoulders. Lower to lower chest. Press up to full extension. Emphasizes lower pecs.',
                sets: 3,
                reps: 10,
                weight: 125,
                image: ' Targets: Lower Chest, Triceps'
            },
            'Flat Dumbbell Flyes': {
                equipment: 'Dumbbells, Bench',
                instructions: 'Lie on flat bench with dumbbells above chest, slight elbow bend. Lower weights out to sides in wide arc until stretch in chest. Squeeze pecs to bring weights back together.',
                sets: 3,
                reps: 12,
                weight: 20,
                image: ' Targets: Chest (stretch and squeeze)'
            },
            'Decline Dumbbell Flyes': {
                equipment: 'Dumbbells, Decline Bench',
                instructions: 'Lie on decline bench. Hold dumbbells above chest with slight elbow bend. Lower in arc motion feeling stretch in lower chest. Squeeze to return.',
                sets: 3,
                reps: 12,
                weight: 20,
                image: ' Targets: Lower Chest'
            },
            'Diamond Push-Ups': {
                equipment: 'Bodyweight',
                instructions: 'Get in push-up position. Place hands close together forming diamond shape with index fingers and thumbs. Lower chest to hands. Push back up. Harder on triceps.',
                sets: 3,
                reps: 12,
                weight: 0,
                image: ' Targets: Triceps, Inner Chest, Core'
            },
            'Wide Push-Ups': {
                equipment: 'Bodyweight',
                instructions: 'Push-up position with hands placed wider than shoulders. Lower chest toward ground. Push back up. Wider grip emphasizes chest more.',
                sets: 3,
                reps: 15,
                weight: 0,
                image: ' Targets: Chest, Shoulders'
            },
            'Decline Push-Ups': {
                equipment: 'Bench/Box',
                instructions: 'Place feet elevated on bench, hands on ground. Perform push-ups. Elevation increases difficulty and emphasizes upper chest.',
                sets: 3,
                reps: 12,
                weight: 0,
                image: ' Targets: Upper Chest, Shoulders'
            },
            'Incline Push-Ups': {
                equipment: 'Bench/Box',
                instructions: 'Place hands on elevated bench, feet on ground. Perform push-ups. Easier variation, good for beginners or burnout sets.',
                sets: 3,
                reps: 20,
                weight: 0,
                image: ' Targets: Chest, Triceps (beginner friendly)'
            },
            'Chest Dips': {
                equipment: 'Dip Bar/Parallel Bars',
                instructions: 'Grip bars, body suspended. Lean forward slightly. Lower body by bending elbows until shoulders are below elbows. Push back up. Lean determines chest vs tricep focus.',
                sets: 3,
                reps: 10,
                weight: 0,
                image: ' Targets: Lower Chest, Triceps, Shoulders'
            },
            'Cable Crossover': {
                equipment: 'Cable Machine',
                instructions: 'Stand between cable towers, handles at shoulder height. Step forward, slight bend in elbows. Bring handles together in front of chest in arc motion. Control return.',
                sets: 3,
                reps: 12,
                weight: 20,
                image: ' Targets: Inner Chest, Definition'
            },
            'Push-Up': {
                equipment: 'Bodyweight',
                instructions: 'Start in plank position with hands shoulder-width apart. Lower body until chest nearly touches floor. Push back up to starting position. Keep core tight throughout.',
                sets: 3,
                reps: 15,
                weight: 0,
                image: ' Targets: Chest, Triceps, Core'
            },

            // Back & Bicep Exercises
            'Dumbbell Bent-Over Row': {
                equipment: 'Dumbbells',
                instructions: 'Hinge at hips with slight knee bend, back straight. Let dumbbells hang at arms length. Pull weights to sides of torso, squeezing shoulder blades together. Lower with control.',
                sets: 4,
                reps: 10,
                weight: 35,
                image: ' Targets: Mid Back, Lats, Biceps'
            },
            'Single-Arm Dumbbell Row': {
                equipment: 'Dumbbell, Bench',
                instructions: 'Place one knee and hand on bench. Hold dumbbell in free hand. Pull weight to hip, keeping elbow close to body. Lower with control. Complete all reps then switch sides.',
                sets: 3,
                reps: 12,
                weight: 40,
                image: ' Targets: Lats, Mid Back, Biceps'
            },
            'Dumbbell Bicep Curls': {
                equipment: 'Dumbbells',
                instructions: 'Stand with dumbbells at sides, palms forward. Curl weights up keeping elbows stationary at sides. Squeeze biceps at top. Lower with control, fully extending arms.',
                sets: 3,
                reps: 12,
                weight: 25,
                image: ' Targets: Biceps'
            },
            'Hammer Curls': {
                equipment: 'Dumbbells',
                instructions: 'Hold dumbbells with palms facing each other. Curl weights up keeping thumbs up throughout movement. Squeeze at top. Lower with control.',
                sets: 3,
                reps: 12,
                weight: 25,
                image: ' Targets: Biceps, Forearms'
            },
            'Barbell Bicep Curls': {
                equipment: 'Barbell',
                instructions: 'Stand holding barbell at arms length, palms up. Curl weight up keeping elbows stationary. Squeeze biceps at top. Lower with control.',
                sets: 3,
                reps: 10,
                weight: 60,
                image: ' Targets: Biceps'
            },
            'EZ-Bar Curls': {
                equipment: 'EZ Curl Bar',
                instructions: 'Hold EZ bar with angled grip (less wrist strain than straight bar). Curl up keeping elbows at sides. Squeeze biceps. Lower slowly.',
                sets: 3,
                reps: 12,
                weight: 50,
                image: ' Targets: Biceps (wrist-friendly)'
            },
            'Preacher Curls': {
                equipment: 'Dumbbells or Barbell, Preacher Bench',
                instructions: 'Sit at preacher bench, arms resting on pad. Curl weight up with strict form (pad prevents cheating). Lower to full extension.',
                sets: 3,
                reps: 12,
                weight: 20,
                image: ' Targets: Biceps (strict form)'
            },
            'Concentration Curls': {
                equipment: 'Dumbbell',
                instructions: 'Sit on bench, legs spread. Rest elbow against inner thigh. Curl dumbbell up to shoulder. Lower with control. Great isolation exercise.',
                sets: 3,
                reps: 12,
                weight: 20,
                image: ' Targets: Biceps Peak'
            },
            'Cable Bicep Curls': {
                equipment: 'Cable Machine',
                instructions: 'Stand at cable with low pulley and straight bar. Curl bar up keeping elbows stationary. Constant tension throughout movement.',
                sets: 3,
                reps: 15,
                weight: 50,
                image: ' Targets: Biceps (constant tension)'
            },
            'Zottman Curls': {
                equipment: 'Dumbbells',
                instructions: 'Curl dumbbells up with palms up (supinated). At top, rotate palms down (pronated). Lower slowly. Rotate palms up at bottom. Works biceps and forearms.',
                sets: 3,
                reps: 10,
                weight: 20,
                image: ' Targets: Biceps, Forearms'
            },
            'Incline Dumbbell Curls': {
                equipment: 'Dumbbells, Incline Bench',
                instructions: 'Lie back on incline bench (45 degrees). Let arms hang straight down. Curl weights up. Full stretch at bottom builds long head of bicep.',
                sets: 3,
                reps: 12,
                weight: 20,
                image: ' Targets: Biceps (stretch emphasis)'
            },
            'Dumbbell Shrugs': {
                equipment: 'Dumbbells',
                instructions: 'Stand holding dumbbells at sides. Elevate shoulders straight up toward ears as high as possible. Hold briefly at top. Lower with control. Keep arms straight throughout.',
                sets: 3,
                reps: 15,
                weight: 45,
                image: ' Targets: Traps, Upper Back'
            },
            'Pull-Ups': {
                equipment: 'Pull-Up Bar',
                instructions: 'Hang from bar with overhand grip (palms away), hands shoulder-width. Pull body up until chin clears bar. Lower with control to full extension. One of the best back exercises.',
                sets: 3,
                reps: 8,
                weight: 0,
                image: ' Targets: Lats, Biceps, Upper Back'
            },
            'Chin-Ups': {
                equipment: 'Pull-Up Bar',
                instructions: 'Hang from bar with underhand grip (palms facing you), hands shoulder-width. Pull up until chin over bar. Lower with control. Easier than pull-ups, more bicep activation.',
                sets: 3,
                reps: 10,
                weight: 0,
                image: ' Targets: Lats, Biceps, Forearms'
            },
            'Assisted Pull-Ups': {
                equipment: 'Resistance Band or Machine',
                instructions: 'Use resistance band under feet or assisted pull-up machine. Perform pull-up motion with assistance. Great for building up to unassisted pull-ups.',
                sets: 3,
                reps: 10,
                weight: 0,
                image: ' Targets: Lats, Biceps (progression exercise)'
            },
            'Negative Pull-Ups': {
                equipment: 'Pull-Up Bar',
                instructions: 'Jump or step up to top position of pull-up (chin over bar). Lower yourself down as slowly as possible (5-10 seconds). Step down and repeat. Builds strength for full pull-ups.',
                sets: 3,
                reps: 5,
                weight: 0,
                image: ' Targets: Lats, Back (eccentric strength)'
            },
            'Wide-Grip Pull-Ups': {
                equipment: 'Pull-Up Bar',
                instructions: 'Hang from bar with overhand grip wider than shoulders. Pull up bringing chest toward bar. Lower with control. Wider grip emphasizes lats more.',
                sets: 3,
                reps: 6,
                weight: 0,
                image: ' Targets: Lats, Upper Back'
            },
            'Barbell Bent-Over Row': {
                equipment: 'Barbell',
                instructions: 'Hinge at hips holding barbell, back straight, knees slightly bent. Pull bar to lower chest/upper abs, squeezing shoulder blades. Lower with control.',
                sets: 4,
                reps: 10,
                weight: 95,
                image: ' Targets: Mid Back, Lats, Biceps'
            },
            'Pendlay Row': {
                equipment: 'Barbell',
                instructions: 'Bend at hips until torso parallel to floor. Pull bar from floor to chest explosively. Return bar to floor between each rep. Builds explosive pulling power.',
                sets: 4,
                reps: 8,
                weight: 85,
                image: ' Targets: Back, Power, Explosiveness'
            },
            'T-Bar Row': {
                equipment: 'Barbell, V-Handle',
                instructions: 'Straddle bar with weight on one end. Grip V-handle or bar. Hinge at hips. Pull bar to chest squeezing back. Lower with control.',
                sets: 3,
                reps: 10,
                weight: 70,
                image: ' Targets: Mid Back, Lats, Thickness'
            },
            'Inverted Row': {
                equipment: 'Bar/Smith Machine',
                instructions: 'Lie under bar set at waist height. Grip bar with straight arms. Pull chest to bar. Lower with control. Like reverse push-up. Adjust height for difficulty.',
                sets: 3,
                reps: 12,
                weight: 0,
                image: ' Targets: Back, Biceps, Core'
            },
            'Lat Pulldown': {
                equipment: 'Cable Machine',
                instructions: 'Sit at lat pulldown machine. Grip bar wider than shoulders. Pull bar down to upper chest. Squeeze shoulder blades. Control weight back up.',
                sets: 3,
                reps: 12,
                weight: 80,
                image: ' Targets: Lats, Back Width'
            },
            'Close-Grip Lat Pulldown': {
                equipment: 'Cable Machine, V-Handle',
                instructions: 'Sit at pulldown. Use close-grip V-handle. Pull to upper chest. Squeeze lats and mid-back. Emphasizes thickness.',
                sets: 3,
                reps: 12,
                weight: 80,
                image: ' Targets: Lats, Mid Back, Thickness'
            },
            'Straight-Arm Pulldown': {
                equipment: 'Cable Machine',
                instructions: 'Stand at cable, arms extended overhead holding bar. Keep arms straight, pull bar down to thighs using lats. Control return. Great lat isolation.',
                sets: 3,
                reps: 15,
                weight: 40,
                image: ' Targets: Lats (isolation)'
            },
            'Face Pulls': {
                equipment: 'Cable Machine, Rope',
                instructions: 'Set cable at head height with rope attachment. Pull rope toward face, separating ends at face. Squeeze shoulder blades. Excellent for rear delts and posture.',
                sets: 3,
                reps: 15,
                weight: 30,
                image: ' Targets: Rear Delts, Upper Back, Posture'
            },
            'Seated Cable Row': {
                equipment: 'Cable Machine',
                instructions: 'Sit at cable row station. Feet on platform, knees slightly bent. Pull handle to torso, squeezing shoulder blades. Control return.',
                sets: 3,
                reps: 12,
                weight: 90,
                image: ' Targets: Mid Back, Lats, Biceps'
            },
            'Barbell Shrugs': {
                equipment: 'Barbell',
                instructions: 'Hold barbell at arms length in front of thighs. Elevate shoulders straight up as high as possible. Hold briefly. Lower with control. Builds traps.',
                sets: 3,
                reps: 15,
                weight: 135,
                image: ' Targets: Traps, Upper Back'
            },
            'Meadows Row': {
                equipment: 'Barbell',
                instructions: 'Stand perpendicular to barbell loaded on one end. Hinge at hips. Grab end of bar. Pull to hip rotating slightly. Great for lats and thickness.',
                sets: 3,
                reps: 10,
                weight: 60,
                image: ' Targets: Lats, Back Thickness'
            },

            // Shoulder & Tricep Exercises
            'Dumbbell Shoulder Press': {
                equipment: 'Dumbbells',
                instructions: 'Sit or stand with dumbbells at shoulder level, palms forward. Press weights overhead until arms are fully extended. Lower with control back to shoulders.',
                sets: 3,
                reps: 10,
                weight: 30,
                image: ' Targets: Shoulders, Triceps'
            },
            'Dumbbell Lateral Raises': {
                equipment: 'Dumbbells',
                instructions: 'Stand with dumbbells at sides. Raise arms out to sides until parallel with floor, slight bend in elbows. Lead with elbows, not hands. Lower with control.',
                sets: 3,
                reps: 12,
                weight: 15,
                image: ' Targets: Side Delts'
            },
            'Dumbbell Front Raises': {
                equipment: 'Dumbbells',
                instructions: 'Hold dumbbells in front of thighs. Raise one or both weights forward and up to shoulder level, keeping arms straight. Lower with control.',
                sets: 3,
                reps: 12,
                weight: 15,
                image: ' Targets: Front Delts'
            },
            'Bent-Over Rear Delt Raises': {
                equipment: 'Dumbbells',
                instructions: 'Hinge at hips until torso is nearly parallel to floor. Let dumbbells hang down. Raise arms out to sides, squeezing shoulder blades. Lower with control.',
                sets: 3,
                reps: 15,
                weight: 12,
                image: ' Targets: Rear Delts, Upper Back'
            },
            'Overhead Tricep Extension': {
                equipment: 'Dumbbell',
                instructions: 'Hold one dumbbell with both hands overhead. Lower weight behind head by bending elbows. Keep upper arms stationary. Extend arms back to start position.',
                sets: 3,
                reps: 12,
                weight: 25,
                image: ' Targets: Triceps'
            },
            'Dumbbell Tricep Kickbacks': {
                equipment: 'Dumbbells',
                instructions: 'Hinge at hips, bring elbows to sides with 90-degree bend. Extend arms backward, straightening elbows fully. Squeeze triceps at top. Return to 90 degrees.',
                sets: 3,
                reps: 12,
                weight: 15,
                image: ' Targets: Triceps'
            },
            'Close-Grip Bench Press': {
                equipment: 'Barbell, Bench',
                instructions: 'Lie on bench. Grip bar with hands 8-12 inches apart. Lower to chest. Press up keeping elbows close to body. Excellent for triceps mass.',
                sets: 4,
                reps: 10,
                weight: 95,
                image: ' Targets: Triceps, Chest'
            },
            'Skull Crushers': {
                equipment: 'EZ Bar or Dumbbells, Bench',
                instructions: 'Lie on bench holding bar above chest. Lower bar toward forehead by bending elbows. Keep upper arms stationary. Extend back up. Also called lying tricep extension.',
                sets: 3,
                reps: 12,
                weight: 40,
                image: ' Targets: Triceps (long head)'
            },
            'Tricep Dips': {
                equipment: 'Parallel Bars or Bench',
                instructions: 'On parallel bars: grip bars, body suspended, stay upright. Lower by bending elbows. Push back up. Or use bench with feet extended forward.',
                sets: 3,
                reps: 12,
                weight: 0,
                image: ' Targets: Triceps, Chest, Shoulders'
            },
            'Cable Tricep Pushdown': {
                equipment: 'Cable Machine, Rope or Bar',
                instructions: 'Stand at cable with high pulley. Grip attachment with elbows at sides. Push down straightening arms. Squeeze triceps. Control return.',
                sets: 3,
                reps: 15,
                weight: 50,
                image: ' Targets: Triceps (isolation)'
            },
            'Overhead Cable Extension': {
                equipment: 'Cable Machine, Rope',
                instructions: 'Face away from cable with rope overhead. Extend arms forward and up. Keep upper arms stationary. Great for tricep stretch.',
                sets: 3,
                reps: 15,
                weight: 30,
                image: ' Targets: Triceps (long head)'
            },
            'Bench Dips': {
                equipment: 'Bench',
                instructions: 'Sit on edge of bench, hands gripping edge. Slide forward off bench, legs extended. Lower body by bending elbows. Push back up.',
                sets: 3,
                reps: 15,
                weight: 0,
                image: ' Targets: Triceps (bodyweight)'
            },

            // Core/Abs Exercises
            'Dumbbell Russian Twists': {
                equipment: 'Dumbbell',
                instructions: 'Sit on floor, lean back slightly, lift feet. Hold dumbbell at chest. Rotate torso side to side, touching weight to floor on each side. Keep core tight.',
                sets: 3,
                reps: 20,
                weight: 15,
                image: ' Targets: Obliques, Core'
            },
            'Dumbbell Side Bends': {
                equipment: 'Dumbbell',
                instructions: 'Stand holding dumbbell in one hand. Bend sideways toward weight, lowering it down your leg. Return to upright. Complete all reps then switch sides.',
                sets: 3,
                reps: 15,
                weight: 25,
                image: ' Targets: Obliques'
            },
            'Plank': {
                equipment: 'Bodyweight',
                instructions: 'Support body on forearms and toes, body in straight line from head to heels. Keep core tight, don\'t let hips sag or pike up. Hold for time.',
                sets: 3,
                reps: 60,
                weight: 0,
                image: ' Targets: Core, Shoulders (time in seconds)'
            },
            'Mountain Climbers': {
                equipment: 'Bodyweight',
                instructions: 'Start in push-up position. Drive one knee toward chest, then quickly switch legs in running motion. Keep core tight and hips level.',
                sets: 3,
                reps: 20,
                weight: 0,
                image: ' Targets: Core, Cardio'
            },
            'Bicycle Crunches': {
                equipment: 'Bodyweight',
                instructions: 'Lie on back, hands behind head. Bring opposite elbow to opposite knee in cycling motion. Extend other leg out. Alternate sides in controlled manner.',
                sets: 3,
                reps: 20,
                weight: 0,
                image: ' Targets: Abs, Obliques'
            },

            // Kettlebell Exercises (30lb)
            'Kettlebell Swings': {
                equipment: 'Kettlebell (30lb)',
                instructions: 'Stand with feet shoulder-width apart, kettlebell between feet. Hinge at hips, swing kettlebell back between legs. Drive hips forward powerfully, swinging weight to shoulder height.',
                sets: 3,
                reps: 15,
                weight: 30,
                image: ' Targets: Glutes, Hamstrings, Core, Cardio'
            },
            'Kettlebell Goblet Squat': {
                equipment: 'Kettlebell (30lb)',
                instructions: 'Hold kettlebell at chest by horns. Squat down keeping chest up, elbows inside knees. Push through heels to stand.',
                sets: 3,
                reps: 12,
                weight: 30,
                image: ' Targets: Quads, Glutes, Core'
            },
            'Kettlebell Turkish Get-Up': {
                equipment: 'Kettlebell (30lb)',
                instructions: 'Lie on back holding kettlebell overhead. Complex movement transitioning from lying to standing while keeping weight overhead. Reverse to return. Excellent full-body exercise.',
                sets: 3,
                reps: 5,
                weight: 30,
                image: ' Targets: Full Body, Core, Stability'
            },
            'Kettlebell Halos': {
                equipment: 'Kettlebell (30lb)',
                instructions: 'Hold kettlebell upside down at chest level. Circle it around your head, keeping core tight. Alternate directions.',
                sets: 3,
                reps: 10,
                weight: 30,
                image: ' Targets: Shoulders, Core'
            },
            'Kettlebell Single-Arm Row': {
                equipment: 'Kettlebell (30lb)',
                instructions: 'Hinge at hips, place one hand on bench for support. Row kettlebell to hip with free hand. Keep back straight. Complete reps then switch sides.',
                sets: 3,
                reps: 12,
                weight: 30,
                image: ' Targets: Back, Biceps'
            },
            'Kettlebell Overhead Press': {
                equipment: 'Kettlebell (30lb)',
                instructions: 'Clean kettlebell to shoulder (rack position). Press overhead until arm is fully extended. Lower with control. Complete reps then switch arms.',
                sets: 3,
                reps: 10,
                weight: 30,
                image: ' Targets: Shoulders, Core'
            },

            // Cardio Exercises
            'Recumbent Bike': {
                equipment: 'Recumbent Bike',
                instructions: 'Adjust seat so legs are nearly fully extended at bottom of pedal stroke. Maintain steady cadence. Monitor heart rate. Vary resistance for intensity.',
                sets: 1,
                reps: 20,
                weight: 0,
                image: ' Targets: Cardiovascular, Quads, Glutes (time in minutes)'
            },
            'Rowing Machine': {
                equipment: 'Rowing Machine',
                instructions: 'Strap in feet. Drive with legs, then pull handle to chest. Reverse: extend arms, hinge at hips, bend knees. Keep back straight throughout.',
                sets: 1,
                reps: 15,
                weight: 0,
                image: ' Targets: Full Body Cardio, Back, Legs (time in minutes)'
            },
            'Interval Sprints - Bike': {
                equipment: 'Recumbent Bike',
                instructions: '30 seconds high intensity, 90 seconds recovery. Repeat for workout duration. Great for fat burning and conditioning.',
                sets: 8,
                reps: 1,
                weight: 0,
                image: ' Targets: HIIT Cardio, Fat Burning (intervals)'
            },
            'Interval Sprints - Rowing': {
                equipment: 'Rowing Machine',
                instructions: '30 seconds maximum effort, 90 seconds easy pace. Focus on powerful drives during work intervals.',
                sets: 8,
                reps: 1,
                weight: 0,
                image: ' Targets: HIIT Full Body, Conditioning (intervals)'
            }
        };

        // Predefined Workout Programs
        const workoutPrograms = {
            leg: {
                name: ' Leg Day',
                exercises: ['Dumbbell Goblet Squat', 'Dumbbell Romanian Deadlift', 'Dumbbell Lunges', 'Dumbbell Calf Raises']
            },
            chest: {
                name: ' Chest Day',
                exercises: ['Incline Dumbbell Press', 'Flat Dumbbell Press', 'Incline Dumbbell Flyes', 'Dumbbell Pullover', 'Push-Up']
            },
            back: {
                name: ' Back & Biceps',
                exercises: ['Dumbbell Bent-Over Row', 'Single-Arm Dumbbell Row', 'Dumbbell Shrugs', 'Dumbbell Bicep Curls', 'Hammer Curls']
            },
            shoulders: {
                name: ' Shoulders & Triceps',
                exercises: ['Dumbbell Shoulder Press', 'Dumbbell Lateral Raises', 'Dumbbell Front Raises', 'Bent-Over Rear Delt Raises', 'Overhead Tricep Extension', 'Dumbbell Tricep Kickbacks']
            },
            abs: {
                name: ' Core/Abs Blast',
                exercises: ['Dumbbell Russian Twists', 'Dumbbell Side Bends', 'Plank', 'Mountain Climbers', 'Bicycle Crunches']
            },
            kettlebell: {
                name: ' Kettlebell Circuit',
                exercises: ['Kettlebell Swings', 'Kettlebell Goblet Squat', 'Kettlebell Single-Arm Row', 'Kettlebell Overhead Press', 'Kettlebell Halos']
            },
            cardio: {
                name: ' Cardio Day',
                exercises: ['Recumbent Bike', 'Rowing Machine', 'Interval Sprints - Bike', 'Interval Sprints - Rowing']
            },
            fullbody: {
                name: ' Full Body Power',
                exercises: ['Dumbbell Goblet Squat', 'Incline Dumbbell Press', 'Dumbbell Bent-Over Row', 'Dumbbell Shoulder Press', 'Dumbbell Romanian Deadlift', 'Plank']
            }
        };

        // THE FIX: Take a snapshot of the original, built-in exercises BEFORE loading custom ones.
        const builtInExerciseNames = Object.keys(exerciseDatabase);

        // App State
        let currentWorkout = [];
        let workoutHistory = JSON.parse(localStorage.getItem('workoutHistory')) || [];
        let timerInterval = null;
        let timerSeconds = 0;
        let timerRunning = false;

        // Guided Workout State
        let guidedMode = false;
        let workoutStyle = 'traditional';
        let currentExerciseIndex = 0;
        let currentSetNumber = 1;
        let currentRound = 1;
        let completedSets = [];
        let restInterval = null;
        let restTimeRemaining = 0;

        // HIIT State
        let hiitTimerInterval = null;
        let hiitTimeRemaining = 0;
        let hiitCurrentMode = 'work'; // 'work', 'rest', 'countdown'
        let hiitCurrentRound = 1;
        let hiitCurrentExerciseIndex = 0;
        let hiitIsPaused = false;
        let hiitWorkoutParams = {
            workTime: 30,
            restTime: 15,
            totalRounds: 4
        };

        // Initialize
        updateRecommendation();
        updateProgress();
        updateHistory();
        loadCustomWorkoutsIntoDropdown();
        loadCustomExercises();
        loadCustomYouTubeLinks();
        loadExerciseDescriptions();

        // Load custom exercises from localStorage
        function loadCustomExercises() {
            const customExercises = JSON.parse(localStorage.getItem('customExercises')) || {};
            Object.keys(customExercises).forEach(name => {
                exerciseDatabase[name] = customExercises[name];
            });
        }

        // Load custom YouTube links from localStorage
        function loadCustomYouTubeLinks() {
            const customLinks = JSON.parse(localStorage.getItem('customYouTubeLinks')) || {};
            Object.keys(customLinks).forEach(name => {
                youtubeVideoLinks[name] = customLinks[name];
            });
        }

        // Load AI-generated exercise descriptions from localStorage
        function loadExerciseDescriptions() {
            const savedDescriptions = JSON.parse(localStorage.getItem('exerciseDescriptions')) || {};
            Object.keys(savedDescriptions).forEach(name => {
                exerciseDescriptions[name] = savedDescriptions[name];
            });
        }

        // Save custom exercise to localStorage
        function saveCustomExerciseToDB(name, data) {
            const customExercises = JSON.parse(localStorage.getItem('customExercises')) || {};
            customExercises[name] = data;
            localStorage.setItem('customExercises', JSON.stringify(customExercises));
            exerciseDatabase[name] = data; // Also update the runtime database
        }

        // Open add/edit exercise modal
        function openAddExerciseModal(isNew = false, exerciseName = '') {
            const modal = document.getElementById('addExerciseModal');
            const title = document.getElementById('addExerciseModalTitle');
            const saveBtn = document.getElementById('saveExerciseBtn');

            // Reset fields
            document.getElementById('originalExerciseName').value = isNew ? '' : exerciseName;
            document.getElementById('newExerciseName').value = isNew ? '' : exerciseName;
            document.getElementById('newExerciseEquipment').value = '';
            document.getElementById('newExerciseInstructions').value = '';
            document.getElementById('newExerciseImage').value = '';
            document.getElementById('newExerciseYouTubeLink').value = '';
            document.getElementById('newExerciseWeight').value = '25';
            document.getElementById('newExerciseSets').value = '3';
            document.getElementById('newExerciseReps').value = '12';

            if (isNew) {
                title.textContent = 'Add New Exercise';
                saveBtn.textContent = 'Add Exercise to Database';
            } else {
                title.textContent = 'Edit Exercise';
                saveBtn.textContent = 'Save Changes';
                const exercise = exerciseDatabase[exerciseName];
                if (exercise) {
                    document.getElementById('newExerciseEquipment').value = exercise.equipment || '';
                    document.getElementById('newExerciseInstructions').value = exercise.instructions || '';
                    document.getElementById('newExerciseImage').value = exercise.image || '';
                    document.getElementById('newExerciseYouTubeLink').value = youtubeVideoLinks[exerciseName] || '';
                    document.getElementById('newExerciseWeight').value = exercise.weight || 25;
                    document.getElementById('newExerciseSets').value = exercise.sets || 3;
                    document.getElementById('newExerciseReps').value = exercise.reps || 12;
                }
            }

            modal.classList.add('active');
        }

        // Close add exercise modal
        function closeAddExerciseModal() {
            document.getElementById('addExerciseModal').classList.remove('active');
        }

        // Save new or updated custom exercise
        function saveNewExercise() {
            const newName = document.getElementById('newExerciseName').value.trim();
            const originalName = document.getElementById('originalExerciseName').value;
            const equipment = document.getElementById('newExerciseEquipment').value.trim();
            const instructions = document.getElementById('newExerciseInstructions').value.trim();
            const image = document.getElementById('newExerciseImage').value.trim() || 'Custom Exercise';
            const youtubeLink = document.getElementById('newExerciseYouTubeLink').value.trim();
            const weight = parseInt(document.getElementById('newExerciseWeight').value) || 25;
            const sets = parseInt(document.getElementById('newExerciseSets').value) || 3;
            const reps = parseInt(document.getElementById('newExerciseReps').value) || 12;

            if (!newName || !equipment || !instructions) {
                alert('Please fill in all required fields (Name, Equipment, Instructions)');
                return;
            }

            const customExercises = JSON.parse(localStorage.getItem('customExercises')) || {};

            // If we are renaming an exercise, we need to remove the old one.
            if (originalName && newName !== originalName) {
                delete customExercises[originalName];
                delete exerciseDatabase[originalName];
            }

            const exerciseData = {
                equipment,
                instructions,
                sets,
                reps,
                weight,
                image
            };

            // Update both the localStorage object and the runtime object
            customExercises[newName] = exerciseData;
            exerciseDatabase[newName] = exerciseData;

            localStorage.setItem('customExercises', JSON.stringify(customExercises));

            if (youtubeLink) {
                youtubeVideoLinks[newName] = youtubeLink;
                localStorage.setItem('customYouTubeLinks', JSON.stringify(youtubeVideoLinks));
            }

            closeAddExerciseModal();
            alert(`Exercise "${newName}" saved successfully!`);

            // Refresh relevant views
            renderExerciseList();
            if (document.getElementById('customExerciseSelect')) {
                loadCustomWorkout();
            }
        }

        // Load saved custom workouts into main dropdown
        function loadCustomWorkoutsIntoDropdown() {
            const savedCustomWorkouts = JSON.parse(localStorage.getItem('customWorkouts')) || {};
            const customWorkoutNames = Object.keys(savedCustomWorkouts);

            if (customWorkoutNames.length === 0) return;

            const dropdown = document.getElementById('workoutType');
            const existingOptions = dropdown.querySelectorAll('option[data-custom="true"]');
            existingOptions.forEach(opt => opt.remove());

            const separator = document.createElement('option');
            separator.disabled = true;
            separator.textContent = ' My Custom Workouts ';
            separator.setAttribute('data-custom', 'true');
            dropdown.appendChild(separator);

            customWorkoutNames.forEach(name => {
                const option = document.createElement('option');
                option.value = 'saved_' + name;
                option.textContent = ' ' + name;
                option.setAttribute('data-custom', 'true');
                dropdown.appendChild(option);
            });
        }

        // Navigation
        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));

            document.getElementById(sectionId).classList.add('active');
            // Use a more robust selector for the button
            const activeButton = Array.from(document.querySelectorAll('.nav-btn')).find(btn => btn.getAttribute('onclick') === `showSection('${sectionId}')`);
            if (activeButton) {
                activeButton.classList.add('active');
            }


            if (sectionId === 'recommend') updateRecommendation();
            if (sectionId === 'progress') updateProgress();
            if (sectionId === 'history') updateHistory();
            if (sectionId === 'exercises') renderExerciseList();
            if (sectionId === 'settings') populateShareWorkoutDropdown();
            if (sectionId === 'share-workout') populateQRShareWorkoutDropdown();
        }


        // Load Workout
        function loadWorkout() {
            const type = document.getElementById('workoutType').value;
            const container = document.getElementById('workoutContainer');

            if (!type) {
                container.innerHTML = '';
                document.getElementById('workoutModeSelection').style.display = 'none';
                document.getElementById('hiitPreWorkoutAdjustments').style.display = 'none';
                return;
            }

            if (type === 'custom_hiit') {
                loadCustomHiitWorkout();
                return;
            }

            if (type === 'custom') {
                loadCustomWorkout();
                return;
            }

            if (type.startsWith('saved_')) {
                const workoutName = type.substring(6);
                loadSavedCustomWorkoutFromMain(workoutName);
                return;
            }
            
            // FEATURE: Load last-used exercise values from localStorage.
            const lastUsed = JSON.parse(localStorage.getItem('lastUsedExerciseValues')) || {};

            const program = workoutPrograms[type];
            currentWorkout = program.exercises.map(name => {
                const defaults = exerciseDatabase[name];
                // Start with defaults, then override with last used values if they exist.
                return {
                    name,
                    ...defaults,
                    weight: lastUsed[name]?.weight !== undefined ? lastUsed[name].weight : defaults.weight,
                    sets: lastUsed[name]?.sets !== undefined ? lastUsed[name].sets : defaults.sets,
                    reps: lastUsed[name]?.reps !== undefined ? lastUsed[name].reps : defaults.reps,
                    completed: false,
                    setsCompleted: 0
                };
            });

            container.innerHTML = `
 <div class="info-box">
 <p><strong>${program.name}</strong></p>
 <p>Customize your weights, sets, and reps below. Your changes will be saved!</p>
 </div>
 <div style="margin-bottom: 20px;">
 ${currentWorkout.map((ex, idx) => `
 <div class="exercise-card">
 <div style="font-weight: bold; font-size: 16px; margin-bottom: 10px; color: #001f3f;">
 ${ex.name}
 </div>
 <div style="font-size: 12px; color: #6c757d; margin-bottom: 10px;">${ex.equipment}</div>
 
 <div class="control-group">
 <div class="control-item">
 <div class="control-label">Weight (lbs)</div>
 <div class="control-buttons">
 <button onclick="adjustValue(${idx}, 'weight', -5)" class="adjust-btn">-</button>
 <input type="number" id="weight-${idx}" value="${ex.weight}" onchange="updateWorkoutValue(${idx}, 'weight', this.value)" class="control-input">
 <button onclick="adjustValue(${idx}, 'weight', 5)" class="adjust-btn plus">+</button>
 </div>
 </div>
 
 <div class="control-item">
 <div class="control-label">Sets</div>
 <div class="control-buttons">
 <button onclick="adjustValue(${idx}, 'sets', -1)" class="adjust-btn">-</button>
 <input type="number" id="sets-${idx}" value="${ex.sets}" onchange="updateWorkoutValue(${idx}, 'sets', this.value)" class="control-input">
 <button onclick="adjustValue(${idx}, 'sets', 1)" class="adjust-btn plus">+</button>
 </div>
 </div>
 
 <div class="control-item">
 <div class="control-label">Reps</div>
 <div class="control-buttons">
 <button onclick="adjustValue(${idx}, 'reps', -1)" class="adjust-btn">-</button>
 <input type="number" id="reps-${idx}" value="${ex.reps}" onchange="updateWorkoutValue(${idx}, 'reps', this.value)" class="control-input">
 <button onclick="adjustValue(${idx}, 'reps', 1)" class="adjust-btn plus">+</button>
 </div>
 </div>
 </div>
 
 <button class="btn btn-secondary" onclick="showExerciseInfo('${escapeHTML(ex.name)}')" style="margin-top: 12px; padding: 8px; font-size: 14px;">
 View Instructions
 </button>
 </div>
 `).join('')}
 </div>
 `;

            document.getElementById('workoutModeSelection').style.display = 'block';
        }

        function loadSavedCustomWorkoutFromMain(workoutName) {
            const savedCustomWorkouts = JSON.parse(localStorage.getItem('customWorkouts')) || {};
            const savedWorkout = savedCustomWorkouts[workoutName];

            if (!savedWorkout) {
                alert('Workout not found!');
                return;
            }

            // Check if it's a HIIT workout
            if (savedWorkout.workoutType === 'hiit') {
                currentWorkout = savedWorkout.exercises.map(ex => ({
                    name: ex.name,
                    ...(exerciseDatabase[ex.name] || {})
                }));
                hiitWorkoutParams = {
                    workTime: savedWorkout.workTime,
                    restTime: savedWorkout.restTime,
                    totalRounds: savedWorkout.rounds,
                    exercises: currentWorkout.map(ex => ex.name)
                };

                // Update pre-workout display values
                document.getElementById('hiitPreWorkWorkDisplay').textContent = hiitWorkoutParams.workTime;
                document.getElementById('hiitPreWorkRestDisplay').textContent = hiitWorkoutParams.restTime;
                document.getElementById('hiitPreWorkRoundsDisplay').textContent = hiitWorkoutParams.totalRounds;

                const container = document.getElementById('workoutContainer');
                container.innerHTML = `
      <div class="info-box">
        <p><strong>${workoutName} (HIIT)</strong></p>
        <p>Work: ${hiitWorkoutParams.workTime}s | Rest: ${hiitWorkoutParams.restTime}s | Rounds: ${hiitWorkoutParams.totalRounds}</p>
      </div>
      <div style="margin-bottom: 20px;">
        ${currentWorkout.map((ex, idx) => `
          <div class="exercise-card">
            <div class="exercise-name">${ex.name}</div>
            <div style="font-size: 12px; color: #6c757d; margin: 5px 0;">${ex.equipment || 'Bodyweight'}</div>
             <button class="btn btn-secondary" onclick="showExerciseInfo('${escapeHTML(ex.name)}')" style="margin-top: 12px; padding: 8px; font-size: 14px;">
                View Instructions
             </button>
          </div>
        `).join('')}
      </div>
    `;

                // Show HIIT adjustments and workout mode selection
                document.getElementById('hiitPreWorkoutAdjustments').style.display = 'block';
                document.getElementById('workoutModeSelection').style.display = 'block';
                return;
            }

            // Hide HIIT adjustments for non-HIIT workouts
            document.getElementById('hiitPreWorkoutAdjustments').style.display = 'none';

            // Load custom exercises from localStorage in case they're not in runtime database
            const customExercises = JSON.parse(localStorage.getItem('customExercises')) || {};

            currentWorkout = savedWorkout.map(ex => {
                // Check if exercise exists in database, if not check customExercises
                const dbExercise = exerciseDatabase[ex.name] || customExercises[ex.name];

                // If still not found, create a minimal exercise object
                if (!dbExercise) {
                    return {
                        name: ex.name,
                        equipment: ex.equipment || 'Various',
                        instructions: ex.instructions || 'Perform as described',
                        image: 'Custom Exercise',
                        weight: ex.weight || 0,
                        sets: ex.sets || 3,
                        reps: ex.reps || 10,
                        completed: false,
                        setsCompleted: 0
                    };
                }

                // Exercise found, merge database data with saved workout data
                return {
                    ...dbExercise,
                    name: ex.name,
                    weight: ex.weight,
                    sets: ex.sets,
                    reps: ex.reps,
                    completed: false,
                    setsCompleted: 0
                };
            });

            const container = document.getElementById('workoutContainer');

            container.innerHTML = `
 <div class="info-box">
 <p><strong> ${workoutName}</strong></p>
 <p>Your saved custom workout. Adjust as needed!</p>
 </div>
 <div style="margin-bottom: 20px;">
 ${currentWorkout.map((ex, idx) => `
 <div class="exercise-card">
 <div style="font-weight: bold; font-size: 16px; margin-bottom: 10px; color: #001f3f;">
 ${ex.name}
 </div>
 <div style="font-size: 12px; color: #6c757d; margin-bottom: 10px;">${ex.equipment || 'Various'}</div>
 
 <div class="control-group">
 <div class="control-item">
 <div class="control-label">Weight (lbs)</div>
 <div class="control-buttons">
 <button onclick="adjustValue(${idx}, 'weight', -5)" class="adjust-btn">-</button>
 <input type="number" id="weight-${idx}" value="${ex.weight}" onchange="updateWorkoutValue(${idx}, 'weight', this.value)" class="control-input">
 <button onclick="adjustValue(${idx}, 'weight', 5)" class="adjust-btn plus">+</button>
 </div>
 </div>
 
 <div class="control-item">
 <div class="control-label">Sets</div>
 <div class="control-buttons">
 <button onclick="adjustValue(${idx}, 'sets', -1)" class="adjust-btn">-</button>
 <input type="number" id="sets-${idx}" value="${ex.sets}" onchange="updateWorkoutValue(${idx}, 'sets', this.value)" class="control-input">
 <button onclick="adjustValue(${idx}, 'sets', 1)" class="adjust-btn plus">+</button>
 </div>
 </div>
 
 <div class="control-item">
 <div class="control-label">Reps</div>
 <div class="control-buttons">
 <button onclick="adjustValue(${idx}, 'reps', -1)" class="adjust-btn">-</button>
 <input type="number" id="reps-${idx}" value="${ex.reps}" onchange="updateWorkoutValue(${idx}, 'reps', this.value)" class="control-input">
 <button onclick="adjustValue(${idx}, 'reps', 1)" class="adjust-btn plus">+</button>
 </div>
 </div>
 </div>
 
 <button class="btn btn-secondary" onclick="showExerciseInfo('${escapeHTML(ex.name)}')" style="margin-top: 12px; padding: 8px; font-size: 14px;">
 View Instructions
 </button>
 </div>
 `).join('')}
 </div>
 `;

            document.getElementById('workoutModeSelection').style.display = 'block';
        }

        function adjustValue(idx, field, change) {
            const input = document.getElementById(`${field}-${idx}`);
            let newValue = parseInt(input.value) + change;

            if (field === 'sets' || field === 'reps') {
                newValue = Math.max(1, newValue);
            } else if (field === 'weight') {
                newValue = Math.max(0, newValue);
            }

            input.value = newValue;
            updateWorkoutValue(idx, field, newValue);
        }

        function updateWorkoutValue(idx, field, value) {
            const numValue = parseFloat(value) || 0;
            currentWorkout[idx][field] = numValue;
            
            // FEATURE: Save the updated values to be recalled next time.
            const exercise = currentWorkout[idx];
            const savedLastUsed = JSON.parse(localStorage.getItem('lastUsedExerciseValues')) || {};
            savedLastUsed[exercise.name] = {
                weight: exercise.weight,
                reps: exercise.reps,
                sets: exercise.sets
            };
            localStorage.setItem('lastUsedExerciseValues', JSON.stringify(savedLastUsed));
        }
        
        // This function is no longer needed as the logic from it is now in updateWorkoutValue
        // function saveWorkoutPreferences() { ... }

        function loadCustomWorkout() {
            const container = document.getElementById('workoutContainer');
            const exercises = Object.keys(exerciseDatabase).sort();
            const savedCustomWorkouts = JSON.parse(localStorage.getItem('customWorkouts')) || {};
            const customWorkoutNames = Object.keys(savedCustomWorkouts).filter(name => !savedCustomWorkouts[name].workoutType);


            container.innerHTML = `
 <div class="info-box">
 <p><strong>Custom Strength Workout Builder:</strong> Build your own routine or load a saved one.</p>
 </div>
 
 ${customWorkoutNames.length > 0 ? `
 <div style="margin-bottom: 20px;">
 <label style="font-weight: 600; margin-bottom: 8px; display: block;">Load Saved Custom Workout</label>
 <div style="display: flex; gap: 10px; margin-bottom: 10px;">
    <select id="savedCustomSelect" style="flex-grow: 1; padding: 12px; border: 2px solid #e9ecef; border-radius: 10px; font-size: 16px;">
    <option value="">-- Select a saved workout --</option>
    ${customWorkoutNames.map(name => `<option value="${name}">${name}</option>`).join('')}
    </select>
    <button class="btn" onclick="loadSavedCustomWorkout()" style="width: auto; margin-top: 0; padding: 12px;">Load</button>
 </div>
 <div style="display: flex; gap: 10px;">
    <button class="delete-btn" onclick="deleteSavedCustomWorkout()" style="width: 100%; padding: 10px; font-size: 14px;">Delete Selected</button>
 </div>
 </div>
 ` : ''}
 
 <div style="${customWorkoutNames.length > 0 ? 'border-top: 2px solid #8b7355; padding-top: 20px; margin-top: 20px;' : ''}">
 <label style="font-weight: 600; margin-bottom: 8px; display: block;">Build New Custom Workout</label>
 <div class="form-group">
 <label>Choose Exercise</label>
 <select id="customExerciseSelect">
 <option value="">-- Select Exercise --</option>
 ${exercises.map(ex => `<option value="${ex}">${ex}</option>`).join('')}
 </select>
 <button class="add-exercise-btn" onclick="addCustomExercise()">+ Add Exercise</button>
 </div>
 </div>
 
 <div id="customExercisesList"></div>
 
 <div id="saveCustomWorkoutSection" style="display: none; margin-top: 20px; padding: 15px; background: #d9c7a5; border-radius: 10px;">
 <label style="font-weight: 600; margin-bottom: 8px; display: block;">Save This Custom Workout</label>
 <input type="text" id="customWorkoutName" placeholder="Enter workout name (e.g., 'My Strength Workout')" style="width: 100%; padding: 12px; border: 2px solid #003d5c; border-radius: 8px; font-size: 16px; margin-bottom: 10px;">
 <button class="btn" onclick="saveCustomWorkout()" style="width: 100%;">
 Save Custom Workout
 </button>
 </div>
 `;

            currentWorkout = [];
            document.getElementById('workoutModeSelection').style.display = 'none';
        }

        function loadCustomHiitWorkout() {
            const container = document.getElementById('workoutContainer');
            const exercises = Object.keys(exerciseDatabase).sort();
            const savedCustomWorkouts = JSON.parse(localStorage.getItem('customWorkouts')) || {};
            const customHiitNames = Object.keys(savedCustomWorkouts).filter(name => savedCustomWorkouts[name].workoutType === 'hiit');

            container.innerHTML = `
    <div class="info-box">
      <p><strong>Custom HIIT Workout Builder:</strong> Define your intervals, add bodyweight exercises, and save your routine.</p>
    </div>

    ${customHiitNames.length > 0 ? `
    <div style="margin-bottom: 20px;">
      <label style="font-weight: 600; margin-bottom: 8px; display: block;">Load Saved HIIT Workout</label>
       <div style="display: flex; gap: 10px; margin-bottom: 10px;">
        <select id="savedCustomSelect" style="flex-grow: 1; padding: 12px; border: 2px solid #e9ecef; border-radius: 10px; font-size: 16px;">
          <option value="">-- Select a saved HIIT workout --</option>
          ${customHiitNames.map(name => `<option value="${name}">${name}</option>`).join('')}
        </select>
        <button class="btn" onclick="loadSavedCustomWorkout()" style="width: auto; margin-top: 0; padding: 12px;">Load</button>
      </div>
      <div style="display: flex; gap: 10px;">
        <button class="delete-btn" onclick="deleteSavedCustomWorkout()" style="width: 100%; padding: 10px; font-size: 14px;">Delete Selected</button>
      </div>
    </div>` : ''}

    <div id="hiitParameterSetup" style="background: #e8dcc4; border-radius: 12px; padding: 15px; margin-bottom: 15px;">
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px;">
            <div class="form-group">
                <label>Work (sec)</label>
                <input type="number" id="hiitWorkTime" value="30">
            </div>
            <div class="form-group">
                <label>Rest (sec)</label>
                <input type="number" id="hiitRestTime" value="15">
            </div>
            <div class="form-group">
                <label>Rounds</label>
                <input type="number" id="hiitTotalRounds" value="4">
            </div>
        </div>
    </div>

    <div class="form-group">
      <label>Choose Exercise</label>
      <select id="customExerciseSelect">
        <option value="">-- Select Exercise --</option>
        ${exercises.map(ex => `<option value="${ex}">${ex}</option>`).join('')}
      </select>
      <button class="add-exercise-btn" onclick="addCustomExercise()">+ Add Exercise</button>
    </div>

    <div id="customExercisesList"></div>

    <div id="saveCustomWorkoutSection" style="display: none; margin-top: 20px; padding: 15px; background: #d9c7a5; border-radius: 10px;">
      <label style="font-weight: 600; margin-bottom: 8px; display: block;">Save This HIIT Workout</label>
      <input type="text" id="customWorkoutName" placeholder="Enter workout name (e.g., 'My HIIT Blast')" style="width: 100%; padding: 12px; border: 2px solid #003d5c; border-radius: 8px; font-size: 16px; margin-bottom: 10px;">
      <button class="btn" onclick="saveCustomWorkout('hiit')" style="width: 100%;">Save HIIT Workout</button>
    </div>
  `;

            currentWorkout = [];
            document.getElementById('workoutModeSelection').style.display = 'none';
        }

        function loadSavedCustomWorkout() {
            const select = document.getElementById('savedCustomSelect');
            const workoutName = select.value;

            if (!workoutName) return;

            const savedCustomWorkouts = JSON.parse(localStorage.getItem('customWorkouts')) || {};
            const savedWorkout = savedCustomWorkouts[workoutName];

            if (!savedWorkout) return;

            // Handle HIIT workouts
            if (savedWorkout.workoutType === 'hiit') {
                document.getElementById('hiitWorkTime').value = savedWorkout.workTime;
                document.getElementById('hiitRestTime').value = savedWorkout.restTime;
                document.getElementById('hiitTotalRounds').value = savedWorkout.rounds;
                currentWorkout = savedWorkout.exercises.map(ex => ({
                    name: ex.name,
                    ...exerciseDatabase[ex.name]
                }));
                renderCustomWorkout('hiit');
                return;
            }

            // Load custom exercises from localStorage in case they're not in runtime database
            const customExercises = JSON.parse(localStorage.getItem('customExercises')) || {};

            currentWorkout = savedWorkout.map(ex => {
                // Check if exercise exists in database, if not check customExercises
                const dbExercise = exerciseDatabase[ex.name] || customExercises[ex.name];

                // If still not found, create a minimal exercise object
                if (!dbExercise) {
                    return {
                        name: ex.name,
                        equipment: ex.equipment || 'Various',
                        instructions: ex.instructions || 'Perform as described',
                        image: 'Custom Exercise',
                        weight: ex.weight || 0,
                        sets: ex.sets || 3,
                        reps: ex.reps || 10,
                        completed: false,
                        setsCompleted: 0
                    };
                }

                // Exercise found, merge database data with saved workout data
                return {
                    ...dbExercise,
                    name: ex.name,
                    weight: ex.weight,
                    sets: ex.sets,
                    reps: ex.reps,
                    completed: false,
                    setsCompleted: 0
                };
            });

            renderCustomWorkout();
        }

        function deleteSavedCustomWorkout() {
            const select = document.getElementById('savedCustomSelect');
            const workoutName = select.value;

            if (!workoutName) {
                alert('Please select a workout to delete');
                return;
            }

            if (!confirm(`Are you sure you want to delete "${workoutName}"?`)) {
                return;
            }

            const savedCustomWorkouts = JSON.parse(localStorage.getItem('customWorkouts')) || {};
            delete savedCustomWorkouts[workoutName];
            localStorage.setItem('customWorkouts', JSON.stringify(savedCustomWorkouts));

            loadCustomWorkoutsIntoDropdown();
            const type = document.getElementById('workoutType').value;
            if (type === 'custom') loadCustomWorkout();
            if (type === 'custom_hiit') loadCustomHiitWorkout();
        }

        function saveCustomWorkout(type = 'strength') {
            const nameInput = document.getElementById('customWorkoutName');
            const workoutName = nameInput.value.trim();

            if (!workoutName) {
                alert('Please enter a name for your workout');
                return;
            }

            if (currentWorkout.length === 0) {
                alert('Add some exercises first!');
                return;
            }

            const savedCustomWorkouts = JSON.parse(localStorage.getItem('customWorkouts')) || {};

            if (type === 'hiit') {
                savedCustomWorkouts[workoutName] = {
                    workoutType: 'hiit',
                    workTime: parseInt(document.getElementById('hiitWorkTime').value) || 30,
                    restTime: parseInt(document.getElementById('hiitRestTime').value) || 15,
                    rounds: parseInt(document.getElementById('hiitTotalRounds').value) || 4,
                    exercises: currentWorkout.map(ex => ({
                        name: ex.name
                    }))
                };
            } else {
                savedCustomWorkouts[workoutName] = currentWorkout.map(ex => ({
                    name: ex.name,
                    weight: ex.weight,
                    sets: ex.sets,
                    reps: ex.reps
                }));
            }

            localStorage.setItem('customWorkouts', JSON.stringify(savedCustomWorkouts));
            loadCustomWorkoutsIntoDropdown();

            alert(` Custom workout "${workoutName}" saved successfully!\n\nYou can now find it in the main workout dropdown!`);
            nameInput.value = '';
        }

        function addCustomExercise() {
            const select = document.getElementById('customExerciseSelect');
            const exerciseName = select.value;
            const workoutType = document.getElementById('workoutType').value;

            if (!exerciseName) {
                alert('Please select an exercise first!');
                return;
            }

            currentWorkout.push({
                name: exerciseName,
                ...exerciseDatabase[exerciseName],
                completed: false
            });

            select.value = '';
            renderCustomWorkout(workoutType === 'custom_hiit' ? 'hiit' : 'strength');
        }

        function renderCustomWorkout(type = 'strength') {
            const list = document.getElementById('customExercisesList');

            if (currentWorkout.length === 0) {
                list.innerHTML = '<p style="color: #6c757d; text-align: center; padding: 20px;">No exercises added yet</p>';
                document.getElementById('workoutModeSelection').style.display = 'none';
                document.getElementById('saveCustomWorkoutSection').style.display = 'none';
                return;
            }
            
            // FEATURE: Restore previously used settings (weight / reps / sets)
            const lastUsed = JSON.parse(localStorage.getItem('lastUsedExerciseValues')) || {};
            currentWorkout = currentWorkout.map(ex => {
                if (lastUsed[ex.name]) {
                    return {
                        ...ex,
                        ...lastUsed[ex.name]
                    };
                }
                return ex;
            });


            if (type === 'hiit') {
                list.innerHTML = currentWorkout.map((ex, idx) => `
      <div class="exercise-card">
        <div class="exercise-header">
          <div class="exercise-name">${ex.name}</div>
          <button class="delete-btn" onclick="removeCustomExercise(${idx})">Remove</button>
        </div>
        <div style="font-size: 12px; color: #6c757d; margin: 5px 0;">${ex.equipment || 'Bodyweight'}</div>
      </div>
    `).join('');
            } else {
                list.innerHTML = currentWorkout.map((ex, idx) => `
    <div class="exercise-card">
    <div class="exercise-header">
    <div class="exercise-name">${ex.name}</div>
    <button class="delete-btn" onclick="removeCustomExercise(${idx})">Remove</button>
    </div>
    <div style="font-size: 12px; color: #6c757d; margin: 5px 0;">${ex.equipment}</div>
    
    <div class="control-group">
    <div class="control-item">
    <div class="control-label">Weight (lbs)</div>
    <div class="control-buttons">
    <button onclick="adjustCustomValue(${idx}, 'weight', -5)" class="adjust-btn">-</button>
    <input type="number" id="custom-weight-${idx}" value="${ex.weight}" onchange="updateCustomExerciseValue(${idx}, 'weight', this.value)" class="control-input">
    <button onclick="adjustCustomValue(${idx}, 'weight', 5)" class="adjust-btn plus">+</button>
    </div>
    </div>
    
    <div class="control-item">
    <div class="control-label">Sets</div>
    <div class="control-buttons">
    <button onclick="adjustCustomValue(${idx}, 'sets', -1)" class="adjust-btn">-</button>
    <input type="number" id="custom-sets-${idx}" value="${ex.sets}" onchange="updateCustomExerciseValue(${idx}, 'sets', this.value)" class="control-input">
    <button onclick="adjustCustomValue(${idx}, 'sets', 1)" class="adjust-btn plus">+</button>
    </div>
    </div>
    
    <div class="control-item">
    <div class="control-label">Reps</div>
    <div class="control-buttons">
    <button onclick="adjustCustomValue(${idx}, 'reps', -1)" class="adjust-btn">-</button>
    <input type="number" id="custom-reps-${idx}" value="${ex.reps}" onchange="updateCustomExerciseValue(${idx}, 'reps', this.value)" class="control-input">
    <button onclick="adjustCustomValue(${idx}, 'reps', 1)" class="adjust-btn plus">+</button>
    </div>
    </div>
    </div>
    
    <button class="btn btn-secondary" onclick="showExerciseInfo('${escapeHTML(ex.name)}')" style="margin-top: 12px; padding: 8px; font-size: 14px;">
    View Instructions
    </button>
    </div>
    `).join('');
            }


            currentWorkout.forEach(ex => ex.setsCompleted = 0);
            document.getElementById('workoutModeSelection').style.display = 'block';
            document.getElementById('saveCustomWorkoutSection').style.display = 'block';
        }

        function adjustCustomValue(idx, field, change) {
            const input = document.getElementById(`custom-${field}-${idx}`);
            let newValue = parseInt(input.value) + change;

            if (field === 'sets' || field === 'reps') {
                newValue = Math.max(1, newValue);
            } else if (field === 'weight') {
                newValue = Math.max(0, newValue);
            }

            input.value = newValue;
            updateCustomExerciseValue(idx, field, newValue);
        }

        function updateCustomExerciseValue(idx, field, value) {
            const numValue = parseFloat(value) || 0;
            currentWorkout[idx][field] = numValue;

            // FEATURE: Persist last-used exercise settings
            const exercise = currentWorkout[idx];
            const savedLastUsed = JSON.parse(localStorage.getItem('lastUsedExerciseValues')) || {};

            savedLastUsed[exercise.name] = {
                weight: exercise.weight,
                reps: exercise.reps,
                sets: exercise.sets
            };

            localStorage.setItem('lastUsedExerciseValues', JSON.stringify(savedLastUsed));
        }

        function removeCustomExercise(idx) {
            currentWorkout.splice(idx, 1);
            const type = document.getElementById('workoutType').value;
            renderCustomWorkout(type === 'custom_hiit' ? 'hiit' : 'strength');
        }

        // Guided Workout Functions
        function startGuidedWorkout(style) {
            workoutStyle = style;
            guidedMode = true;
            currentExerciseIndex = 0;
            currentSetNumber = 1;
            currentRound = 1;
            completedSets = currentWorkout.map(ex => ({
                name: ex.name,
                completed: Array(ex.sets).fill(false)
            }));

            document.getElementById('workoutSetup').style.display = 'none';
            document.getElementById('guidedWorkoutMode').style.display = 'block';
            document.querySelector('.nav').style.display = 'none'; // Hide nav bar during workout

            startTimer();
            showAppleWatchReminder();
            updateGuidedDisplay();
        }

        function showAppleWatchReminder() {
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;

            if (!isIOS) return;

            const reminder = document.createElement('div');
            reminder.style.cssText = `
 position: fixed;
 top: 20px;
 left: 50%;
 transform: translateX(-50%);
 background: linear-gradient(135deg, #003d5c 0%, #005580 100%);
 color: #d4af37;
 padding: 15px 25px;
 border-radius: 12px;
 border: 2px solid #d4af37;
 font-weight: 600;
 z-index: 10000;
 box-shadow: 0 10px 30px rgba(0,0,0,0.5);
 text-align: center;
 max-width: 90%;
 `;
            reminder.innerHTML = ' Start your Apple Watch workout now!';
            document.body.appendChild(reminder);

            setTimeout(() => {
                reminder.style.transition = 'opacity 0.5s';
                reminder.style.opacity = '0';
                setTimeout(() => document.body.removeChild(reminder), 500);
            }, 4000);
        }

        function updateGuidedDisplay() {
            const exercise = currentWorkout[currentExerciseIndex];

            document.getElementById('currentExerciseName').textContent = exercise.name;
            document.getElementById('currentWeight').textContent = exercise.weight;
            document.getElementById('currentReps').textContent = exercise.reps;
            document.getElementById('currentSets').textContent = exercise.sets;

            if (workoutStyle === 'traditional') {
                document.getElementById('exerciseProgress').textContent =
                    `Exercise ${currentExerciseIndex + 1} of ${currentWorkout.length}`;
                document.getElementById('setProgress').textContent =
                    `Set ${currentSetNumber}/${exercise.sets}`;
            } else {
                document.getElementById('exerciseProgress').textContent =
                    `Round ${currentRound} Exercise ${currentExerciseIndex + 1}/${currentWorkout.length}`;
                document.getElementById('setProgress').textContent =
                    `Set ${currentRound}/${exercise.sets}`;
            }

            updateProgressList();
        }

        function updateProgressList() {
            const list = document.getElementById('workoutProgressList');
            list.innerHTML = completedSets.map((ex, idx) => {
                const completedCount = ex.completed.filter(s => s).length;
                const totalSets = ex.completed.length;
                const percentage = (completedCount / totalSets) * 100;

                return `
 <div class="chart-bar" style="margin-bottom: 10px;">
 <div class="chart-label" style="width: 150px; font-size: 13px;">${ex.name}</div>
 <div style="flex: 1; height: 25px; background: #d9c7a5; border-radius: 5px; position: relative; overflow: hidden;">
 <div style="width: ${percentage}%; height: 100%; background: linear-gradient(90deg, #001f3f 0%, #003d5c 100%); transition: width 0.3s;"></div>
 <div style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); color: ${percentage > 50 ? '#d4af37' : '#333'}; font-weight: 600; font-size: 12px;">
 ${completedCount}/${totalSets}
 </div>
 </div>
 </div>
 `;
            }).join('');
        }

        function completeSet() {
            completedSets[currentExerciseIndex].completed[currentSetNumber - 1] = true;

            if (workoutStyle === 'traditional') {
                if (currentSetNumber < currentWorkout[currentExerciseIndex].sets) {
                    currentSetNumber++;
                    startRest(60);
                } else {
                    currentExerciseIndex++;
                    currentSetNumber = 1;

                    if (currentExerciseIndex < currentWorkout.length) {
                        startRest(90);
                    } else {
                        finishWorkout();
                    }
                }
            } else {
                currentExerciseIndex++;

                if (currentExerciseIndex < currentWorkout.length) {
                    startRest(30);
                } else {
                    currentRound++;
                    currentExerciseIndex = 0;

                    const allComplete = completedSets.every(ex =>
                        ex.completed.every(s => s)
                    );

                    if (allComplete) {
                        finishWorkout();
                    } else {
                        startRest(90);
                    }
                }
            }
        }

        function startRest(seconds) {
            restTimeRemaining = seconds;
            document.getElementById('restTimer').style.display = 'block';
            document.getElementById('completeSetBtn').style.display = 'none';
            document.getElementById('restDisplay').textContent = restTimeRemaining;

            restInterval = setInterval(() => {
                restTimeRemaining--;
                document.getElementById('restDisplay').textContent = restTimeRemaining;

                if (restTimeRemaining <= 0) {
                    skipRest();
                }
            }, 1000);
        }

        function skipRest() {
            clearInterval(restInterval);
            document.getElementById('restTimer').style.display = 'none';
            document.getElementById('completeSetBtn').style.display = 'block';
            updateGuidedDisplay();
        }

        function showCurrentExerciseInfo() {
            const exercise = currentWorkout[currentExerciseIndex];
            showExerciseInfo(exercise.name);
        }

        function endWorkout() {
            if (confirm('Are you sure you want to end this workout early? Your progress will still be saved.')) {
                finishWorkout();
            }
        }

        function finishWorkout() {
            pauseTimer();

            const workoutTypeSelect = document.getElementById('workoutType');
            const selectedOption = workoutTypeSelect.options[workoutTypeSelect.selectedIndex];
            const programName = selectedOption.textContent.trim();

            const totalVolume = completedSets.reduce((sum, ex, idx) => {
                if (!ex || !ex.completed) return sum;
                const completedCount = ex.completed.filter(s => s).length;
                const exercise = currentWorkout[idx];
                if (!exercise) return sum;
                return sum + (exercise.weight * completedCount * exercise.reps);
            }, 0);

            const workout = {
                date: new Date().toISOString(),
                type: programName + (workoutStyle === 'circuit' ? ' (Circuit)' : ''),
                exercises: currentWorkout.map((ex, idx) => ({
                    name: ex.name,
                    weight: ex.weight,
                    sets: (completedSets[idx] && completedSets[idx].completed) ? completedSets[idx].completed.filter(s => s).length : 0,
                    reps: ex.reps,
                    plannedSets: ex.sets
                })),
                duration: timerSeconds,
                volume: totalVolume
            };

            workoutHistory.unshift(workout);
            localStorage.setItem('workoutHistory', JSON.stringify(workoutHistory));

            const totalSets = completedSets.reduce((sum, ex) => {
                if (!ex || !ex.completed) return sum;
                return sum + ex.completed.length;
            }, 0);
            const completedCount = completedSets.reduce((sum, ex) => {
                if (!ex || !ex.completed) return sum;
                return sum + ex.completed.filter(s => s).length;
            }, 0);
            const percentage = totalSets > 0 ? Math.round((completedCount / totalSets) * 100) : 0;

            alert(` Workout ${percentage === 100 ? 'Completed' : 'Saved'}!\n\nCompleted: ${completedCount}/${totalSets} sets (${percentage}%)\nTotal Volume: ${totalVolume} lbs\nDuration: ${formatTime(timerSeconds)}\n\nGreat work! Keep crushing it! `);

            resetWorkoutState();
        }

        function resetWorkoutState() {
            guidedMode = false;
            window.hiitActive = false;
            document.getElementById('workoutSetup').style.display = 'block';
            document.getElementById('guidedWorkoutMode').style.display = 'none';
            document.getElementById('hiitWorkoutMode').style.display = 'none';
            document.getElementById('workoutType').value = '';
            document.getElementById('workoutContainer').innerHTML = '';
            document.getElementById('workoutModeSelection').style.display = 'none';

            currentWorkout = [];
            completedSets = [];
            currentExerciseIndex = 0;
            currentSetNumber = 1;
            currentRound = 1;
            workoutStyle = 'traditional';

            resetTimer();
            updateRecommendation();
            updateProgress();
            updateHistory();

            document.querySelector('.nav').style.display = 'flex';
            showSection('history');
        }

        function showExerciseInfo(name) {
            const exercise = exerciseDatabase[name];
            const modal = document.getElementById('exerciseModal');
            const modalName = document.getElementById('modalExerciseName');
            const modalContent = document.getElementById('modalExerciseContent');

            modalName.textContent = name;

            // Check for AI-generated description
            const aiDescription = exerciseDescriptions[name];

            // If exercise not in database (AI-generated), check localStorage for saved data
            if (!exercise) {
                const customExercises = JSON.parse(localStorage.getItem('customExercises')) || {};
                const savedExercise = customExercises[name];

                const equipment = savedExercise ? savedExercise.equipment : 'Various';
                const instructions = aiDescription || (savedExercise ? savedExercise.instructions : "This exercise doesn't have detailed form instructions saved yet. You can still perform this exercise following standard form guidelines, or watch video tutorials for proper technique.");
                const youtubeLink = youtubeVideoLinks[name] || 'https://www.youtube.com/results?search_query=' + encodeURIComponent(name);

                modalContent.innerHTML = `
 <div style="margin-bottom: 15px;">
 <strong>Equipment:</strong> ${equipment}
 </div>
 <div style="margin-top: 15px;">
 <strong>[TIP] Detailed Instructions</strong>
 <p style="line-height: 1.6; margin-top: 10px;">${instructions}</p>
 </div>
 <div style="margin-top: 15px;">
 <a href="${youtubeLink}" target="_blank" class="btn" style="display: block; text-align: center; text-decoration: none; margin-top: 0;">
 [VIDEO] [VIDEO] Watch Video Tutorial on YouTube
 </a>
 </div>
 `;
                modal.classList.add('active');
                return;
            }

            // Build the image URL using free exercise database
            const imageUrl = getExerciseImageUrl(name);
            const imageHtml = `
 <div class="exercise-image" style="margin: 15px auto;" id="modal-img">
 <img src="${imageUrl}" 
 alt="${name}" 
 onerror="this.parentElement.innerHTML='<div class=exercise-image-fallback>${exercise.image}<br><small>Image not available</small></div>'">
 </div>
 `;
            const youtubeLink = youtubeVideoLinks[name] || 'https://www.youtube.com/results?search_query=' + encodeURIComponent(name);

            const displayInstructions = aiDescription || exercise.instructions;

            modalContent.innerHTML = `
 <div style="margin-bottom: 15px;">
 <strong>Equipment:</strong> ${exercise.equipment}
 </div>
 ${imageHtml}
 <div style="margin-top: 15px;">
 <strong>[TIP] Detailed Instructions</strong>
 <p style="line-height: 1.6; margin-top: 10px;">${displayInstructions}</p>
 </div>
 <div style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
 <strong>Suggested:</strong> ${exercise.sets} sets, ${exercise.reps} reps @ ${exercise.weight} lbs
 </div>
 <div style="margin-top: 15px;">
 <a href="${youtubeLink}" target="_blank" class="btn" style="display: block; text-align: center; text-decoration: none; margin-top: 0;">
 [VIDEO] [VIDEO] Watch Video Tutorial on YouTube
 </a>
 </div>
 `;

            modal.classList.add('active');
        }

        function closeModal() {
            document.getElementById('exerciseModal').classList.remove('active');
        }

        // Recommendations
        function updateRecommendation() {
            const container = document.getElementById('recommendationContainer');

            if (workoutHistory.length === 0) {
                container.innerHTML = `
 <div class="recommendation-card">
 <h3> Welcome to Your Fitness Journey!</h3>
 <p><strong>Today's Recommendation: Full Body Power</strong></p>
 <p>Start with a well-rounded full body workout to establish your baseline strength. This workout includes compound movements that hit all major muscle groups.</p>
 <p style="margin-top: 15px;"><strong>Why this workout?</strong> It's perfect for beginners and helps you learn proper form on key exercises while building foundational strength.</p>
 <button class="btn" onclick="selectRecommendedWorkout('fullbody')" style="margin-top: 15px;">Start This Workout</button>
 </div>
 <div class="info-box">
 <p><strong>Workout Tips:</strong></p>
 <p> Start with suggested weights and adjust as needed</p>
 <p> Focus on proper form over heavy weight</p>
 <p> Rest 60-90 seconds between sets</p>
 <p> Stay hydrated throughout your workout</p>
 </div>
 `;
                return;
            }

            const lastWorkout = workoutHistory[0];
            const lastWorkoutDate = new Date(lastWorkout.date);
            const daysSince = Math.floor((Date.now() - lastWorkoutDate) / (1000 * 60 * 60 * 24));

            // Check if we should generate a new AI recommendation (daily)
            const lastRecommendationDate = localStorage.getItem('lastRecommendationDate');
            const today = new Date().toDateString();
            const shouldGenerateNewAI = lastRecommendationDate !== today && localStorage.getItem('geminiKey');

            const recentTypes = workoutHistory.slice(0, 5).map(w => w.type);
            const recommendation = getSmartRecommendation(recentTypes, daysSince);

            let aiRecommendationHtml = '';
            if (shouldGenerateNewAI) {
                aiRecommendationHtml = `
 <div style="margin-top: 20px; padding: 15px; background: #d9c7a5; border-radius: 12px; border: 2px solid #d4af37;">
 <p style="margin: 0; font-size: 14px;"><strong> AI Daily Recommendation:</strong> Click button below to generate a personalized AI workout based on your history!</p>
 <button class="btn" onclick="generateAIDailyRecommendation()" style="margin-top: 10px; font-size: 14px; padding: 10px;">
  Generate AI Workout
 </button>
 </div>
 `;
            }

            container.innerHTML = `
 <div class="recommendation-card">
 <h3>${recommendation.title}</h3>
 <p><strong>Recommended: ${recommendation.workout}</strong></p>
 <p>${recommendation.reason}</p>
 <p style="margin-top: 10px;"><strong>Focus:</strong> ${recommendation.focus}</p>
 ${daysSince > 3 ? `<p style="margin-top: 10px; color: #fff3cd; background: rgba(255,255,255,0.2); padding: 10px; border-radius: 8px;"> It's been ${daysSince} days since your last workout. Let's get back on track!</p>` : ''}
 <button class="btn" onclick="selectRecommendedWorkout('${recommendation.type}')" style="margin-top: 15px;">Start This Workout</button>
 </div>
 <div class="info-box">
 <p><strong>Last Workout:</strong> ${lastWorkout.type} - ${formatDate(lastWorkout.date)}</p>
 <p><strong>Total Volume:</strong> ${lastWorkout.volume} lbs</p>
 <p><strong>Duration:</strong> ${formatTime(lastWorkout.duration)}</p>
 </div>
 ${aiRecommendationHtml}
 `;
        }

        async function generateAIDailyRecommendation() {
            const key = localStorage.getItem('geminiKey');
            if (!key) {
                alert('Please set up your AI Coach API key first in the AI Coach tab!');
                return;
            }

            try {
                // Prepare workout history summary
                const last10Workouts = workoutHistory.slice(0, 10);
                const workoutSummary = last10Workouts.map(w => `${w.type}: ${w.volume}lbs`).join(', ');
                const totalVolume = workoutHistory.reduce((sum, w) => sum + w.volume, 0);
                const avgDuration = Math.round(workoutHistory.reduce((sum, w) => sum + w.duration, 0) / workoutHistory.length / 60);

                const prompt = `Based on this user's workout history, create a personalized workout for today:
 
Recent Workouts: ${workoutSummary}
Total Volume: ${totalVolume} lbs
Average Duration: ${avgDuration} minutes
Total Workouts: ${workoutHistory.length}

Available equipment: dumbbells, 30lb kettlebell, incline bench, recumbent bike, rowing machine

Create a workout that:
1. Focuses on weak areas or underworked muscle groups
2. Provides good variety from recent workouts
3. Matches their typical duration and volume
4. Includes new exercises to prevent boredom

Format your response as JSON with this EXACT structure: {"title": "Workout Name", "description": "Why this workout helps your progress", "exercises": [{"name": "Exercise Name", "sets": number, "reps": number, "weight": number, "equipment": "equipment needed", "description": "Detailed 2-3 sentence description of proper form with step-by-step instructions", "youtubeLink": "https://www.youtube.com/results?search_query=exercise+name+tutorial"}]}

IMPORTANT: Include equipment, detailed description, and youtubeLink for EVERY exercise.`;

                const response = await fetch('https://generativelanguage.googleapis.com/v1/models/gemini-2.5-pro:generateContent?key=' + key, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: prompt
                            }]
                        }]
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    alert('API Error: ' + (data.error?.message || 'Unknown error'));
                    return;
                }

                let result = 'Error getting response';
                let aiWorkout = null;
                if (data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts[0]) {
                    result = data.candidates[0].content.parts[0].text;
                    aiWorkout = parseAIDailyWorkout(result);
                }

                if (aiWorkout) {
                    displayAIDailyRecommendation(aiWorkout);
                    localStorage.setItem('lastRecommendationDate', new Date().toDateString());
                } else {
                    alert('Could not parse AI recommendation. Please try again.');
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        function parseAIDailyWorkout(text) {
            try {
                const jsonMatch = text.match(/\{[\s\S]*\}/);
                if (!jsonMatch) return null;

                const jsonStr = jsonMatch[0];
                const workout = JSON.parse(jsonStr);

                if (workout.title && Array.isArray(workout.exercises)) {
                    return workout;
                }
                return null;
            } catch (e) {
                console.error('Failed to parse AI daily workout:', e);
                return null;
            }
        }

        function displayAIDailyRecommendation(aiWorkout) {
            const container = document.getElementById('recommendationContainer');

            let exercisesHtml = aiWorkout.exercises.map((ex, idx) => `
 <div style="margin: 10px 0; padding: 10px; background: rgba(212, 175, 55, 0.2); border-radius: 8px;">
 <strong>${idx + 1}. ${ex.name}</strong> - ${ex.sets}x${ex.reps} @ ${ex.weight}lbs
 <div style="font-size: 13px; color: #6c757d; margin-top: 5px;">${ex.description || ''}</div>
 </div>
 `).join('');

            const aiHTML = `
 <div class="recommendation-card" style="margin-top: 20px; background: linear-gradient(135deg, #d4af37 0%, #f0d680 100%); color: #001f3f; border: 2px solid #001f3f;">
 <h3 style="color: #001f3f;"> Today's AI Generated Workout</h3>
 <p><strong>${aiWorkout.title}</strong></p>
 <p style="margin: 10px 0;">${aiWorkout.description}</p>
 <div style="background: rgba(255,255,255,0.5); border-radius: 8px; padding: 15px; margin: 15px 0;">
 ${exercisesHtml}
 </div>
 <div style="display: flex; gap: 10px; margin-top: 15px;">
 <button class="btn btn-success" onclick="createWorkoutFromAIDailyRecommendation('${escapeHTML(aiWorkout.title)}', ${JSON.stringify(aiWorkout.exercises).replace(/'/g, "&apos;")})" style="flex: 1;">
 [+] Add to Custom Workouts
 </button>
 <button class="btn btn-secondary" onclick="updateRecommendation()" style="flex: 1;">
 [X] View Other Option
 </button>
 </div>
 </div>
 `;

            container.insertAdjacentHTML('beforeend', aiHTML);
        }

        function createWorkoutFromAIDailyRecommendation(title, exercises) {
            const savedCustomWorkouts = JSON.parse(localStorage.getItem('customWorkouts')) || {};

            let workoutName = title;
            let counter = 1;
            const originalName = workoutName;
            while (savedCustomWorkouts[workoutName]) {
                workoutName = `${originalName} (${counter})`;
                counter++;
            }

            const workoutExercises = exercises.map(ex => ({
                name: ex.name,
                sets: parseInt(ex.sets) || 3,
                reps: parseInt(ex.reps) || 10,
                weight: parseInt(ex.weight) || 0,
                equipment: ex.equipment || 'Various',
                instructions: ex.description || 'Perform as described',
                image: ex.description || 'Custom Exercise'
            }));

            // Add exercises to exercise database if they don't exist
            // Also save AI-generated descriptions and YouTube links
            workoutExercises.forEach((ex, idx) => {
                if (!exerciseDatabase[ex.name]) {
                    exerciseDatabase[ex.name] = {
                        equipment: ex.equipment,
                        instructions: ex.instructions,
                        sets: ex.sets,
                        reps: ex.reps,
                        weight: ex.weight,
                        image: ex.image
                    };

                    const customExercises = JSON.parse(localStorage.getItem('customExercises')) || {};
                    customExercises[ex.name] = exerciseDatabase[ex.name];
                    localStorage.setItem('customExercises', JSON.stringify(customExercises));
                }

                // Save AI-generated description
                if (exercises[idx] && exercises[idx].description) {
                    exerciseDescriptions[ex.name] = exercises[idx].description;
                    localStorage.setItem('exerciseDescriptions', JSON.stringify(exerciseDescriptions));
                }

                // Save YouTube link if provided by AI
                if (exercises[idx] && exercises[idx].youtubeLink) {
                    youtubeVideoLinks[ex.name] = exercises[idx].youtubeLink;
                    const customYouTubeLinks = JSON.parse(localStorage.getItem('customYouTubeLinks')) || {};
                    customYouTubeLinks[ex.name] = exercises[idx].youtubeLink;
                    localStorage.setItem('customYouTubeLinks', JSON.stringify(customYouTubeLinks));
                }
            });

            savedCustomWorkouts[workoutName] = workoutExercises;
            localStorage.setItem('customWorkouts', JSON.stringify(savedCustomWorkouts));

            loadCustomWorkoutsIntoDropdown();
            alert(` Workout "${workoutName}" has been added to your custom workouts!`);
            updateRecommendation();
        }

        function getSmartRecommendation(recentTypes, daysSince) {
            if (daysSince > 5) {
                return {
                    title: ' Welcome Back!',
                    workout: 'Full Body Power or Cardio Day',
                    type: 'fullbody',
                    reason: 'After a break, ease back in with a full body workout or cardio to rebuild conditioning.',
                    focus: 'Overall fitness and getting back into rhythm'
                };
            }

            const hasLeg = recentTypes.some(t => t.includes('Leg'));
            const hasChest = recentTypes.some(t => t.includes('Chest'));
            const hasBack = recentTypes.some(t => t.includes('Back'));
            const hasShoulder = recentTypes.some(t => t.includes('Shoulder'));
            const hasAbs = recentTypes.some(t => t.includes('Core') || t.includes('Abs'));
            const hasCardio = recentTypes.some(t => t.includes('Cardio'));
            const hasKettlebell = recentTypes.some(t => t.includes('Kettlebell'));

            if (!hasLeg) {
                return {
                    title: ' Time to Train Legs!',
                    workout: 'Leg Day',
                    type: 'leg',
                    reason: 'You haven\'t trained legs recently. Lower body strength is crucial for overall fitness and metabolism.',
                    focus: 'Quads, hamstrings, glutes, and calves'
                };
            }

            if (!hasBack && !hasChest) {
                return {
                    title: ' Upper Body Push Day',
                    workout: 'Chest Day',
                    type: 'chest',
                    reason: 'Build upper body pushing strength with chest and tricep focused exercises.',
                    focus: 'Chest, shoulders, and triceps'
                };
            }

            if (!hasBack) {
                return {
                    title: ' Pull Day - Back Focus',
                    workout: 'Back & Biceps',
                    type: 'back',
                    reason: 'Balance your training with a pulling day. Strong back muscles improve posture and overall strength.',
                    focus: 'Lats, traps, rhomboids, and biceps'
                };
            }

            if (!hasShoulder) {
                return {
                    title: ' Shoulder Development',
                    workout: 'Shoulders & Triceps',
                    type: 'shoulders',
                    reason: 'Well-developed shoulders create a strong upper body foundation and improve functional strength.',
                    focus: 'All three deltoid heads and triceps'
                };
            }

            if (!hasCardio && (hasLeg || hasChest || hasBack)) {
                return {
                    title: ' Cardio & Recovery',
                    workout: 'Cardio Day',
                    type: 'cardio',
                    reason: 'You\'ve been lifting hard! Time for cardio to boost heart health, burn fat, and aid recovery.',
                    focus: 'Cardiovascular endurance and active recovery'
                };
            }

            if (!hasKettlebell) {
                return {
                    title: ' Kettlebell Circuit',
                    workout: 'Kettlebell Circuit',
                    type: 'kettlebell',
                    reason: 'Mix things up with kettlebell training! Great for explosive power, core strength, and conditioning.',
                    focus: 'Full body power and conditioning'
                };
            }

            if (!hasAbs) {
                return {
                    title: ' Core Strength',
                    workout: 'Core/Abs Blast',
                    type: 'abs',
                    reason: 'A strong core is the foundation for all other lifts and protects your back.',
                    focus: 'Abs, obliques, and core stability'
                };
            }

            return {
                title: ' Balanced Training',
                workout: 'Full Body Power',
                type: 'fullbody',
                reason: 'Hit all major muscle groups with compound movements for balanced development.',
                focus: 'Total body strength and coordination'
            };
        }

        function selectRecommendedWorkout(type) {
            document.getElementById('workoutType').value = type;
            loadWorkout();
            showSection('workout');
            document.querySelector('.nav-btn.active').classList.remove('active');
            // Find the button for the workout tab and activate it
            const workoutButton = Array.from(document.querySelectorAll('.nav-btn')).find(btn => btn.getAttribute('onclick') === "showSection('workout')");
            if (workoutButton) {
                workoutButton.classList.add('active');
            }
        }


        // Progress Tracking
        function updateProgress() {
            const total = workoutHistory.length;
            document.getElementById('totalWorkouts').textContent = total;

            const weekAgo = Date.now() - (7 * 24 * 60 * 60 * 1000);
            const thisWeek = workoutHistory.filter(w => new Date(w.date) > weekAgo).length;
            document.getElementById('thisWeek').textContent = thisWeek;

            const totalVolume = workoutHistory.reduce((sum, w) => sum + (w.volume || 0), 0);
            document.getElementById('totalVolume').textContent = totalVolume.toLocaleString();

            const streak = calculateStreak();
            document.getElementById('streak').textContent = streak;

            updateWorkoutDistribution();
            updateVolumeProgress();
        }

        function calculateStreak() {
            if (workoutHistory.length === 0) return 0;

            let streak = 0;
            let currentDate = new Date();
            currentDate.setHours(0, 0, 0, 0);

            for (let i = 0; i < workoutHistory.length; i++) {
                const workoutDate = new Date(workoutHistory[i].date);
                workoutDate.setHours(0, 0, 0, 0);

                const diffDays = Math.floor((currentDate - workoutDate) / (1000 * 60 * 60 * 24));

                if (diffDays === streak) {
                    streak++;
                } else if (diffDays > streak) {
                    break;
                }
            }

            return streak;
        }

        function updateWorkoutDistribution() {
            const container = document.getElementById('workoutDistribution');
            const distribution = {};

            workoutHistory.forEach(w => {
                const type = w.type;
                distribution[type] = (distribution[type] || 0) + 1;
            });

            const sorted = Object.entries(distribution).sort((a, b) => b[1] - a[1]);
            const max = sorted[0]?.[1] || 1;

            if (sorted.length === 0) {
                container.innerHTML = '<p style="color: #6c757d; text-align: center;">No workout data yet. Start training to see your progress!</p>';
                return;
            }

            container.innerHTML = sorted.map(([type, count]) => {
                const width = (count / max) * 100;
                return `
 <div class="chart-bar">
 <div class="chart-label">${type}</div>
 <div class="chart-fill" style="width: ${width}%">
 <div class="chart-value">${count}</div>
 </div>
 </div>
 `;
            }).join('');
        }

        function updateVolumeProgress() {
            const container = document.getElementById('volumeProgress');
            const recent = workoutHistory.slice(0, 10).reverse();

            if (recent.length === 0) {
                container.innerHTML = '<p style="color: #6c757d; text-align: center;">Complete workouts to track volume progress!</p>';
                return;
            }

            const max = Math.max(...recent.map(w => w.volume || 0));

            container.innerHTML = recent.map((w, idx) => {
                const width = max > 0 ? ((w.volume || 0) / max) * 100 : 0;
                const shortType = w.type.split(' ')[0];
                return `
 <div class="chart-bar">
 <div class="chart-label">${shortType} #${recent.length - idx}</div>
 <div class="chart-fill" style="width: ${width}%">
 <div class="chart-value">${w.volume || 0}</div>
 </div>
 </div>
 `;
            }).join('');
        }

        // History
        function updateHistory() {
            const container = document.getElementById('historyContainer');

            if (workoutHistory.length === 0) {
                container.innerHTML = '<p style="color: #6c757d; text-align: center; padding: 40px;">No workout history yet. Complete your first workout to start tracking progress!</p>';
                return;
            }

            container.innerHTML = workoutHistory.map((w, idx) => {
                // Handle both regular and HIIT workouts
                let exerciseDisplay = '';
                if (Array.isArray(w.exercises)) {
                    if (w.exercises.length > 0 && typeof w.exercises[0] === 'string') {
                        // HIIT workouts have string array
                        exerciseDisplay = w.exercises.join(', ');
                    } else if (w.exercises.length > 0 && typeof w.exercises[0] === 'object') {
                        // Regular workouts have object array
                        exerciseDisplay = w.exercises.map(e => e.name).join(', ');
                    }
                }

                let durationDisplay = formatTime(w.duration || 0);

                return `
 <div class="history-item">
 <div class="history-header">
 <div class="history-date">${formatDate(w.date)}</div>
 <div class="history-type">${w.type}</div>
 </div>
 <div class="history-exercises">
 <strong>Exercises:</strong> ${exerciseDisplay}
 </div>
 ${w.rounds ? `<div style="margin-top: 5px; font-size: 14px; color: #6c757d;"><strong>Rounds:</strong> ${w.rounds}</div>` : ''}
 <div style="margin-top: 10px; font-size: 14px; color: #6c757d;">
 ${w.volume ? `<strong>Volume:</strong> ${w.volume} lbs |` : ''} <strong>Duration:</strong> ${durationDisplay}
 </div>
 <button class="delete-btn" onclick="deleteWorkout(${idx})" style="margin-top: 10px;">Delete</button>
 </div>
 `;
            }).join('');
        }

        function deleteWorkout(idx) {
            if (confirm('Are you sure you want to delete this workout?')) {
                workoutHistory.splice(idx, 1);
                localStorage.setItem('workoutHistory', JSON.stringify(workoutHistory));
                updateHistory();
                updateProgress();
                updateRecommendation();
            }
        }

       // ===== TIMER FUNCTIONS =====

        function startTimer() {
            // --- START OF FIX: Unlock Audio on the correct user tap ---
            if (!audioCtx) {
                try {
                    // Create the audio context the very first time the timer is started.
                    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                    console.log("Audio Context initialized by user starting timer.");
                } catch (e) {
                    console.log("Could not initialize audio context:", e);
                }
            }
            // If the context exists but was suspended by the browser, try to resume it.
            if (audioCtx && audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
            // --- END OF FIX ---

            if (!timerRunning) {
                timerRunning = true;
                timerInterval = setInterval(() => {
                    timerSeconds++;
                    document.getElementById('timerDisplay').textContent = formatTime(timerSeconds);
                }, 1000);

                // Check if HIIT workout mode is active (countdown screen visible)
                const hiitMode = document.getElementById('hiitWorkoutMode');
                const hiitCountdownScreen = document.getElementById('hiitCountdownScreen');
                
                if (hiitMode && hiitMode.style.display === 'block' && 
                    hiitCountdownScreen && hiitCountdownScreen.style.display !== 'none') {
                    console.log("Starting HIIT countdown");
                    startHiitCountdown();
                } else if (window.hiitActive) {
                    // If already in active HIIT interval, resume it
                    console.log("Resuming HIIT interval");
                    runHiitInterval();
                }
            }
        }

        function pauseTimer() {
            timerRunning = false;
            clearInterval(timerInterval);
        }

        function resetTimer() {
            timerRunning = false;
            clearInterval(timerInterval);
            timerSeconds = 0;
            document.getElementById('timerDisplay').textContent = '00:00';
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffTime = now - date;
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

            if (diffDays === 0) return 'Today';
            if (diffDays === 1) return 'Yesterday';
            if (diffDays < 7) return `${diffDays} days ago`;

            return date.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric'
            });
        }

        // Close modal on outside click
        document.getElementById('exerciseModal').addEventListener('click', (e) => {
            if (e.target.id === 'exerciseModal') {
                closeModal();
            }
        });

        document.getElementById('addExerciseModal').addEventListener('click', (e) => {
            if (e.target.id === 'addExerciseModal') {
                closeAddExerciseModal();
            }
        });

        // AI Coach Functions
        function saveApiKey() {
            const key = document.getElementById('apiKey').value.trim();
            if (!key) {
                alert('Please paste your API key');
                return;
            }
            localStorage.setItem('geminiKey', key);
            initAI();
        }

        function initAI() {
            const key = localStorage.getItem('geminiKey');
            if (key) {
                document.getElementById('api-setup').style.display = 'none';
                document.getElementById('chat-box').style.display = 'block';
                if (document.getElementById('messages').children.length === 0) {
                    addMsg('Hi! I am your AI Workout Coach. How can I help you train today?', 'bot');
                }
            }
        }

        function resetApiKey() {
            if (confirm('Are you sure you want to change your API key?')) {
                localStorage.removeItem('geminiKey');
                document.getElementById('api-setup').style.display = 'block';
                document.getElementById('chat-box').style.display = 'none';
                document.getElementById('messages').innerHTML = ''; // Clear chat history on key change
            }
        }

        function addMsg(text, role) {
            const msg = document.createElement('div');
            msg.style.padding = '10px';
            msg.style.borderRadius = '8px';
            msg.style.maxWidth = '80%';
            if (role === 'user') {
                msg.style.background = '#003d5c';
                msg.style.color = '#f5f5dc';
                msg.style.alignSelf = 'flex-end';
            } else {
                msg.style.background = '#d4af37';
                msg.style.color = '#001f3f';
                msg.style.alignSelf = 'flex-start';
            }
            msg.textContent = text;
            document.getElementById('messages').appendChild(msg);
            document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
        }

        async function sendMessage() {
            const msg = document.getElementById('userMessage').value.trim();
            if (!msg) return;

            addMsg(msg, 'user');
            document.getElementById('userMessage').value = '';

            const key = localStorage.getItem('geminiKey');
            if (!key) {
                alert('API key not set');
                return;
            }

            const instruction_prompt = `You are a helpful AI fitness coach integrated into a workout app. Your primary goal is to assist the user. Analyze the user's request and respond in one of four ways:

1. If the user wants to create a standard strength workout (e.g., "give me a leg workout", "create a 30 minute dumbbell routine"):
Respond with a JSON object for the workout plan. The JSON must have this EXACT structure:
{"title": "Workout Name", "exercises": [{"name": "Exercise Name", "sets": number, "reps": number, "weight": number, "equipment": "e.g., Dumbbells", "description": "Detailed 2-3 sentence description of proper form"}]}

2. If the user wants to create a High-Intensity Interval Training (HIIT) workout (e.g., "give me a 20 minute HIIT workout", "bodyweight HIIT routine"):
Respond with a JSON object specifically for a HIIT workout. The JSON must have this EXACT structure:
{"title": "Workout Name", "workoutType": "hiit", "workTime": number, "restTime": number, "rounds": number, "exercises": [{"name": "Exercise Name", "description": "How to do the exercise. Assume bodyweight unless specified."}]}

3. If the user wants to add, fix, or update the details for a SINGLE exercise (e.g., "add instructions for farmers walk", "what's the equipment for a dumbbell squat?"):
Respond with a JSON object to update the app's database. The JSON must have this EXACT structure:
{"action": "update_exercise", "exerciseName": "Name Of The Exercise", "details": {"description": "Detailed instructions on how to perform the exercise.", "equipment": "The equipment needed."}}

4. If the user asks a general fitness question or wants advice (e.g., "what's the best way to warm up?", "should I do cardio before or after weights?", "how many rest days should I take?", "what's better for fat loss?"):
Respond conversationally with helpful, accurate fitness advice. Do NOT use JSON format for these responses - just respond naturally as a knowledgeable fitness coach.

For workout/HIIT creation or exercise updates (options 1-3), respond ONLY with the appropriate JSON format. For general questions and advice (option 4), respond conversationally without JSON.

User's request: ${msg}`;

            try {
                const response = await fetch('https://generativelanguage.googleapis.com/v1/models/gemini-2.5-pro:generateContent?key=' + key, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: instruction_prompt
                            }]
                        }]
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    console.error('API Error Response:', data);
                    addMsg(`API Error: ${data.error?.message || response.statusText}. Please check your API key and its permissions.`, 'bot');
                    return;
                }

                let resultText = 'Error getting response';
                if (data.candidates && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts[0]) {
                    resultText = data.candidates[0].content.parts[0].text;
                } else if (data.error) {
                    console.error('API Error Response:', data);
                    resultText = `API Error: ${data.error.message}. Please check your key.`;
                    addMsg(resultText, 'bot');
                    return;
                }

                // Attempt to parse the AI response
                try {
                    const aiResponse = JSON.parse(resultText.match(/\{[\s\S]*\}/)[0]);

                    if (aiResponse.action === 'update_exercise') {
                        updateExerciseFromAI(aiResponse);
                    } else if (aiResponse.title && aiResponse.exercises) {
                        handleWorkoutCreation(aiResponse);
                    } else {
                        // The JSON is not in a recognized format
                        addMsg(resultText, 'bot');
                    }
                } catch (e) {
                    // If parsing fails, it's likely a conversational response
                    console.error('Failed to parse AI response as JSON:', e);
                    addMsg(resultText, 'bot');
                }

            } catch (e) {
                console.error('Network or other error:', e);
                addMsg(`Error: ${e.message}. Make sure you are connected to the internet.`, 'bot');
            }
        }

        function handleWorkoutCreation(aiWorkout) {
            let workoutDetails;
            if (aiWorkout.workoutType === 'hiit') {
                workoutDetails = `Work: ${aiWorkout.workTime}s, Rest: ${aiWorkout.restTime}s, Rounds: ${aiWorkout.rounds}\n` +
                    aiWorkout.exercises.map(ex => `- ${ex.name}`).join('\n');
            } else {
                workoutDetails = aiWorkout.exercises.map(ex => `- ${ex.name}: ${ex.sets}x${ex.reps} @ ${ex.weight} lbs`).join('\n');
            }

            addMsg('Here is the workout I generated for you:', 'bot');
            addMsg(workoutDetails, 'bot');
            addMsg('Would you like me to save this workout in your app?', 'bot');

            const msgContainer = document.getElementById('messages');
            const buttonContainer = document.createElement('div');
            buttonContainer.style.display = 'flex';
            buttonContainer.style.gap = '10px';
            buttonContainer.style.marginTop = '10px';
            buttonContainer.style.justifyContent = 'center';

            const createBtn = document.createElement('button');
            createBtn.textContent = '[+] Save Workout';
            createBtn.className = 'btn btn-success';
            createBtn.style.width = 'auto';
            createBtn.style.padding = '10px 20px';
            createBtn.style.marginTop = '0';
            createBtn.onclick = () => {
                createWorkoutFromAI(aiWorkout);
                buttonContainer.remove();
            };

            const cancelBtn = document.createElement('button');
            cancelBtn.textContent = '[X] No Thanks';
            cancelBtn.className = 'btn btn-secondary';
            cancelBtn.style.width = 'auto';
            cancelBtn.style.padding = '10px 20px';
            cancelBtn.style.marginTop = '0';
            cancelBtn.onclick = () => buttonContainer.remove();

            buttonContainer.appendChild(createBtn);
            buttonContainer.appendChild(cancelBtn);
            msgContainer.appendChild(buttonContainer);
            msgContainer.scrollTop = msgContainer.scrollHeight;
        }

        function updateExerciseFromAI(data) {
            const {
                exerciseName,
                details
            } = data;
            if (!exerciseName || !details) {
                addMsg("I couldn't understand which exercise to update. Please try again.", 'bot');
                return;
            }

            const {
                description,
                equipment
            } = details;

            const customExercises = JSON.parse(localStorage.getItem('customExercises')) || {};
            const existingExercise = customExercises[exerciseName] || exerciseDatabase[exerciseName] || {};

            const updatedExerciseData = {
                ...existingExercise,
                equipment: equipment || existingExercise.equipment || 'Various',
                instructions: description || existingExercise.instructions || 'No instructions provided.',
                image: existingExercise.image || 'AI Generated Exercise'
            };

            saveCustomExerciseToDB(exerciseName, updatedExerciseData);

            if (description) {
                exerciseDescriptions[exerciseName] = description;
                localStorage.setItem('exerciseDescriptions', JSON.stringify(exerciseDescriptions));
            }

            addMsg(`[SUCCESS] I've updated the details for "${exerciseName}" in the app's database.`, 'bot');
            renderExerciseList();
        }

        function createWorkoutFromAI(aiWorkout) {
            const savedCustomWorkouts = JSON.parse(localStorage.getItem('customWorkouts')) || {};
            let workoutName = aiWorkout.title || (aiWorkout.workoutType === 'hiit' ? 'AI HIIT Workout' : 'AI Strength Workout');
            let counter = 1;
            const originalName = workoutName;
            while (savedCustomWorkouts[workoutName]) {
                workoutName = `${originalName} (${counter})`;
                counter++;
            }

            if (aiWorkout.workoutType === 'hiit') {
                // Save as a HIIT workout
                savedCustomWorkouts[workoutName] = {
                    workoutType: 'hiit',
                    workTime: aiWorkout.workTime || 30,
                    restTime: aiWorkout.restTime || 15,
                    rounds: aiWorkout.rounds || 4,
                    exercises: aiWorkout.exercises.map(ex => ({
                        name: ex.name
                    }))
                };
            } else {
                // Save as a strength workout
                savedCustomWorkouts[workoutName] = aiWorkout.exercises.map(ex => ({
                    name: ex.name,
                    sets: parseInt(ex.sets) || 3,
                    reps: parseInt(ex.reps) || 10,
                    weight: parseInt(ex.weight) || 0
                }));
            }

            // Add any new exercises from the workout to the database
            aiWorkout.exercises.forEach(ex => {
                if (!exerciseDatabase[ex.name]) {
                    const newExerciseData = {
                        equipment: ex.equipment || 'Bodyweight',
                        instructions: ex.description || 'No specific instructions provided by AI.',
                        sets: parseInt(ex.sets) || 3,
                        reps: parseInt(ex.reps) || 10,
                        weight: parseInt(ex.weight) || 0,
                        image: 'AI Generated Exercise'
                    };
                    saveCustomExerciseToDB(ex.name, newExerciseData);
                }
                if (ex.description) {
                    exerciseDescriptions[ex.name] = ex.description;
                }
            });
            localStorage.setItem('exerciseDescriptions', JSON.stringify(exerciseDescriptions));

            localStorage.setItem('customWorkouts', JSON.stringify(savedCustomWorkouts));
            addMsg(`[SUCCESS] Workout has been saved! You can now find it in the "Workout" tab.`, 'bot');

            loadCustomWorkoutsIntoDropdown();
            renderExerciseList();
        }

        // New functions for the Exercises Tab
        function renderExerciseList() {
            const container = document.getElementById('exerciseListContainer');
            const searchTerm = document.getElementById('exerciseSearch').value.toLowerCase();

            // Important: We get ALL keys from the live database first
            const allExerciseNames = Object.keys(exerciseDatabase).sort();

            const filteredExercises = allExerciseNames.filter(name => name.toLowerCase().includes(searchTerm));

            if (filteredExercises.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6c757d;">No exercises found.</p>';
                return;
            }

            container.innerHTML = filteredExercises.map(name => {
                const exercise = exerciseDatabase[name];
                // The new, robust way to check if an exercise is custom
                const isCustom = !builtInExerciseNames.includes(name);
                const escapedName = escapeHTML(name);

                return `
      <div class="history-item">
        <div class="history-header">
          <div class="history-date" style="font-size: 16px;">${name}</div>
          <div style="display: flex; gap: 8px;">
            <button class="edit-btn" onclick="showExerciseInfo('${escapedName}')" style="background: #8b7355;">View</button>
            ${isCustom ? `<button class="edit-btn" onclick="openAddExerciseModal(false, '${escapedName}')">Edit</button>` : ''}
            ${isCustom ? `<button class="delete-btn" onclick="deleteExercise('${escapedName}')">Delete</button>` : ''}
          </div>
        </div>
        <div class="history-exercises"><strong>Equipment:</strong> ${exercise.equipment}</div>
      </div>
    `;
            }).join('');
        }

        function deleteExercise(exerciseName) {
            if (!confirm(`Are you sure you want to permanently delete "${exerciseName}"? This cannot be undone.`)) {
                return;
            }

            const customExercises = JSON.parse(localStorage.getItem('customExercises')) || {};

            delete customExercises[exerciseName];
            delete exerciseDatabase[exerciseName];

            localStorage.setItem('customExercises', JSON.stringify(customExercises));

            // Also remove from any saved workouts (important!)
            const savedWorkouts = JSON.parse(localStorage.getItem('customWorkouts')) || {};
            Object.keys(savedWorkouts).forEach(workoutName => {
                savedWorkouts[workoutName] = savedWorkouts[workoutName].filter(ex => ex.name !== exerciseName);
            });
            localStorage.setItem('customWorkouts', JSON.stringify(savedWorkouts));

            alert(`"${exerciseName}" has been deleted.`);
            renderExerciseList();
            loadCustomWorkoutsIntoDropdown();
        }

        async function generateExerciseDetailsWithAI() {
            const exerciseName = document.getElementById('newExerciseName').value.trim();
            if (!exerciseName) {
                alert('Please enter an exercise name first.');
                return;
            }

            const key = localStorage.getItem('geminiKey');
            if (!key) {
                alert('Please set up your API key in the AI Coach tab first.');
                return;
            }

            const btn = document.getElementById('aiGenerateBtn');
            btn.textContent = 'Generating...';
            btn.disabled = true;

            const prompt = `Provide a detailed description and the typical equipment for the exercise: "${exerciseName}". Respond ONLY with a JSON object in this exact format: {"description": "...", "equipment": "..."}`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1/models/gemini-2.5-pro:generateContent?key=${key}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: prompt
                            }]
                        }]
                    })
                });

                if (!response.ok) {
                    throw new Error('API request failed');
                }

                const data = await response.json();
                const resultText = data.candidates[0].content.parts[0].text;
                const jsonResponse = JSON.parse(resultText.match(/\{[\s\S]*\}/)[0]);

                if (jsonResponse.description && jsonResponse.equipment) {
                    document.getElementById('newExerciseInstructions').value = jsonResponse.description;
                    document.getElementById('newExerciseEquipment').value = jsonResponse.equipment;
                } else {
                    alert('AI could not generate details in the correct format. Please try again.');
                }

            } catch (error) {
                console.error("AI Generation Error:", error);
                alert('An error occurred while generating details with AI. Please check the console.');
            } finally {
                btn.textContent = '[AI] Generate with AI';
                btn.disabled = false;
            }
        }

        // ===== DATA MANAGEMENT FUNCTIONS (RESTORED) =====

        function exportData() {
            try {
                const dataToExport = {
                    workoutHistory: JSON.parse(localStorage.getItem('workoutHistory')) || [],
                    customWorkouts: JSON.parse(localStorage.getItem('customWorkouts')) || {},
                    customExercises: JSON.parse(localStorage.getItem('customExercises')) || {},
                    workoutPreferences: JSON.parse(localStorage.getItem('workoutPreferences')) || {},
                    customYouTubeLinks: JSON.parse(localStorage.getItem('customYouTubeLinks')) || {},
                    exerciseDescriptions: JSON.parse(localStorage.getItem('exerciseDescriptions')) || {},
                    geminiKey: localStorage.getItem('geminiKey') || '',
                    lastRecommendationDate: localStorage.getItem('lastRecommendationDate') || '',
                    exportDate: new Date().toISOString(),
                    appVersion: 'Workout Tracker Pro v2.1' // Updated version
                };
                
                const jsonString = JSON.stringify(dataToExport, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                const dateStr = new Date().toISOString().split('T')[0];
                a.href = url;
                a.download = `workout-tracker-backup-${dateStr}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                alert('[SUCCESS] Data exported successfully! Your backup file has been downloaded.');
            } catch (error) {
                console.error('Export failed:', error);
                alert('Failed to export data: ' + error.message);
            }
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    if (!importedData.workoutHistory && !importedData.customWorkouts) {
                        alert('Invalid backup file format. Please select a valid backup file.');
                        return;
                    }
                    
                    const workoutCount = (importedData.workoutHistory || []).length;
                    const exportDate = importedData.exportDate ? new Date(importedData.exportDate).toLocaleDateString() : 'Unknown';
                    
                    const confirmMsg = `Import backup from ${exportDate}?\n\n` +
                        `This backup contains ${workoutCount} workout(s) in history.\n\n` +
                        `[!] WARNING: This will REPLACE all your current data!\n\n` +
                        `Are you sure you want to continue?`;
                    
                    if (!confirm(confirmMsg)) {
                        event.target.value = ''; // Reset file input
                        return;
                    }
                    
                    // Clear existing data before import
                    localStorage.clear();

                    // Import all data keys found in the file
                    Object.keys(importedData).forEach(key => {
                        // The data is already an object/array, so we need to stringify it for localStorage
                        localStorage.setItem(key, JSON.stringify(importedData[key]));
                    });
                    
                    alert('[SUCCESS] Data imported successfully! The page will now reload.');
                    location.reload();
                    
                } catch (error) {
                    console.error('Import failed:', error);
                    alert('Failed to import data: ' + error.message);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }
        
        window.addEventListener('load', function () {
            if (localStorage.getItem('geminiKey')) {
                initAI();
            }
            
            document.getElementById('userMessage').addEventListener('keydown', function (event) {
                if (event.key === 'Enter' && !event.shiftKey) {
                    event.preventDefault();
                    sendMessage();
                }
            });

            // NEW: Handle incoming workout from URL on page load
            handleIncomingWorkout();
        });

        // ===== HIIT WORKOUT FUNCTIONS =====
        function playHiitSound(type) {
            // Use simple audio API with error handling
            try {
                if (!window.audioCtx) {
                    window.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                }

                const ctx = window.audioCtx;

                // Resume audio context if it was suspended
                if (ctx.state === 'suspended') {
                    ctx.resume().then(() => {
                        console.log("Audio context resumed");
                    });
                }

                const osc = ctx.createOscillator();
                const gain = ctx.createGain();

                let freq = 440;
                let duration = 0.15;

                if (type === 'work') {
                    freq = 880; // High pitch for work start
                    duration = 0.3;
                } else if (type === 'rest') {
                    freq = 440; // Medium pitch for rest start
                    duration = 0.3;
                } else if (type === 'countdown3') {
                    freq = 800; // For 3...
                    duration = 0.15;
                } else if (type === 'countdown2') {
                    freq = 800; // For 2...
                    duration = 0.15;
                } else if (type === 'countdown1') {
                    freq = 800; // For 1...
                    duration = 0.15;
                }

                osc.frequency.value = freq;
                osc.type = 'sine';

                gain.gain.setValueAtTime(0.7, ctx.currentTime); // Increased volume from 0.3 to 0.7
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + duration);

                osc.connect(gain);
                gain.connect(ctx.destination);

                osc.start(ctx.currentTime);
                osc.stop(ctx.currentTime + duration);

                console.log("Sound played:", type);
            } catch (e) {
                console.log("Sound not available:", e.message);
            }
        }

        function startHiitWorkout() {
            // This now sources the parameters directly from the UI/state
            if (!currentWorkout || currentWorkout.length === 0) {
                alert("No HIIT exercises are loaded. Please create or load a custom HIIT workout first.");
                return;
            }

            // Initialize audio context on user interaction (required for beeps to work)
            if (!window.audioCtx) {
                try {
                    window.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                    console.log("Audio context initialized");
                } catch (e) {
                    console.log("Could not initialize audio context:", e);
                }
            }

            hiitWorkoutParams.exercises = currentWorkout.map(ex => ex.name);
            // Parameters are already set in hiitWorkoutParams by the load function or pre-workout adjustments

            hiitCurrentRound = 1;
            hiitCurrentExerciseIndex = 0;
            hiitCurrentMode = 'countdown'; // Start with countdown
            hiitIsPaused = false;

            document.getElementById('workoutSetup').style.display = 'none';
            document.getElementById('guidedWorkoutMode').style.display = 'none';
            document.getElementById('hiitWorkoutMode').style.display = 'block';
            document.querySelector('.nav').style.display = 'none'; // Hide nav bar

            document.getElementById('hiitCountdownScreen').style.display = 'block';
            document.getElementById('hiitActiveScreen').style.display = 'none';
            document.getElementById('hiitPauseResumeBtn').textContent = 'Pause Exercise';

            // Show message to user to press Start button
            alert("HIIT Workout ready! Now click the 'Start' button on the Workout Timer above to begin your workout.");
        }


        function startHiitCountdown() {
            let hiitCountdown = 5;
            document.getElementById('hiitCountdownDisplay').textContent = hiitCountdown;

            console.log("=== HIIT Countdown Starting ===");

            let countdownInterval = setInterval(() => {
                hiitCountdown--;
                console.log("Countdown:", hiitCountdown);
                document.getElementById('hiitCountdownDisplay').textContent = hiitCountdown;

                if (hiitCountdown <= 0) {
                    clearInterval(countdownInterval);
                    console.log("Countdown complete, showing active screen");
                    document.getElementById('hiitCountdownScreen').style.display = 'none';
                    document.getElementById('hiitActiveScreen').style.display = 'block';
                    hiitCurrentMode = 'work';
                    hiitTimeRemaining = hiitWorkoutParams.workTime;

                    startTimer(); // Start the main workout timer
                    window.hiitActive = true;
                    runHiitInterval();
                }
            }, 1000);
        }

        function runHiitInterval() {
            if (hiitTimerInterval) clearInterval(hiitTimerInterval);

            updateHiitDisplay();

            // Play sound when phase starts
            if (hiitCurrentMode === 'work') {
                playHiitSound('work'); // High pitch for work
            } else {
                playHiitSound('rest'); // Medium pitch for rest
            }

            hiitTimerInterval = setInterval(() => {
                if (hiitIsPaused) return;

                hiitTimeRemaining--;
                document.getElementById('hiitTimerDisplay').textContent = hiitTimeRemaining;

                // Play beeps during final 3 seconds countdown (3, 2, 1)
                if (hiitTimeRemaining === 3) {
                    playHiitSound('countdown3'); // First beep
                } else if (hiitTimeRemaining === 2) {
                    playHiitSound('countdown2'); // Second beep
                } else if (hiitTimeRemaining === 1) {
                    playHiitSound('countdown1'); // Third beep
                }

                if (hiitTimeRemaining <= 0) {
                    clearInterval(hiitTimerInterval);
                    nextHiitPhase();
                }
            }, 1000);
        }

        function nextHiitPhase() {
            if (hiitCurrentMode === 'work') {
                hiitCurrentMode = 'rest';
                hiitTimeRemaining = hiitWorkoutParams.restTime;
            } else { // It was 'rest'
                hiitCurrentExerciseIndex++;
                if (hiitCurrentExerciseIndex >= hiitWorkoutParams.exercises.length) {
                    hiitCurrentExerciseIndex = 0;
                    hiitCurrentRound++;
                }
                hiitCurrentMode = 'work';
                hiitTimeRemaining = hiitWorkoutParams.workTime;
            }

            if (hiitCurrentRound > hiitWorkoutParams.totalRounds) {
                completeHiitWorkout();
            } else {
                runHiitInterval();
            }
        }

        function updateHiitDisplay() {
            const modeDisplay = document.getElementById('hiitModeDisplay');
            const exerciseNameEl = document.getElementById('hiitExerciseName');
            const nextExerciseNameEl = document.getElementById('hiitNextExerciseName');
            const roundDisplay = document.getElementById('hiitRoundDisplay');

            roundDisplay.textContent = `Round ${hiitCurrentRound} of ${hiitWorkoutParams.totalRounds}`;

            // Update the display values
            document.getElementById('hiitWorkDisplay').textContent = hiitWorkoutParams.workTime;
            document.getElementById('hiitRestDisplay').textContent = hiitWorkoutParams.restTime;
            document.getElementById('hiitRoundsDisplay').textContent = hiitWorkoutParams.totalRounds;

            if (hiitCurrentMode === 'work') {
                modeDisplay.textContent = 'WORK!';
                modeDisplay.classList.remove('rest');
                modeDisplay.classList.add('work');
                const exerciseName = hiitWorkoutParams.exercises[hiitCurrentExerciseIndex] || 'Exercise';
                exerciseNameEl.textContent = exerciseName;
                nextExerciseNameEl.textContent = 'Next Up: Rest';
            } else {
                modeDisplay.textContent = 'REST';
                modeDisplay.classList.remove('work');
                modeDisplay.classList.add('rest');
                exerciseNameEl.textContent = 'Rest';

                let nextIndex = hiitCurrentExerciseIndex + 1;
                let nextUpText = 'Next Up: ';
                if (nextIndex >= hiitWorkoutParams.exercises.length) {
                    nextUpText += `Round ${hiitCurrentRound + 1} - ${hiitWorkoutParams.exercises[0]}`;
                } else {
                    nextUpText += hiitWorkoutParams.exercises[nextIndex];
                }
                nextExerciseNameEl.textContent = nextUpText;

            }

            document.getElementById('hiitTimerDisplay').textContent = hiitTimeRemaining;
        }

        function adjustHiitParamPreWorkout(param, change) {
            if (param === 'work') {
                hiitWorkoutParams.workTime = Math.max(5, hiitWorkoutParams.workTime + change);
                document.getElementById('hiitPreWorkWorkDisplay').textContent = hiitWorkoutParams.workTime;
                console.log("Pre-workout: Work time adjusted to:", hiitWorkoutParams.workTime);
            } else if (param === 'rest') {
                hiitWorkoutParams.restTime = Math.max(5, hiitWorkoutParams.restTime + change);
                document.getElementById('hiitPreWorkRestDisplay').textContent = hiitWorkoutParams.restTime;
                console.log("Pre-workout: Rest time adjusted to:", hiitWorkoutParams.restTime);
            } else if (param === 'rounds') {
                hiitWorkoutParams.totalRounds = Math.max(1, hiitWorkoutParams.totalRounds + change);
                document.getElementById('hiitPreWorkRoundsDisplay').textContent = hiitWorkoutParams.totalRounds;
                console.log("Pre-workout: Rounds adjusted to:", hiitWorkoutParams.totalRounds);
            }
        }

        function adjustHiitParam(param, change) {
            if (param === 'work') {
                hiitWorkoutParams.workTime = Math.max(5, hiitWorkoutParams.workTime + change);
                document.getElementById('hiitWorkDisplay').textContent = hiitWorkoutParams.workTime;
                console.log("Work time adjusted to:", hiitWorkoutParams.workTime);
            } else if (param === 'rest') {
                hiitWorkoutParams.restTime = Math.max(5, hiitWorkoutParams.restTime + change);
                document.getElementById('hiitRestDisplay').textContent = hiitWorkoutParams.restTime;
                console.log("Rest time adjusted to:", hiitWorkoutParams.restTime);
            } else if (param === 'rounds') {
                hiitWorkoutParams.totalRounds = Math.max(1, hiitWorkoutParams.totalRounds + change);
                document.getElementById('hiitRoundsDisplay').textContent = hiitWorkoutParams.totalRounds;
                // Update the round display to reflect new total
                document.getElementById('hiitRoundDisplay').textContent = `Round ${hiitCurrentRound} of ${hiitWorkoutParams.totalRounds}`;
                console.log("Rounds adjusted to:", hiitWorkoutParams.totalRounds);
            }
        }

        function pauseResumeHiit() {
            const btn = document.getElementById('hiitPauseResumeBtn');
            hiitIsPaused = !hiitIsPaused; // This flag is all we need to pause the interval

            if (hiitIsPaused) {
                // We are now paused. Update the button text.
                btn.textContent = 'Resume Exercise';
                // DO NOT call pauseTimer(). The main timer will continue running.
            } else {
                // We are resuming. Update the button text.
                btn.textContent = 'Pause Exercise';
                
                // It's still good practice to resume the audio context here.
                if (window.audioCtx && window.audioCtx.state === 'suspended') {
                    window.audioCtx.resume();
                }
            }
        }

        function endHiitWorkout() {
            if (!confirm('Are you sure you want to end this workout?')) {
                return;
            }
            pauseTimer();
            clearInterval(hiitTimerInterval);

            const workout = {
                date: new Date().toISOString(),
                type: 'HIIT Workout',
                exercises: hiitWorkoutParams.exercises,
                rounds: hiitCurrentRound - 1,
                volume: 0,
                duration: timerSeconds // Include the total duration from main timer
            };

            workoutHistory.unshift(workout);
            localStorage.setItem('workoutHistory', JSON.stringify(workoutHistory));

            alert('Workout saved! Great work!');
            resetWorkoutState();
        }

        function completeHiitWorkout() {
            pauseTimer();
            clearInterval(hiitTimerInterval);
            playHiitSound('work');


            document.getElementById('hiitModeDisplay').textContent = 'COMPLETE!';
            document.getElementById('hiitTimerDisplay').textContent = '[OK]';
            document.getElementById('hiitExerciseName').textContent = 'Workout Finished';
            document.getElementById('hiitNextExerciseName').textContent = '';
            document.getElementById('hiitPauseResumeBtn').style.display = 'none';

            setTimeout(() => {
                const workout = {
                    date: new Date().toISOString(),
                    type: 'HIIT Workout',
                    exercises: hiitWorkoutParams.exercises,
                    rounds: hiitWorkoutParams.totalRounds,
                    volume: 0,
                    duration: timerSeconds // Include the total duration from main timer
                };

                workoutHistory.unshift(workout);
                localStorage.setItem('workoutHistory', JSON.stringify(workoutHistory));

                alert('Workout Complete! Excellent work! [STRONG]');
                resetWorkoutState();
            }, 1500);
        }

        // ===== SETTINGS TAB FUNCTIONS (RESTORED) =====
        
        // This function is already present from a previous step, but included for completeness
        function populateShareWorkoutDropdown() {
            const select = document.getElementById('shareWorkoutSelect');
            if (!select) return;
            
            const savedCustomWorkouts = JSON.parse(localStorage.getItem('customWorkouts')) || {};
            const workoutNames = Object.keys(savedCustomWorkouts).sort();
            
            select.innerHTML = '<option value="">-- Choose a workout --</option>';
            
            workoutNames.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                const workout = savedCustomWorkouts[name];
                const type = workout.workoutType === 'hiit' ? ' (HIIT)' : ' (Strength)';
                option.textContent = name + type;
                select.appendChild(option);
            });
        }
        
        function clearAllData() {
            const confirmMsg = '[!] PERMANENT DATA DELETION WARNING [!]\n\n' +
                'This will delete:\n' +
                ' All workout history\n' +
                ' All custom workouts\n' +
                ' All custom exercises\n' +
                ' All preferences\n' +
                ' Your API key\n\n' +
                'This action CANNOT be undone!\n\n' +
                'Type "DELETE" to confirm:';
            
            const userInput = prompt(confirmMsg);
            
            if (userInput === 'DELETE') {
                localStorage.clear();
                alert('[SUCCESS] All data has been cleared. The page will now reload.');
                location.reload();
            } else if (userInput !== null) {
                alert('Deletion cancelled. You must type "DELETE" exactly to confirm.');
            }
        }

        // ===================================================================
        // QR CODE SHARING FUNCTIONS (v5 - URL-based, Native Camera)
        // ===================================================================
        
        // This function is already present from a previous step, but included for completeness
        function populateQRShareWorkoutDropdown() {
            const select = document.getElementById('qrShareWorkoutSelect');
            if (!select) return;
            select.innerHTML = '<option value="">-- Choose a workout --</option>';
            const savedCustomWorkouts = JSON.parse(localStorage.getItem('customWorkouts')) || {};
            Object.keys(savedCustomWorkouts).forEach(workoutName => {
                const option = document.createElement('option');
                option.value = workoutName;
                option.textContent = workoutName;
                select.appendChild(option);
            });
        }
        
        function generateWorkoutQR() {
            const workoutSelect = document.getElementById('qrShareWorkoutSelect');
            const workoutName = workoutSelect.value;
            if (!workoutName) {
                alert('[!] Please select a workout to share.');
                return;
            }
            const savedCustomWorkouts = JSON.parse(localStorage.getItem('customWorkouts')) || {};
            const workoutData = savedCustomWorkouts[workoutName];
            if (!workoutData) {
                alert('[!] Workout not found.');
                return;
            }

            const customExercisesData = [];
            const allCustomExercises = JSON.parse(localStorage.getItem('customExercises')) || {};
            const exercisesInWorkout = workoutData.workoutType === 'hiit' ? workoutData.exercises : workoutData;

            if (Array.isArray(exercisesInWorkout)) {
                exercisesInWorkout.forEach(ex => {
                    if (allCustomExercises[ex.name] && !customExercisesData.some(customEx => customEx.name === ex.name)) {
                        customExercisesData.push({ name: ex.name, ...allCustomExercises[ex.name] });
                    }
                });
            }

            const shareableWorkout = {
                v: '2.2-b64zip', 
                t: workoutName,
                d: workoutData,
                c: customExercisesData,
                s: new Date().toISOString()
            };

            const jsonString = JSON.stringify(shareableWorkout);
            const compressedBinary = pako.deflate(jsonString);
            const binaryString = String.fromCharCode.apply(null, compressedBinary);
            const base64String = btoa(binaryString);

            // Create a URL with the data
            const baseUrl = window.location.origin + window.location.pathname;
            const shareUrl = `${baseUrl}?workout=${encodeURIComponent(base64String)}`;
            
            const qrContainer = document.getElementById('qrCodeContainer');
            qrContainer.style.display = 'block';
            
            const qrCanvasContainer = document.getElementById('qrCanvas').parentNode;
            qrCanvasContainer.innerHTML = ''; // Clear previous QR

            new QRCode(qrCanvasContainer, {
                text: shareUrl, // Generate a QR code for the URL
                width: 280,
                height: 280,
                colorDark: "#001f3f",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.M // M is good for URLs
            });
            
            document.getElementById('qrCanvas').style.display = 'none';
        }

        function handleIncomingWorkout() {
            const params = new URLSearchParams(window.location.search);
            const workoutParam = params.get('workout');

            if (!workoutParam) return; // No workout data in URL, do nothing

            try {
                let jsonString;
                let sharedWorkout;
                const qrData = decodeURIComponent(workoutParam);

                try {
                   const binaryString = atob(qrData);
                   const compressedBinary = new Uint8Array(binaryString.length).map((_, i) => binaryString.charCodeAt(i));
                   jsonString = pako.inflate(compressedBinary, { to: 'string' });
                   sharedWorkout = JSON.parse(jsonString);
                } catch (e) {
                   console.log("Could not decompress, attempting to parse as plain JSON.");
                   sharedWorkout = JSON.parse(qrData);
                }
                
                const title = sharedWorkout.t || sharedWorkout.title;
                const workoutData = sharedWorkout.d || sharedWorkout.workoutData;
                const customExercisesData = sharedWorkout.c || sharedWorkout.customExercisesData;

                if (!title || !workoutData) {
                    alert('[!] Invalid workout data in the URL.');
                    return;
                }
                
                const workoutType = workoutData.workoutType === 'hiit' ? 'HIIT' : 'Strength';
                const exercises = workoutData.workoutType === 'hiit' ? workoutData.exercises : workoutData;
                const exerciseCount = Array.isArray(exercises) ? exercises.length : 0;
                
                let confirmMsg = `[Workout Found] Import this shared workout?\n\n`;
                confirmMsg += `Name: ${title}\n`;
                confirmMsg += `Type: ${workoutType}\n`;
                confirmMsg += `Exercises: ${exerciseCount}\n`;
                if (customExercisesData && customExercisesData.length > 0) {
                    confirmMsg += `Custom Exercises: ${customExercisesData.length}\n`;
                }
                confirmMsg += `\nAdd this workout to your app?`;
                
                if (!confirm(confirmMsg)) {
                     // Clean the URL even if user cancels
                    window.history.replaceState({}, document.title, window.location.pathname);
                    return;
                }
                
                let importedExerciseCount = 0;
                if (customExercisesData && customExercisesData.length > 0) {
                    customExercisesData.forEach(ex => {
                        const { name, ...exerciseData } = ex;
                        if (!exerciseDatabase[name]) {
                            saveCustomExerciseToDB(name, exerciseData);
                            importedExerciseCount++;
                        }
                    });
                }
                
                const savedCustomWorkouts = JSON.parse(localStorage.getItem('customWorkouts')) || {};
                let newName = title;
                let counter = 1;
                while (savedCustomWorkouts[newName]) {
                    newName = `${title} (Imported ${counter++})`;
                }
                
                savedCustomWorkouts[newName] = workoutData;
                localStorage.setItem('customWorkouts', JSON.stringify(savedCustomWorkouts));
                
                loadCustomWorkoutsIntoDropdown();
                populateQRShareWorkoutDropdown();
                
                let successMsg = `[SUCCESS] Workout imported!\n\n"${newName}" is now available in your custom workouts.`;
                if (importedExerciseCount > 0) {
                    successMsg += `\n${importedExerciseCount} new custom exercise(s) were also added.`;
                }
                alert(successMsg);

                // IMPORTANT: Clean the URL after import to prevent re-importing on refresh
                window.history.replaceState({}, document.title, window.location.pathname);
                
            } catch (error) {
                console.error('Import failed:', error);
                alert('[!] Failed to import workout from URL. The data may be corrupted.');
                // Clean the URL on failure too
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }
        // FIX: Removed duplicated lines and extra curly braces that were causing a syntax error.
    </script>
</body>
</html>
```
